<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>mengchao666</title>
  
  <subtitle>ä¸ªäººè®°å½•</subtitle>
  <link href="http://example.com/atom.xml" rel="self"/>
  
  <link href="http://example.com/"/>
  <updated>2024-11-25T15:00:09.324Z</updated>
  <id>http://example.com/</id>
  
  <author>
    <name>John Doe</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>çº¢é»‘æ ‘</title>
    <link href="http://example.com/posts/%E7%BA%A2%E9%BB%91%E6%A0%91.html"/>
    <id>http://example.com/posts/%E7%BA%A2%E9%BB%91%E6%A0%91.html</id>
    <published>2024-11-25T14:59:37.000Z</published>
    <updated>2024-11-25T15:00:09.324Z</updated>
    
    <content type="html"><![CDATA[<h3 id="ä¸€ã€-çº¢é»‘æ ‘çš„åŸç†"><a href="#ä¸€ã€-çº¢é»‘æ ‘çš„åŸç†" class="headerlink" title="ä¸€ã€ çº¢é»‘æ ‘çš„åŸç†"></a>ä¸€ã€ çº¢é»‘æ ‘çš„åŸç†</h3><p>çº¢é»‘æ ‘RB Treeæ˜¯äºŒå‰æ ‘çš„ä¸€ç§ï¼Œä½œä¸ºä¸€ç§è‡ªå¹³è¡¡äºŒå‰æ ‘ï¼ˆä¸€äº›æƒ…å†µä¸‹ä¸æ˜¯å®Œå…¨å¹³è¡¡çš„ï¼‰ï¼Œå®ƒåœ¨æœ€åçš„æƒ…å†µä¸‹æŸ¥è¯¢å¤æ‚åº¦ä¸ºO(logN)ğ‘‚(ğ‘™ğ‘œğ‘”ğ‘)ã€‚ä¸AVLæ ‘ç±»ä¼¼ï¼Œå°½ç®¡RB TreeæŸ¥è¯¢æ•ˆç‡ä¸å¦‚AVLæ ‘ï¼ˆå› ä¸ºRB Treeå·¦å³å­æ ‘é«˜åº¦å·®è·æœ€å¤šæ¥è¿‘ä¸¤å€ï¼Œè€ŒAVLæ ‘å§‹ç»ˆä¿æŒå·¦å³å­æ ‘é«˜åº¦æœ€å¤šä¸è¶…è¿‡1ï¼‰ï¼Œä½†å…¶æ’å…¥åˆ é™¤æ•ˆç‡é«˜ï¼Œé€‚åˆç”¨äºå¤§æ•°æ®é‡ä¸”æ›´æ–°é¢‘ç¹çš„åœºæ™¯ï¼Œä¾‹å¦‚å†…æ ¸IOè°ƒåº¦ç®—æ³•ã€‚<br />çº¢é»‘æ ‘åœ¨äºŒå‰æ ‘çš„åŸºç¡€ä¸Šåšäº†å¦‚ä¸‹çº¦æŸï¼š</p><ol><li>æ ‘ç§å…¨éƒ¨èŠ‚ç‚¹è¦ä¹ˆæ˜¯é»‘è‰²è¦ä¹ˆæ˜¯çº¢è‰²</li><li>æ ‘çš„æ ¹èŠ‚ç‚¹æ˜¯é»‘è‰²çš„</li><li>å¶èŠ‚ç‚¹ï¼ˆæŒ‡NULLèŠ‚ç‚¹ï¼‰é¢œè‰²ä¸ºé»‘è‰²</li><li>çº¢è‰²èŠ‚ç‚¹ä¹‹é—´ä¸èƒ½ç›¸é‚»</li><li>ä¸€ä¸ªèŠ‚ç‚¹çš„å·¦å­æ ‘å’Œå³å­æ ‘é«˜åº¦ï¼ˆåªç»Ÿè®¡é»‘è‰²èŠ‚ç‚¹ï¼‰ç›¸åŒ</li></ol><p>åœ¨ä»‹ç»çº¢é»‘æ ‘çš„æ“ä½œå‰ï¼Œæˆ‘ä»¬å…ˆè¯´æ˜ä»¥ä¸‹å‡ ç‚¹æƒ¯ä¾‹ï¼š</p><ul><li>&#x3D;&#x3D;æ‰€æœ‰èŠ‚ç‚¹åœ¨æ’å…¥çš„æ—¶å€™éƒ½å°†æ˜¯çº¢è‰²èŠ‚ç‚¹ï¼ˆä¸åŒ…æ‹¬æ ¹èŠ‚ç‚¹ï¼Œå…¶æ’å…¥æ—¶æ˜¯é»‘è‰²çš„ï¼‰&#x3D;&#x3D;ï¼Œè¿™æ ·æœ‰ä¸€ä¸ªå¥½å¤„æ˜¯å¯ä»¥ä¸è¿åçº¦æŸ1ï¼Œ2ï¼Œ3å’Œ5ï¼Œå¯¹äºçº¦æŸ1ï¼Œ2å’Œ3æ˜¯æ˜¾ç„¶çš„ï¼Œå¯¹äº5ï¼Œç”±äºæ·»åŠ çº¢è‰²èŠ‚ç‚¹å¹¶ä¸ä¼šå½±å“å…¶çˆ¶èŠ‚ç‚¹åŠä»¥ä¸ŠèŠ‚ç‚¹å·¦å³å­æ ‘é»‘è‰²èŠ‚ç‚¹æ•°é‡ï¼Œæ•…ä¸è¿åçº¦æŸ5ã€‚å› æ­¤ï¼Œåœ¨æ’å…¥èŠ‚ç‚¹åï¼Œåªéœ€åˆ¤æ–­æ˜¯å¦è¿åçº¦æŸ4ã€‚</li><li>&#x3D;&#x3D;ä¸€é¢—çº¢é»‘æ ‘ä¸­ï¼ŒæŸä¸€èŠ‚ç‚¹å·¦å³å­æ ‘èŠ‚ç‚¹é«˜åº¦å·®ä¸ä¼šè¶…è¿‡2å€&#x3D;&#x3D;ï¼Œè€ƒè™‘ä¸€ç§æé™æƒ…å†µï¼šå·¦å­æ ‘é»‘è‰²èŠ‚ç‚¹é«˜åº¦ä¸ºxï¼Œä¸”æœ€é•¿è·¯å¾„ä¸­ä¸å­˜åœ¨çº¢è‰²èŠ‚ç‚¹ï¼Œè¿™æ˜¯å…è®¸çš„ï¼Œå³å­æ ‘æœ‰é»‘è‰²èŠ‚ç‚¹é«˜åº¦ä¸ºxï¼Œè¿™æ ·æ»¡è¶³çº¦æŸ5ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œå³å­æ ‘æœ€é•¿è·¯å¾„é»‘è‰²å‡ ç‚¹ä¹‹é—´éƒ½ç”±çº¢è‰²èŠ‚ç‚¹éš”å¼€ï¼ˆæ»¡è¶³çº¦æŸ4ï¼‰ï¼Œæ•…å³å­æ ‘æ€»é«˜åº¦ä¸º2x-1ï¼Œçº¦ç­‰äº2xã€‚</li></ul><h3 id="äºŒã€çº¢é»‘æ ‘æ“ä½œ"><a href="#äºŒã€çº¢é»‘æ ‘æ“ä½œ" class="headerlink" title="äºŒã€çº¢é»‘æ ‘æ“ä½œ"></a>äºŒã€çº¢é»‘æ ‘æ“ä½œ</h3><p>åœ¨Linuxå†…æ ¸ä»£ç ä¸­ä»…æä¾›äº†çº¢é»‘æ ‘èŠ‚ç‚¹é“¾æ¥ã€ç´¢å¼•ã€è°ƒæ•´ã€åˆ é™¤ç­‰åŸºç¡€æ“ä½œï¼Œä¸åŒ…å«ç‰¹å®šå«ä¹‰çš„æŸ¥è¯¢ã€æ’å…¥ç­‰æ“ä½œï¼š</p><ul><li><code>void rb_insert_color(struct rb_node *, struct rb_root *);</code>ï¼Œæ£€æŸ¥è°ƒæ•´ä¸€ä¸ªæŒ‡å®šèŠ‚ç‚¹ï¼Œé€šå¸¸ä¸<code>rb_link_node</code>æ­é…ä½¿ç”¨ï¼›</li><li><code>void rb_erase(struct rb_node *, struct rb_root *);</code>ï¼Œä»æ ‘ä¸­åˆ é™¤ä¸€ä¸ªæŒ‡å®šèŠ‚ç‚¹ï¼›</li><li><code>struct rb_node *rb_next(struct rb_node *);</code>ï¼Œè¿”å›ä¸€ä¸ªèŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼ˆé¡ºåºçš„ï¼‰ï¼›</li><li><code>struct rb_node *rb_prev(struct rb_node *);</code>ï¼Œè¿”å›ä¸€ä¸ªèŠ‚ç‚¹çš„ä¸Šä¸€ä¸ªèŠ‚ç‚¹ï¼ˆé¡ºåºçš„ï¼‰ï¼›</li><li><code>struct rb_node *rb_first(struct rb_root *);</code>ï¼Œè¿”å›æ ‘ä¸­çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ï¼ˆé¡ºåºçš„ï¼‰ï¼›</li><li><code>struct rb_node *rb_last(struct rb_root *);</code>ï¼Œè¿”å›æ ‘ä¸­çš„æœ€åä¸€ä¸ªèŠ‚ç‚¹ï¼ˆé¡ºåºçš„ï¼‰ï¼›</li><li><code>void rb_replace_node(struct rb_node *victim, struct rb_node *new, struct rb_root *root);</code>ï¼Œç”¨<code>new</code>æ›¿æ¢èŠ‚ç‚¹<code>victim</code>ï¼›</li><li><code>inline void rb_link_node(struct rb_node * node, struct rb_node * parent, struct rb_node ** rb_link)</code>ï¼Œå°†ä¸€ä¸ªèŠ‚ç‚¹é“¾æ¥åˆ°æ ‘ä¸­æŒ‡å®šä½ç½®ï¼Œ<code>parent</code>æ˜¯çˆ¶èŠ‚ç‚¹ï¼Œ<code>rb_link</code>æŒ‡å®šäº†é“¾æ¥çˆ¶èŠ‚ç‚¹çš„ä½ç½®æ˜¯å·¦è¿˜æ˜¯å³ã€‚</li></ul><h4 id="2-1-çº¢é»‘æ ‘çš„èŠ‚ç‚¹æ’å…¥"><a href="#2-1-çº¢é»‘æ ‘çš„èŠ‚ç‚¹æ’å…¥" class="headerlink" title="2.1 çº¢é»‘æ ‘çš„èŠ‚ç‚¹æ’å…¥"></a>2.1 çº¢é»‘æ ‘çš„èŠ‚ç‚¹æ’å…¥</h4><p>æ ¹æ®ç¬¬ä¸€ä¸ªéƒ¨åˆ†æˆ‘ä»¬æ‰€è®²çš„å†…å®¹å¯çŸ¥ï¼Œä¸€ä¸ªèŠ‚ç‚¹æ’å…¥RB Treeæ—¶ä¼šè¢«æŸ“æˆçº¢è‰²ï¼Œå› æ­¤åªéœ€è¦æ£€æŸ¥æ’å…¥æ—¶æ˜¯å¦è¿åè§„åˆ™4ï¼Œæ—¢æ’å…¥èŠ‚ç‚¹ä¸å…¶çˆ¶èŠ‚ç‚¹æ˜¯å¦éƒ½æ˜¯çº¢è‰²ï¼Œç„¶ååšå‡ºç›¸åº”çš„è°ƒæ•´ï¼Œè¿™äº›å·¥ä½œç”±<code>rb_insert_color</code>å‡½æ•°å®Œæˆï¼Œå…¶ä¸»è¦åˆ†ä»¥ä¸‹ä¸‰ç§æƒ…å†µï¼Œç¬¬ä¸€ç§æ˜¯çˆ¶èŠ‚ç‚¹ä¸ºé»‘è‰²ï¼Œé‚£ä¹ˆä¸éœ€è¦åšä»»ä½•äº‹æƒ…ï¼Œæ’å…¥çº¢èŠ‚ç‚¹åè¯¥æ ‘ä»ç„¶ç¬¦åˆæ‰€æœ‰è§„åˆ™ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">rb_insert_color</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> rb_node *node, <span class="hljs-keyword">struct</span> rb_root *root)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rb_node</span> *<span class="hljs-title">parent</span>, *<span class="hljs-title">gparent</span>;</span><br><br>    <span class="hljs-keyword">while</span> ((parent = node-&gt;rb_parent) &amp;&amp; parent-&gt;rb_color == RB_RED)<br>    &#123;<br>        ... <span class="hljs-comment">// æ£€æŸ¥ä¸å¤„ç†</span><br>    &#125;<br><br>    root-&gt;rb_node-&gt;rb_color = RB_BLACK; <span class="hljs-comment">// ä¿è¯æ ¹èŠ‚ç‚¹æ˜¯é»‘è‰²çš„</span><br>&#125;<br></code></pre></td></tr></table></figure><p>ç”±ä»£ç å¯çŸ¥ï¼Œåªè¦çˆ¶èŠ‚ç‚¹ä¸ºé»‘è‰²é‚£ä¹ˆå¯ä»¥ç›´æ¥é€€å‡ºã€‚ç¬¬äºŒç§æƒ…å†µæ˜¯çˆ¶èŠ‚ç‚¹ä¸ºçº¢è‰²ï¼Œæ­¤æ—¶è¿åè§„åˆ™4ï¼Œä½†æ˜¯å…¶å”çˆ¶èŠ‚ç‚¹ï¼ˆçˆ¶èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹çš„å¦ä¸€ä¸ªå­èŠ‚ç‚¹ï¼‰ä¹Ÿæ˜¯çº¢è‰²ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå·¦è¾¹å››ä¸ªæ ‘åŒ…å«äº†å…¨éƒ¨è¿™ç§æƒ…å†µï¼ŒAæ˜¯ç¥–çˆ¶ï¼ŒBæ˜¯æ’å…¥èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ï¼ŒEæ˜¯æ’å…¥èŠ‚ç‚¹ã€‚<br /></p><p><img src="https://raw.githubusercontent.com/mengchao666/picture/main/blog1949124-20240324144319658-1183105020.png"></p><p>è¿™ç§æƒ…å†µä¸‹ï¼Œå¯ä»¥ç›´æ¥å°†çˆ¶èŠ‚ç‚¹å’Œå”çˆ¶èŠ‚ç‚¹æŸ“æˆé»‘è‰²ï¼Œç¥–çˆ¶èŠ‚ç‚¹æŸ“æˆçº¢è‰²ï¼Œè¿™æ ·æ’å…¥èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹è§£å†³äº†è§„åˆ™4ï¼ŒåŒæ—¶ç¥–çˆ¶èŠ‚ç‚¹å·¦å³å­æ ‘é»‘è‰²èŠ‚ç‚¹é«˜åº¦ä»ç„¶ç›¸åŒï¼Œä¾‹å¦‚ä¸Šå›¾ä¸­çš„ç¬¬5æ£µæ ‘ï¼Œä¹‹åå°†ç¥–çˆ¶èŠ‚ç‚¹ä½œä¸ºæ’å…¥èŠ‚ç‚¹ç»§ç»­å‘ä¸Šæ£€æŸ¥ï¼Œä¸‹é¢çš„ä»£ç æ‰§è¡Œçš„æ­£æ˜¯è¿™ä¸€æ­¥éª¤ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">rb_insert_color</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> rb_node *node, <span class="hljs-keyword">struct</span> rb_root *root)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rb_node</span> *<span class="hljs-title">parent</span>, *<span class="hljs-title">gparent</span>;</span><br><br>    <span class="hljs-keyword">while</span> ((parent = node-&gt;rb_parent) &amp;&amp; parent-&gt;rb_color == RB_RED)<br>    &#123;<br>        gparent = parent-&gt;rb_parent; <span class="hljs-comment">// ç¥–çˆ¶èŠ‚ç‚¹</span><br><br>        <span class="hljs-keyword">if</span> (parent == gparent-&gt;rb_left)<br>        &#123;<br>            &#123;<br>                <span class="hljs-keyword">register</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rb_node</span> *<span class="hljs-title">uncle</span> =</span> gparent-&gt;rb_right;<br>                <span class="hljs-keyword">if</span> (uncle &amp;&amp; uncle-&gt;rb_color == RB_RED)<br>                &#123;<br>                    uncle-&gt;rb_color = RB_BLACK;<br>                    parent-&gt;rb_color = RB_BLACK;<br>                    gparent-&gt;rb_color = RB_RED;<br>                    node = gparent;<br>                    <span class="hljs-keyword">continue</span>;<br>                &#125;<br>            &#125;<br>            ... <span class="hljs-comment">// å…¶ä»–æ£€æŸ¥å’Œå¤„ç†</span><br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            &#123;<br>                <span class="hljs-keyword">register</span> <span class="hljs-keyword">struct</span> rb_node *uncle = gparent-&gt;rb_left;<br>                <span class="hljs-keyword">if</span> (uncle &amp;&amp; uncle-&gt;rb_color == RB_RED)<br>                &#123;<br>                    uncle-&gt;rb_color = RB_BLACK;<br>                    parent-&gt;rb_color = RB_BLACK;<br>                    gparent-&gt;rb_color = RB_RED;<br>                    node = gparent;<br>                    <span class="hljs-keyword">continue</span>;<br>                &#125;<br>            &#125;<br>            ... <span class="hljs-comment">// å…¶ä»–æ£€æŸ¥å’Œå¤„ç†</span><br>        &#125;<br>    &#125;<br><br>    root-&gt;rb_node-&gt;rb_color = RB_BLACK;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç¬¬ä¸‰ç§æƒ…å†µæœ€ä¸ºå¤æ‚ï¼Œç”±äºå”çˆ¶èŠ‚ç‚¹ä¸å†æ˜¯çº¢è‰²ï¼Œæ•…ä¸èƒ½åªé æŸ“è‰²æ¥è§£å†³ï¼Œå…¶å¯åˆ†ä¸ºä»¥ä¸‹å››ç§ï¼š</p><ol><li>æ’å…¥èŠ‚ç‚¹ä¸ºçˆ¶èŠ‚ç‚¹çš„å³èŠ‚ç‚¹ï¼Œçˆ¶èŠ‚ç‚¹ä¸ºç¥–çˆ¶èŠ‚ç‚¹çš„å·¦èŠ‚ç‚¹ï¼›</li><li>æ’å…¥èŠ‚ç‚¹ä¸ºçˆ¶èŠ‚ç‚¹çš„å·¦èŠ‚ç‚¹ï¼Œçˆ¶èŠ‚ç‚¹ä¸ºç¥–çˆ¶èŠ‚ç‚¹çš„å·¦èŠ‚ç‚¹ï¼›</li><li>æ’å…¥èŠ‚ç‚¹ä¸ºçˆ¶èŠ‚ç‚¹çš„å³èŠ‚ç‚¹ï¼Œçˆ¶èŠ‚ç‚¹ä¸ºç¥–çˆ¶èŠ‚ç‚¹çš„å³èŠ‚ç‚¹ï¼›</li><li>æ’å…¥èŠ‚ç‚¹ä¸ºçˆ¶èŠ‚ç‚¹çš„å·¦èŠ‚ç‚¹ï¼Œçˆ¶èŠ‚ç‚¹ä¸ºç¥–çˆ¶èŠ‚ç‚¹çš„å³èŠ‚ç‚¹ï¼›</li></ol><p>åœ¨è¿™å››ç§ä¸­ï¼Œç¬¬2ç§ï¼ˆå·¦å·¦ï¼‰å’Œç¬¬3ç§ï¼ˆå³å³ï¼‰éœ€è¦å…ˆè¿›è¡Œä¸€æ¬¡æŸ“è‰²è§£å†³è§„åˆ™4å†²çªï¼Œç„¶åç»è¿‡æ—‹è½¬è§£å†³æŸ“è‰²åçš„è§„åˆ™5å†²çªã€‚ä»¥å·¦å·¦ä¸ºä¾‹ï¼Œå…ˆå°†çˆ¶èŠ‚ç‚¹æŸ“æˆé»‘è‰²ï¼Œç¥–çˆ¶èŠ‚ç‚¹æŸ“æˆçº¢è‰²ï¼Œæ­¤æ—¶ä¸å†æœ‰é¢œè‰²å†²çªï¼Œä½†æ˜¯è§„åˆ™5å‡ºç°å†²çªï¼Œå› ä¸ºå·¦å­æ ‘æ˜¾ç„¶å¤šå‡ºä¸€ä¸ªé»‘è‰²èŠ‚ç‚¹ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥ç¥–çˆ¶èŠ‚ç‚¹å³æ—‹ï¼Œå°†çˆ¶èŠ‚ç‚¹ä½œä¸ºç¥–çˆ¶èŠ‚ç‚¹ï¼Œè¿™æ ·å°±å®Œæˆäº†ä¸¤ä¸ªæ°åˆ°å¥½å¤„çš„äº‹æƒ…ï¼š1ï¼‰ç¥–çˆ¶èŠ‚ç‚¹ä½ç½®çš„é¢œè‰²å†æ¬¡å˜ä¸ºé»‘è‰²ï¼Œè¿™å¿…ç„¶ä½¿å¾—ç¥–çˆ¶ä¸ä¼šç ´åè§„åˆ™4ï¼›2ï¼‰ç”±äºåŸç¥–çˆ¶èŠ‚ç‚¹æŸ“æˆçº¢è‰²ï¼Œæ‰€ä»¥å³ä½¿å…¶å˜æˆäº†å³å­æ ‘çš„èŠ‚ç‚¹ä¹Ÿä¸å½±å“è§„åˆ™5ã€‚ä¸‹å›¾å±•ç¤ºäº†è¿™ä¸€è¿‡ç¨‹ï¼š</p><p><img src="https://raw.githubusercontent.com/mengchao666/picture/main/blog1949124-20240324160538162-1068851558.png"></p><p>å¯¹äºå³å³ï¼Œå…¶ä¸å·¦å·¦åŒºåˆ«åœ¨äºä½¿ç”¨å·¦æ—‹ï¼ŒåŸç†å¯ä»¥å‚è€ƒå·¦å·¦è‡ªè¡Œæ¨æ–­ã€‚<br />å¯¹äºç¬¬1ç§ï¼ˆå³å·¦ï¼‰å’Œç¬¬4ç§ï¼ˆå·¦å³ï¼‰ï¼Œéœ€è¦å¤šå¢åŠ ä¸€ä¸ªæ—‹è½¬ï¼Œä½¿å…¶å˜ä¸ºå·¦å·¦æˆ–è€…å³å³ï¼Œç„¶åä¾¿å¯æŒ‰ç…§å·¦å·¦&#x2F;å³å³çš„è§„åˆ™è°ƒæ•´RB Treeï¼Œä¸‹å›¾å±•ç¤ºäº†å³å·¦çš„è°ƒæ•´è¿‡ç¨‹ã€‚</p><p><img src="https://raw.githubusercontent.com/mengchao666/picture/main/blog1949124-20240324154716488-957268159.png"></p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸è®ºæ˜¯è¿™å››ç§ä¸­çš„å“ªç§ï¼Œæœ€åæ“ä½œçš„ç»“æœå®é™…ä¸Šéƒ½æ˜¯åœ¨ç¥–çˆ¶èŠ‚ç‚¹å’Œå”çˆ¶èŠ‚ç‚¹ç›´æ¥æ–°æ’å…¥äº†çº¢è‰²èŠ‚ç‚¹ï¼Œç¥–çˆ¶èŠ‚ç‚¹é¢œè‰²å¹¶æ²¡æœ‰æ”¹å˜ï¼Œè€Œä¸”é»‘è‰²èŠ‚ç‚¹æ•°é‡ä¹Ÿæ²¡æœ‰æ”¹å˜ï¼Œæ‰€ä»¥åœ¨è°ƒæ•´ç»“æŸåæ— éœ€ç»§ç»­å‘ä¸Šæ£€æŸ¥ã€‚ä¸‹é¢æ˜¯å†…æ ¸ä¸­å…³äºç¬¬ä¸‰ç§æƒ…å†µçš„å¤„ç†ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> __rb_rotate_left(<span class="hljs-keyword">struct</span> rb_node *node, <span class="hljs-keyword">struct</span> rb_root *root)<br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rb_node</span> *<span class="hljs-title">right</span> =</span> node-&gt;rb_right;<br><br>    <span class="hljs-keyword">if</span> ((node-&gt;rb_right = right-&gt;rb_left))<br>        right-&gt;rb_left-&gt;rb_parent = node;<br>    right-&gt;rb_left = node;<br><br>    <span class="hljs-keyword">if</span> ((right-&gt;rb_parent = node-&gt;rb_parent))<br>    &#123;<br>        <span class="hljs-keyword">if</span> (node == node-&gt;rb_parent-&gt;rb_left)<br>            node-&gt;rb_parent-&gt;rb_left = right;<br>        <span class="hljs-keyword">else</span><br>            node-&gt;rb_parent-&gt;rb_right = right;<br>    &#125;<br>    <span class="hljs-keyword">else</span><br>        root-&gt;rb_node = right;<br>    node-&gt;rb_parent = right;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> __rb_rotate_right(<span class="hljs-keyword">struct</span> rb_node *node, <span class="hljs-keyword">struct</span> rb_root *root)<br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rb_node</span> *<span class="hljs-title">left</span> =</span> node-&gt;rb_left;<br><br>    <span class="hljs-keyword">if</span> ((node-&gt;rb_left = left-&gt;rb_right))<br>        left-&gt;rb_right-&gt;rb_parent = node;<br>    left-&gt;rb_right = node;<br><br>    <span class="hljs-keyword">if</span> ((left-&gt;rb_parent = node-&gt;rb_parent))<br>    &#123;<br>        <span class="hljs-keyword">if</span> (node == node-&gt;rb_parent-&gt;rb_right)<br>            node-&gt;rb_parent-&gt;rb_right = left;<br>        <span class="hljs-keyword">else</span><br>            node-&gt;rb_parent-&gt;rb_left = left;<br>    &#125;<br>    <span class="hljs-keyword">else</span><br>        root-&gt;rb_node = left;<br>    node-&gt;rb_parent = left;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">rb_insert_color</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> rb_node *node, <span class="hljs-keyword">struct</span> rb_root *root)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rb_node</span> *<span class="hljs-title">parent</span>, *<span class="hljs-title">gparent</span>;</span><br><br>    <span class="hljs-keyword">while</span> ((parent = node-&gt;rb_parent) &amp;&amp; parent-&gt;rb_color == RB_RED)<br>    &#123;<br>        gparent = parent-&gt;rb_parent;<br><br>        <span class="hljs-keyword">if</span> (parent == gparent-&gt;rb_left)<br>        &#123;<br>            &#123;<br>                <span class="hljs-keyword">register</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rb_node</span> *<span class="hljs-title">uncle</span> =</span> gparent-&gt;rb_right;<br>                ... <span class="hljs-comment">// å”çˆ¶ä¸ºçº¢è‰²çš„å¤„ç†</span><br>            &#125;<br><br>            <span class="hljs-keyword">if</span> (parent-&gt;rb_right == node)<br>            &#123;<br>                <span class="hljs-keyword">register</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rb_node</span> *<span class="hljs-title">tmp</span>;</span><br>                __rb_rotate_left(parent, root);<br>                tmp = parent; <br>                parent = node;<br>                node = tmp;<br>            &#125;<br><br>            parent-&gt;rb_color = RB_BLACK;<br>            gparent-&gt;rb_color = RB_RED;<br>            __rb_rotate_right(gparent, root);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            &#123;<br>                <span class="hljs-keyword">register</span> <span class="hljs-keyword">struct</span> rb_node *uncle = gparent-&gt;rb_left;<br>                ... <span class="hljs-comment">// å”çˆ¶ä¸ºçº¢è‰²çš„å¤„ç†</span><br>            &#125;<br><br>            <span class="hljs-keyword">if</span> (parent-&gt;rb_left == node)<br>            &#123;<br>                <span class="hljs-keyword">register</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rb_node</span> *<span class="hljs-title">tmp</span>;</span><br>                __rb_rotate_right(parent, root);<br>                tmp = parent;<br>                parent = node;<br>                node = tmp;<br>            &#125;<br><br>            parent-&gt;rb_color = RB_BLACK;<br>            gparent-&gt;rb_color = RB_RED;<br>            __rb_rotate_left(gparent, root);<br>        &#125;<br>    &#125;<br><br>    root-&gt;rb_node-&gt;rb_color = RB_BLACK;<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨Linuxå†…æ ¸ä¸­ï¼Œå¦‚æœéœ€è¦æ’å…¥ä¸€ä¸ªèŠ‚ç‚¹åˆ°RB Treeä¸­ï¼Œéœ€è¦æ‰§è¡Œä»¥ä¸‹å‡ æ­¥ï¼š</p><ol><li>éå†RB Treeï¼Œæ‰¾åˆ°æ–°èŠ‚ç‚¹æ’å…¥ä½ç½®ï¼›</li><li>è°ƒç”¨<code>rb_link_node</code>å°†èŠ‚ç‚¹é“¾æ¥åˆ°1æ‰¾åˆ°çš„ä½ç½®ï¼›</li><li>è°ƒç”¨<code>rb_insert_color</code>è°ƒæ•´RB Treeï¼Œä½¿å…¶ç¬¦åˆè§„åˆ™ã€‚</li></ol><h4 id="2-2-çº¢é»‘æ ‘çš„èŠ‚ç‚¹åˆ é™¤"><a href="#2-2-çº¢é»‘æ ‘çš„èŠ‚ç‚¹åˆ é™¤" class="headerlink" title="2.2 çº¢é»‘æ ‘çš„èŠ‚ç‚¹åˆ é™¤"></a>2.2 çº¢é»‘æ ‘çš„èŠ‚ç‚¹åˆ é™¤</h4><p>çº¢é»‘æ ‘çš„åˆ é™¤æ¯”æ’å…¥æ“ä½œæ›´ä¸ºå¤æ‚ï¼Œå…¶åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼Œç¬¬ä¸€ä¸ªé˜¶æ®µå…ˆåˆ é™¤èŠ‚ç‚¹ï¼Œå…¶æŠ€å·§ä¸ºï¼šå¦‚æœåˆ é™¤èŠ‚ç‚¹åªæœ‰ä¸€ä¸ªå­©å­æˆ–è€…æ²¡å­©å­ï¼Œé‚£ä¹ˆç›´æ¥åˆ é™¤è¯¥èŠ‚ç‚¹ï¼Œå¹¶é“¾æ¥çˆ¶èŠ‚ç‚¹å’Œå­©å­èŠ‚ç‚¹ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">rb_erase</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> rb_node *node, <span class="hljs-keyword">struct</span> rb_root *root)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rb_node</span> *<span class="hljs-title">child</span>, *<span class="hljs-title">parent</span>;</span><br>    <span class="hljs-type">int</span> color;<br><br>    <span class="hljs-keyword">if</span> (!node-&gt;rb_left)<br>        child = node-&gt;rb_right;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!node-&gt;rb_right)<br>        child = node-&gt;rb_left;<br>    <span class="hljs-keyword">else</span><br>    &#123;<br>        ... <span class="hljs-comment">// æœ‰ä¸¤ä¸ªå­©å­çš„æ“ä½œ</span><br>    &#125;<br><br>    parent = node-&gt;rb_parent;<br>    color = node-&gt;rb_color;<br><br>    <span class="hljs-comment">// é“¾æ¥çˆ¶èŠ‚ç‚¹å’Œå­©å­èŠ‚ç‚¹</span><br>    <span class="hljs-keyword">if</span> (child)<br>        child-&gt;rb_parent = parent;<br>    <span class="hljs-keyword">if</span> (parent)<br>    &#123;<br>        <span class="hljs-keyword">if</span> (parent-&gt;rb_left == node)<br>            parent-&gt;rb_left = child;<br>        <span class="hljs-keyword">else</span><br>            parent-&gt;rb_right = child;<br>    &#125;<br>    <span class="hljs-keyword">else</span><br>        root-&gt;rb_node = child;<br><br> color: <span class="hljs-comment">// ç¬¬äºŒé˜¶æ®µï¼šè°ƒæ•´</span><br>    <span class="hljs-keyword">if</span> (color == RB_BLACK)<br>        __rb_erase_color(child, parent, root);<br>&#125;<br></code></pre></td></tr></table></figure><p>å¦‚æœæœ‰ä¸¤ä¸ªå­©å­ï¼Œé‚£ä¹ˆé€‰æ‹©åˆ é™¤èŠ‚ç‚¹çš„é¡ºåºä¸‹ä¸€ä¸ªèŠ‚ç‚¹æ›¿æ¢åˆ é™¤èŠ‚ç‚¹ï¼Œæ—¢åˆ é™¤ä½ç½®å˜åˆ°äº†åˆ é™¤èŠ‚ç‚¹çš„é¡ºåºä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„åŸå…ˆä½ç½®ï¼Œè¿™æ ·å¯ä»¥ä¿è¯åˆ é™¤èŠ‚ç‚¹åªæœ‰ä¸€ä¸ªå³å­æ ‘ï¼ˆå› ä¸ºåˆ é™¤èŠ‚ç‚¹çš„é¡ºåºä¸‹ä¸€ä¸ªèŠ‚ç‚¹æ˜¯åˆ é™¤èŠ‚ç‚¹çš„å³å­æ ‘çš„æœ€å·¦è¾¹çš„å¶å­èŠ‚ç‚¹ï¼‰ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">rb_erase</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> rb_node *node, <span class="hljs-keyword">struct</span> rb_root *root)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rb_node</span> *<span class="hljs-title">child</span>, *<span class="hljs-title">parent</span>;</span><br>    <span class="hljs-type">int</span> color;<br><br>    <span class="hljs-keyword">if</span> (!node-&gt;rb_left)<br>        ...<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!node-&gt;rb_right)<br>        ...<br>    <span class="hljs-keyword">else</span><br>    &#123;<br>        <span class="hljs-keyword">struct</span> rb_node *old = node, *left;<br><br>        node = node-&gt;rb_right;<br>        <span class="hljs-keyword">while</span> ((left = node-&gt;rb_left) != <span class="hljs-literal">NULL</span>)<br>            node = left;<br>        <span class="hljs-comment">// æ­¤æ—¶ node ä¸º åˆ é™¤èŠ‚ç‚¹çš„é¡ºåºä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼ˆåªæœ‰å³å­æ ‘æˆ–è€…æ— å­©å­ï¼‰ï¼Œold ä¸ºåŸåˆ é™¤èŠ‚ç‚¹</span><br>        child = node-&gt;rb_right;<br>        parent = node-&gt;rb_parent;<br>        color = node-&gt;rb_color;<br><br>        <span class="hljs-comment">// é“¾æ¥åˆ é™¤èŠ‚ç‚¹çš„é¡ºåºä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„å­©å­èŠ‚ç‚¹å’Œçˆ¶èŠ‚ç‚¹</span><br>        <span class="hljs-keyword">if</span> (child)<br>            child-&gt;rb_parent = parent;<br>        <span class="hljs-keyword">if</span> (parent)<br>        &#123;<br>            <span class="hljs-keyword">if</span> (parent-&gt;rb_left == node)<br>                parent-&gt;rb_left = child;<br>            <span class="hljs-keyword">else</span><br>                parent-&gt;rb_right = child;<br>        &#125;<br>        <span class="hljs-keyword">else</span><br>            root-&gt;rb_node = child;<br><br>        <span class="hljs-keyword">if</span> (node-&gt;rb_parent == old) <span class="hljs-comment">// ç”±äº old æ˜¯å¾…åˆ é™¤èŠ‚ç‚¹ï¼Œè€Œ parent æ­¤æ—¶æŒ‡å‘ oldï¼Œæ‰€ä»¥è¦å°† parent æŒ‡å‘æ–°çš„ node</span><br>            parent = node;<br>        <span class="hljs-comment">// node èŠ‚ç‚¹æ›¿æ¢åŸåˆ é™¤èŠ‚ç‚¹</span><br>        node-&gt;rb_parent = old-&gt;rb_parent;<br>        node-&gt;rb_color = old-&gt;rb_color;<br>        node-&gt;rb_right = old-&gt;rb_right;<br>        node-&gt;rb_left = old-&gt;rb_left;<br><br>        <span class="hljs-comment">// å°†æ–° node é“¾æ¥åˆ°åŸåˆ é™¤èŠ‚ç‚¹ old çš„çˆ¶èŠ‚ç‚¹ä¸Š</span><br>        <span class="hljs-keyword">if</span> (old-&gt;rb_parent)<br>        &#123;<br>            <span class="hljs-keyword">if</span> (old-&gt;rb_parent-&gt;rb_left == old)<br>                old-&gt;rb_parent-&gt;rb_left = node;<br>            <span class="hljs-keyword">else</span><br>                old-&gt;rb_parent-&gt;rb_right = node;<br>        &#125; <span class="hljs-keyword">else</span><br>            root-&gt;rb_node = node;<br><br>        <span class="hljs-comment">// å°†æ–° node é“¾æ¥åˆ°åŸåˆ é™¤èŠ‚ç‚¹ old çš„å­èŠ‚ç‚¹ä¸Š</span><br>        old-&gt;rb_left-&gt;rb_parent = node;<br>        <span class="hljs-keyword">if</span> (old-&gt;rb_right) <span class="hljs-comment">// å¯èƒ½åˆ é™¤çš„å³å­æ ‘åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹ï¼Œåˆ é™¤åå˜ä¸ºNULL</span><br>            old-&gt;rb_right-&gt;rb_parent = node;<br>        <span class="hljs-keyword">goto</span> color;<br>    &#125;<br><br> color: <span class="hljs-comment">// ç¬¬äºŒé˜¶æ®µï¼šè°ƒæ•´</span><br>    <span class="hljs-keyword">if</span> (color == RB_BLACK)<br>        __rb_erase_color(child, parent, root);<br>&#125;<br></code></pre></td></tr></table></figure><p>ç¬¬äºŒé˜¶æ®µ</p><p>å½“åœ¨ç¬¬ä¸€é˜¶æ®µç¡®å®šäº†åˆ é™¤èŠ‚ç‚¹ä½ç½®ï¼ˆé€šå¸¸å…¶åªæœ‰ä¸€ä¸ªå­æ ‘æˆ–è€…æ²¡æœ‰å­æ ‘ï¼‰åï¼Œå°†ä¼šæ£€æŸ¥æ˜¯å¦è¦è¿›è¡Œè°ƒè‰²å’Œæ—‹è½¬ä½¿å¾—èŠ‚ç‚¹åˆ é™¤åçš„RB Treeå†æ¬¡ç¬¦åˆè§„åˆ™ã€‚æˆ‘ä»¬åœ¨ä¸‹é¢é€šè¿‡5ç§å¤§çš„æƒ…å†µæ¥è®²è§£è¿™ä¸€æ“ä½œã€‚<br />(1) æœ€ç®€å•çš„æƒ…å†µæ˜¯ï¼šæˆ‘ä»¬åˆ é™¤çš„èŠ‚ç‚¹é¢œè‰²æ˜¯çº¢è‰²çš„ï¼Œè¿™æ„å‘³ç€èŠ‚ç‚¹åˆ é™¤åï¼Œå­æ ‘è¿æ¥åˆ°å…¶çˆ¶èŠ‚ç‚¹åé»‘è‰²èŠ‚ç‚¹é«˜åº¦ä¸å˜ï¼Œå› æ­¤æ— éœ€è°ƒæ•´ï¼Œè¿™ç‚¹å¯ä»¥åœ¨<code>rb_erase</code>å‡½æ•°çš„æœ€åå°è¯ï¼Œå› ä¸ºåªæœ‰åˆ é™¤èŠ‚ç‚¹ä¸ºé»‘è‰²æ‰éœ€è¦æ‰§è¡Œ<code>__rb_erase_color</code>å‡½æ•°ã€‚</p><p>(2) ç¨å¾®å¤æ‚çš„ä¸€ç§æƒ…å†µæ˜¯ï¼šæˆ‘ä»¬åˆ é™¤çš„èŠ‚ç‚¹Bé¢œè‰²æ˜¯é»‘è‰²ï¼ŒåŒæ—¶å…¶çˆ¶èŠ‚ç‚¹çš„å¦ä¸€ä¸ªå­©å­èŠ‚ç‚¹Cé¢œè‰²ä¹Ÿæ˜¯é»‘è‰²ä¸”å…¶å·¦å³å­©å­èŠ‚ç‚¹E&#x2F;Fä¹Ÿä¸ºé»‘è‰²ã€‚ç”±äºçˆ¶èŠ‚ç‚¹Açš„ä¸€è¾¹å°‘äº†ä¸€ä¸ªé»‘è‰²èŠ‚ç‚¹ï¼Œæ‰€ä»¥åº”è¯¥æŠŠå¦ä¸€è¾¹çš„é»‘è‰²èŠ‚ç‚¹æŸ“æˆçº¢è‰²ï¼Œè¿™æ ·çˆ¶èŠ‚ç‚¹Açš„å·¦å³é»‘è‰²èŠ‚ç‚¹é«˜åº¦ç›¸åŒï¼Œè€Œä¸”Cå’ŒE&#x2F;FèŠ‚ç‚¹é¢œè‰²ä¸å†²çªã€‚å¯¹äºçˆ¶èŠ‚ç‚¹Aï¼Œå¦‚æœå…¶ä¸ºçº¢è‰²ï¼Œé‚£æ­£å¥½ï¼Œå°†å…¶æŸ“è‰²ä¸ºé»‘è‰²ï¼Œè¿™æ ·ä»¥Aä¸ºæ ¹çš„å­æ ‘é«˜åº¦åˆæ¢å¤åŸæ ·ï¼Œä¸”é¢œè‰²ä¹Ÿä¸ä¼šå†²çªï¼›å¦‚æœAä¸ºé»‘è‰²ï¼Œé‚£ä¹ˆå°±è¦ç»§ç»­å‘ä¸Šæ£€æŸ¥è°ƒæ•´ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> __rb_erase_color(<span class="hljs-keyword">struct</span> rb_node *node, <span class="hljs-keyword">struct</span> rb_node *parent,<br>                 <span class="hljs-keyword">struct</span> rb_root *root)<br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rb_node</span> *<span class="hljs-title">other</span>;</span><br><br>    <span class="hljs-keyword">while</span> ((!node || node-&gt;rb_color == RB_BLACK) &amp;&amp; node != root-&gt;rb_node)<br>    &#123;<br>        <span class="hljs-keyword">if</span> (parent-&gt;rb_left == node)<br>        &#123;<br>            other = parent-&gt;rb_right;<br>            <span class="hljs-keyword">if</span> (other-&gt;rb_color == RB_RED)<br>            &#123;<br>                ...<br>            &#125;<br>            <span class="hljs-keyword">if</span> ((!other-&gt;rb_left ||<br>                 other-&gt;rb_left-&gt;rb_color == RB_BLACK)<br>                &amp;&amp; (!other-&gt;rb_right ||<br>                other-&gt;rb_right-&gt;rb_color == RB_BLACK))<br>            &#123;<br>                other-&gt;rb_color = RB_RED;<br>                node = parent;<br>                parent = node-&gt;rb_parent;<br>            &#125;<br>            <span class="hljs-keyword">else</span><br>            &#123;<br>                ...<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">else</span><br>        &#123;<br>            other = parent-&gt;rb_left;<br>            <span class="hljs-keyword">if</span> (other-&gt;rb_color == RB_RED)<br>            &#123;<br>                ...<br>            &#125;<br>            <span class="hljs-keyword">if</span> ((!other-&gt;rb_left ||<br>                 other-&gt;rb_left-&gt;rb_color == RB_BLACK)<br>                &amp;&amp; (!other-&gt;rb_right ||<br>                other-&gt;rb_right-&gt;rb_color == RB_BLACK))<br>            &#123;<br>                other-&gt;rb_color = RB_RED;<br>                node = parent;<br>                parent = node-&gt;rb_parent;<br>            &#125;<br>            <span class="hljs-keyword">else</span><br>            &#123;<br>                ...<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (node)<br>        node-&gt;rb_color = RB_BLACK;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸‹é¢ä»¥åˆ é™¤èŠ‚ç‚¹ä¸ºå·¦å­æ ‘ä¸ºä¾‹å±•ç¤ºäº†è°ƒè‰²è¿‡ç¨‹ï¼š<br /></p><p><img src="https://raw.githubusercontent.com/mengchao666/picture/main/blog1949124-20240331170002381-854800943.png"></p><p>(3) æˆ‘ä»¬åˆ é™¤çš„èŠ‚ç‚¹Bé¢œè‰²æ˜¯é»‘è‰²çš„ï¼ŒåŒæ—¶å…¶çˆ¶èŠ‚ç‚¹Açš„å¦ä¸€ä¸ªå­©å­èŠ‚ç‚¹Cé¢œè‰²æ˜¯é»‘è‰²çš„ï¼Œè€ŒCå·¦å­©å­èŠ‚ç‚¹Eä¸ºé»‘è‰²ï¼Œå³å­©å­èŠ‚ç‚¹Fä¸ºçº¢è‰²ã€‚å¯¹äºè¿™ç§æƒ…å†µï¼Œå¯ä»¥å°†çˆ¶èŠ‚ç‚¹æŸ“è‰²æˆé»‘è‰²å·¦æ—‹&#x2F;å³æ—‹ä½¿å¾—åˆ é™¤èŠ‚ç‚¹ä¸€ä¾§å¢åŠ ä¸€ä¸ªé»‘è‰²èŠ‚ç‚¹ï¼Œå¯¹äºå¦ä¸€è¾¹ï¼Œå› ä¸ºCå› ä¸ºæ—‹è½¬å˜æˆäº†å­æ ‘æ ¹èŠ‚ç‚¹ï¼Œæ‰€ä»¥å…¶åº”è¯¥ç»§æ‰¿åŸå…ˆå­æ ‘æ ¹èŠ‚ç‚¹é¢œè‰²ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œç”±äºCä¸å†æ˜¯å­æ ‘èŠ‚ç‚¹ï¼Œæ‰€ä»¥å°‘äº†ä¸€ä¸ªé»‘è‰²èŠ‚ç‚¹ï¼Œæ‰€ä»¥è¦æŠŠFæŸ“æˆé»‘è‰²ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> __rb_erase_color(<span class="hljs-keyword">struct</span> rb_node *node, <span class="hljs-keyword">struct</span> rb_node *parent,<br>                 <span class="hljs-keyword">struct</span> rb_root *root)<br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rb_node</span> *<span class="hljs-title">other</span>;</span><br><br>    <span class="hljs-keyword">while</span> ((!node || node-&gt;rb_color == RB_BLACK) &amp;&amp; node != root-&gt;rb_node)<br>    &#123;<br>        <span class="hljs-keyword">if</span> (parent-&gt;rb_left == node)<br>        &#123;<br>            other = parent-&gt;rb_right;<br>            <span class="hljs-keyword">if</span> (other-&gt;rb_color == RB_RED)<br>            &#123;<br>                ...<br>            &#125;<br>            <span class="hljs-keyword">if</span> ((!other-&gt;rb_left ||<br>                 other-&gt;rb_left-&gt;rb_color == RB_BLACK)<br>                &amp;&amp; (!other-&gt;rb_right ||<br>                other-&gt;rb_right-&gt;rb_color == RB_BLACK))<br>            &#123;<br>                ...<br>            &#125;<br>            <span class="hljs-keyword">else</span><br>            &#123;<br>                <span class="hljs-keyword">if</span> (!other-&gt;rb_right ||<br>                    other-&gt;rb_right-&gt;rb_color == RB_BLACK)<br>                &#123;<br>                    ...<br>                &#125;<br>                other-&gt;rb_color = parent-&gt;rb_color;<br>                parent-&gt;rb_color = RB_BLACK;<br>                <span class="hljs-keyword">if</span> (other-&gt;rb_right)<br>                    other-&gt;rb_right-&gt;rb_color = RB_BLACK;<br>                __rb_rotate_left(parent, root);<br>                node = root-&gt;rb_node;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">else</span><br>        &#123;<br>            other = parent-&gt;rb_left;<br>            <span class="hljs-keyword">if</span> (other-&gt;rb_color == RB_RED)<br>            &#123;<br>                ...<br>            &#125;<br>            <span class="hljs-keyword">if</span> ((!other-&gt;rb_left ||<br>                 other-&gt;rb_left-&gt;rb_color == RB_BLACK)<br>                &amp;&amp; (!other-&gt;rb_right ||<br>                other-&gt;rb_right-&gt;rb_color == RB_BLACK))<br>            &#123;<br>                ...<br>            &#125;<br>            <span class="hljs-keyword">else</span><br>            &#123;<br>                <span class="hljs-keyword">if</span> (!other-&gt;rb_left ||<br>                    other-&gt;rb_left-&gt;rb_color == RB_BLACK)<br>                &#123;<br>                    ...<br>                &#125;<br>                other-&gt;rb_color = parent-&gt;rb_color;<br>                parent-&gt;rb_color = RB_BLACK;<br>                <span class="hljs-keyword">if</span> (other-&gt;rb_left)<br>                    other-&gt;rb_left-&gt;rb_color = RB_BLACK;<br>                __rb_rotate_right(parent, root);<br>                node = root-&gt;rb_node;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (node)<br>        node-&gt;rb_color = RB_BLACK;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸‹é¢ä»¥åˆ é™¤èŠ‚ç‚¹ä¸ºå·¦å­æ ‘ä¸ºä¾‹å±•ç¤ºäº†è°ƒè‰²è¿‡ç¨‹ï¼š<br /></p><p><img src="https://raw.githubusercontent.com/mengchao666/picture/main/blog1949124-20240331170232219-236724999.png"></p><p>(4) æˆ‘ä»¬åˆ é™¤çš„èŠ‚ç‚¹Bé¢œè‰²æ˜¯é»‘è‰²çš„ï¼ŒåŒæ—¶å…¶çˆ¶èŠ‚ç‚¹Açš„å¦ä¸€ä¸ªå­©å­èŠ‚ç‚¹Cé¢œè‰²æ˜¯é»‘è‰²çš„ï¼Œè€ŒCå·¦å­©å­èŠ‚ç‚¹Eä¸ºçº¢è‰²ï¼Œå³å­©å­èŠ‚ç‚¹Fä¸ºé»‘è‰²ã€‚å¯¹äºè¿™ç§æƒ…å†µï¼Œåº”è¯¥å…ˆç»è¿‡æŸ“è‰²å’Œæ—‹è½¬å°†å…¶å˜ä¸ºæƒ…å†µ(3)ã€‚å…¶è¿‡ç¨‹ä¸ºå°†CæŸ“æˆçº¢è‰²å³æ—‹ï¼Œè¿™æ ·CåŸå…ˆè¿™é¢—å­æ ‘å·¦å³å­æ ‘é»‘è‰²èŠ‚ç‚¹é«˜åº¦ä¸å˜ï¼Œåªæ˜¯Cå’ŒEé¢œè‰²å†²çªï¼Œä¸è¿‡è¿™ä¸ç”¨æ‹…å¿ƒï¼ŒæŒ‰ç…§(3)çš„æ–¹æ³•ï¼ŒCæœ€åå˜æˆé»‘è‰²ï¼Œè€ŒEå˜æˆäº†åŸå…ˆAçš„é¢œè‰²ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><code class="hljs cstatic">                 struct rb_root *root)<br>&#123;<br>    struct rb_node *other;<br><br>    while ((!node || node-&gt;rb_color == RB_BLACK) &amp;&amp; node != root-&gt;rb_node)<br>    &#123;<br>        if (parent-&gt;rb_left == node)<br>        &#123;<br>            other = parent-&gt;rb_right;<br>            if (other-&gt;rb_color == RB_RED)<br>            &#123;<br>                ...<br>            &#125;<br>            if ((!other-&gt;rb_left ||<br>                 other-&gt;rb_left-&gt;rb_color == RB_BLACK)<br>                &amp;&amp; (!other-&gt;rb_right ||<br>                other-&gt;rb_right-&gt;rb_color == RB_BLACK))<br>            &#123;<br>                ...<br>            &#125;<br>            else<br>            &#123;<br>                if (!other-&gt;rb_right ||<br>                    other-&gt;rb_right-&gt;rb_color == RB_BLACK)<br>                &#123;<br>                    register struct rb_node *o_left;<br>                    if ((o_left = other-&gt;rb_left))<br>                        o_left-&gt;rb_color = RB_BLACK;<br>                    other-&gt;rb_color = RB_RED;<br>                    __rb_rotate_right(other, root);<br>                    other = parent-&gt;rb_right;<br>                &#125;<br>                other-&gt;rb_color = parent-&gt;rb_color;<br>                parent-&gt;rb_color = RB_BLACK;<br>                if (other-&gt;rb_right)<br>                    other-&gt;rb_right-&gt;rb_color = RB_BLACK;<br>                __rb_rotate_left(parent, root);<br>                node = root-&gt;rb_node;<br>                break;<br>            &#125;<br>        &#125;<br>        else<br>        &#123;<br>            other = parent-&gt;rb_left;<br>            if (other-&gt;rb_color == RB_RED)<br>            &#123;<br>                ...<br>            &#125;<br>            if ((!other-&gt;rb_left ||<br>                 other-&gt;rb_left-&gt;rb_color == RB_BLACK)<br>                &amp;&amp; (!other-&gt;rb_right ||<br>                other-&gt;rb_right-&gt;rb_color == RB_BLACK))<br>            &#123;<br>                ...<br>            &#125;<br>            else<br>            &#123;<br>                if (!other-&gt;rb_left ||<br>                    other-&gt;rb_left-&gt;rb_color == RB_BLACK)<br>                &#123;<br>                    register struct rb_node *o_right;<br>                    if ((o_right = other-&gt;rb_right))<br>                        o_right-&gt;rb_color = RB_BLACK;<br>                    other-&gt;rb_color = RB_RED;<br>                    __rb_rotate_left(other, root);<br>                    other = parent-&gt;rb_left;<br>                &#125;<br>                other-&gt;rb_color = parent-&gt;rb_color;<br>                parent-&gt;rb_color = RB_BLACK;<br>                if (other-&gt;rb_left)<br>                    other-&gt;rb_left-&gt;rb_color = RB_BLACK;<br>                __rb_rotate_right(parent, root);<br>                node = root-&gt;rb_node;<br>                break;<br>            &#125;<br>        &#125;<br>    &#125;<br>    if (node)<br>        node-&gt;rb_color = RB_BLACK;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸‹é¢ä»¥åˆ é™¤èŠ‚ç‚¹ä¸ºå·¦å­æ ‘ä¸ºä¾‹å±•ç¤ºäº†è°ƒè‰²è¿‡ç¨‹ï¼š<br /></p><p><img src="https://raw.githubusercontent.com/mengchao666/picture/main/blog1949124-20240331172122810-1623435620.png"></p><p>(5) æˆ‘ä»¬åˆ é™¤çš„èŠ‚ç‚¹Bé¢œè‰²æ˜¯é»‘è‰²çš„ï¼ŒåŒæ—¶å…¶çˆ¶èŠ‚ç‚¹Açš„å¦ä¸€ä¸ªå­©å­èŠ‚ç‚¹Cé¢œè‰²æ˜¯çº¢è‰²çš„ã€‚å¯¹äºè¿™ç§æƒ…å†µï¼Œæ„å‘³ç€çˆ¶èŠ‚ç‚¹Aå¿…å®šä¸ºé»‘è‰²çš„ï¼Œè€ŒCçš„E&#x2F;Få­©å­èŠ‚ç‚¹ä¸ºé»‘è‰²çš„ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥é€šè¿‡å°†AæŸ“æˆçº¢è‰²å·¦æ—‹&#x2F;å³æ—‹ï¼Œç„¶åCæŸ“æˆé»‘è‰²ï¼Œè¿™æ ·ï¼Œè¿™é¢—å­æ ‘é»‘è‰²èŠ‚ç‚¹é«˜åº¦ä¸å˜ï¼ŒåŒæ—¶åˆ é™¤èŠ‚ç‚¹ä¸€ä¾§çš„å­æ ‘å˜æˆäº†(3)æˆ–è€…(4)çš„æƒ…å†µï¼Œå› ä¸ºç»è¿‡æ—‹è½¬ï¼ŒAçš„å³èŠ‚ç‚¹å˜æˆäº†é»‘è‰²ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs cstatic">                 struct rb_root *root)<br>&#123;<br>    struct rb_node *other;<br><br>    while ((!node || node-&gt;rb_color == RB_BLACK) &amp;&amp; node != root-&gt;rb_node)<br>    &#123;<br>        if (parent-&gt;rb_left == node)<br>        &#123;<br>            other = parent-&gt;rb_right;<br>            if (other-&gt;rb_color == RB_RED)<br>            &#123;<br>                other-&gt;rb_color = RB_BLACK;<br>                parent-&gt;rb_color = RB_RED;<br>                __rb_rotate_left(parent, root);<br>                other = parent-&gt;rb_right;<br>            &#125;<br>            ...<br>        &#125;<br>        else<br>        &#123;<br>            other = parent-&gt;rb_left;<br>            if (other-&gt;rb_color == RB_RED)<br>            &#123;<br>                other-&gt;rb_color = RB_BLACK;<br>                parent-&gt;rb_color = RB_RED;<br>                __rb_rotate_right(parent, root);<br>                other = parent-&gt;rb_left;<br>            &#125;<br>            ...<br>        &#125;<br>    &#125;<br>    if (node)<br>        node-&gt;rb_color = RB_BLACK;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸‹é¢ä»¥åˆ é™¤èŠ‚ç‚¹ä¸ºå·¦å­æ ‘ä¸ºä¾‹å±•ç¤ºäº†è°ƒè‰²è¿‡ç¨‹ï¼š<br /></p><p><img src="https://raw.githubusercontent.com/mengchao666/picture/main/blog1949124-20240331170407070-1560007634.png"></p><h4 id="2-3-çº¢é»‘æ ‘çš„æŸ¥è¯¢æ“ä½œ"><a href="#2-3-çº¢é»‘æ ‘çš„æŸ¥è¯¢æ“ä½œ" class="headerlink" title="2.3 çº¢é»‘æ ‘çš„æŸ¥è¯¢æ“ä½œ"></a>2.3 çº¢é»‘æ ‘çš„æŸ¥è¯¢æ“ä½œ</h4><p>Linuxå†…æ ¸ä¸­çº¢é»‘æ ‘åº“æä¾›çš„åŠŸèƒ½æ²¡æœ‰ç‰¹å®šæŸä¸€ç§æ’åºæ–¹æ³•ï¼Œæ‰€ä»¥ä¹Ÿæ²¡æœ‰ç»™å‡ºæŸ¥è¯¢æ¥å£ã€‚ç”±äºçº¢é»‘æ ‘ä¹Ÿæ˜¯äºŒå‰æ’åºæ ‘çš„ä¸€ç§ï¼Œä»¥å‡åºä¸ºä¾‹ï¼Œæˆ‘ä»¬åªéœ€è¦æŒ‰ç…§ä»¥ä¸‹æµç¨‹å³å¯è¿›è¡ŒæŸ¥è¯¢æ“ä½œï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python">Query x:<br><br>node = root<br><span class="hljs-keyword">while</span> node <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> null <span class="hljs-keyword">and</span> node.value != x:<br>    <span class="hljs-keyword">if</span> node.value &lt; xï¼š<br>        node = node.right<br>    <span class="hljs-keyword">else</span>:<br>        node = node.left<br><br>Return node<br></code></pre></td></tr></table></figure><h3 id="3-çº¢é»‘æ ‘æ“ä½œå®éªŒ"><a href="#3-çº¢é»‘æ ‘æ“ä½œå®éªŒ" class="headerlink" title="3. çº¢é»‘æ ‘æ“ä½œå®éªŒ"></a>3. çº¢é»‘æ ‘æ“ä½œå®éªŒ</h3><blockquote><p>å®éªŒä»‹ç»ï¼šæœ‰ä¸€ç§å¯¹è±¡Itemï¼Œé‡Œé¢åŒ…å«ï¼š1ï¼‰æ ‘èŠ‚ç‚¹ï¼Œç”¨äºç®¡ç†RB Treeï¼›2ï¼‰æ•°å€¼ï¼Œè¡¨ç¤ºäº†å¯¹è±¡çš„å®é™…å†…å®¹ï¼›3ï¼‰å‡ºç°æ¬¡æ•°ï¼Œç”±äºæˆ‘ä»¬å¸Œæœ›èŠ‚ç‚¹éšæœºäº§ç”Ÿï¼Œå› æ­¤å¯èƒ½å­˜åœ¨é‡å¤çš„æƒ…å†µï¼Œè¯¥å€¼ç”¨äºç»Ÿè®¡ç›¸åŒèŠ‚ç‚¹çš„æ•°é‡ã€‚æˆ‘ä»¬å…ˆéšæœºnumä¸ªItemï¼Œç„¶åä½¿ç”¨è¿™äº›Itemæ„å»ºå‡ºçº¢é»‘æ ‘ã€‚æœ€åé€šè¿‡è¾“å…¥è¦æ“¦é™¤çš„å¯¹è±¡ï¼Œæˆ‘ä»¬å°†å…¶ä»æ ‘ä¸­åˆ é™¤å¹¶æ˜¾ç¤ºã€‚</p></blockquote><p>ä¸‹å›¾æ—¶ä»£ç è¿è¡Œåçš„æ•ˆæœï¼Œæ¯ä¸ªèŠ‚ç‚¹æ‰“å°å«ä¹‰ä¸º<code>[æ•°å€¼ï¼Œå‡ºç°æ¬¡æ•°ï¼ŒèŠ‚ç‚¹é¢œè‰²]</code>ï¼Œæœ€å·¦è¾¹ä¸ºæ ¹èŠ‚ç‚¹ï¼Œå·¦èŠ‚ç‚¹åœ¨å³èŠ‚ç‚¹ä¸Šæ–¹ã€‚<br /></p><p><img src="https://raw.githubusercontent.com/mengchao666/picture/main/blog1949124-20240331141025628-1498122160.png"></p><h3 id="é™„å½•A-å®éªŒä»£ç "><a href="#é™„å½•A-å®éªŒä»£ç " class="headerlink" title="é™„å½•A: å®éªŒä»£ç "></a>é™„å½•A: å®éªŒä»£ç </h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br></pre></td><td class="code"><pre><code class="hljs c">main.c :<br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;time.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;rbtree.h&quot;</span></span><br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">Item</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">int</span> val;<br>    <span class="hljs-type">int</span> num; <span class="hljs-comment">// appear num</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rb_node</span> <span class="hljs-title">node</span>;</span><br>&#125;Item;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> print_num = <span class="hljs-number">0</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">int</span> print_level = <span class="hljs-number">0</span>;<br><br>Item* <span class="hljs-title function_">GenerateItem</span><span class="hljs-params">()</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">DFS</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> rb_node *node)</span>;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-type">int</span> num = <span class="hljs-number">0</span>;<br>    Item *item, *cur, *prev = <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rb_node</span> **<span class="hljs-title">link</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rb_root</span> <span class="hljs-title">root</span> =</span> RB_ROOT;<br>  <br>    srand(time(<span class="hljs-literal">NULL</span>));<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Test item num: &quot;</span>);<br>    <span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d&quot;</span>, &amp;num);<br>  <br>    print_num = <span class="hljs-number">0</span>;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Generate Item[%d]:\n&quot;</span>, num);<br>    <span class="hljs-comment">/* generate a random rb tree with [num] node */</span><br>    <span class="hljs-keyword">while</span> (num &gt; <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-comment">/* randomize a rb tree node */</span><br>        item = GenerateItem();<br>        <span class="hljs-keyword">if</span> (print_num == <span class="hljs-number">16</span>)<br>        &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\n&quot;</span>);<br>            print_num = <span class="hljs-number">0</span>;<br>        &#125;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d\t&quot;</span>, item-&gt;val);<br><br>        <span class="hljs-comment">/* insert a rb tree node to rb tree */</span><br>        <span class="hljs-keyword">if</span> (!root.rb_node) <span class="hljs-comment">// empty rb tree</span><br>        &#123;<br>            root.rb_node = &amp;(item-&gt;node);<br>            rb_insert_color(&amp;(item-&gt;node), &amp;root);<br>            <span class="hljs-keyword">goto</span> next_loop;<br>        &#125;<br>        cur = rb_entry(root.rb_node, Item, node);<br>        <span class="hljs-comment">/* 1. find insert position */</span><br>        <span class="hljs-keyword">while</span> (cur)<br>        &#123;<br>            <span class="hljs-keyword">if</span> (cur-&gt;val == item-&gt;val) <span class="hljs-comment">// the same item</span><br>            &#123;<br>                cur-&gt;num++;<br>                <span class="hljs-built_in">free</span>(item);<br>                <span class="hljs-keyword">goto</span> next_loop;<br>            &#125;<br>            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (cur-&gt;val &gt; item-&gt;val)<br>            &#123;<br>                prev = cur;<br>                link = &amp;(cur-&gt;node.rb_left);<br>                <span class="hljs-keyword">if</span> (cur-&gt;node.rb_left == <span class="hljs-literal">NULL</span>)<br>                &#123;<br>                    <span class="hljs-keyword">break</span>;<br>                &#125;<br>                cur = rb_entry(cur-&gt;node.rb_left, Item, node);<br>            &#125;<br>            <span class="hljs-keyword">else</span><br>            &#123;<br>                prev = cur;<br>                link = &amp;(cur-&gt;node.rb_right);<br>                <span class="hljs-keyword">if</span> (cur-&gt;node.rb_right == <span class="hljs-literal">NULL</span>)<br>                &#123;<br>                    <span class="hljs-keyword">break</span>;<br>                &#125;<br>                cur = rb_entry(cur-&gt;node.rb_right, Item, node);<br>            &#125;<br>        &#125;<br>        <span class="hljs-comment">/* 2. link node */</span><br>        rb_link_node(&amp;(item-&gt;node), &amp;(prev-&gt;node), link);<br>        <span class="hljs-comment">/* 3. adjust */</span><br>        rb_insert_color(&amp;(item-&gt;node), &amp;root);<br>next_loop:<br>        num--;<br>    &#125;<br>  <br>    <span class="hljs-comment">/* print a generated rb tree */</span><br>    print_num = <span class="hljs-number">0</span>;<br>    print_level = <span class="hljs-number">0</span>;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\nsort result:\n&quot;</span>);<br>    DFS(root.rb_node);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\n&quot;</span>);<br><br>    <span class="hljs-comment">/* testing erase some rb tree node */</span><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\nTest Erase, input node value to erase its node, or input negative value to exit\n&quot;</span>);<br>    <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>)<br>    &#123;<br>        <span class="hljs-comment">/* get the node need to erase */</span><br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;&gt;&gt;&quot;</span>);<br>        <span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d&quot;</span>, &amp;num);<br>        <span class="hljs-keyword">if</span> (num &lt; <span class="hljs-number">0</span>)<br>        &#123;<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>        <span class="hljs-comment">/* 1. find insert position */</span><br>        <span class="hljs-keyword">if</span> (!root.rb_node) <span class="hljs-comment">// empty rb tree</span><br>        &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;empty tree\n&quot;</span>);<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>        cur = rb_entry(root.rb_node, Item, node);<br>        <span class="hljs-keyword">while</span> (cur)<br>        &#123;<br>            <span class="hljs-keyword">if</span> (cur-&gt;val == num) <span class="hljs-comment">// the same item</span><br>            &#123;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (cur-&gt;val &gt; num)<br>            &#123;<br>                <span class="hljs-keyword">if</span> (cur-&gt;node.rb_left == <span class="hljs-literal">NULL</span>)<br>                &#123;<br>                    cur = <span class="hljs-literal">NULL</span>;<br>                    <span class="hljs-keyword">break</span>;<br>                &#125;<br>                cur = rb_entry(cur-&gt;node.rb_left, Item, node);<br>            &#125;<br>            <span class="hljs-keyword">else</span><br>            &#123;<br>                <span class="hljs-keyword">if</span> (cur-&gt;node.rb_right == <span class="hljs-literal">NULL</span>)<br>                &#123;<br>                    cur = <span class="hljs-literal">NULL</span>;<br>                    <span class="hljs-keyword">break</span>;<br>                &#125;<br>                cur = rb_entry(cur-&gt;node.rb_right, Item, node);<br>            &#125;<br>        &#125;<br>        <span class="hljs-comment">/* 2. do erase function */</span><br>        <span class="hljs-keyword">if</span> (cur)<br>        &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;erase %d\n&quot;</span>, num);<br>            rb_erase(&amp;(cur-&gt;node), &amp;root);<br>            <span class="hljs-built_in">free</span>(cur);<br>            DFS(root.rb_node);<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\n&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">else</span><br>        &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;not exist\n&quot;</span>);<br>        &#125;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;===================================================================\n&quot;</span>);<br>    &#125;<br>  <br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br>Item* <span class="hljs-title function_">GenerateItem</span><span class="hljs-params">()</span><br>&#123;<br>    Item *item = (Item*)<span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(Item));<br>  <br>    item-&gt;val = rand() % <span class="hljs-number">1000</span>;<br>    item-&gt;num = <span class="hljs-number">1</span>;<br>  <br>    item-&gt;node.rb_parent = <span class="hljs-literal">NULL</span>;<br>    item-&gt;node.rb_left = <span class="hljs-literal">NULL</span>;<br>    item-&gt;node.rb_right = <span class="hljs-literal">NULL</span>;<br>  <br>    <span class="hljs-keyword">return</span> item;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">DFS</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> rb_node *node)</span><br>&#123;<br>    Item *item;<br>    <span class="hljs-type">int</span> i;<br>  <br>    <span class="hljs-keyword">if</span> (node)<br>    &#123;<br>        print_level++;<br>        DFS(node-&gt;rb_left);<br>        <span class="hljs-keyword">if</span> (print_num == <span class="hljs-number">4</span>)<br>        &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\n&quot;</span>);<br>            print_num = <span class="hljs-number">0</span>;<br>        &#125;<br>        item = rb_entry(node, Item, node);<br>        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">1</span>; i &lt; print_level; i++)<br>        &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;            &quot;</span>);<br>        &#125;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[%3d,%3d,%c]\n&quot;</span>, item-&gt;val, item-&gt;num, (item-&gt;node.rb_color == RB_RED) ? <span class="hljs-string">&#x27;R&#x27;</span> : <span class="hljs-string">&#x27;B&#x27;</span>);<br>        print_num++;<br>        DFS(node-&gt;rb_right);<br>        print_level--;<br>    &#125;<br>&#125;<br><br>rbtree.h :<br><span class="hljs-comment">/*</span><br><span class="hljs-comment">  Red Black Trees</span><br><span class="hljs-comment">  (C) 1999  Andrea Arcangeli &lt;andrea@suse.de&gt;</span><br><span class="hljs-comment">  </span><br><span class="hljs-comment">  This program is free software; you can redistribute it and/or modify</span><br><span class="hljs-comment">  it under the terms of the GNU General Public License as published by</span><br><span class="hljs-comment">  the Free Software Foundation; either version 2 of the License, or</span><br><span class="hljs-comment">  (at your option) any later version.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">  This program is distributed in the hope that it will be useful,</span><br><span class="hljs-comment">  but WITHOUT ANY WARRANTY; without even the implied warranty of</span><br><span class="hljs-comment">  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span><br><span class="hljs-comment">  GNU General Public License for more details.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">  You should have received a copy of the GNU General Public License</span><br><span class="hljs-comment">  along with this program; if not, write to the Free Software</span><br><span class="hljs-comment">  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">  linux/include/linux/rbtree.h</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">  To use rbtrees you&#x27;ll have to implement your own insert and search cores.</span><br><span class="hljs-comment">  This will avoid us to use callbacks and to drop drammatically performances.</span><br><span class="hljs-comment">  I know it&#x27;s not the cleaner way,  but in C (not in C++) to get</span><br><span class="hljs-comment">  performances and genericity...</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">  Some example of insert and search follows here. The search is a plain</span><br><span class="hljs-comment">  normal search over an ordered tree. The insert instead must be implemented</span><br><span class="hljs-comment">  int two steps: as first thing the code must insert the element in</span><br><span class="hljs-comment">  order as a red leaf in the tree, then the support library function</span><br><span class="hljs-comment">  rb_insert_color() must be called. Such function will do the</span><br><span class="hljs-comment">  not trivial work to rebalance the rbtree if necessary.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">-----------------------------------------------------------------------</span><br><span class="hljs-comment">static inline struct page * rb_search_page_cache(struct inode * inode,</span><br><span class="hljs-comment">                         unsigned long offset)</span><br><span class="hljs-comment">&#123;</span><br><span class="hljs-comment">    struct rb_node * n = inode-&gt;i_rb_page_cache.rb_node;</span><br><span class="hljs-comment">    struct page * page;</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    while (n)</span><br><span class="hljs-comment">    &#123;</span><br><span class="hljs-comment">        page = rb_entry(n, struct page, rb_page_cache);</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">        if (offset &lt; page-&gt;offset)</span><br><span class="hljs-comment">            n = n-&gt;rb_left;</span><br><span class="hljs-comment">        else if (offset &gt; page-&gt;offset)</span><br><span class="hljs-comment">            n = n-&gt;rb_right;</span><br><span class="hljs-comment">        else</span><br><span class="hljs-comment">            return page;</span><br><span class="hljs-comment">    &#125;</span><br><span class="hljs-comment">    return NULL;</span><br><span class="hljs-comment">&#125;</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">static inline struct page * __rb_insert_page_cache(struct inode * inode,</span><br><span class="hljs-comment">                           unsigned long offset,</span><br><span class="hljs-comment">                           struct rb_node * node)</span><br><span class="hljs-comment">&#123;</span><br><span class="hljs-comment">    struct rb_node ** p = &amp;inode-&gt;i_rb_page_cache.rb_node;</span><br><span class="hljs-comment">    struct rb_node * parent = NULL;</span><br><span class="hljs-comment">    struct page * page;</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    while (*p)</span><br><span class="hljs-comment">    &#123;</span><br><span class="hljs-comment">        parent = *p;</span><br><span class="hljs-comment">        page = rb_entry(parent, struct page, rb_page_cache);</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">        if (offset &lt; page-&gt;offset)</span><br><span class="hljs-comment">            p = &amp;(*p)-&gt;rb_left;</span><br><span class="hljs-comment">        else if (offset &gt; page-&gt;offset)</span><br><span class="hljs-comment">            p = &amp;(*p)-&gt;rb_right;</span><br><span class="hljs-comment">        else</span><br><span class="hljs-comment">            return page;</span><br><span class="hljs-comment">    &#125;</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    rb_link_node(node, parent, p);</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    return NULL;</span><br><span class="hljs-comment">&#125;</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">static inline struct page * rb_insert_page_cache(struct inode * inode,</span><br><span class="hljs-comment">                         unsigned long offset,</span><br><span class="hljs-comment">                         struct rb_node * node)</span><br><span class="hljs-comment">&#123;</span><br><span class="hljs-comment">    struct page * ret;</span><br><span class="hljs-comment">    if ((ret = __rb_insert_page_cache(inode, offset, node)))</span><br><span class="hljs-comment">        goto out;</span><br><span class="hljs-comment">    rb_insert_color(node, &amp;inode-&gt;i_rb_page_cache);</span><br><span class="hljs-comment"> out:</span><br><span class="hljs-comment">    return ret;</span><br><span class="hljs-comment">&#125;</span><br><span class="hljs-comment">-----------------------------------------------------------------------</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span>    _LINUX_RBTREE_H</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span>    _LINUX_RBTREE_H</span><br><br><span class="hljs-comment">// #include &lt;linux/kernel.h&gt;</span><br><span class="hljs-comment">// #include &lt;linux/stddef.h&gt;</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> offsetof(TYPE, MEMBER) ((size_t) &amp;((TYPE*)0)-&gt;MEMBER)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> container_of(ptr, type, member) (&#123;            \</span><br><span class="hljs-meta">        const typeof( ((type *)0)-&gt;member ) *__mptr = (ptr);    \</span><br><span class="hljs-meta">        (type *)( (char *)__mptr - offsetof(type,member) );&#125;)</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rb_node</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rb_node</span> *<span class="hljs-title">rb_parent</span>;</span><br>    <span class="hljs-type">int</span> rb_color;<br><span class="hljs-meta">#<span class="hljs-keyword">define</span>    RB_RED        0</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span>    RB_BLACK    1</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rb_node</span> *<span class="hljs-title">rb_right</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rb_node</span> *<span class="hljs-title">rb_left</span>;</span><br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rb_root</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rb_node</span> *<span class="hljs-title">rb_node</span>;</span><br>&#125;;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> RB_ROOT    (struct rb_root) &#123; NULL, &#125;</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span>    rb_entry(ptr, type, member) container_of(ptr, type, member)</span><br><br><span class="hljs-keyword">extern</span> <span class="hljs-type">void</span> <span class="hljs-title function_">rb_insert_color</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> rb_node *, <span class="hljs-keyword">struct</span> rb_root *)</span>;<br><span class="hljs-keyword">extern</span> <span class="hljs-type">void</span> <span class="hljs-title function_">rb_erase</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> rb_node *, <span class="hljs-keyword">struct</span> rb_root *)</span>;<br><br><span class="hljs-comment">/* Find logical next and previous nodes in a tree */</span><br><span class="hljs-keyword">extern</span> <span class="hljs-keyword">struct</span> rb_node *<span class="hljs-title function_">rb_next</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> rb_node *)</span>;<br><span class="hljs-keyword">extern</span> <span class="hljs-keyword">struct</span> rb_node *<span class="hljs-title function_">rb_prev</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> rb_node *)</span>;<br><span class="hljs-keyword">extern</span> <span class="hljs-keyword">struct</span> rb_node *<span class="hljs-title function_">rb_first</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> rb_root *)</span>;<br><span class="hljs-keyword">extern</span> <span class="hljs-keyword">struct</span> rb_node *<span class="hljs-title function_">rb_last</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> rb_root *)</span>;<br><br><span class="hljs-comment">/* Fast replacement of a single node without remove/rebalance/add/rebalance */</span><br><span class="hljs-keyword">extern</span> <span class="hljs-type">void</span> <span class="hljs-title function_">rb_replace_node</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> rb_node *victim, <span class="hljs-keyword">struct</span> rb_node *new, </span><br><span class="hljs-params">                <span class="hljs-keyword">struct</span> rb_root *root)</span>;<br><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title function_">rb_link_node</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> rb_node * node, <span class="hljs-keyword">struct</span> rb_node * parent,</span><br><span class="hljs-params">                <span class="hljs-keyword">struct</span> rb_node ** rb_link)</span><br>&#123;<br>    node-&gt;rb_parent = parent;<br>    node-&gt;rb_color = RB_RED;<br>    node-&gt;rb_left = node-&gt;rb_right = <span class="hljs-literal">NULL</span>;<br><br>    *rb_link = node;<br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span>    <span class="hljs-comment">/* _LINUX_RBTREE_H */</span></span><br><br>rbtree.c :<br><span class="hljs-comment">/*</span><br><span class="hljs-comment">  Red Black Trees</span><br><span class="hljs-comment">  (C) 1999  Andrea Arcangeli &lt;andrea@suse.de&gt;</span><br><span class="hljs-comment">  (C) 2002  David Woodhouse &lt;dwmw2@infradead.org&gt;</span><br><span class="hljs-comment">  </span><br><span class="hljs-comment">  This program is free software; you can redistribute it and/or modify</span><br><span class="hljs-comment">  it under the terms of the GNU General Public License as published by</span><br><span class="hljs-comment">  the Free Software Foundation; either version 2 of the License, or</span><br><span class="hljs-comment">  (at your option) any later version.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">  This program is distributed in the hope that it will be useful,</span><br><span class="hljs-comment">  but WITHOUT ANY WARRANTY; without even the implied warranty of</span><br><span class="hljs-comment">  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span><br><span class="hljs-comment">  GNU General Public License for more details.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">  You should have received a copy of the GNU General Public License</span><br><span class="hljs-comment">  along with this program; if not, write to the Free Software</span><br><span class="hljs-comment">  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">  linux/lib/rbtree.c</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-comment">// #include &lt;linux/rbtree.h&gt;</span><br><span class="hljs-comment">// #include &lt;linux/module.h&gt;</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;rbtree.h&quot;</span></span><br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> __rb_rotate_left(<span class="hljs-keyword">struct</span> rb_node *node, <span class="hljs-keyword">struct</span> rb_root *root)<br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rb_node</span> *<span class="hljs-title">right</span> =</span> node-&gt;rb_right;<br><br>    <span class="hljs-keyword">if</span> ((node-&gt;rb_right = right-&gt;rb_left))<br>        right-&gt;rb_left-&gt;rb_parent = node;<br>    right-&gt;rb_left = node;<br><br>    <span class="hljs-keyword">if</span> ((right-&gt;rb_parent = node-&gt;rb_parent))<br>    &#123;<br>        <span class="hljs-keyword">if</span> (node == node-&gt;rb_parent-&gt;rb_left)<br>            node-&gt;rb_parent-&gt;rb_left = right;<br>        <span class="hljs-keyword">else</span><br>            node-&gt;rb_parent-&gt;rb_right = right;<br>    &#125;<br>    <span class="hljs-keyword">else</span><br>        root-&gt;rb_node = right;<br>    node-&gt;rb_parent = right;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> __rb_rotate_right(<span class="hljs-keyword">struct</span> rb_node *node, <span class="hljs-keyword">struct</span> rb_root *root)<br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rb_node</span> *<span class="hljs-title">left</span> =</span> node-&gt;rb_left;<br><br>    <span class="hljs-keyword">if</span> ((node-&gt;rb_left = left-&gt;rb_right))<br>        left-&gt;rb_right-&gt;rb_parent = node;<br>    left-&gt;rb_right = node;<br><br>    <span class="hljs-keyword">if</span> ((left-&gt;rb_parent = node-&gt;rb_parent))<br>    &#123;<br>        <span class="hljs-keyword">if</span> (node == node-&gt;rb_parent-&gt;rb_right)<br>            node-&gt;rb_parent-&gt;rb_right = left;<br>        <span class="hljs-keyword">else</span><br>            node-&gt;rb_parent-&gt;rb_left = left;<br>    &#125;<br>    <span class="hljs-keyword">else</span><br>        root-&gt;rb_node = left;<br>    node-&gt;rb_parent = left;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">rb_insert_color</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> rb_node *node, <span class="hljs-keyword">struct</span> rb_root *root)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rb_node</span> *<span class="hljs-title">parent</span>, *<span class="hljs-title">gparent</span>;</span><br><br>    <span class="hljs-keyword">while</span> ((parent = node-&gt;rb_parent) &amp;&amp; parent-&gt;rb_color == RB_RED)<br>    &#123;<br>        gparent = parent-&gt;rb_parent;<br><br>        <span class="hljs-keyword">if</span> (parent == gparent-&gt;rb_left)<br>        &#123;<br>            &#123;<br>                <span class="hljs-keyword">register</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rb_node</span> *<span class="hljs-title">uncle</span> =</span> gparent-&gt;rb_right;<br>                <span class="hljs-keyword">if</span> (uncle &amp;&amp; uncle-&gt;rb_color == RB_RED)<br>                &#123;<br>                    uncle-&gt;rb_color = RB_BLACK;<br>                    parent-&gt;rb_color = RB_BLACK;<br>                    gparent-&gt;rb_color = RB_RED;<br>                    node = gparent;<br>                    <span class="hljs-keyword">continue</span>;<br>                &#125;<br>            &#125;<br><br>            <span class="hljs-keyword">if</span> (parent-&gt;rb_right == node)<br>            &#123;<br>                <span class="hljs-keyword">register</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rb_node</span> *<span class="hljs-title">tmp</span>;</span><br>                __rb_rotate_left(parent, root);<br>                tmp = parent;<br>                parent = node;<br>                node = tmp;<br>            &#125;<br><br>            parent-&gt;rb_color = RB_BLACK;<br>            gparent-&gt;rb_color = RB_RED;<br>            __rb_rotate_right(gparent, root);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            &#123;<br>                <span class="hljs-keyword">register</span> <span class="hljs-keyword">struct</span> rb_node *uncle = gparent-&gt;rb_left;<br>                <span class="hljs-keyword">if</span> (uncle &amp;&amp; uncle-&gt;rb_color == RB_RED)<br>                &#123;<br>                    uncle-&gt;rb_color = RB_BLACK;<br>                    parent-&gt;rb_color = RB_BLACK;<br>                    gparent-&gt;rb_color = RB_RED;<br>                    node = gparent;<br>                    <span class="hljs-keyword">continue</span>;<br>                &#125;<br>            &#125;<br><br>            <span class="hljs-keyword">if</span> (parent-&gt;rb_left == node)<br>            &#123;<br>                <span class="hljs-keyword">register</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rb_node</span> *<span class="hljs-title">tmp</span>;</span><br>                __rb_rotate_right(parent, root);<br>                tmp = parent;<br>                parent = node;<br>                node = tmp;<br>            &#125;<br><br>            parent-&gt;rb_color = RB_BLACK;<br>            gparent-&gt;rb_color = RB_RED;<br>            __rb_rotate_left(gparent, root);<br>        &#125;<br>    &#125;<br><br>    root-&gt;rb_node-&gt;rb_color = RB_BLACK;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> __rb_erase_color(<span class="hljs-keyword">struct</span> rb_node *node, <span class="hljs-keyword">struct</span> rb_node *parent,<br>                 <span class="hljs-keyword">struct</span> rb_root *root)<br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rb_node</span> *<span class="hljs-title">other</span>;</span><br><br>    <span class="hljs-keyword">while</span> ((!node || node-&gt;rb_color == RB_BLACK) &amp;&amp; node != root-&gt;rb_node)<br>    &#123;<br>        <span class="hljs-keyword">if</span> (parent-&gt;rb_left == node)<br>        &#123;<br>            other = parent-&gt;rb_right;<br>            <span class="hljs-keyword">if</span> (other-&gt;rb_color == RB_RED)<br>            &#123;<br>                other-&gt;rb_color = RB_BLACK;<br>                parent-&gt;rb_color = RB_RED;<br>                __rb_rotate_left(parent, root);<br>                other = parent-&gt;rb_right;<br>            &#125;<br>            <span class="hljs-keyword">if</span> ((!other-&gt;rb_left ||<br>                 other-&gt;rb_left-&gt;rb_color == RB_BLACK)<br>                &amp;&amp; (!other-&gt;rb_right ||<br>                other-&gt;rb_right-&gt;rb_color == RB_BLACK))<br>            &#123;<br>                other-&gt;rb_color = RB_RED;<br>                node = parent;<br>                parent = node-&gt;rb_parent;<br>            &#125;<br>            <span class="hljs-keyword">else</span><br>            &#123;<br>                <span class="hljs-keyword">if</span> (!other-&gt;rb_right ||<br>                    other-&gt;rb_right-&gt;rb_color == RB_BLACK)<br>                &#123;<br>                    <span class="hljs-keyword">register</span> <span class="hljs-keyword">struct</span> rb_node *o_left;<br>                    <span class="hljs-keyword">if</span> ((o_left = other-&gt;rb_left))<br>                        o_left-&gt;rb_color = RB_BLACK;<br>                    other-&gt;rb_color = RB_RED;<br>                    __rb_rotate_right(other, root);<br>                    other = parent-&gt;rb_right;<br>                &#125;<br>                other-&gt;rb_color = parent-&gt;rb_color;<br>                parent-&gt;rb_color = RB_BLACK;<br>                <span class="hljs-keyword">if</span> (other-&gt;rb_right)<br>                    other-&gt;rb_right-&gt;rb_color = RB_BLACK;<br>                __rb_rotate_left(parent, root);<br>                node = root-&gt;rb_node;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">else</span><br>        &#123;<br>            other = parent-&gt;rb_left;<br>            <span class="hljs-keyword">if</span> (other-&gt;rb_color == RB_RED)<br>            &#123;<br>                other-&gt;rb_color = RB_BLACK;<br>                parent-&gt;rb_color = RB_RED;<br>                __rb_rotate_right(parent, root);<br>                other = parent-&gt;rb_left;<br>            &#125;<br>            <span class="hljs-keyword">if</span> ((!other-&gt;rb_left ||<br>                 other-&gt;rb_left-&gt;rb_color == RB_BLACK)<br>                &amp;&amp; (!other-&gt;rb_right ||<br>                other-&gt;rb_right-&gt;rb_color == RB_BLACK))<br>            &#123;<br>                other-&gt;rb_color = RB_RED;<br>                node = parent;<br>                parent = node-&gt;rb_parent;<br>            &#125;<br>            <span class="hljs-keyword">else</span><br>            &#123;<br>                <span class="hljs-keyword">if</span> (!other-&gt;rb_left ||<br>                    other-&gt;rb_left-&gt;rb_color == RB_BLACK)<br>                &#123;<br>                    <span class="hljs-keyword">register</span> <span class="hljs-keyword">struct</span> rb_node *o_right;<br>                    <span class="hljs-keyword">if</span> ((o_right = other-&gt;rb_right))<br>                        o_right-&gt;rb_color = RB_BLACK;<br>                    other-&gt;rb_color = RB_RED;<br>                    __rb_rotate_left(other, root);<br>                    other = parent-&gt;rb_left;<br>                &#125;<br>                other-&gt;rb_color = parent-&gt;rb_color;<br>                parent-&gt;rb_color = RB_BLACK;<br>                <span class="hljs-keyword">if</span> (other-&gt;rb_left)<br>                    other-&gt;rb_left-&gt;rb_color = RB_BLACK;<br>                __rb_rotate_right(parent, root);<br>                node = root-&gt;rb_node;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (node)<br>        node-&gt;rb_color = RB_BLACK;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">rb_erase</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> rb_node *node, <span class="hljs-keyword">struct</span> rb_root *root)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rb_node</span> *<span class="hljs-title">child</span>, *<span class="hljs-title">parent</span>;</span><br>    <span class="hljs-type">int</span> color;<br><br>    <span class="hljs-keyword">if</span> (!node-&gt;rb_left)<br>        child = node-&gt;rb_right;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!node-&gt;rb_right)<br>        child = node-&gt;rb_left;<br>    <span class="hljs-keyword">else</span><br>    &#123;<br>        <span class="hljs-keyword">struct</span> rb_node *old = node, *left;<br><br>        node = node-&gt;rb_right;<br>        <span class="hljs-keyword">while</span> ((left = node-&gt;rb_left) != <span class="hljs-literal">NULL</span>)<br>            node = left;<br>        child = node-&gt;rb_right;<br>        parent = node-&gt;rb_parent;<br>        color = node-&gt;rb_color;<br><br>        <span class="hljs-keyword">if</span> (child)<br>            child-&gt;rb_parent = parent;<br>        <span class="hljs-keyword">if</span> (parent)<br>        &#123;<br>            <span class="hljs-keyword">if</span> (parent-&gt;rb_left == node)<br>                parent-&gt;rb_left = child;<br>            <span class="hljs-keyword">else</span><br>                parent-&gt;rb_right = child;<br>        &#125;<br>        <span class="hljs-keyword">else</span><br>            root-&gt;rb_node = child;<br><br>        <span class="hljs-keyword">if</span> (node-&gt;rb_parent == old)<br>            parent = node;<br>        node-&gt;rb_parent = old-&gt;rb_parent;<br>        node-&gt;rb_color = old-&gt;rb_color;<br>        node-&gt;rb_right = old-&gt;rb_right;<br>        node-&gt;rb_left = old-&gt;rb_left;<br><br>        <span class="hljs-keyword">if</span> (old-&gt;rb_parent)<br>        &#123;<br>            <span class="hljs-keyword">if</span> (old-&gt;rb_parent-&gt;rb_left == old)<br>                old-&gt;rb_parent-&gt;rb_left = node;<br>            <span class="hljs-keyword">else</span><br>                old-&gt;rb_parent-&gt;rb_right = node;<br>        &#125; <span class="hljs-keyword">else</span><br>            root-&gt;rb_node = node;<br><br>        old-&gt;rb_left-&gt;rb_parent = node;<br>        <span class="hljs-keyword">if</span> (old-&gt;rb_right)<br>            old-&gt;rb_right-&gt;rb_parent = node;<br>        <span class="hljs-keyword">goto</span> color;<br>    &#125;<br><br>    parent = node-&gt;rb_parent;<br>    color = node-&gt;rb_color;<br><br>    <span class="hljs-keyword">if</span> (child)<br>        child-&gt;rb_parent = parent;<br>    <span class="hljs-keyword">if</span> (parent)<br>    &#123;<br>        <span class="hljs-keyword">if</span> (parent-&gt;rb_left == node)<br>            parent-&gt;rb_left = child;<br>        <span class="hljs-keyword">else</span><br>            parent-&gt;rb_right = child;<br>    &#125;<br>    <span class="hljs-keyword">else</span><br>        root-&gt;rb_node = child;<br><br> color:<br>    <span class="hljs-keyword">if</span> (color == RB_BLACK)<br>        __rb_erase_color(child, parent, root);<br>&#125;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * This function returns the first node (in sort order) of the tree.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">struct</span> rb_node *<span class="hljs-title function_">rb_first</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> rb_root *root)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rb_node</span>  *<span class="hljs-title">n</span>;</span><br><br>    n = root-&gt;rb_node;<br>    <span class="hljs-keyword">if</span> (!n)<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-keyword">while</span> (n-&gt;rb_left)<br>        n = n-&gt;rb_left;<br>    <span class="hljs-keyword">return</span> n;<br>&#125;<br><br><span class="hljs-keyword">struct</span> rb_node *<span class="hljs-title function_">rb_last</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> rb_root *root)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rb_node</span>  *<span class="hljs-title">n</span>;</span><br><br>    n = root-&gt;rb_node;<br>    <span class="hljs-keyword">if</span> (!n)<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-keyword">while</span> (n-&gt;rb_right)<br>        n = n-&gt;rb_right;<br>    <span class="hljs-keyword">return</span> n;<br>&#125;<br><br><span class="hljs-keyword">struct</span> rb_node *<span class="hljs-title function_">rb_next</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> rb_node *node)</span><br>&#123;<br>    <span class="hljs-comment">/* If we have a right-hand child, go down and then left as far</span><br><span class="hljs-comment">       as we can. */</span><br>    <span class="hljs-keyword">if</span> (node-&gt;rb_right) &#123;<br>        node = node-&gt;rb_right; <br>        <span class="hljs-keyword">while</span> (node-&gt;rb_left)<br>            node=node-&gt;rb_left;<br>        <span class="hljs-keyword">return</span> node;<br>    &#125;<br><br>    <span class="hljs-comment">/* No right-hand children.  Everything down and left is</span><br><span class="hljs-comment">       smaller than us, so any &#x27;next&#x27; node must be in the general</span><br><span class="hljs-comment">       direction of our parent. Go up the tree; any time the</span><br><span class="hljs-comment">       ancestor is a right-hand child of its parent, keep going</span><br><span class="hljs-comment">       up. First time it&#x27;s a left-hand child of its parent, said</span><br><span class="hljs-comment">       parent is our &#x27;next&#x27; node. */</span><br>    <span class="hljs-keyword">while</span> (node-&gt;rb_parent &amp;&amp; node == node-&gt;rb_parent-&gt;rb_right)<br>        node = node-&gt;rb_parent;<br><br>    <span class="hljs-keyword">return</span> node-&gt;rb_parent;<br>&#125;<br><br><span class="hljs-keyword">struct</span> rb_node *<span class="hljs-title function_">rb_prev</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> rb_node *node)</span><br>&#123;<br>    <span class="hljs-comment">/* If we have a left-hand child, go down and then right as far</span><br><span class="hljs-comment">       as we can. */</span><br>    <span class="hljs-keyword">if</span> (node-&gt;rb_left) &#123;<br>        node = node-&gt;rb_left; <br>        <span class="hljs-keyword">while</span> (node-&gt;rb_right)<br>            node=node-&gt;rb_right;<br>        <span class="hljs-keyword">return</span> node;<br>    &#125;<br><br>    <span class="hljs-comment">/* No left-hand children. Go up till we find an ancestor which</span><br><span class="hljs-comment">       is a right-hand child of its parent */</span><br>    <span class="hljs-keyword">while</span> (node-&gt;rb_parent &amp;&amp; node == node-&gt;rb_parent-&gt;rb_left)<br>        node = node-&gt;rb_parent;<br><br>    <span class="hljs-keyword">return</span> node-&gt;rb_parent;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">rb_replace_node</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> rb_node *victim, <span class="hljs-keyword">struct</span> rb_node *new,</span><br><span class="hljs-params">             <span class="hljs-keyword">struct</span> rb_root *root)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rb_node</span> *<span class="hljs-title">parent</span> =</span> victim-&gt;rb_parent;<br><br>    <span class="hljs-comment">/* Set the surrounding nodes to point to the replacement */</span><br>    <span class="hljs-keyword">if</span> (parent) &#123;<br>        <span class="hljs-keyword">if</span> (victim == parent-&gt;rb_left)<br>            parent-&gt;rb_left = new;<br>        <span class="hljs-keyword">else</span><br>            parent-&gt;rb_right = new;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        root-&gt;rb_node = new;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (victim-&gt;rb_left)<br>        victim-&gt;rb_left-&gt;rb_parent = new;<br>    <span class="hljs-keyword">if</span> (victim-&gt;rb_right)<br>        victim-&gt;rb_right-&gt;rb_parent = new;<br><br>    <span class="hljs-comment">/* Copy the pointers/colour from the victim to the replacement */</span><br>    *new = *victim;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;ä¸€ã€-çº¢é»‘æ ‘çš„åŸç†&quot;&gt;&lt;a href=&quot;#ä¸€ã€-çº¢é»‘æ ‘çš„åŸç†&quot; class=&quot;headerlink&quot; title=&quot;ä¸€ã€ çº¢é»‘æ ‘çš„åŸç†&quot;&gt;&lt;/a&gt;ä¸€ã€ çº¢é»‘æ ‘çš„åŸç†&lt;/h3&gt;&lt;p&gt;çº¢é»‘æ ‘RB Treeæ˜¯äºŒå‰æ ‘çš„ä¸€ç§ï¼Œä½œä¸ºä¸€ç§è‡ªå¹³è¡¡äºŒå‰æ ‘ï¼ˆä¸€äº›æƒ…å†µä¸‹ä¸æ˜¯å®Œå…¨å¹³è¡¡çš„ï¼‰</summary>
      
    
    
    
    <category term="kernel" scheme="http://example.com/categories/kernel/"/>
    
    
    <category term="kernel" scheme="http://example.com/tags/kernel/"/>
    
  </entry>
  
  <entry>
    <title>å†…æ ¸é˜Ÿåˆ—</title>
    <link href="http://example.com/posts/%E5%86%85%E6%A0%B8%E9%98%9F%E5%88%97.html"/>
    <id>http://example.com/posts/%E5%86%85%E6%A0%B8%E9%98%9F%E5%88%97.html</id>
    <published>2024-11-25T14:55:17.000Z</published>
    <updated>2024-11-25T14:55:37.894Z</updated>
    
    <content type="html"><![CDATA[<h3 id="ä¸€ã€kfifoåŸç†"><a href="#ä¸€ã€kfifoåŸç†" class="headerlink" title="ä¸€ã€kfifoåŸç†"></a>ä¸€ã€kfifoåŸç†</h3><p>   kfifoå®ç°åŸç†æ˜¯é‡‡ç”¨å¾ªç¯ï¼ˆç¯å½¢ï¼‰é˜Ÿåˆ—ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kfifo</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *buffer; / *ä¿å­˜æ•°æ®çš„ç¼“å†²åŒº* /<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> size;      / *åˆ†é…çš„ç¼“å†²åŒºçš„å¤§å°* /<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> in;        / *æ•°æ®ä»¥åç§»é‡(in%size)æ·»åŠ * /<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> out;       / *æ•°æ®ä»offä¸­æå–ã€‚(out%size)* /<br>&#125;;<br></code></pre></td></tr></table></figure><h3 id="äºŒã€kfifoç‰¹ç‚¹"><a href="#äºŒã€kfifoç‰¹ç‚¹" class="headerlink" title="äºŒã€kfifoç‰¹ç‚¹"></a>äºŒã€kfifoç‰¹ç‚¹</h3><p>1ã€é‡‡ç”¨ç¯å½¢ç¼“å†²åŒºæ¥å®ç°ï¼Œæä¾›ä¸€ä¸ªæ— è¾¹ç•Œçš„å­—èŠ‚æµæœåŠ¡ã€‚é‡‡ç”¨ç¯å½¢ç¼“å†²åŒºçš„å¥½å¤„ä¸ºï¼Œå½“ä¸€ä¸ªæ•°æ®å…ƒç´ è¢«ç”¨æ‰åï¼Œå…¶ä½™æ•°æ®å…ƒç´ ä¸éœ€è¦ç§»åŠ¨å…¶å­˜å‚¨ä½ç½®ï¼Œä»è€Œå‡å°‘æ‹·è´æé«˜æ•ˆç‡ã€‚</p><p>2ã€ä¿è¯ç¼“å†²åŒºå¤§å°ä¸º2çš„æ¬¡å¹‚ï¼Œä¸æ˜¯çš„å‘ä¸Šå–æ•´ä¸º2çš„æ¬¡å¹‚ï¼ˆå¾ˆé‡è¦ï¼‰ã€‚</p><p>3ã€ä½¿ç”¨æ— ç¬¦å·æ•´æ•°ä¿å­˜è¾“å…¥(in)å’Œè¾“å‡º(out)çš„ä½ç½®ï¼Œåœ¨è¾“å…¥è¾“å‡ºæ—¶ä¸å¯¹inå’Œoutçš„å€¼è¿›è¡Œæ¨¡è¿ç®—ï¼Œè€Œè®©å…¶è‡ªç„¶æº¢å‡ºï¼Œå¹¶èƒ½å¤Ÿä¿è¯in-outçš„ç»“æœä¸ºç¼“å†²åŒºä¸­å·²å­˜æ”¾çš„æ•°æ®é•¿åº¦ã€‚</p><p>4ã€å°†éœ€è¦å–æ¨¡çš„è¿ç®—ç”¨ &amp; æ“ä½œä»£æ›¿ï¼ˆ a % size &#x3D; (a &amp; (size âˆ’ 1)) ), è¿™éœ€è¦sizeä¿è¯ä¸º2çš„æ¬¡å¹‚ã€‚</p><p>5ã€ä½¿ç”¨å†…å­˜å±éšœ(Memory Barrier)æŠ€æœ¯ï¼Œå®ç°å•æ¶ˆè´¹è€…å’Œå•ç”Ÿäº§è€…å¯¹kfifoçš„æ— é”å¹¶å‘è®¿é—®ï¼ˆåŒ…æ‹¬å¤šCPUçš„æƒ…å†µï¼‰ï¼Œå¤šä¸ªæ¶ˆè´¹è€…ã€ç”Ÿäº§è€…çš„å¹¶å‘è®¿é—®è¿˜æ˜¯éœ€è¦åŠ é”çš„ã€‚</p><p>å…³äºkfifoä¸­å†…å­˜å±éšœçš„ä½¿ç”¨ï¼Œè¯·å‚è€ƒ<a href="https://www.linuxidc.com/Linux/2016-12/137936.htm">https://www.linuxidc.com/Linux/2016-12/137936.htm</a>ã€‚</p><h3 id="ä¸‰ã€kfifoåŠŸèƒ½å‡½æ•°ä¹‹åˆ›å»ºé˜Ÿåˆ—"><a href="#ä¸‰ã€kfifoåŠŸèƒ½å‡½æ•°ä¹‹åˆ›å»ºé˜Ÿåˆ—" class="headerlink" title="ä¸‰ã€kfifoåŠŸèƒ½å‡½æ•°ä¹‹åˆ›å»ºé˜Ÿåˆ—"></a>ä¸‰ã€kfifoåŠŸèƒ½å‡½æ•°ä¹‹åˆ›å»ºé˜Ÿåˆ—</h3><p>   kfifoæä¾›ä¸¤ç§åˆ›å»ºé˜Ÿåˆ—çš„æ–¹æ³•ï¼ŒåŠ¨æ€åˆ›å»ºå’Œé™æ€åˆ›å»ºã€‚</p><h5 id="1ã€åŠ¨æ€åˆ›å»º"><a href="#1ã€åŠ¨æ€åˆ›å»º" class="headerlink" title="1ã€åŠ¨æ€åˆ›å»º"></a>1ã€åŠ¨æ€åˆ›å»º</h5><p>(1)ã€kfifo_alloc</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kfifo</span> <span class="hljs-title">g_fifoqueue</span>;</span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">kfifo_alloc</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kfifo *fifo, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> size, <span class="hljs-type">gfp_t</span> gfp_mask)</span>;<br></code></pre></td></tr></table></figure><p>è¯¥å‡½æ•°åˆ›å»ºå¹¶åˆå§‹åŒ–ä¸€ä¸ªsizeå¤§å°çš„kfifoã€‚å†…æ ¸ä½¿ç”¨gfp_maskæ ‡è¯†ç¬¦åˆ†é…é˜Ÿåˆ—çš„ç¼“å†²åŒºå†…å­˜ã€‚å¦‚æœæˆåŠŸï¼Œå‡½æ•°è¿”å›0ï¼Œé”™è¯¯åˆ™è¿”å›è´Ÿæ•°çš„é”™è¯¯ç ã€‚æ³¨æ„kfifo_allocç”³è¯·çš„å†…å­˜æ˜¯åœ¨ç‰©ç†åœ°å€ä¸Šæ˜¯è¿ç»­çš„</p><p>(2)ã€kfifo_init</p><p>å¦‚æœè¦è‡ªå·±åˆ†é…ç¼“å†²åŒºï¼Œå¯ä»¥è°ƒç”¨å‡½æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">kfifo_init</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kfifo *fifo, <span class="hljs-type">void</span> *buffer, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> size)</span>;<br></code></pre></td></tr></table></figure><h5 id="2ã€é™æ€åˆ›å»º"><a href="#2ã€é™æ€åˆ›å»º" class="headerlink" title="2ã€é™æ€åˆ›å»º"></a>2ã€é™æ€åˆ›å»º</h5><p>DECLARE_KFIFO(name, size) ;</p><p>INIT_KFIFO(name);</p><h3 id="å››ã€å…¥é˜Ÿæ“ä½œ"><a href="#å››ã€å…¥é˜Ÿæ“ä½œ" class="headerlink" title="å››ã€å…¥é˜Ÿæ“ä½œ"></a>å››ã€å…¥é˜Ÿæ“ä½œ</h3><p>å¯¹äºæ¨å…¥é˜Ÿåˆ—æ•°æ®ï¼Œkfifoæä¾›ä¸‰å¤§ç±»å‡½æ•°ï¼šå¸¸è§„å‡½æ•°ï¼Œ å°†ç”¨æˆ·ç©ºé—´æ•°æ®æ¨å…¥é˜Ÿåˆ—çš„å‡½æ•°ï¼Œå¸¦è®°å½•åŸŸåŠŸèƒ½çš„å‡½æ•°ã€‚</p><p>1ï¼‰å¸¸è§„å‡½æ•°</p><p>unsigned int kfifo_in(struct kfifo *fifo, const void *from, unsigned int len);</p><p>unsigned int kfifo_in_locked(struct kfifo *fifo, const void *from, unsigned int n, spinlock_t *lock);</p><p>2ï¼‰å°†ç”¨æˆ·ç©ºé—´æ•°æ®æ¨å…¥é˜Ÿåˆ—çš„å‡½æ•°</p><p>int kfifo_from_user(struct kfifo *fifo, const void __user *from, unsigned int n, unsigned *lenout);</p><p>unsigned int kfifo_from_user_rec(struct kfifo *fifo, const void __user *from, unsigned int n, unsigned int recsize);</p><p>3ï¼‰å¸¦è®°å½•åŸŸåŠŸèƒ½çš„å‡½æ•°</p><p>unsigned int kfifo_in_rec(struct kfifo *fifo, void *from, unsigned int n, unsigned int recsize)ï¼›             </p><h3 id="äº”ã€å‡ºé˜Ÿ"><a href="#äº”ã€å‡ºé˜Ÿ" class="headerlink" title="äº”ã€å‡ºé˜Ÿ"></a>äº”ã€å‡ºé˜Ÿ</h3><p>å¯¹äºæ‘˜å–é˜Ÿåˆ—æ•°æ®ï¼Œkfifoæä¾›ä¸‰å¤§ç±»å‡½æ•°ï¼šå¸¸è§„å‡½æ•°ï¼Œ æ‘˜å–é˜Ÿåˆ—æ•°æ®è‡³ç”¨æˆ·ç©ºé—´çš„å‡½æ•°ï¼Œå¸¦è®°å½•åŸŸåŠŸèƒ½çš„å‡½æ•°ã€‚</p><p>(1)ã€å¸¸è§„å‡½æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> <span class="hljs-title function_">kfifo_out</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kfifo *fifo, <span class="hljs-type">void</span> *to, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> len)</span>;<br><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> <span class="hljs-title function_">kfifo_out_locked</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kfifo *fifo, <span class="hljs-type">void</span> *to, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> n, <span class="hljs-type">spinlock_t</span> *lock)</span>;<br><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> <span class="hljs-title function_">kfifo_out_peek</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kfifo *fifo, <span class="hljs-type">void</span> *to, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> len, <span class="hljs-type">unsigned</span> offset)</span>;<br></code></pre></td></tr></table></figure><p>(2)ã€æ‘˜å–é˜Ÿåˆ—æ•°æ®è‡³ç”¨æˆ·ç©ºé—´çš„å‡½æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">unsigned</span>  <span class="hljs-type">int</span> <span class="hljs-title function_">kfifo_to_user</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kfifo *fifo, <span class="hljs-type">void</span> __user *to, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> n, <span class="hljs-type">unsigned</span> *lenout)</span>;<br><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> <span class="hljs-title function_">kfifo_to_user_rec</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kfifo *fifo, <span class="hljs-type">void</span> __user *to, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> n, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> recsize, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> *total)</span>;<br></code></pre></td></tr></table></figure><p>(3)ã€å¸¦è®°å½•åŸŸåŠŸèƒ½çš„å‡½æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> <span class="hljs-title function_">kfifo_out_rec</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kfifo *fifo, <span class="hljs-type">void</span> *to, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> n, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> recsize, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> *total)</span>;<br></code></pre></td></tr></table></figure><h3 id="å…­ã€è·å–é˜Ÿåˆ—é•¿åº¦ã€åˆ¤ç©ºç­‰æ“ä½œ"><a href="#å…­ã€è·å–é˜Ÿåˆ—é•¿åº¦ã€åˆ¤ç©ºç­‰æ“ä½œ" class="headerlink" title="å…­ã€è·å–é˜Ÿåˆ—é•¿åº¦ã€åˆ¤ç©ºç­‰æ“ä½œ"></a>å…­ã€è·å–é˜Ÿåˆ—é•¿åº¦ã€åˆ¤ç©ºç­‰æ“ä½œ</h3><p>(1)ã€è·å–é˜Ÿåˆ—ç¼“å†²åŒºå¤§å°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> <span class="hljs-title function_">kfifo_size</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kfifo *fifo)</span>;<br></code></pre></td></tr></table></figure><p>(2)ã€è·å–é˜Ÿåˆ—å·²æ¨å…¥çš„æ•°æ®å¤§å°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> <span class="hljs-title function_">kfifo_len</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kfifo *fifo)</span>;<br></code></pre></td></tr></table></figure><p>(3)ã€è·å–é˜Ÿåˆ—å¯ç”¨ç©ºé—´å¤§å°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> <span class="hljs-title function_">kfifo_avail</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kfifo *fifo)</span>;<br></code></pre></td></tr></table></figure><p>(4)ã€åˆ¤æ–­é˜Ÿåˆ—æ˜¯å¦ç©º</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">kfifo_is_empty</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kfifo *fifo)</span>;<br></code></pre></td></tr></table></figure><p>(5)ã€åˆ¤æ–­é˜Ÿåˆ—æ˜¯å¦æ»¡</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">kfifo_is_full</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kfifo *fifo)</span>;<br></code></pre></td></tr></table></figure><h3 id="ä¸ƒã€é‡ç½®å’Œæ’¤é”€é˜Ÿåˆ—"><a href="#ä¸ƒã€é‡ç½®å’Œæ’¤é”€é˜Ÿåˆ—" class="headerlink" title="ä¸ƒã€é‡ç½®å’Œæ’¤é”€é˜Ÿåˆ—"></a>ä¸ƒã€é‡ç½®å’Œæ’¤é”€é˜Ÿåˆ—</h3><p>(1)ã€é‡ç½®é˜Ÿåˆ—</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">kfifo_reset</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kfifo *fifo)</span>;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">kfifo_skip</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kfifo *fifo, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> len)</span>;<br></code></pre></td></tr></table></figure><p>(2)ã€æ’¤é”€é˜Ÿåˆ—</p><p>å¦‚æœé˜Ÿåˆ—æ˜¯ç”±å‡½æ•°kfifo_allocåˆ›å»ºï¼Œåˆ™æ’¤é”€é˜Ÿåˆ—ä½¿ç”¨ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">kfifo_free</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kfifo *fifo)</span>;<br><br></code></pre></td></tr></table></figure><p>å¦‚æœé˜Ÿåˆ—æ˜¯ç”±å‡½æ•°kfifo_initåˆ›å»ºï¼Œåˆ™ä½ éœ€è¦è´Ÿè´£é‡Šæ”¾ç›¸å…³ç¼“å†²ã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;ä¸€ã€kfifoåŸç†&quot;&gt;&lt;a href=&quot;#ä¸€ã€kfifoåŸç†&quot; class=&quot;headerlink&quot; title=&quot;ä¸€ã€kfifoåŸç†&quot;&gt;&lt;/a&gt;ä¸€ã€kfifoåŸç†&lt;/h3&gt;&lt;p&gt;   kfifoå®ç°åŸç†æ˜¯é‡‡ç”¨å¾ªç¯ï¼ˆç¯å½¢ï¼‰é˜Ÿåˆ—ã€‚&lt;/p&gt;
&lt;figure class</summary>
      
    
    
    
    <category term="kernel" scheme="http://example.com/categories/kernel/"/>
    
    
    <category term="kernel" scheme="http://example.com/tags/kernel/"/>
    
  </entry>
  
  <entry>
    <title>å†…æ ¸é“¾è¡¨</title>
    <link href="http://example.com/posts/%E5%86%85%E6%A0%B8%E9%93%BE%E8%A1%A8.html"/>
    <id>http://example.com/posts/%E5%86%85%E6%A0%B8%E9%93%BE%E8%A1%A8.html</id>
    <published>2024-11-25T14:54:19.000Z</published>
    <updated>2024-11-25T14:54:44.655Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨Linuxå†…æ ¸ä¸­ä½¿ç”¨äº†å¤§é‡çš„é“¾è¡¨ç»“æ„æ¥ç»„ç»‡æ•°æ®ï¼ŒåŒ…æ‹¬è®¾å¤‡åˆ—è¡¨ä»¥åŠå„ç§åŠŸèƒ½æ¨¡å—ä¸­çš„æ•°æ®ç»„ç»‡ã€‚è¿™äº›é“¾è¡¨å¤§å¤šé‡‡ç”¨åœ¨include&#x2F;linux&#x2F;list.hå®ç°çš„ä¸€ä¸ªç›¸å½“ç²¾å½©çš„é“¾è¡¨æ•°æ®ç»“æ„ã€‚äº‹å®ä¸Šï¼Œå†…æ ¸é“¾è¡¨å°±æ˜¯é‡‡ç”¨åŒå¾ªç¯é“¾è¡¨æœºåˆ¶ã€‚</p><p>å†…æ ¸é“¾è¡¨æœ‰åˆ«äºä¼ ç»Ÿé“¾è¡¨å°±åœ¨èŠ‚ç‚¹æœ¬èº«ä¸åŒ…å«æ•°æ®åŸŸï¼ŒåªåŒ…å«æŒ‡é’ˆåŸŸã€‚æ•…è€Œå¯ä»¥å¾ˆçµæ´»çš„æ‹“å±•æ•°æ®ç»“æ„ã€‚</p><h3 id="ä¸€ã€ç¥å¥‡çš„ç»“æ„ï¼šlist-head"><a href="#ä¸€ã€ç¥å¥‡çš„ç»“æ„ï¼šlist-head" class="headerlink" title="ä¸€ã€ç¥å¥‡çš„ç»“æ„ï¼šlist_head"></a>ä¸€ã€ç¥å¥‡çš„ç»“æ„ï¼šlist_head</h3><p>è¦äº†è§£å†…æ ¸é“¾è¡¨ï¼Œå°±ä¸å¾—ä¸æ list_headã€‚è¿™ä¸ªç»“æ„å¾ˆæœ‰æ„æ€ï¼Œæ•´ä¸ªç»“æ„æ²¡æœ‰æ•°æ®åŸŸï¼Œåªæœ‰ä¸¤ä¸ªæŒ‡é’ˆåŸŸã€‚<br>è¿™ä¸ªç»“æ„æœ¬èº«æ„ä¹‰ä¸å¤§ï¼Œä¸è¿‡åœ¨å†…æ ¸é“¾è¡¨ä¸­ï¼Œèµ·ç€æ•´ä¸ªè¡”æ¥ä½œç”¨ï¼Œå¯ä»¥è¯´æ˜¯å†…æ ¸é“¾è¡¨çš„æ ¸å¿ƒä¸ä¸ºè¿‡ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs javascript">struct list_head &#123;<br>   struct list_head *next, *prev;<br>&#125;;<br></code></pre></td></tr></table></figure><h3 id="äºŒã€é“¾è¡¨åˆå§‹åŒ–"><a href="#äºŒã€é“¾è¡¨åˆå§‹åŒ–" class="headerlink" title="äºŒã€é“¾è¡¨åˆå§‹åŒ–"></a>äºŒã€é“¾è¡¨åˆå§‹åŒ–</h3><p>å†…æ ¸æä¾›å¤šç§æ–¹å¼æ¥åˆå§‹åŒ–é“¾è¡¨ï¼šå®åˆå§‹åŒ–å’Œæ¥å£åˆå§‹åŒ–ã€‚</p><h4 id="1-å®åˆå§‹åŒ–"><a href="#1-å®åˆå§‹åŒ–" class="headerlink" title="(1)å®åˆå§‹åŒ–"></a>(1)å®åˆå§‹åŒ–</h4><p>LIST_HEAD_HEAD_INITå®è®¾è®¡çš„å¾ˆç²¾å¦™ã€‚è¿™ä¸ªå®æœ¬èº«ä¸åŒ…å«ä»»ä½•æ•°æ®ç±»å‹ï¼Œä¹Ÿå°±æ˜¯è¯´æ²¡æœ‰é™å®šå”¯ä¸€çš„æ•°æ®ç±»å‹ï¼Œè¿™å°±ä½¿å¾—æ•´ä¸ªé“¾è¡¨è¶³å¤Ÿçµæ´»ã€‚æ˜¯ä¸æ˜¯æœ‰ç‚¹C++æ¨¡æ¿çš„æ„æ€ï¼Ÿ</p><p>å¯¹äºä»»æ„ç»™å®šçš„ç»“æ„æŒ‡é’ˆï¼Œå°†ã€å‰é©±ã€‘å’Œã€åç»§ã€‘æŒ‡é’ˆéƒ½æŒ‡å‘è‡ªå·±ï¼Œä½œä¸ºé“¾è¡¨å¤´æŒ‡é’ˆã€‚</p><p>LIST_HEAD å® æœ¬è´¨å°±æ˜¯èµ‹äºˆäº† name äº ã€struct list_headã€‘ å±æ€§ï¼Œç”±äº list_head æœ¬èº«ä¸åŒ…å«æ•°æ®åŸŸï¼Œæ‰€ä»¥æ­é… LIST_HEAD_HEAD_INIT å®ï¼Œå°±ä½¿å¾—æ•´ä¸ªé“¾è¡¨ä¸Šçš„æ•°æ®æ›´åŠ çµæ´»ã€‚å…·å¤‡é€šç”¨æ€§ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs javascript">#define <span class="hljs-title function_">LIST_HEAD_INIT</span>(<span class="hljs-params">name</span>) &#123; &amp;(name), &amp;(name) &#125;<br>#define <span class="hljs-title function_">LIST_HEAD</span>(name) \<br>   struct list_head name = <span class="hljs-title function_">LIST_HEAD_INIT</span>(name)<br></code></pre></td></tr></table></figure><h4 id="2-æ¥å£åˆå§‹åŒ–"><a href="#2-æ¥å£åˆå§‹åŒ–" class="headerlink" title="(2)æ¥å£åˆå§‹åŒ–"></a>(2)æ¥å£åˆå§‹åŒ–</h4><p>æ¥å£æ“ä½œå°±æ¯”è¾ƒç›´æ¥æ˜äº†ï¼ŒåŸºæœ¬ä¸Šå’Œå®å®ç°çš„æ„å›¾ä¸€æ ·ã€‚ç›´æ¥å°†é“¾è¡¨å¤´æŒ‡é’ˆçš„å‰é©±å’Œåç»§éƒ½æŒ‡å‘è‡ªå·±</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">static</span> inline <span class="hljs-keyword">void</span> <span class="hljs-title function_">INIT_LIST_HEAD</span>(<span class="hljs-params">struct list_head *list</span>)<br>&#123;<br>   list-&gt;next = list;<br>   list-&gt;prev = list;<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬ä»¥ç¤ºä¾‹æ¥è¡¥å……è¯´æ˜ï¼Œè¿™æ ·æœ‰åŠ©äºå¤§å®¶è¾…åŠ©ç†è§£ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// 1. é“¾è¡¨èŠ‚ç‚¹åˆå§‹åŒ–ï¼Œå‰é©±å’Œåç»§éƒ½æŒ‡å‘è‡ªå·±ï¼ˆåˆå§‹åŒ–ï¼‰</span><br>struct list = <span class="hljs-title function_">LIST_HEAD</span>(list);<br></code></pre></td></tr></table></figure><p>å‰é¢è¯´äº† list_head åªæœ‰æŒ‡é’ˆåŸŸï¼Œæ²¡æœ‰æ•°æ®åŸŸï¼Œå¦‚æœåªæ˜¯è¿™æ ·å°±æ²¡æœ‰ä»€ä¹ˆæ„ä¹‰äº†ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªå®¿ä¸»ç»“æ„ï¼Œç„¶åå†å†æ­¤ç»“æ„åŒ…å« list å­—æ®µï¼Œå®¿ä¸»ç»“æ„ï¼Œä¹Ÿæœ‰å…¶ä»–å­—æ®µï¼ˆè¿›ç¨‹æè¿°ç¬¦ï¼Œé¡µé¢ç®¡ç†ç»“æ„ç­‰éƒ½æ˜¯é‡‡ç”¨è¿™ç§æ–¹æ³•åˆ›å»ºé“¾è¡¨çš„ï¼‰ã€‚å‡è®¾å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs javascript">struct my_data_list &#123;<br>    int data ;<br>    struct list_head list; <span class="hljs-comment">/* list head , è¿™ä¸ªè‡³å…³é‡è¦ï¼ŒåæœŸéå†é€šè¿‡container_of è§£æmy_data_list åœ°å€ */</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>åˆ›å»ºä¸€ä¸ªèŠ‚ç‚¹ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs javascript">struct my_data_list first_data =<br>&#123; <br>    .<span class="hljs-property">val</span> = <span class="hljs-number">1</span>,<br>    <span class="hljs-comment">/* è¿™é‡Œæœ‰ç‚¹ç»•ï¼Œäº‹å®ä¸Šå°±æ˜¯å°†first_data.list , å‰é©±å’Œåç»§éƒ½æŒ‡å‘è‡ªå·±è¿›è¡Œåˆå§‹åŒ– */</span><br>    .<span class="hljs-property">list</span> = <span class="hljs-title function_">LIST_HEAD_INIT</span>(first_data.<span class="hljs-property">list</span>),<br>&#125;;<br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/mengchao666/picture/main/blog69ipvfwph3.png"></p><p>è¿™é‡Œ list çš„ prev å’Œ next éƒ½æŒ‡å‘list è‡ªå·±äº†ï¼Œå¹¶ä¸”list å±äº my_data_list çš„æˆå‘˜ã€‚åªéœ€è¦éå†åˆ°lst èŠ‚ç‚¹å°±èƒ½æ ¹æ® å‰é¢è®²çš„ container_of æ¨å¯¼å¾—åˆ°å…¶å®¿ä¸»ç»“æ„çš„åœ°å€ï¼Œä»è€Œè®¿é—®valå€¼ï¼Œå¦‚æœæœ‰å…¶ä»–æ–¹æ³•ï¼Œä¹Ÿå¯è®¿é—®ã€‚</p><p>åˆ†æåˆ°è¿™é‡Œï¼Œåº”è¯¥é€æ¸æ˜æ™°ï¼Œä¸ºä½•list_head è®¾è®¡å¾ˆæœ‰æ„æ€ï¼Ÿä¸ºä»€ä¹ˆé“¾è¡¨æœ¬èº«ä¸åŒ…å«æ•°æ®åŸŸï¼Œå´èƒ½è¡ç”Ÿå‡ºæ— æ•°æ•°æ®ç±»å‹ï¼Œä¸å—ç‰¹å®šçš„æ•°æ®ç±»å‹é™åˆ¶ã€‚</p><h3 id="ä¸‰ã€æ·»åŠ èŠ‚ç‚¹"><a href="#ä¸‰ã€æ·»åŠ èŠ‚ç‚¹" class="headerlink" title="ä¸‰ã€æ·»åŠ èŠ‚ç‚¹"></a>ä¸‰ã€æ·»åŠ èŠ‚ç‚¹</h3><p>å†…æ ¸ç›¸åº”çš„æä¾›äº†æ·»åŠ èŠ‚ç‚¹çš„æ¥å£ï¼š</p><h4 id="1-list-add"><a href="#1-list-add" class="headerlink" title="(1)list_add"></a>(1)list_add</h4><p>list_add å¦‚ä¸‹ï¼Œæœ€ç»ˆè°ƒç”¨çš„æ˜¯__list_add å‡½æ•°ï¼Œæ ¹æ®æ³¨é‡Šå¯çŸ¥ï¼Œlist_add æ˜¯å¤´éƒ¨æ’å…¥ï¼Œæ€»æ˜¯åœ¨é“¾è¡¨çš„å¤´éƒ¨æ’å…¥ä¸€ä¸ªæ–°çš„èŠ‚ç‚¹ã€‚</p><p>list_add</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * list_add - add a new entry</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@new</span>: new entry to be added</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@head</span>: list head to add it after</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Insert a new entry after the specified head.</span><br><span class="hljs-comment"> * This is good for implementing stacks.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">static</span> inline <span class="hljs-keyword">void</span> <span class="hljs-title function_">list_add</span>(<span class="hljs-params">struct list_head *<span class="hljs-keyword">new</span>, struct list_head *head</span>)<br>&#123;<br>   <span class="hljs-title function_">__list_add</span>(<span class="hljs-keyword">new</span>, head, head-&gt;next);<br>&#125;<br></code></pre></td></tr></table></figure><p>__list_add</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Insert a new entry between two known consecutive entries.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * This is only for internal list manipulation where we know</span><br><span class="hljs-comment"> * the prev/next entries already!</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">static</span> inline <span class="hljs-keyword">void</span> <span class="hljs-title function_">__list_add</span>(<span class="hljs-params">struct list_head *<span class="hljs-keyword">new</span>,</span><br><span class="hljs-params">         struct list_head *prev,</span><br><span class="hljs-params">         struct list_head *next</span>)<br>&#123;<br>   next-&gt;prev = <span class="hljs-keyword">new</span>;<br>   <span class="hljs-keyword">new</span>-&gt;next = next;<br>   <span class="hljs-keyword">new</span>-&gt;prev = prev;<br>   prev-&gt;next = <span class="hljs-keyword">new</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬å†ä»¥ç¤ºä¾‹è¡¥å……è¯´æ˜ï¼š</p><ul><li>é¦–å…ˆåˆ›å»ºä¸€ä¸ªé“¾è¡¨å¤´ï¼šlistHead</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-title function_">LIST_HEAD</span>(listHead);<br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/mengchao666/picture/main/blog5u9thd0jfz.png"></p><ul><li>ç„¶åå†åˆ›å»ºç¬¬ä¸€ä¸ªé“¾è¡¨èŠ‚ç‚¹ï¼š</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs javascript">struct my_data_list first_data =<br>&#123; <br>    .<span class="hljs-property">val</span> = <span class="hljs-number">1</span>,<br>    .<span class="hljs-property">list</span> = <span class="hljs-title function_">LIST_HEAD_INIT</span>(first_data.<span class="hljs-property">list</span>),<br>&#125;;<br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/mengchao666/picture/main/blogdgyqru9zqw.png"></p><ul><li>æ¥ç€ æŠŠè¿™ä¸ªèŠ‚ç‚¹æ’å…¥åˆ° listHead å</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-title function_">list_add</span>(&amp;frist_data.<span class="hljs-property">list</span>, &amp;listHead);<br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/mengchao666/picture/main/blogzysoo1ylwe.png"></p><ul><li>ç´§æ¥ç€æˆ‘ä»¬å†åˆ›å»ºç¬¬äºŒä¸ªèŠ‚ç‚¹ï¼š</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs javascript">struct my_data_list second_data =<br>&#123; <br>    .<span class="hljs-property">val</span> = <span class="hljs-number">2</span>,<br>    <span class="hljs-comment">/* ä¹Ÿå¯ä»¥è°ƒç”¨æ¥å£ åˆå§‹åŒ–*/</span><br>    .<span class="hljs-property">list</span> = <span class="hljs-title function_">LIST_HEAD_INIT</span>(second_data.<span class="hljs-property">list</span>),<br>&#125;;<br><br><span class="hljs-title function_">list_add</span>(&amp;second_data.<span class="hljs-property">list</span>, &amp;listHead);<br></code></pre></td></tr></table></figure><p>ç¤ºæ„å›¾å¦‚ä¸‹ï¼š</p><p><img src="https://raw.githubusercontent.com/mengchao666/picture/main/blogamryt0epan.png"></p><p>ä»¥æ­¤ç±»æ¨ï¼Œæ¯æ¬¡æ’å…¥ä¸€ä¸ªæ–°èŠ‚ç‚¹ï¼Œéƒ½æ˜¯ç´§é ç€headerèŠ‚ç‚¹ï¼Œè€Œä¹‹å‰æ’å…¥çš„èŠ‚ç‚¹ä¾æ¬¡æ’åºé åï¼Œé‚£æœ€åä¸€ä¸ªèŠ‚ç‚¹åˆ™æ˜¯ç¬¬ä¸€æ¬¡æ’å…¥headeråçš„é‚£ä¸ªèŠ‚ç‚¹ã€‚</p><p>å¯ä»¥çœ‹å‡ºï¼šå…ˆæ¥çš„èŠ‚ç‚¹é åï¼Œè€Œåæ¥çš„èŠ‚ç‚¹é å‰ï¼Œç¬¦åˆâ€œå…ˆè¿›åå‡ºï¼Œåè¿›å…ˆå‡ºâ€ã€‚æ‰€ä»¥æ­¤ç§ç»“æ„ç±»ä¼¼äº <strong>stackâ€œæ ˆâ€</strong> ï¼Œ ç±»ä¼¼äºå†…æ ¸stackä¸­çš„æ ˆé¡¶æŒ‡é’ˆespï¼Œ å®ƒéƒ½æ˜¯ç´§é ç€æœ€åpushåˆ°æ ˆçš„å…ƒç´ ã€‚</p><h4 id="2-list-add-tail"><a href="#2-list-add-tail" class="headerlink" title="(2)list_add_tail"></a>(2)list_add_tail</h4><p>å†çœ‹å†…æ ¸å¦å¤–ä¸€ç§æ’å…¥æ–¹å¼ï¼Œæœ¬è´¨éƒ½æ˜¯è°ƒç”¨__lis_addã€‚ä¸åŒçš„æ˜¯ï¼Œä¸€ä¸ªæ˜¯å¤´éƒ¨æ’å…¥ï¼Œä¸€ä¸ªæ˜¯å°¾éƒ¨æ’å…¥ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * list_add_tail - add a new entry</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@new</span>: new entry to be added</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@head</span>: list head to add it before</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Insert a new entry before the specified head.</span><br><span class="hljs-comment"> * This is useful for implementing queues.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">static</span> inline <span class="hljs-keyword">void</span> <span class="hljs-title function_">list_add_tail</span>(<span class="hljs-params">struct list_head *<span class="hljs-keyword">new</span>, struct list_head *head</span>)<br>&#123;<br>   <span class="hljs-title function_">__list_add</span>(<span class="hljs-keyword">new</span>, head-&gt;prev, head);<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬è¿˜æ˜¯ä»¥ç¤ºä¾‹è¾…åŠ©è¯´æ˜ï¼š</p><ul><li>é¦–å…ˆåˆ›å»ºä¸€ä¸ªé“¾è¡¨å¤´ï¼š</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-title function_">LIST_HEAD</span>(listHead);<br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/mengchao666/picture/main/blog5u9thd0jfz.png"></p><ul><li>ç„¶ååˆ›å»ºç¬¬ä¸€ä¸ªèŠ‚ç‚¹</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs javascript">struct my_data_list first_data =<br>&#123; <br>    .<span class="hljs-property">val</span> = <span class="hljs-number">1</span>,<br>    .<span class="hljs-property">list</span> = <span class="hljs-title function_">LIST_HEAD_INIT</span>(first_data.<span class="hljs-property">list</span>),<br>&#125;;<br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/mengchao666/picture/main/blogdgyqru9zqw.png"></p><ul><li>æ’å…¥ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ï¼š</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-title function_">list_add_tail</span>(&amp;first_data.<span class="hljs-property">list</span>, listHead);<br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/mengchao666/picture/main/blogq3n8hhap8i.png"></p><ul><li>ç´§æ¥ç€æ’å…¥ç¬¬äºŒä¸ªèŠ‚ç‚¹ï¼š</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs javascript">struct my_data_list second_data =<br>&#123; <br>    .<span class="hljs-property">val</span> = <span class="hljs-number">2</span>,<br>    <span class="hljs-comment">/* ä¹Ÿå¯ä»¥è°ƒç”¨æ¥å£ åˆå§‹åŒ–*/</span><br>    .<span class="hljs-property">list</span> = <span class="hljs-title function_">LIST_HEAD_INIT</span>(second_data.<span class="hljs-property">list</span>),<br>&#125;;<br><br><span class="hljs-title function_">list_add_tail</span>(&amp;second_data.<span class="hljs-property">list</span>, &amp;listHead);<br></code></pre></td></tr></table></figure><p>ç¤ºæ„å›¾å¦‚ä¸‹ï¼š</p><p><img src="https://raw.githubusercontent.com/mengchao666/picture/main/blog1srgg2q44x.png"></p><p>æ¯æ¬¡æ’å…¥çš„æ–°èŠ‚ç‚¹éƒ½æ˜¯ç´§æŒ¨ç€ header è¡¨å°¾ï¼Œè€Œæ’å…¥çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹æ’åœ¨äº†ç¬¬ä¸€ä½ï¼Œç¬¬äºŒä¸ªæ’åœ¨äº†ç¬¬äºŒä½ã€‚</p><p>å…ˆæ’å…¥çš„èŠ‚ç‚¹æ’åœ¨å‰é¢ï¼Œåæ’å…¥çš„èŠ‚ç‚¹æ’åœ¨åé¢ï¼Œâ€œå…ˆè¿›å…ˆå‡ºï¼Œåè¿›åå‡ºâ€ï¼ˆFirst in First out,<strong>FIFO</strong>ï¼‰ï¼è¿™ä¸å°±æ˜¯é˜Ÿåˆ—å—ï¼Ÿ</p><h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a><strong>æ€»ç»“</strong></h4><p>ç”±äºæ˜¯åŒå¾ªç¯é“¾è¡¨ï¼Œçœ‹èµ·æ¥å°¾éƒ¨æ’å…¥å’Œå¤´éƒ¨æ’å…¥æ˜¯ä¸€æ ·çš„ï¼Œå…¶å®ä¸ç„¶ã€‚</p><p>æˆ‘ä»¬å†æ¥å¯¹æ¯”å°¾éƒ¨å’Œå¤´éƒ¨æ’å…¥çš„åŒºåˆ«ï¼š</p><ul><li>å¤´éƒ¨æ’å…¥ï¼Œç»“æ„æ˜¯é€†åºï¼Œå±äºå…ˆè¿›åå‡ºï¼Œæœ€ä¸»è¦çš„åŒºåˆ«å°±æ˜¯å¤´èŠ‚ç‚¹çš„prevæŒ‡é’ˆæŒ‡å‘ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ã€‚</li><li>å°¾éƒ¨æ’å…¥ï¼Œç»“æ„æ˜¯é¡ºåºï¼Œå±äºFIFOç»“æ„ï¼Œæœ€ä¸»è¦çš„åŒºåˆ«å°±æ˜¯å¤´èŠ‚ç‚¹çš„nextæŒ‡é’ˆæŒ‡å‘ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ã€‚</li><li>list_addï¼šå¤´éƒ¨æ’å…¥ä¸€ä¸ªèŠ‚ç‚¹</li><li>list_add_tailï¼šå°¾éƒ¨æ’å…¥ä¸€ä¸ªèŠ‚ç‚¹</li></ul><h3 id="å››ã€åˆ é™¤èŠ‚ç‚¹"><a href="#å››ã€åˆ é™¤èŠ‚ç‚¹" class="headerlink" title="å››ã€åˆ é™¤èŠ‚ç‚¹"></a>å››ã€åˆ é™¤èŠ‚ç‚¹</h3><p>å†…æ ¸åŒæ ·å®šä¹‰äº†åˆ é™¤èŠ‚ç‚¹çš„æ¥å£ list_del</p><p>list_delï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">static</span> inline <span class="hljs-keyword">void</span> <span class="hljs-title function_">list_del</span>(<span class="hljs-params">struct list_head *entry</span>)<br>&#123;<br>    <span class="hljs-comment">/* __list_del_entry(entry) ä¹Ÿè¡Œ*/</span><br>   <span class="hljs-title function_">__list_del</span>(entry-&gt;prev, entry-&gt;next);<br>  <br>    <span class="hljs-comment">/* æŒ‡å‘ç‰¹å®šçš„ä½ç½®ï¼Œååˆå§‹åŒ– */</span><br>   entry-&gt;next = <span class="hljs-variable constant_">LIST_POISON1</span>;<br>   entry-&gt;prev = <span class="hljs-variable constant_">LIST_POISON2</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>__list_delï¼šè¿™ä¸ªæ¥å£ï¼Œæ ¹æ®prev&#x2F;next åˆ é™¤å…¶èŠ‚ç‚¹ï¼Œåˆ é™¤çš„èŠ‚ç‚¹å¿…é¡»æ˜¯å·²çŸ¥çš„å¹¶ä¸” prev å’Œ next ä¸ä¸ºç©º</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Delete a list entry by making the prev/next entries</span><br><span class="hljs-comment"> * point to each other.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * This is only for internal list manipulation where we know</span><br><span class="hljs-comment"> * the prev/next entries already!</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">static</span> inline <span class="hljs-keyword">void</span> <span class="hljs-title function_">__list_del</span>(<span class="hljs-params">struct list_head * prev, struct list_head * next</span>)<br>&#123;<br> next-&gt;prev = prev;<br> prev-&gt;next = next;<br>&#125;<br></code></pre></td></tr></table></figure><p>__list_del_entryï¼šåˆ é™¤ä¸€ä¸ªèŠ‚ç‚¹ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * list_del - deletes entry from list.</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@entry</span>: the element to delete from the list.</span><br><span class="hljs-comment"> * Note: list_empty() on entry does not return true after this, the entry is</span><br><span class="hljs-comment"> * in an undefined state.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">static</span> inline <span class="hljs-keyword">void</span> <span class="hljs-title function_">__list_del_entry</span>(<span class="hljs-params">struct list_head *entry</span>)<br>&#123;<br>   <span class="hljs-title function_">__list_del</span>(entry-&gt;prev, entry-&gt;next);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * list_del_init - deletes entry from list and reinitialize it.</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@entry</span>: the element to delete from the list.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">static</span> inline <span class="hljs-keyword">void</span> <span class="hljs-title function_">list_del_init</span>(<span class="hljs-params">struct list_head *entry</span>)<br>&#123;<br> <span class="hljs-title function_">__list_del_entry</span>(entry);<br> <span class="hljs-title function_">INIT_LIST_HEAD</span>(entry);<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>åˆ©ç”¨list_del(struct list_head *entry) æ¥å£å°±å¯ä»¥åˆ é™¤é“¾è¡¨ä¸­çš„ä»»æ„èŠ‚ç‚¹äº†ï¼Œéœ€æ³¨æ„ï¼Œå‰ææ¡ä»¶æ˜¯è¿™ä¸ªèŠ‚ç‚¹æ˜¯å·²çŸ¥çš„ï¼Œæ—¢åœ¨é“¾è¡¨ä¸­çœŸå®å­˜åœ¨ï¼Œåˆ‡prevï¼ŒnextæŒ‡é’ˆéƒ½ä¸ä¸ºNULLã€‚</li><li>è¢«å‰”é™¤ä¸‹æ¥çš„ my_data_list.listï¼Œprevã€next æŒ‡é’ˆåˆ†åˆ«è¢«è®¾ä¸º LIST_POSITION2å’ŒLIST_POSITION1ä¸¤ä¸ªç‰¹æ®Šå€¼ï¼Œè¿™æ ·è®¾ç½®æ˜¯ä¸ºäº†ä¿è¯ä¸åœ¨é“¾è¡¨ä¸­çš„èŠ‚ç‚¹é¡¹ä¸å¯è®¿é—®â€“å¯¹LIST_POSITION1å’ŒLIST_POSITION2çš„è®¿é—®éƒ½å°†å¼•èµ·é¡µæ•…éšœã€‚</li><li>ä¸ä¹‹ç›¸å¯¹åº”ï¼Œlist_del_init()å‡½æ•°å°†èŠ‚ç‚¹ä»é“¾è¡¨ä¸­è§£ä¸‹æ¥ä¹‹åï¼Œè°ƒç”¨LIST_INIT_HEAD()å°†èŠ‚ç‚¹ç½®ä¸ºç©ºé“¾çŠ¶æ€ã€‚</li></ul><blockquote><p>list_del() å’Œ list_del_init æ˜¯å¤–éƒ¨æ¥å£ã€‚__list_del() å’Œ __list_entry() æ˜¯å†…æ ¸å†…éƒ¨èŠ‚ç‚¹ã€‚ list_del() ä½œç”¨æ˜¯åˆ é™¤åŒé“¾è¡¨ä¸­çš„ä¸€ä¸ªèŠ‚ç‚¹ã€‚å¹¶å°†èŠ‚ç‚¹çš„prevå’Œnextéƒ½æŒ‡å‘ç‰¹å®šä½ç½®ï¼ŒLIST_POSITION1å’ŒLIST_POSITION2ã€‚ list_del_init() ä½œç”¨æ˜¯åˆ é™¤åŒé“¾è¡¨ä¸­çš„ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå¹¶å°†èŠ‚ç‚¹çš„prevå’Œnextéƒ½æŒ‡å‘è‡ªå·±ï¼Œå›åˆ°æœ€å¼€å§‹åˆ›å»ºèŠ‚ç‚¹å‰çš„çŠ¶æ€ã€‚</p></blockquote><h3 id="äº”ã€æ¬ç§»"><a href="#äº”ã€æ¬ç§»" class="headerlink" title="äº”ã€æ¬ç§»"></a>äº”ã€æ¬ç§»</h3><p>å†…æ ¸æä¾›äº†å°†åŸæœ¬å±äºä¸€ä¸ªé“¾è¡¨çš„èŠ‚ç‚¹ç§»åŠ¨åˆ°å¦ä¸€ä¸ªé“¾è¡¨çš„æ“ä½œï¼Œå¹¶æ ¹æ®æ’å…¥åˆ°æ–°é“¾è¡¨çš„ä½ç½®åˆ†ä¸ºä¸¤ç±»ï¼šå¤´éƒ¨æ¬ç§»å’Œå°¾éƒ¨æ¬ç§»ã€‚æ¬ç§»çš„æœ¬è´¨å°±æ˜¯åˆ é™¤åŠ æ’å…¥ã€‚</p><h4 id="å¤´éƒ¨æ¬ç§»"><a href="#å¤´éƒ¨æ¬ç§»" class="headerlink" title="å¤´éƒ¨æ¬ç§»"></a><strong>å¤´éƒ¨æ¬ç§»</strong></h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * list_move - delete from one list and add as another&#x27;s head</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@list</span>: the entry to move</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@head</span>: the head that will precede our entry</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">static</span> inline <span class="hljs-keyword">void</span> <span class="hljs-title function_">list_move</span>(<span class="hljs-params">struct list_head *list, struct list_head *head</span>)<br>&#123;<br>   <span class="hljs-title function_">__list_del_entry</span>(list);<br>   <span class="hljs-title function_">list_add</span>(list, head);<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="å°¾éƒ¨æ¬ç§»"><a href="#å°¾éƒ¨æ¬ç§»" class="headerlink" title="å°¾éƒ¨æ¬ç§»"></a><strong>å°¾éƒ¨æ¬ç§»</strong></h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * list_move_tail - delete from one list and add as another&#x27;s tail</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@list</span>: the entry to move</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@head</span>: the head that will follow our entry</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">static</span> inline <span class="hljs-keyword">void</span> <span class="hljs-title function_">list_move_tail</span>(<span class="hljs-params">struct list_head *list,</span><br><span class="hljs-params">      struct list_head *head</span>)<br>&#123;<br>   <span class="hljs-title function_">__list_del_entry</span>(list);<br>   <span class="hljs-title function_">list_add_tail</span>(list, head);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="å…­ã€åˆå¹¶"><a href="#å…­ã€åˆå¹¶" class="headerlink" title="å…­ã€åˆå¹¶"></a>å…­ã€åˆå¹¶</h3><p>å†…æ ¸è¿˜æä¾›ä¸¤ç»„åˆå¹¶æ“ä½œï¼Œå°†ä¸¤æ¡é“¾è¡¨åˆå¹¶åœ¨ä¸€èµ·ã€‚</p><p>å½“ list1 è¢«æŒ‚æ¥åˆ° list2 ä¹‹åï¼Œä½œä¸ºåŸè¡¨å¤´æŒ‡é’ˆçš„ list1 çš„nextã€prevä»ç„¶æŒ‡å‘åŸæ¥çš„èŠ‚ç‚¹ï¼Œä¸ºäº†é¿å…å¼•èµ·æ··ä¹±ï¼ŒLinuxæä¾›äº†ä¸€ä¸ªlist_splice_init()å‡½æ•°.è¯¥å‡½æ•°åœ¨å°†liståˆå¹¶åˆ°headé“¾è¡¨çš„åŸºç¡€ä¸Šï¼Œè°ƒç”¨INIT_LIST_HEAD(list)å°†listè®¾ç½®ä¸ºç©ºé“¾ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">static</span> inline <span class="hljs-keyword">void</span> <span class="hljs-title function_">list_splice</span>(<span class="hljs-keyword">const</span> struct list_head *list, struct list_head *head);<br><span class="hljs-keyword">static</span> inline <span class="hljs-keyword">void</span> <span class="hljs-title function_">list_splice_init</span>(struct list_head *list, struct list_head *head);<br><span class="hljs-keyword">static</span> inline <span class="hljs-keyword">void</span> <span class="hljs-title function_">list_splice_tail</span>(<span class="hljs-keyword">const</span> struct list_head *list, struct list_head *head);<br><span class="hljs-keyword">static</span> inline <span class="hljs-keyword">void</span> <span class="hljs-title function_">list_splice_tail_init</span>(struct list_head *list, struct list_head *head);<br></code></pre></td></tr></table></figure><p>ç¤ºæ„å›¾å¦‚ä¸‹ï¼š</p><p><img src="https://raw.githubusercontent.com/mengchao666/picture/main/blog7twpttdv04.png"></p><p>å¦å¤–ä¸€ç§æ–¹å¼ç±»ä¼¼ï¼Œåªä¸è¿‡åˆå¹¶æ—¶æ–­å¼€çš„ä½ç½®æœ‰æ‰€ä¸åŒ</p><h3 id="ä¸ƒã€æ›¿æ¢"><a href="#ä¸ƒã€æ›¿æ¢" class="headerlink" title="ä¸ƒã€æ›¿æ¢"></a>ä¸ƒã€æ›¿æ¢</h3><p>å†…æ ¸è¿˜æä¾›ä¸€ç»„æ›¿æ¢é“¾è¡¨èŠ‚ç‚¹çš„æ“ä½œã€‚list_replaceï¼šå°†æ–°çš„èŠ‚ç‚¹æ›¿æ¢åˆ°æ—§çš„èŠ‚ç‚¹ä¸Šã€‚list_replace_initï¼šå°†æ–°çš„èŠ‚ç‚¹æ›¿æ¢åˆ°æ—§çš„èŠ‚ç‚¹ä¸Šã€‚åŒæ—¶å°†æ—§çš„èŠ‚ç‚¹çš„prevå’ŒnextæŒ‡å‘è‡ªå·±ï¼Œååˆå§‹åŒ–</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">static</span> inline <span class="hljs-keyword">void</span> <span class="hljs-title function_">list_replace</span>(struct list_head *old, struct list_head *<span class="hljs-keyword">new</span>);<br><span class="hljs-keyword">static</span> inline <span class="hljs-keyword">void</span> <span class="hljs-title function_">list_replace_init</span>(struct list_head *old, struct list_head *<span class="hljs-keyword">new</span>);<br></code></pre></td></tr></table></figure><h3 id="å…«ã€éå†æ“ä½œ"><a href="#å…«ã€éå†æ“ä½œ" class="headerlink" title="å…«ã€éå†æ“ä½œ"></a>å…«ã€éå†æ“ä½œ</h3><p>å†…æ ¸æä¾›äº†ä¸€ç»„å®è¿›è¡Œéå†æ“ä½œã€‚ç»è¿‡ä¸€ç³»åˆ—çš„å¢åˆ å‡æ”¹æ“ä½œï¼Œæˆ‘ä»¬ç»ˆäºåˆ°äº†éå†çš„æ—¶å€™ã€‚</p><h4 id="list-entry-å®"><a href="#list-entry-å®" class="headerlink" title="list_entry å®"></a><strong>list_entry å®</strong></h4><p>é‡å¤´æˆæ¥äº†ï¼Œéå†çš„å…³é”®å°±æ˜¯è¿™ä¸ªlist_entryå®ã€‚æœ¬è´¨å°±æ˜¯container_ofå®ã€‚</p><p>å…·ä½“åˆ†æè§ä¸Šä¸€ç¯‡æ–‡ç« ã€‚è¿™ä¸ªå®çš„ä¸»è¦ä½œç”¨å°±æ˜¯è·å–å®¿ä¸»ç»“æ„çš„æŒ‡é’ˆåœ°å€ã€‚</p><p>å‰æ–‡æåˆ°ï¼Œæˆ‘ä»¬æ˜¯ä»¥list æŒ‡é’ˆä¸ºèŠ‚ç‚¹ç»„æˆçš„ä¸€æ¡åŒé“¾è¡¨ï¼Œéå†çš„è¿‡ç¨‹ä¸­åªèƒ½å¾—åˆ°listçš„åœ°å€ï¼Œé‚£ä¹ˆå¯¹äºå…¶æ‰€æœ‰è€…åœ°å€å°±æ˜¯é€šè¿‡è¿™ä¸ªå®è·å–çš„ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">/**</span><br><span class="hljs-comment">* list_entry - get the struct for this entry</span><br><span class="hljs-comment">* <span class="hljs-doctag">@ptr</span>: the &amp;struct list_head pointer.</span><br><span class="hljs-comment">* <span class="hljs-doctag">@type</span>: the type of the struct this is embedded in.</span><br><span class="hljs-comment">* <span class="hljs-doctag">@member</span>: the name of the list_struct within the struct.</span><br><span class="hljs-comment">*/</span><br>#define <span class="hljs-title function_">list_entry</span>(ptr, type, member) \<br>   <span class="hljs-title function_">container_of</span>(ptr, type, member)<br></code></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">/* æ ¹æ®list å€’æ¨ my_list_data*/</span><br><span class="hljs-title function_">list_entry</span>(&amp;my_list_data.<span class="hljs-property">list</span>, <span class="hljs-title function_">typeof</span>(&amp;my_list_data), list)<br></code></pre></td></tr></table></figure><h4 id="list-for-each"><a href="#list-for-each" class="headerlink" title="list_for_each"></a><strong>list_for_each</strong></h4><p>list_for_each å®ƒå®é™…ä¸Šæ˜¯ä¸€ä¸ªforå¾ªç¯ï¼Œåˆ©ç”¨ä¼ å…¥çš„posä½œä¸ºå¾ªç¯å˜é‡ï¼Œä»è¡¨å¤´headå¼€å§‹ï¼Œé€é¡¹å‘åï¼ˆnextæ–¹å‘ï¼‰ç§»åŠ¨posï¼Œç›´è‡³åˆå›åˆ°head</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * list_for_each - iterate over a list</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@pos</span>: the &amp;struct list_head to use as a loop cursor.</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@head</span>: the head for your list.</span><br><span class="hljs-comment"> */</span><br>#define <span class="hljs-title function_">list_for_each</span>(pos, head) \<br> <span class="hljs-keyword">for</span> (pos = (head)-&gt;next; pos != (head); pos = pos-&gt;next)<br></code></pre></td></tr></table></figure><h4 id="list-for-each-entry"><a href="#list-for-each-entry" class="headerlink" title="list_for_each_entry"></a><strong>list_for_each_entry</strong></h4><p>éå†æ¯ä¸€ä¸ªlist,ç„¶åè·å–å…¶å®¿ä¸»ç»“æ„åœ°å€ã€‚<br>&#x3D;&#x3D;posä¸€èˆ¬æ˜¯æ–°å»ºä¸€ä¸ªé“¾è¡¨ï¼Œä¼ å…¥ï¼Œç”¨äºforå¾ªç¯éå†ï¼Œheadä¸€èˆ¬æ˜¯å¾…éå†çš„é“¾è¡¨ï¼Œmemberæ˜¯ä¼ å…¥çš„posä¸­çš„list_headå¯¹åº”çš„æˆå‘˜&#x3D;&#x3D;</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * list_for_each_entry - iterate over list of given type</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@pos</span>: the type * to use as a loop cursor.</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@head</span>: the head for your list.</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@member</span>: the name of the list_struct within the struct.</span><br><span class="hljs-comment"> */</span><br>#define <span class="hljs-title function_">list_for_each_entry</span>(pos, head, member)    \<br> <span class="hljs-keyword">for</span> (pos = <span class="hljs-title function_">list_entry</span>((head)-&gt;next, <span class="hljs-title function_">typeof</span>(*pos), member); \<br>      &amp;pos-&gt;member != (head);  \<br>      pos = <span class="hljs-title function_">list_entry</span>(pos-&gt;member.<span class="hljs-property">next</span>, <span class="hljs-title function_">typeof</span>(*pos), member))<br></code></pre></td></tr></table></figure><h4 id="list-for-each-prev"><a href="#list-for-each-prev" class="headerlink" title="list_for_each_prev"></a><strong>list_for_each_prev</strong></h4><p>åå‘éå†å¾—åˆ°list.</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * list_for_each_prev - iterate over a list backwards</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@pos</span>: the &amp;struct list_head to use as a loop cursor.</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@head</span>: the head for your list.</span><br><span class="hljs-comment"> */</span><br>#define <span class="hljs-title function_">list_for_each_prev</span>(pos, head) \<br> <span class="hljs-keyword">for</span> (pos = (head)-&gt;prev; pos != (head); pos = pos-&gt;prev)<br></code></pre></td></tr></table></figure><h4 id="list-for-each-entry-reverse"><a href="#list-for-each-entry-reverse" class="headerlink" title="list_for_each_entry_reverse"></a><strong>list_for_each_entry_reverse</strong></h4><p>åå‘éå†å¾—åˆ°list,ç„¶åè·å–å…¶å®¿ä¸»ç»“æ„åœ°å€ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">/**</span><br><span class="hljs-comment">* list_for_each_entry_reverse - iterate backwards over list of given type.</span><br><span class="hljs-comment">* <span class="hljs-doctag">@pos</span>: the type * to use as a loop cursor.</span><br><span class="hljs-comment">* <span class="hljs-doctag">@head</span>: the head for your list.</span><br><span class="hljs-comment">* <span class="hljs-doctag">@member</span>: the name of the list_struct within the struct.</span><br><span class="hljs-comment">*/</span><br>#define <span class="hljs-title function_">list_for_each_entry_reverse</span>(pos, head, member)   \<br>   <span class="hljs-keyword">for</span> (pos = <span class="hljs-title function_">list_entry</span>((head)-&gt;prev, <span class="hljs-title function_">typeof</span>(*pos), member); \<br>        &amp;pos-&gt;member != (head);  \<br>        pos = <span class="hljs-title function_">list_entry</span>(pos-&gt;member.<span class="hljs-property">prev</span>, <span class="hljs-title function_">typeof</span>(*pos), member))<br></code></pre></td></tr></table></figure><h3 id="ä¹ã€æ€»ç»“"><a href="#ä¹ã€æ€»ç»“" class="headerlink" title="ä¹ã€æ€»ç»“"></a>ä¹ã€æ€»ç»“</h3><p>æœ¬æ–‡è¯¦ç»†åˆ†æäº† linux å†…æ ¸ ä¸­çš„åŒé“¾è¡¨ç»“æ„ï¼Œä»¥å›¾æ–‡çš„æ–¹å¼æ—¨åœ¨å¸®åŠ©å¤§å®¶ç†è§£ã€‚</p><p>å½“ç„¶è¿˜æœ‰å¾ˆå¤šæ¥å£é™äºç¯‡å¹…æ²¡æœ‰ä»‹ç»ï¼Œæœ¬æ–‡åªåˆ—å‡ºäº†å¸¸ç”¨äº†æ¥å£ï¼Œç›¸ä¿¡åªè¦ç†è§£äº†å‰é¢åŒé“¾è¡¨çš„ç»„æˆå’Œæ’å…¥è¿‡ç¨‹ï¼Œåé¢çš„åˆ é™¤å’Œéå†å°±è‡ªç„¶è€Œç„¶é€šäº†ã€‚</p><p><img src="https://raw.githubusercontent.com/mengchao666/picture/main/blogsakrwx0yw5.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;åœ¨Linuxå†…æ ¸ä¸­ä½¿ç”¨äº†å¤§é‡çš„é“¾è¡¨ç»“æ„æ¥ç»„ç»‡æ•°æ®ï¼ŒåŒ…æ‹¬è®¾å¤‡åˆ—è¡¨ä»¥åŠå„ç§åŠŸèƒ½æ¨¡å—ä¸­çš„æ•°æ®ç»„ç»‡ã€‚è¿™äº›é“¾è¡¨å¤§å¤šé‡‡ç”¨åœ¨include&amp;#x2F;linux&amp;#x2F;list.hå®ç°çš„ä¸€ä¸ªç›¸å½“ç²¾å½©çš„é“¾è¡¨æ•°æ®ç»“æ„ã€‚äº‹å®ä¸Šï¼Œå†…æ ¸é“¾è¡¨å°±æ˜¯é‡‡ç”¨åŒå¾ªç¯é“¾è¡¨æœºåˆ¶ã€‚&lt;/p&gt;
&lt;p&gt;å†…æ ¸é“¾è¡¨æœ‰åˆ«äº</summary>
      
    
    
    
    <category term="kernel" scheme="http://example.com/categories/kernel/"/>
    
    
    <category term="kernel" scheme="http://example.com/tags/kernel/"/>
    
  </entry>
  
  <entry>
    <title>offset_ofå’Œcontainer_ofå®</title>
    <link href="http://example.com/posts/offset-of%E5%92%8Ccontainer-of%E5%AE%8F.html"/>
    <id>http://example.com/posts/offset-of%E5%92%8Ccontainer-of%E5%AE%8F.html</id>
    <published>2024-11-25T14:51:03.000Z</published>
    <updated>2024-11-25T14:51:27.975Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ä¸€ã€container-of-å®ä»‹ç»"><a href="#ä¸€ã€container-of-å®ä»‹ç»" class="headerlink" title="ä¸€ã€container_of å®ä»‹ç»"></a>ä¸€ã€container_of å®ä»‹ç»</h2><p>åˆ°è¿™é‡Œå‡è®¾å¤§å®¶éƒ½æ‡‚äº† <strong>typeof</strong> å’Œ <strong>è¯­å¥è¡¨è¾¾å¼</strong>ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¼€å§‹ä¸€ç¹ Linux å†…æ ¸ç¬¬ä¸€å® container_of çš„èŠ³å®¹å§ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-meta">#<span class="hljs-keyword">define</span> offsetof(TYPE, MEMBER) ((size_t) &amp;((TYPE *)0)-&gt;MEMBER)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> container_of(ptr, type, member) (&#123; \</span><br><span class="hljs-meta">    const typeof( ((type *)0)-&gt;member ) *__mptr = (ptr); \</span><br><span class="hljs-meta">    (type *)( (char *)__mptr - offsetof(type,member) );&#125;)</span><br></code></pre></td></tr></table></figure><p>ä½œä¸º Linux å†…æ ¸ç¬¬ä¸€ä¸ªå®ï¼Œç»å¯¹æ˜¯å®è‡³åå½’çš„ï¼Œçœ‹çœ‹å®ƒå¤–è¡¨æ–¯æ–‡è€Œå†…è—å…«å—è…¹è‚Œçš„èº«å½¢ï¼Œå°±çŸ¥é“å®ƒæ˜¯ä¸å¥½æƒ¹çš„ã€‚å®ä¸­æœ‰å®ï¼Œä½œä¸º GNU C é«˜ç«¯æ‰©å±•ç‰¹æ€§çš„ç»¼åˆè¿ç”¨ï¼Œé‚£ä¹ˆå®ƒæœ‰ä»€ä¹ˆä½œç”¨å‘¢ï¼Ÿå®ƒçš„ä¸»è¦<strong>ä½œç”¨</strong>æ˜¯ï¼š<strong>æ ¹æ®ç»“æ„ä½“æŸä¸€æˆå‘˜çš„åœ°å€ï¼Œè·å–è¿™ä¸ªç»“æ„ä½“çš„é¦–åœ°å€ã€‚</strong> æ ¹æ®å®å®šä¹‰ï¼Œå¯çŸ¥è¿™ä¸ªå®æœ‰ä¸‰ä¸ªå‚æ•°ï¼š</p><ul><li>ptrï¼šç»“æ„ä½“å†…æˆå‘˜ member çš„åœ°å€</li><li>typeï¼šç»“æ„ä½“ç±»å‹</li><li>memberï¼šç»“æ„ä½“å†…çš„æˆå‘˜</li></ul><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“æˆ‘ä»¬çŸ¥é“äº†ä¸€ä¸ªç»“æ„ä½“çš„ç±»å‹ï¼Œç»“æ„ä½“å†…æŸä¸€æˆå‘˜çš„åœ°å€ï¼Œä¹Ÿå°±å¯ä»¥ç›´æ¥è·å¾—åˆ°è¿™ä¸ªç»“æ„ä½“çš„é¦–åœ°å€ã€‚container_of å®è¿”å›çš„å°±æ˜¯è¿™ä¸ªç»“æ„ä½“çš„é¦–åœ°å€ã€‚</p><h2 id="äºŒã€container-of-å®çš„ä½¿ç”¨ç¤ºä¾‹"><a href="#äºŒã€container-of-å®çš„ä½¿ç”¨ç¤ºä¾‹" class="headerlink" title="äºŒã€container_of å®çš„ä½¿ç”¨ç¤ºä¾‹"></a>äºŒã€container_of å®çš„ä½¿ç”¨ç¤ºä¾‹</h2><p>è¿™ä¸ªå®åœ¨å†…æ ¸ä¸­éå¸¸é‡è¦ã€‚åœ¨å†…æ ¸ä¸­ä¼šç»å¸¸æœ‰è¿™æ ·çš„éœ€æ±‚ï¼šæˆ‘ä»¬ä¼ é€’ç»™æŸä¸ªå‡½æ•°çš„å‚æ•°æ˜¯æŸä¸ªç»“æ„ä½“çš„æˆå‘˜å˜é‡ï¼Œç„¶ååœ¨è¿™ä¸ªå‡½æ•°ä¸­ï¼Œå¯èƒ½è¿˜ä¼šç”¨åˆ°æ­¤ç»“æ„ä½“çš„å…¶å®ƒæˆå‘˜å˜é‡ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™æ€ä¹ˆåŠå‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ container_of å…ˆé€šè¿‡ç»“æ„ä½“æŸä¸€æˆå‘˜çš„è®¿é—®æ‰¾åˆ°è¿™ä¸ªç»“æ„ä½“çš„é¦–åœ°å€ï¼Œç„¶åå°±å¯ä»¥è®¿é—®å…¶å®ƒæˆå‘˜å˜é‡äº†ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">box_t</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">double</span> length;   <span class="hljs-comment">// ç›’å­çš„é•¿åº¦</span><br>    <span class="hljs-type">double</span> breadth;  <span class="hljs-comment">// ç›’å­çš„å®½åº¦</span><br>    <span class="hljs-type">double</span> height;   <span class="hljs-comment">// ç›’å­çš„é«˜åº¦</span><br>&#125;;<br> <br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">box_t</span> <span class="hljs-title">box</span> =</span> &#123;<span class="hljs-number">30.0</span>, <span class="hljs-number">20.0</span>, <span class="hljs-number">10.0</span>&#125;;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">box_t</span> *<span class="hljs-title">p_box</span> =</span> <span class="hljs-literal">NULL</span>;<br> <br>    p_box = container_of(&amp;box.height, <span class="hljs-keyword">struct</span> <span class="hljs-type">_box_t</span>, height);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%p\n&quot;</span>, p_box);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;length: %f\n&quot;</span>, p_box-&gt;length);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;breadth: %f\n&quot;</span>, p_box-&gt;breadth);<br> <br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªç¨‹åºä¸­ï¼Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªç»“æ„ä½“å˜é‡ boxï¼ŒçŸ¥é“äº†å®ƒçš„æˆå‘˜å˜é‡ height çš„åœ°å€ &amp;box.heightï¼Œå°±å¯ä»¥é€šè¿‡ container_of å®ç›´æ¥è·å¾— box ç»“æ„ä½“å˜é‡çš„é¦–åœ°å€ï¼Œç„¶åç›´æ¥è®¿é—® box ç»“æ„ä½“çš„å…¶å®ƒæˆå‘˜ p_box-&gt;length å’Œ p_box-&gt;breadthã€‚</p><h2 id="ä¸‰ã€container-of-å®å®ç°åŸç†åˆ†æ"><a href="#ä¸‰ã€container-of-å®å®ç°åŸç†åˆ†æ" class="headerlink" title="ä¸‰ã€container_of å®å®ç°åŸç†åˆ†æ"></a>ä¸‰ã€container_of å®å®ç°åŸç†åˆ†æ</h2><p>container_of å®çš„å®ç°ä¸»è¦ç”¨åˆ°çš„çŸ¥è¯†ä¸ºï¼šè¯­å¥è¡¨è¾¾å¼å’Œ typeofï¼Œå†åŠ ä¸Šç»“æ„ä½“å­˜å‚¨çš„åŸºç¡€çŸ¥è¯†ã€‚ä¸ºäº†å¸®åŠ©å¤§å®¶æ›´å¥½åœ°ç†è§£è¿™ä¸ªå®ï¼Œæˆ‘ä»¬å…ˆå¤ä¹ ä¸‹ç»“æ„ä½“å­˜å‚¨çš„åŸºç¡€çŸ¥è¯†ã€‚</p><h3 id="3-1-ç»“æ„ä½“åœ¨å†…å­˜ä¸­çš„å­˜å‚¨"><a href="#3-1-ç»“æ„ä½“åœ¨å†…å­˜ä¸­çš„å­˜å‚¨" class="headerlink" title="3.1 ç»“æ„ä½“åœ¨å†…å­˜ä¸­çš„å­˜å‚¨"></a>3.1 ç»“æ„ä½“åœ¨å†…å­˜ä¸­çš„å­˜å‚¨</h3><p>æˆ‘ä»¬çŸ¥é“ï¼Œç»“æ„ä½“ä½œä¸ºä¸€ä¸ªå¤åˆç±»å‹æ•°æ®ï¼Œå®ƒé‡Œé¢å¯ä»¥æœ‰å¤šä¸ªæˆå‘˜ã€‚å½“æˆ‘ä»¬å®šä¹‰ä¸€ä¸ªç»“æ„ä½“å˜é‡æ—¶ï¼Œç¼–è¯‘å™¨è¦ç»™è¿™ä¸ªå˜é‡åœ¨å†…å­˜ä¸­åˆ†é…å­˜å‚¨ç©ºé—´ã€‚é™¤äº†è€ƒè™‘æ•°æ®ç±»å‹ã€å­—èŠ‚å¯¹é½ç­‰å› ç´ ä¹‹å¤–ï¼Œç¼–è¯‘å™¨ä¼šæŒ‰ç…§ç»“æ„ä½“ä¸­å„ä¸ªæˆå‘˜çš„é¡ºåºï¼Œåœ¨å†…å­˜ä¸­åˆ†é…ä¸€ç‰‡è¿ç»­çš„ç©ºé—´æ¥å­˜å‚¨å®ƒä»¬ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">box_t</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">double</span> length;   <span class="hljs-comment">// ç›’å­çš„é•¿åº¦</span><br>    <span class="hljs-type">double</span> breadth;  <span class="hljs-comment">// ç›’å­çš„å®½åº¦</span><br>    <span class="hljs-type">double</span> height;   <span class="hljs-comment">// ç›’å­çš„é«˜åº¦</span><br>&#125;;<br> <br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">box_t</span> <span class="hljs-title">box</span> =</span> &#123;<span class="hljs-number">30.0</span>, <span class="hljs-number">20.0</span>, <span class="hljs-number">10.0</span>&#125;;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;&amp;box = %p\n&quot;</span>, &amp;box);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;&amp;box.length = %p\n&quot;</span>, &amp;box.length);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;&amp;box.breadth = %p\n&quot;</span>, &amp;box.breadth);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;&amp;box.height = %p\n&quot;</span>, &amp;box.height);<br> <br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªç¨‹åºä¸­ï¼Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªç»“æ„ä½“ï¼Œé‡Œé¢æœ‰ä¸‰ä¸ª double å‹æ•°æ®æˆå‘˜ï¼Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªå˜é‡ï¼Œç„¶ååˆ†åˆ«æ‰“å°ç»“æ„ä½“çš„åœ°å€ã€å„ä¸ªæˆå‘˜å˜é‡çš„åœ°å€ï¼Œè¿è¡Œç»“æœå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs C">&amp;box         = <span class="hljs-number">2b</span>6c3dd0<br>&amp;box.length  = <span class="hljs-number">2b</span>6c3dd0<br>&amp;box.breadth = <span class="hljs-number">2b</span>6c3dd8<br>&amp;box.height  = <span class="hljs-number">2b</span>6c3de0<br></code></pre></td></tr></table></figure><p>ä»è¿è¡Œç»“æœæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œç»“æ„ä½“ä¸­çš„æ¯ä¸ªæˆå‘˜å˜é‡ï¼Œä»ç»“æ„ä½“é¦–åœ°å€å¼€å§‹ï¼Œä¾æ¬¡å­˜æ”¾ã€‚æ¯ä¸ªæˆå‘˜å˜é‡ç›¸å¯¹äºç»“æ„ä½“é¦–åœ°å€ï¼Œéƒ½æœ‰ä¸€ä¸ªå›ºå®šåç§»ã€‚æ¯”å¦‚ breadth ç›¸å¯¹äºç»“æ„ä½“é¦–åœ°å€åç§»äº†8ä¸ªå­—èŠ‚ã€‚height çš„å­˜å‚¨åœ°å€ï¼Œç›¸å¯¹äºç»“æ„ä½“é¦–åœ°å€åç§»äº†16ä¸ªå­—èŠ‚ã€‚</p><h3 id="3-2-è®¡ç®—æˆå‘˜å˜é‡åœ¨ç»“æ„ä½“å†…çš„åç§»"><a href="#3-2-è®¡ç®—æˆå‘˜å˜é‡åœ¨ç»“æ„ä½“å†…çš„åç§»" class="headerlink" title="3.2 è®¡ç®—æˆå‘˜å˜é‡åœ¨ç»“æ„ä½“å†…çš„åç§»"></a>3.2 è®¡ç®—æˆå‘˜å˜é‡åœ¨ç»“æ„ä½“å†…çš„åç§»</h3><p>ä¸€ä¸ªç»“æ„ä½“æ•°æ®ç±»å‹ï¼Œåœ¨åŒä¸€ä¸ªç¼–è¯‘ç¯å¢ƒä¸‹ï¼Œå„ä¸ªæˆå‘˜ç›¸å¯¹äºç»“æ„ä½“é¦–åœ°å€çš„åç§»æ˜¯å›ºå®šçš„ã€‚æˆ‘ä»¬å¯ä»¥ä¿®æ”¹ä¸€ä¸‹ä¸Šé¢çš„ç¨‹åºï¼Œå½“ç»“æ„ä½“çš„é¦–åœ°å€ä¸º 0 æ—¶ï¼Œç»“æ„ä½“ä¸­çš„å„æˆå‘˜åœ°å€åœ¨æ•°å€¼ä¸Šç­‰äºç»“æ„ä½“å„æˆå‘˜ç›¸å¯¹äºç»“æ„ä½“é¦–åœ°å€çš„åç§»ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">box_t</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">double</span> length;   <span class="hljs-comment">// ç›’å­çš„é•¿åº¦</span><br>    <span class="hljs-type">double</span> breadth;  <span class="hljs-comment">// ç›’å­çš„å®½åº¦</span><br>    <span class="hljs-type">double</span> height;   <span class="hljs-comment">// ç›’å­çš„é«˜åº¦</span><br>&#125;;<br> <br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;&amp;length = %p\n&quot;</span>, &amp;((<span class="hljs-keyword">struct</span> <span class="hljs-type">_box_t</span>*)<span class="hljs-number">0</span>)-&gt;length);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;&amp;breadth = %p\n&quot;</span>, &amp;((<span class="hljs-keyword">struct</span> <span class="hljs-type">_box_t</span>*)<span class="hljs-number">0</span>)-&gt;breadth);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;&amp;height = %p\n&quot;</span>, &amp;((<span class="hljs-keyword">struct</span> <span class="hljs-type">_box_t</span>*)<span class="hljs-number">0</span>)-&gt;height);<br> <br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨ä¸Šé¢çš„ç¨‹åºä¸­ï¼Œæˆ‘ä»¬æ²¡æœ‰ç›´æ¥å®šä¹‰ç»“æ„ä½“å˜é‡ï¼Œè€Œæ˜¯å°†æ•°å­— 0 é€šè¿‡å¼ºåˆ¶ç±»å‹è½¬æ¢ï¼Œè½¬æ¢ä¸ºä¸€ä¸ªæŒ‡å‘ç»“æ„ä½“ç±»å‹ä¸º _box_t çš„å¸¸é‡æŒ‡é’ˆï¼Œç„¶ååˆ†åˆ«æ‰“å°è¿™ä¸ªå¸¸é‡æŒ‡é’ˆæŒ‡å‘çš„ç»“æ„ä½“çš„å„æˆå‘˜åœ°å€ã€‚è¿è¡Œç»“æœå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs C">&amp;length  = ox0<br>&amp;breadth = <span class="hljs-number">0x8</span><br>&amp;height  = <span class="hljs-number">0x10</span><br></code></pre></td></tr></table></figure><p>å› ä¸ºå¸¸é‡æŒ‡é’ˆä¸º 0ï¼Œå³å¯ä»¥çœ‹åšç»“æ„ä½“é¦–åœ°å€ä¸º 0ï¼Œæ‰€ä»¥ç»“æ„ä½“ä¸­æ¯ä¸ªæˆå‘˜å˜é‡çš„åœ°å€å³ä¸ºè¯¥æˆå‘˜ç›¸å¯¹äºç»“æ„ä½“é¦–åœ°å€çš„åç§»ã€‚container_of å®çš„å®ç°å°±æ˜¯ä½¿ç”¨è¿™ä¸ªæŠ€å·§æ¥å®ç°çš„ã€‚</p><h3 id="3-3-container-of-å®çš„åŸç†å®ç°"><a href="#3-3-container-of-å®çš„åŸç†å®ç°" class="headerlink" title="3.3 container_of å®çš„åŸç†å®ç°"></a>3.3 container_of å®çš„åŸç†å®ç°</h3><p>container_of å®æ•´ä½“çš„å®ç°åŸç†å¦‚å›¾æ‰€ç¤ºï¼š</p><p><img src="https://hwwyaazvtut.feishu.cn/space/api/box/stream/download/asynccode/?code=NmE5MjNhZmIyZjQ1NjgzNzBlZTc4ZWZjMjM2YTBkMjBfZnpWTktHSDJWMWxTY0p4ckgzWjdwSkhSSXl1T0ZTbXNfVG9rZW46VU8zVmJpaTUzb2hZS2R4N1hCNGNWRVp5bmloXzE3MjEyMzAyNTU6MTcyMTIzMzg1NV9WNA"></p><p>ä»è¯­æ³•è§’åº¦æ¥çœ‹ï¼Œcontainer_of å®çš„å®ç°ç”±ä¸€ä¸ªè¯­å¥è¡¨è¾¾å¼æ„æˆï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-meta">#<span class="hljs-keyword">define</span> offsetof(TYPE, MEMBER) ((size_t) &amp;((TYPE *)0)-&gt;MEMBER)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> container_of(ptr, type, member) (&#123; \</span><br><span class="hljs-meta">    const typeof( ((type *)0)-&gt;member ) *__mptr = (ptr); \</span><br><span class="hljs-meta">    (type *)( (char *)__mptr - offsetof(type,member) );&#125;)</span><br></code></pre></td></tr></table></figure><p><strong>è¯­å¥è¡¨è¾¾å¼çš„å€¼å³ä¸ºæœ€åä¸€ä¸ªè¡¨è¾¾å¼çš„å€¼</strong>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs C">(type *)( (<span class="hljs-type">char</span> *)__mptr - offsetof(type,member) );<br></code></pre></td></tr></table></figure><p>ä»¥ä¸Šè¿™ä¸ªè¯­å¥çš„æ„ä¹‰å°±æ˜¯ï¼Œæ‹¿ç»“æ„ä½“æŸä¸ªæˆå‘˜ member çš„åœ°å€ï¼Œå‡å»è¿™ä¸ªæˆå‘˜åœ¨ç»“æ„ä½“ type ä¸­çš„åç§»ï¼Œç»“æœå°±æ˜¯ç»“æ„ä½“ type çš„é¦–åœ°å€ã€‚å› ä¸ºè¯­å¥è¡¨è¾¾å¼çš„å€¼ç­‰äºæœ€åä¸€ä¸ªè¡¨è¾¾å¼çš„å€¼ï¼Œæ‰€ä»¥è¿™ä¸ªç»“æœä¹Ÿæ˜¯æ•´ä¸ªè¯­å¥è¡¨è¾¾å¼çš„å€¼ï¼Œcontainer_of æœ€åå°±ä¼šè¿”å›è¿™ä¸ªåœ°å€å€¼ç»™å®çš„è°ƒç”¨è€…ã€‚</p><p>å†…æ ¸ä¸­å®šä¹‰äº† offset å®æ¥è®¡ç®—ç»“æ„ä½“æŸä¸ªæˆå‘˜åœ¨ç»“æ„ä½“å†…çš„åç§»ï¼Œå®ƒçš„å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-meta">#<span class="hljs-keyword">define</span> offsetof(TYPE, MEMBER) ((size_t) &amp;((TYPE *)0)-&gt;MEMBER)</span><br></code></pre></td></tr></table></figure><p>è¿™ä¸ªå®æœ‰ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯ç»“æ„ä½“ç±»å‹ TYPEï¼Œä¸€ä¸ªæ˜¯ç»“æ„ä½“çš„æˆå‘˜ MEMBERï¼Œå®ƒä½¿ç”¨çš„æŠ€å·§è·Ÿæˆ‘ä»¬ä¸Šé¢è®¡ç®— 0 åœ°å€å¸¸é‡æŒ‡é’ˆçš„åç§»æ˜¯ä¸€æ ·çš„ï¼šå°† 0 å¼ºåˆ¶è½¬æ¢ä¸ºä¸€ä¸ªæŒ‡å‘ TYPE çš„ç»“æ„ä½“å¸¸é‡æŒ‡é’ˆï¼Œç„¶åé€šè¿‡è¿™ä¸ªå¸¸é‡æŒ‡é’ˆè®¿é—®æˆå‘˜ï¼Œè·å–æˆå‘˜ MEMBER çš„åœ°å€ï¼Œå…¶å¤§å°åœ¨æ•°å€¼ä¸Šå°±ç­‰äº MEMBER åœ¨ç»“æ„ä½“ TYPE ä¸­çš„åç§»ã€‚</p><p>å› ä¸ºç»“æ„ä½“çš„æˆå‘˜æ•°æ®ç±»å‹å¯ä»¥æ˜¯ä»»æ„æ•°æ®ç±»å‹ï¼Œæ‰€ä»¥ä¸ºäº†è®©è¿™ä¸ªå®å…¼å®¹å„ç§æ•°æ®ç±»å‹ã€‚æˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªä¸´æ—¶æŒ‡é’ˆå˜é‡ __mptr ï¼Œè¯¥å˜é‡ç”¨æ¥å­˜å‚¨ç»“æ„ä½“æˆå‘˜ MEMBER çš„åœ°å€ï¼Œå³å­˜å‚¨ ptr çš„å€¼ã€‚é‚£ä¹ˆå¦‚ä½•è·å– ptr æŒ‡é’ˆç±»å‹å‘¢ï¼Ÿé€šè¿‡ä¸‹é¢çš„æ–¹å¼ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-keyword">typeof</span>( ((type *)<span class="hljs-number">0</span>)-&gt;member ) *__mptr = (ptr);<br></code></pre></td></tr></table></figure><p>ä»¥ä¸Šå®çš„å‚æ•° ptr ä»£è¡¨çš„æ˜¯ä¸€ä¸ªç»“æ„ä½“æˆå‘˜å˜é‡ MEMBER çš„åœ°å€ï¼Œæ‰€ä»¥ ptr çš„ç±»å‹æ˜¯ä¸€ä¸ªæŒ‡å‘ MEMBER æ•°æ®ç±»å‹çš„æŒ‡é’ˆã€‚ä¸ºäº†ç¡®ä¿ä¸´æ—¶å˜é‡ __mptr çš„æŒ‡é’ˆç±»å‹ä¹Ÿæ˜¯ä¸€ä¸ªæŒ‡å‘ MEMBER ç±»å‹çš„æŒ‡é’ˆå˜é‡ï¼Œé€šè¿‡ typeof( ((type *)0)-&gt;member ) è¡¨è¾¾å¼ï¼Œä½¿ç”¨ typeof å…³é”®å­—æ¥è·å–ç»“æ„ä½“æˆå‘˜ member çš„æ•°æ®ç±»å‹ï¼Œç„¶åä½¿ç”¨ typeof( ((type *)0)-&gt;member ) *__mptr å°±å¯ä»¥å®šä¹‰ä¸€ä¸ªæŒ‡å‘è¯¥ç±»å‹çš„æŒ‡é’ˆå˜é‡äº†ã€‚</p><p>æ³¨æ„ï¼šåœ¨è¯­å¥è¡¨è¾¾å¼çš„æœ€åï¼Œå› ä¸ºè¿”å›çš„æ˜¯ç»“æ„ä½“çš„é¦–åœ°å€ï¼Œæ‰€ä»¥æ•°æ®ç±»å‹è¿˜å¿…é¡»å¼ºåˆ¶è½¬æ¢ä¸º TYPE *ï¼Œå³è¿”å›ä¸€ä¸ªæŒ‡å‘ TYPE ç»“æ„ä½“ç±»å‹çš„æŒ‡é’ˆï¼Œæ‰€ä»¥ä½ ä¼šåœ¨æœ€åä¸€ä¸ªè¡¨è¾¾çš„offsetå®ä¸­çœ‹åˆ°ä¸€ä¸ªå¼ºåˆ¶ç±»å‹è½¬æ¢(TYPE *)ã€‚</p><h2 id="å››ã€æ€»ç»“"><a href="#å››ã€æ€»ç»“" class="headerlink" title="å››ã€æ€»ç»“"></a>å››ã€æ€»ç»“</h2><p>é€šè¿‡å¯¹ container_of å®çš„æ•´ä½“åˆ†æåï¼Œè¿™ä¸ªè¿‡ç¨‹åˆ°åº•å¯¹æˆ‘ä»¬æœ‰ä»€ä¹ˆå¯å‘å‘¢ï¼Ÿ</p><p>å¯¹äºä»»ä½•ä¸€ä¸ªå¤æ‚çš„æŠ€æœ¯ï¼Œæˆ‘ä»¬éƒ½å¯ä»¥æŠŠå®ƒç”±ä¸Šè€Œä¸‹çš„é€æ­¥åˆ†è§£ï¼Œç„¶åè¿ç”¨æ‰€å­¦çš„åŸºç¡€çŸ¥è¯†ä¸€ç‚¹ä¸€ç‚¹å‰–æï¼šå…ˆè¿›è¡Œå°æ¨¡å—åˆ†æï¼Œç„¶åå†è¿›è¡Œç»¼åˆåˆ†æã€‚</p><p>æ¯”å¦‚ container_of å®çš„å®šä¹‰ï¼Œå°±è¿ç”¨äº†ç»“æ„ä½“çš„å­˜å‚¨ã€è¯­å¥è¡¨è¾¾å¼ã€typeof ç­‰çŸ¥è¯†ç‚¹ã€‚</p><p>å½“æˆ‘ä»¬æŒæ¡äº†è¿™äº›åŸºç¡€çŸ¥è¯†ï¼Œå¹¶ä¸”æœ‰äº†åˆ†ææ–¹æ³•ï¼Œä»¥ååœ¨å†…æ ¸ä¸­å†é‡åˆ°è¿™æ ·ç±»ä¼¼çš„å®ï¼Œæˆ‘ä»¬å°±å¯ä»¥è‡ªä¿¡ä»å®¹åœ°å»è‡ªå·±åˆ†æï¼Œè€Œä¸å¿…æ€»æ˜¯ä¾èµ–ç½‘ä¸Šå¤§æµ·æé’ˆå¼çš„æœç´¢äº†ã€‚</p><p>è¿™å°±æ˜¯ä½ çš„æ ¸å¿ƒç«äº‰åŠ›ï¼Œä¹Ÿæ˜¯ä½ è¶…è¶Šå…¶ä»–å·¥ç¨‹å¸ˆã€è„±é¢–è€Œå‡ºçš„æœºä¼šã€‚</p><p>åŸæ–‡é“¾æ¥ï¼š<a href="https://blog.csdn.net/m0_37383484/article/details/129244244">https://blog.csdn.net/m0_37383484/article/details/129244244</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;ä¸€ã€container-of-å®ä»‹ç»&quot;&gt;&lt;a href=&quot;#ä¸€ã€container-of-å®ä»‹ç»&quot; class=&quot;headerlink&quot; title=&quot;ä¸€ã€container_of å®ä»‹ç»&quot;&gt;&lt;/a&gt;ä¸€ã€container_of å®ä»‹ç»&lt;/h2&gt;&lt;p&gt;åˆ°è¿™é‡Œå‡è®¾å¤§</summary>
      
    
    
    
    <category term="kernel" scheme="http://example.com/categories/kernel/"/>
    
    
    <category term="kernel" scheme="http://example.com/tags/kernel/"/>
    
  </entry>
  
  <entry>
    <title>mmap</title>
    <link href="http://example.com/posts/mmap.html"/>
    <id>http://example.com/posts/mmap.html</id>
    <published>2024-11-25T14:49:19.000Z</published>
    <updated>2024-11-25T14:49:36.742Z</updated>
    
    <content type="html"><![CDATA[<p>mmap å³ memory mapï¼Œä¹Ÿå°±æ˜¯å†…å­˜æ˜ å°„ã€‚mmap æ˜¯ä¸€ç§å†…å­˜æ˜ å°„æ–‡ä»¶çš„æ–¹æ³•ï¼Œå³å°†ä¸€ä¸ªæ–‡ä»¶æˆ–è€…å…¶å®ƒå¯¹è±¡æ˜ å°„åˆ°è¿›ç¨‹çš„åœ°å€ç©ºé—´ï¼Œå®ç°æ–‡ä»¶ç£ç›˜åœ°å€å’Œè¿›ç¨‹è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­ä¸€æ®µè™šæ‹Ÿåœ°å€çš„ä¸€ä¸€å¯¹æ˜ å…³ç³»ã€‚å®ç°è¿™æ ·çš„æ˜ å°„å…³ç³»åï¼Œè¿›ç¨‹å°±å¯ä»¥é‡‡ç”¨æŒ‡é’ˆçš„æ–¹å¼è¯»å†™æ“ä½œè¿™ä¸€æ®µå†…å­˜ï¼Œè€Œç³»ç»Ÿä¼šè‡ªåŠ¨å›å†™è„é¡µé¢åˆ°å¯¹åº”çš„æ–‡ä»¶ç£ç›˜ä¸Šï¼Œå³å®Œæˆäº†å¯¹æ–‡ä»¶çš„æ“ä½œè€Œä¸å¿…å†è°ƒç”¨ readã€write ç­‰ç³»ç»Ÿè°ƒç”¨å‡½æ•°ã€‚ç›¸åï¼Œå†…æ ¸ç©ºé—´å¯¹è¿™æ®µåŒºåŸŸçš„ä¿®æ”¹ä¹Ÿç›´æ¥åæ˜ ç”¨æˆ·ç©ºé—´ï¼Œä»è€Œå¯ä»¥å®ç°ä¸åŒè¿›ç¨‹é—´çš„æ–‡ä»¶å…±äº«ã€‚</p><p><img src="https://raw.githubusercontent.com/mengchao666/picture/main/blog5175f10387866d6173bea7fbe89c4eeb.webp"></p><p>mmapåŸå‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-type">void</span> *<span class="hljs-title function_">mmap</span><span class="hljs-params">(<span class="hljs-type">void</span> *start, <span class="hljs-type">size_t</span> length, <span class="hljs-type">int</span> prot, <span class="hljs-type">int</span> flags, <span class="hljs-type">int</span> fd, <span class="hljs-type">off_t</span> offset)</span><br></code></pre></td></tr></table></figure><p>&#x3D;&#x3D;å¿…é¡»æ³¨æ„è¿™é‡Œçš„æ˜ å°„é•¿åº¦lengthå¿…é¡»æ˜¯4Kæ•´æ•°å€&#x3D;&#x3D;</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br> <br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>  <span class="hljs-type">int</span> my_data;<br>    <span class="hljs-type">int</span> fd = open(<span class="hljs-string">&quot;/dev/mem&quot;</span>, O_RDWR | O_SYNC);<br>    <span class="hljs-keyword">if</span> (fd &lt; <span class="hljs-number">0</span>) &#123;<br>        perror(<span class="hljs-string">&quot;open&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>    &#125;<br> <br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> addr = <span class="hljs-number">0x80000000</span>; <span class="hljs-comment">// å‡è®¾æˆ‘ä»¬è¦è®¿é—®çš„ç‰©ç†åœ°å€</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> map_length = <span class="hljs-number">0x1000</span>; <span class="hljs-comment">// æ˜ å°„çš„é•¿åº¦ä¸º4KB</span><br> <br>    <span class="hljs-comment">// æ˜ å°„å†…å­˜</span><br>    <span class="hljs-type">void</span> *ptr = mmap(<span class="hljs-literal">NULL</span>, map_length, PROT_READ | PROT_WRITE, MAP_SHARED, fd, addr &amp; ~(getpagesize() - <span class="hljs-number">1</span>)); <span class="hljs-comment">// è·å–é¡µé¢å¯¹é½åŸºåœ°å€ï¼Œå¿…é¡»ä»¥4Kå¯¹é½</span><br>    <span class="hljs-keyword">if</span> (ptr == MAP_FAILED) &#123;<br>        perror(<span class="hljs-string">&quot;mmap&quot;</span>);<br>        close(fd);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>    &#125;<br><br>  my_data = *(<span class="hljs-type">int</span> *)(ptr + addr &amp; (getpagesize() - <span class="hljs-number">1</span>));<br><br>    <span class="hljs-comment">// è§£é™¤å†…å­˜æ˜ å°„</span><br>    <span class="hljs-keyword">if</span> (munmap(ptr, map_length) &lt; <span class="hljs-number">0</span>) &#123;<br>        perror(<span class="hljs-string">&quot;munmap&quot;</span>);<br>        close(fd);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>    &#125;<br> <br>    <span class="hljs-comment">// å…³é—­æ–‡ä»¶æè¿°ç¬¦</span><br>    close(fd);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;mmap å³ memory mapï¼Œä¹Ÿå°±æ˜¯å†…å­˜æ˜ å°„ã€‚mmap æ˜¯ä¸€ç§å†…å­˜æ˜ å°„æ–‡ä»¶çš„æ–¹æ³•ï¼Œå³å°†ä¸€ä¸ªæ–‡ä»¶æˆ–è€…å…¶å®ƒå¯¹è±¡æ˜ å°„åˆ°è¿›ç¨‹çš„åœ°å€ç©ºé—´ï¼Œå®ç°æ–‡ä»¶ç£ç›˜åœ°å€å’Œè¿›ç¨‹è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­ä¸€æ®µè™šæ‹Ÿåœ°å€çš„ä¸€ä¸€å¯¹æ˜ å…³ç³»ã€‚å®ç°è¿™æ ·çš„æ˜ å°„å…³ç³»åï¼Œè¿›ç¨‹å°±å¯ä»¥é‡‡ç”¨æŒ‡é’ˆçš„æ–¹å¼è¯»å†™æ“ä½œè¿™ä¸€æ®µå†…å­˜ï¼Œè€Œç³»ç»Ÿä¼šè‡ª</summary>
      
    
    
    
    <category term="Cè¯­è¨€" scheme="http://example.com/categories/C%E8%AF%AD%E8%A8%80/"/>
    
    
    <category term="Cè¯­è¨€" scheme="http://example.com/tags/C%E8%AF%AD%E8%A8%80/"/>
    
  </entry>
  
  <entry>
    <title>gtest</title>
    <link href="http://example.com/posts/gtest.html"/>
    <id>http://example.com/posts/gtest.html</id>
    <published>2024-11-25T14:48:13.000Z</published>
    <updated>2024-11-25T14:48:37.470Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ä¸€ã€æ„å»ºgtest"><a href="#ä¸€ã€æ„å»ºgtest" class="headerlink" title="ä¸€ã€æ„å»ºgtest"></a>ä¸€ã€æ„å»ºgtest</h2><p>æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤åï¼Œå°±ä¼šåœ¨ç³»ç»Ÿç›®å½•ä¸‹ç”Ÿæˆå¯¹åº”çš„å¤´æ–‡ä»¶å’Œé™æ€åº“ï¼Œå¯ä»¥ç›´æ¥åœ¨ä»£ç ä¸­å¼•ç”¨äº†ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c">git clone git@github.com:google/googletest.git <br>cd googletest<br>mkdir build<br>cd build<br>cmake .. <br>make<br>sudo make install<br></code></pre></td></tr></table></figure><p>ä¸€ä¸ªå°ä¾‹å­ mySrc.h</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> UNTITLED_MYSRC_H</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> UNTITLED_MYSRC_H</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">Foo</span><span class="hljs-params">(<span class="hljs-type">int</span> a,<span class="hljs-type">int</span> b)</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span> <span class="hljs-comment">//UNTITLED_MYSRC_H</span></span><br></code></pre></td></tr></table></figure><p>mySrc.cpp</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">Foo</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b)</span> &#123;    <br>  <span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> == a || <span class="hljs-number">0</span> == b)  throw <span class="hljs-string">&quot;don&#x27;t do that&quot;</span>;<br>  <span class="hljs-type">int</span> c = a % b;     <br>  <span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> == c) &#123; <span class="hljs-keyword">return</span> b; &#125;     <br>  <span class="hljs-keyword">return</span> Foo(b, c); &#125;`<br></code></pre></td></tr></table></figure><p>test.cpp</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c">`<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;mySrc.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;gtest/gtest.h&quot;</span></span><br>TEST(FooTest, HandleNoneZeroInput) <br>&#123;     <br>  EXPECT_EQ(<span class="hljs-number">2</span>, Foo(<span class="hljs-number">4</span>, <span class="hljs-number">10</span>));     <br>  EXPECT_EQ(<span class="hljs-number">6</span>, Foo(<span class="hljs-number">30</span>, <span class="hljs-number">18</span>)); <br>&#125;  <br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> *argv[])</span> <br>&#123;     <br>  testing::InitGoogleTest(&amp;argc, argv);    <br>  <span class="hljs-keyword">return</span> RUN_ALL_TESTS(); <br>&#125;<br></code></pre></td></tr></table></figure><p>CMakeLists.txt</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c">cmake_minimum_required(VERSION <span class="hljs-number">3.20</span>)<br>project(untitled)  <br><span class="hljs-built_in">set</span>(CMAKE_CXX_STANDARD <span class="hljs-number">11</span>)  <br>include_directories(/usr/local/include)  <br>add_executable(untitled mySrc.cpp test.cpp)  <br>FIND_LIBRARY(gtest libgtest.a /usr/local/lib)  <br>target_link_libraries (untitled $&#123;gtest&#125;)<br></code></pre></td></tr></table></figure><p>è¾“å‡ºä¿¡æ¯ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c">[==========] Running <span class="hljs-number">1</span> test from <span class="hljs-number">1</span> test suite. <br>[----------] Global test environment <span class="hljs-built_in">set</span>-up. <br>[----------] <span class="hljs-number">1</span> test from FooTest <br>[ RUN      ] FooTest.HandleNoneZeroInput<br>[       OK ] FooTest.HandleNoneZeroInput (<span class="hljs-number">0</span> ms) <br>[----------] <span class="hljs-number">1</span> test from FooTest (<span class="hljs-number">0</span> ms total)  <br>[----------] Global test environment tear-down [==========] <span class="hljs-number">1</span> test from <span class="hljs-number">1</span> test suite ran. (<span class="hljs-number">0</span> ms total) [  PASSED  ] <span class="hljs-number">1</span> test.<br></code></pre></td></tr></table></figure><p><strong>ä¸Šé¢çš„æ˜¯é€šè¿‡äº‹å…ˆç¼–è¯‘å¥½gtestçš„æ–¹å¼è¿›è¡Œä½¿ç”¨ï¼Œå…¶å®ä¹Ÿå¯ä»¥åœ¨é¡¹ç›®çš„ç›®å½•ä¸‹ï¼Œç›´æ¥æŠŠgoogletestæ”¾è¿›å»çš„æ–¹å¼è¿›è¡Œä½¿ç”¨</strong></p><h2 id="äºŒã€assertion"><a href="#äºŒã€assertion" class="headerlink" title="äºŒã€assertion"></a>äºŒã€assertion</h2><p>åœ¨gtestä¸­ï¼Œæ˜¯é€šè¿‡æ–­è¨€ï¼ˆassertionï¼‰æ¥åˆ¤æ–­ä»£ç å®ç°çš„åŠŸèƒ½æ˜¯å¦ç¬¦åˆé¢„æœŸã€‚æ–­è¨€çš„ç»“æœåˆ†ä¸ºsuccessã€non-fatal failtureå’Œfatal failtureã€‚</p><p>æ ¹æ®æ–­è¨€å¤±è´¥çš„ç§ç±»ï¼Œgtestæä¾›äº†ä¸¤ç§æ–­è¨€å‡½æ•°ï¼š</p><p>successï¼šå³æ–­è¨€æˆåŠŸï¼Œç¨‹åºçš„è¡Œä¸ºç¬¦åˆé¢„æœŸï¼Œç¨‹åºç»§ç»­å‘ä¸‹å…è®¸ã€‚</p><p>non-fatal failureï¼šå³æ–­è¨€å¤±è´¥ï¼Œä½†æ˜¯ç¨‹åºæ²¡æœ‰ç›´æ¥crashï¼Œè€Œæ˜¯ç»§ç»­å‘ä¸‹è¿è¡Œã€‚</p><p>gtestæä¾›äº†å®å‡½æ•°EXPECT_XXX(expected, actual)ï¼šå¦‚æœcondition(expected, actual)è¿”å›falseï¼Œåˆ™EXPECT_XXXäº§ç”Ÿçš„å°±æ˜¯non-fatal failureé”™è¯¯ï¼Œå¹¶æ˜¾ç¤ºç›¸å…³é”™è¯¯ã€‚</p><p>fatal failureï¼šæ–­è¨€å¤±è´¥ï¼Œç¨‹åºç›´æ¥crashï¼Œåç»­çš„æµ‹è¯•æ¡ˆä¾‹ä¸ä¼šè¢«è¿è¡Œã€‚</p><p>gtestæä¾›äº†å®å‡½æ•°ASSERT_XXX(expected, actual)ã€‚</p><p>åœ¨å†™å•å…ƒæµ‹è¯•æ—¶ï¼Œæ›´åŠ å€¾å‘äºä½¿ç”¨EXPECT_XXXï¼Œå› ä¸ºASSERT_XXXæ˜¯ç›´æ¥crashé€€å‡ºçš„ï¼Œå¯èƒ½ä¼šå¯¼è‡´ä¸€äº›å†…å­˜ã€æ–‡ä»¶èµ„æºæ²¡æœ‰é‡Šæ”¾ï¼Œå› æ­¤å¯èƒ½ä¼šå¼•å…¥ä¸€äº›bugã€‚</p><p>å…·ä½“çš„EXPECT_XXXã€ASSERT_XXXå‡½æ•°åŠå…¶åˆ¤æ–­æ¡ä»¶ï¼Œå¦‚ä¸‹ä¸¤ä¸ªè¡¨ã€‚</p><p>è¡¨1 ä¸€å…ƒæ¯”è¾ƒ</p><table><thead><tr><th>ASSERT</th><th>EXPECT</th><th>Verifies</th></tr></thead><tbody><tr><td>ASSERT_TRUE(condition);</td><td>EXPECT_TRUE(condition);</td><td>condition is true</td></tr><tr><td>ASSERT_FALSE(condition)</td><td>EXPECT_FALSE(condition)</td><td>condition is false</td></tr></tbody></table><p>è¡¨2 äºŒå…ƒæ¯”è¾ƒ</p><table><thead><tr><th>ASSERT</th><th>EXPECT</th><th>Condition</th></tr></thead><tbody><tr><td>ASSERT_EQ(val1, val2);</td><td>EXPECT_EQ(val1, val2);</td><td>val1 &#x3D;&#x3D; val2</td></tr><tr><td>ASSERT_NE(val1, val2);</td><td>EXPECT_NE(val1, val2);</td><td>val1 !&#x3D; val2</td></tr><tr><td>ASSERT_LT(val1, val2);</td><td>EXPECT_LT(val1, val2);</td><td>val1 &lt; val2</td></tr><tr><td>ASSERT_LE(val1, val2);</td><td>EXPECT_LE(val1, val2);</td><td>val1 &lt;&#x3D; val2</td></tr><tr><td>ASSERT_GT(val1, val2);</td><td>EXPECT_GT(val1, val2);</td><td>val1 &gt; val2</td></tr><tr><td>ASSERT_GE(val1, val2);</td><td>EXPECT_GE(val1, val2);</td><td>val1 &gt;&#x3D; val2</td></tr></tbody></table><h2 id="ä¸‰ã€Quick-Start"><a href="#ä¸‰ã€Quick-Start" class="headerlink" title="ä¸‰ã€Quick Start"></a>ä¸‰ã€Quick Start</h2><p>ä¸‹é¢ä»¥EXPECT_XXXä¸ºä¾‹å­ï¼Œå¿«é€Ÿå¼€å§‹ä½¿ç”¨gtestå§ã€‚</p><p>å¯¹äºEXPECT_XXXï¼Œæ— è®ºæ¡ä»¶æ˜¯å¦æ»¡è¶³ï¼Œéƒ½ä¼šç»§ç»­å‘ä¸‹è¿è¡Œï¼Œä½†æ˜¯å¦‚æœæ¡ä»¶ä¸æ»¡è¶³ï¼Œåœ¨æŠ¥é”™çš„åœ°æ–¹ä¼šæ˜¾ç¤ºï¼š</p><p>æ²¡æœ‰é€šè¿‡çš„é‚£ä¸ªEXPECT_XXXå‡½æ•°ä½ç½®ï¼› EXPECT_XXXç¬¬ä¸€ä¸ªå‚æ•°çš„å€¼ï¼Œå³æœŸå¾…å€¼ EXPECT_XXXç¬¬äºŒä¸ªå‚æ•°çš„å€¼ï¼Œå³å®é™…å€¼ å¦‚ä¸‹demoï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// in gtest_demo_1.cc</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;gtest/gtest.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">int</span> lhs, <span class="hljs-type">int</span> rhs)</span> <br>&#123; <br>  <span class="hljs-keyword">return</span> lhs + rhs; <br>&#125;  <br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> <span class="hljs-type">const</span> *argv[])</span> <br>&#123;      <br>  EXPECT_EQ(add(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>), <span class="hljs-number">2</span>); <span class="hljs-comment">// PASS     EXPECT_EQ(add(1,1), 1) &lt;&lt; &quot;FAILED: EXPECT: 2, but given 1&quot;;; // FAILDED          return 0; </span><br>&#125;<br></code></pre></td></tr></table></figure><p>ç¼–è¯‘æ‰§è¡Œåè¾“å‡ºå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c">`$ ./gtest_demo_1 <br>/Users/self_study/Cpp/OpenSource/demo/gtest_demo_1.cc:<span class="hljs-number">9</span>: Failure Expected equality of these values:   <br>  add(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>)     <br>  Which is: <span class="hljs-number">2</span>                <br># æœŸå¾…çš„å€¼   <span class="hljs-number">1</span>                            <br># ç»™å®šçš„å€¼<br>FAILED: EXPECT: <span class="hljs-number">2</span>, but given <span class="hljs-number">1</span> # è‡ªå·±æ·»åŠ çš„æç¤ºä¿¡æ¯<br></code></pre></td></tr></table></figure><p>å¯èƒ½ä½ æ³¨æ„åˆ°äº†ï¼Œåœ¨EXPECT_EQ(add(1,1), 1)åæœ‰ä¸ª&lt;&lt;ï¼Œè¿™æ˜¯å› ä¸ºgtestå…è®¸æ·»åŠ è‡ªå®šä¹‰çš„æè¿°ä¿¡æ¯ï¼Œå½“è¿™ä¸ªè¯­å¥æµ‹è¯•æœªé€šè¿‡æ—¶å°±ä¼šæ˜¾ç¤ºï¼Œæ¯”å¦‚ä¸Šé¢çš„â€FAILED: EXPECT: 2, but given 1â€ã€‚</p><p>è¿™ä¸ª&lt;&lt;å’Œstd::ostreamæ¥å—çš„ç±»å‹ä¸€è‡´ï¼Œå³å¯ä»¥æ¥å—std::ostreamå¯ä»¥æ¥å—çš„ç±»å‹ã€‚</p><h2 id="å››ã€TEST"><a href="#å››ã€TEST" class="headerlink" title="å››ã€TEST"></a>å››ã€TEST</h2><p>ä¸‹é¢ä»¥googletest&#x2F;samplesä¸­çš„sample1_unittest.ccä¸­çš„demoä¸ºä¾‹ï¼Œä»‹ç»å¦‚ä½•æ›´å¥½åœ°ç»„ç»‡æµ‹è¯•æ¡ˆä¾‹ã€‚</p><p>ä¸€ä¸ªç®€å•è®¡ç®—é˜¶ä¹˜å‡½æ•°Factorialå®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">Factorial</span><span class="hljs-params">(<span class="hljs-type">int</span> n)</span> &#123;   <br>  <span class="hljs-type">int</span> result = <span class="hljs-number">1</span>;   <br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">1</span>; i &lt;= n; i++) &#123;     <br>    result *= i;   <br>  &#125;    <br>  <span class="hljs-keyword">return</span> result; <br>&#125;<br></code></pre></td></tr></table></figure><p>æ€ä¹ˆä½¿ç”¨gtestæ¥æµ‹è¯•è¿™ä¸ªå‡½æ•°çš„è¡Œä¸ºï¼Ÿ</p><p>æŒ‰ç…§ä¸Šé¢çš„quick startå¯çŸ¥ï¼Œè¿™ä¸ªæ—¶å€™å°±å¯ä»¥ä½¿ç”¨EXPECT_EQå®æ¥åˆ¤æ–­ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c">EXPECT_EQ(<span class="hljs-number">1</span>, Factorial(<span class="hljs-number">-5</span>)); <span class="hljs-comment">// æµ‹è¯•è®¡ç®—è´Ÿæ•°çš„é˜¶ä¹˜   </span><br>EXPECT_EQ(<span class="hljs-number">1</span>, Factorial(<span class="hljs-number">0</span>));   <span class="hljs-comment">// æµ‹è¯•è®¡ç®—0çš„é˜¶ä¹˜   </span><br>EXPECT_EQ(<span class="hljs-number">6</span>, Factorial(<span class="hljs-number">3</span>));   <span class="hljs-comment">// æµ‹è¯•è®¡ç®—æ­£æ•°çš„é˜¶ä¹˜</span><br></code></pre></td></tr></table></figure><p>ä½†æ˜¯å½“æµ‹è¯•æ¡ˆä¾‹è§„æ¨¡å˜å¤§ï¼Œä¸å¥½ç»„ç»‡ã€‚</p><p>å› æ­¤ï¼Œä¸ºäº†æ›´å¥½çš„ç»„ç»‡test casesï¼Œæ¯”å¦‚é’ˆå¯¹Factorialå‡½æ•°ï¼Œè¾“å…¥æ˜¯è´Ÿæ•°çš„casesä¸ºä¸€ç»„ï¼Œè¾“å…¥æ˜¯0çš„caseä¸ºä¸€ç»„ï¼Œæ­£æ•°casesä¸ºä¸€ç»„ã€‚gtestæä¾›äº†ä¸€ä¸ªå®TEST(TestSuiteName, TestName)ï¼Œç”¨äºç»„ç»‡ä¸åŒåœºæ™¯çš„casesï¼Œè¿™ä¸ªåŠŸèƒ½åœ¨gtestä¸­ç§°ä¸ºtest suiteã€‚</p><p>ç”¨æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// ä¸‹é¢ä¸‰ä¸ª TEST éƒ½æ˜¯å±äºåŒä¸€ä¸ª test suiteï¼Œå³ FactorialTest// æ­£æ•°ä¸ºä¸€ç»„TEST(FactorialTest, Negative) &#123;   </span><br>  EXPECT_EQ(<span class="hljs-number">1</span>, Factorial(<span class="hljs-number">-5</span>));   <br>  EXPECT_EQ(<span class="hljs-number">1</span>, Factorial(<span class="hljs-number">-1</span>));   <br>  EXPECT_GT(Factorial(<span class="hljs-number">-10</span>), <span class="hljs-number">0</span>); <br>&#125; <br><span class="hljs-comment">// 0</span><br>TEST(FactorialTest, Zero) &#123;   <br>  EXPECT_EQ(<span class="hljs-number">1</span>, Factorial(<span class="hljs-number">0</span>)); <br>&#125; <br><span class="hljs-comment">// è´Ÿæ•°ä¸ºä¸€ç»„</span><br>TEST(FactorialTest, Positive) &#123;   <br>  EXPECT_EQ(<span class="hljs-number">1</span>, Factorial(<span class="hljs-number">1</span>));   <br>  EXPECT_EQ(<span class="hljs-number">2</span>, Factorial(<span class="hljs-number">2</span>));   <br>  EXPECT_EQ(<span class="hljs-number">6</span>, Factorial(<span class="hljs-number">3</span>));   <br>  EXPECT_EQ(<span class="hljs-number">40320</span>, Factorial(<span class="hljs-number">8</span>)); <br>&#125;<br></code></pre></td></tr></table></figure><p>é—®é¢˜æ¥äº†ï¼Œæ€ä¹ˆè¿è¡Œè¿™äº›TESTï¼Ÿ</p><p>åœ¨sample1_unittest.ccçš„mainå‡½æ•°ä¸­ï¼Œæ·»åŠ RUN_ALL_TESTSå‡½æ•°å³å¯ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv)</span> &#123;   <br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Running main() from %s\n&quot;</span>, __FILE__);   <br>  testing::InitGoogleTest(&amp;argc, argv);   <br>  <span class="hljs-keyword">return</span> RUN_ALL_TESTS();  <br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨build&#x2F;binè·¯å¾„ä¸‹ï¼Œæ‰§è¡Œå¯¹åº”çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œè¾“å‡ºå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c">$./sample1_unittest  Running <span class="hljs-title function_">main</span><span class="hljs-params">()</span> from /Users/self_study/Cpp/OpenSource/demo/include/googletest/googletest/samples/sample1_unittest.cc [==========] Running <span class="hljs-number">6</span> tests from <span class="hljs-number">2</span> test suites. # åœ¨ sample1_unittest.cc ä¸­æœ‰ä¸¤ä¸ª test suites [----------] Global test environment <span class="hljs-built_in">set</span>-up.      # ç¬¬ä¸€ä¸ª test suiteï¼Œå³ä¸Šé¢çš„ FactorialTest [----------] <span class="hljs-number">3</span> tests from FactorialTest     # <span class="hljs-number">3</span> ç»„ [ RUN      ] FactorialTest.Negative         # Negative ç»„è¾“å‡º [       OK ] FactorialTest.Negative (<span class="hljs-number">0</span> ms)  # OK è¡¨ç¤º Negative ç»„å…¨éƒ¨æµ‹è¯•é€šè¿‡ [ RUN      ] FactorialTest.Zero             # Zeroç»„è¾“å‡º  [       OK ] FactorialTest.Zero (<span class="hljs-number">0</span> ms)     [ RUN      ] FactorialTest.Positive         # Positiveç»„è¾“å‡º [       OK ] FactorialTest.Positive (<span class="hljs-number">0</span> ms)    <br>[----------] <span class="hljs-number">3</span> tests from FactorialTest (<span class="hljs-number">0</span> ms total) #sample1_unitest å¦ä¸€ä¸ªæµ‹è¯•æ¡ˆä¾‹çš„è¾“å‡º ...  [----------] Global test environment tear-down   [==========] <span class="hljs-number">6</span> tests from <span class="hljs-number">2</span> test suites ran. (<span class="hljs-number">0</span> ms total)  [  PASSED  ] <span class="hljs-number">6</span> tests.              # å…¨éƒ¨æµ‹è¯•ç»“æœï¼šPASSè¡¨ç¤ºå…¨éƒ¨é€šè¿‡  <br><br>ä¸‹é¢ç¨å¾®ä¿®æ”¹ä¸‹sample1_unittest.ccä¸­çš„ä»£ç ï¼Œæ¥äº§ç”Ÿä¸€ä¸ªé”™è¯¯ï¼š  <br>TEST(FactorialTest, Negative) &#123;   <br>  EXPECT_EQ(<span class="hljs-number">10</span>, Factorial(<span class="hljs-number">-5</span>));  <span class="hljs-comment">// æ­£ç¡®çš„åº”è¯¥æ˜¯  EXPECT_EQ(1, Factorial(-5));   </span><br>  <span class="hljs-comment">// ... </span><br>&#125;<br></code></pre></td></tr></table></figure><p>é‡æ–°ç¼–è¯‘ï¼Œè¿è¡Œç»“æœå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c">$ ./sample1_unittest  Running <span class="hljs-title function_">main</span><span class="hljs-params">()</span> from /Users/self_study/Cpp/OpenSource/demo/include/googletest/googletest/samples/sample1_unittest.cc [==========] Running <span class="hljs-number">6</span> tests from <span class="hljs-number">2</span> test suites. [----------] Global test environment <span class="hljs-built_in">set</span>-up. [----------] <span class="hljs-number">3</span> tests from FactorialTest [ RUN      ] FactorialTest.Negative          # å¼€å§‹è¿è¡Œä¸Šé¢ä¿®æ”¹çš„é‚£ä¸ªç»„ /Users/self_study/Cpp/OpenSource/demo/include/googletest/googletest/samples/sample1_unittest.cc:<span class="hljs-number">79</span>: Failure                 # æµ‹è¯•å¤±è´¥ï¼Œå¹¶æŒ‡å‡ºé”™è¯¯<span class="hljs-keyword">case</span>çš„ä½ç½® Expected equality of these values:           # æœŸå¾…çš„å€¼   <span class="hljs-number">10</span>   Factorial(<span class="hljs-number">-5</span>)                              # å®é™…è®¡ç®—å‡ºçš„å€¼     Which is: <span class="hljs-number">1</span> [  FAILED  ] FactorialTest.Negative (<span class="hljs-number">0</span> ms)   # è¿™ç»„<span class="hljs-keyword">case</span>æµ‹è¯•çŠ¶æ€ï¼šFAILED [ RUN      ] FactorialTest.Zero              # ä¸‹é¢ç»§ç»­è¿è¡Œ [       OK ] FactorialTest.Zero (<span class="hljs-number">0</span> ms) <br>[ RUN      ] FactorialTest.Positive <br>[       OK ] FactorialTest.Positive (<span class="hljs-number">0</span> ms) <br>[----------] <span class="hljs-number">3</span> tests from FactorialTest (<span class="hljs-number">0</span> ms total)  # ...  <br>[----------] Global test environment tear-down [==========] <span class="hljs-number">6</span> tests from <span class="hljs-number">2</span> test suites ran. (<span class="hljs-number">0</span> ms total) [  PASSED  ] <span class="hljs-number">5</span> tests.           [  FAILED  ] <span class="hljs-number">1</span> test, listed below:     # <span class="hljs-number">1</span>ä¸ªtestå¤±è´¥ [  FAILED  ] FactorialTest.Negative    # å¤±è´¥çš„test suiteåŠå…¶ç»„   <span class="hljs-number">1</span> FAILED TEST<br></code></pre></td></tr></table></figure><p>æ­¤å¤–ï¼Œåœ¨TESTå®å‡½æ•°ä¸­ï¼Œä¹Ÿå¯ä»¥åƒä¸ªæ™®é€šå‡½æ•°ä¸€æ ·ï¼Œå®šä¹‰å˜é‡ä¹‹ç±»çš„è¡Œä¸ºã€‚</p><p>æ¯”å¦‚åœ¨sample2_unittest.ccä¸­ï¼Œæµ‹è¯•ä¸€ä¸ªè‡ªå®šä¹‰ç±»MyStringçš„å¤åˆ¶æ„é€ å‡½æ•°æ˜¯å¦è¡¨ç°æ­£å¸¸ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">const</span> <span class="hljs-type">char</span> kHelloString[] = <span class="hljs-string">&quot;Hello, world!&quot;</span>;  <span class="hljs-comment">// åœ¨ TESTå†…éƒ¨ï¼Œå®šä¹‰å˜é‡TEST(MyString, CopyConstructor) &#123;   </span><br>  <span class="hljs-type">const</span> MyString <span class="hljs-title function_">s1</span><span class="hljs-params">(kHelloString)</span>;   <br>  <span class="hljs-type">const</span> MyString s2 = s1;   <br>  EXPECT_EQ(<span class="hljs-number">0</span>, <span class="hljs-built_in">strcmp</span>(s2.c_string(), kHelloString)); <br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸ºè·å¾—è¿›ä¸€æ­¥å­¦ä¹ ï¼Œè¯»è€…å¯ä»¥è‡ªè¡Œè°ƒæ•´sample1_unittest.ccã€sample2_unittest.ccä¸­çš„TESTè¡Œä¸ºï¼ŒåŠ æ·±å¯¹gtestçš„TESTå®çš„ç†è§£ã€‚</p><h2 id="äº”ã€TEST-F"><a href="#äº”ã€TEST-F" class="headerlink" title="äº”ã€TEST_F"></a>äº”ã€TEST_F</h2><p>ä¸‹é¢ä»‹ç»gtestä¸­æ›´ä¸ºé«˜çº§çš„åŠŸèƒ½ï¼štest fixtureï¼Œå¯¹åº”çš„å®å‡½æ•°æ˜¯TEST_F(TestFixtureName, TestName)ã€‚</p><p>fixtureï¼Œå…¶è¯­ä¹‰æ˜¯å›ºå®šçš„è®¾æ–½ï¼Œè€Œtest fixtureåœ¨gtestä¸­çš„ä½œç”¨å°±æ˜¯ä¸ºæ¯ä¸ªTESTéƒ½æ‰§è¡Œä¸€äº›åŒæ ·çš„æ“ä½œã€‚</p><p>æ¯”å¦‚ï¼Œè¦æµ‹è¯•ä¸€ä¸ªé˜Ÿåˆ—Queueçš„å„ä¸ªæ¥å£åŠŸèƒ½æ˜¯å¦æ­£å¸¸ï¼Œå› æ­¤å°±éœ€è¦å‘é˜Ÿåˆ—ä¸­æ·»åŠ å…ƒç´ ã€‚å¦‚æœä½¿ç”¨ä¸€ä¸ªTESTå‡½æ•°æµ‹è¯•Queueçš„ä¸€ä¸ªæ¥å£ï¼Œé‚£ä¹ˆæ¯æ¬¡æ‰§è¡ŒTESTæ—¶ï¼Œéƒ½éœ€è¦åœ¨TESTå®å‡½æ•°ä¸­å®šä¹‰ä¸€ä¸ªQueueå¯¹è±¡ï¼Œå¹¶å‘è¯¥å¯¹è±¡ä¸­æ·»åŠ å…ƒç´ ï¼Œå°±å¾ˆå†—ä½™ã€ç¹çã€‚</p><p>æ€ä¹ˆé¿å…è¿™éƒ¨åˆ†å†—ä½™çš„è¿‡ç¨‹ï¼Ÿ</p><p>TEST_Få°±æ˜¯å®Œæˆè¿™æ ·çš„äº‹æƒ…ï¼Œå®ƒçš„ç¬¬ä¸€ä¸ªå‚æ•°TestFixtureNameæ˜¯ä¸ªç±»ï¼Œéœ€è¦ç»§æ‰¿testing::Testï¼ŒåŒæ—¶æ ¹æ®éœ€è¦å®ç°ä»¥ä¸‹ä¸¤ä¸ªè™šå‡½æ•°ï¼š</p><p>virtual void SetUp()ï¼šåœ¨TEST_Fä¸­æµ‹è¯•æ¡ˆä¾‹ä¹‹å‰è¿è¡Œï¼› virtual void TearDown()ï¼šåœ¨TEST_Fä¹‹åè¿è¡Œã€‚ å¯ä»¥ç±»æ¯”å¯¹è±¡çš„æ„é€ å‡½æ•°å’Œææ„å‡½æ•°ã€‚è¿™æ ·ï¼ŒåŒä¸€ä¸ªTestFixtureNameä¸‹çš„æ¯ä¸ªTEST_Féƒ½ä¼šå…ˆæ‰§è¡ŒSetUpï¼Œæœ€åæ‰§è¡ŒTearDwomã€‚</p><p>æ­¤å¤–ï¼Œtesting::Testè¿˜æä¾›äº†ä¸¤ä¸ªstaticå‡½æ•°ï¼š</p><p>static void SetUpTestSuite()ï¼šåœ¨ç¬¬ä¸€ä¸ªTESTä¹‹å‰è¿è¡Œ static void TearDownTestSuite()ï¼šåœ¨æœ€åä¸€ä¸ªTESTä¹‹åè¿è¡Œ ä»¥sample3-inlä¸­å®ç°çš„class Queueä¸ºä¾‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">QueueTestSmpl3</span> :</span> public testing::Test &#123; <span class="hljs-comment">// ç»§æ‰¿äº† testing::Test</span><br>  protected:        <br>  <span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">SetUpTestSuite</span><span class="hljs-params">()</span> &#123;     <br>    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span>&lt;&lt;<span class="hljs-string">&quot;run before first case...&quot;</span>&lt;&lt;<span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;   <br>  &#125;     <br><br>  <span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">TearDownTestSuite</span><span class="hljs-params">()</span> &#123;  <br>    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span>&lt;&lt;<span class="hljs-string">&quot;run after last case...&quot;</span>&lt;&lt;<span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;   <br>  &#125;      <br><br>  virtual <span class="hljs-type">void</span> <span class="hljs-title function_">SetUp</span><span class="hljs-params">()</span> override &#123;    <br>    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span>&lt;&lt;<span class="hljs-string">&quot;enter into SetUp()&quot;</span> &lt;&lt;<span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>; <br>    q1_.Enqueue(<span class="hljs-number">1</span>);     <br>    q2_.Enqueue(<span class="hljs-number">2</span>);    <br>    q2_.Enqueue(<span class="hljs-number">3</span>);   <br>  &#125;    <br><br>  virtual <span class="hljs-type">void</span> <span class="hljs-title function_">TearDown</span><span class="hljs-params">()</span> override &#123;     <br>    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span>&lt;&lt;<span class="hljs-string">&quot;exit from TearDown&quot;</span> &lt;&lt;<span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;   <br>  &#125;      <br><br>  <span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">Double</span><span class="hljs-params">(<span class="hljs-type">int</span> n)</span> &#123;    <br>    <span class="hljs-keyword">return</span> <span class="hljs-number">2</span>*n;<br>  &#125;      <br><br>  <span class="hljs-type">void</span> <span class="hljs-title function_">MapTester</span><span class="hljs-params">(<span class="hljs-type">const</span> Queue&lt;<span class="hljs-type">int</span>&gt; * q)</span> &#123;     <br>    <span class="hljs-type">const</span> Queue&lt;<span class="hljs-type">int</span>&gt; * <span class="hljs-type">const</span> new_q = q-&gt;Map(Double);<br>    ASSERT_EQ(q-&gt;Size(), new_q-&gt;Size());      <br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">const</span> QueueNode&lt;<span class="hljs-type">int</span>&gt;*n1 = q-&gt;Head(), *n2 = new_q-&gt;Head();          n1 != nullptr; n1 = n1-&gt;next(), n2 = n2-&gt;next()) <br>    &#123;       <br>      EXPECT_EQ(<span class="hljs-number">2</span> * n1-&gt;element(), n2-&gt;element());    <br>    &#125;      <br>    delete new_q;   <br>  &#125;    <br><br>  Queue&lt;<span class="hljs-type">int</span>&gt; q0_;   <br>  Queue&lt;<span class="hljs-type">int</span>&gt; q1_;   <br>  Queue&lt;<span class="hljs-type">int</span>&gt; q2_; <br>&#125;;<br></code></pre></td></tr></table></figure><p>ä¸‹é¢æ˜¯sample3_unittest.ccä¸­çš„TEST_Fï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// in sample3_unittest.cc</span><br><span class="hljs-comment">// Tests the default c&#x27;tor.</span><br>TEST_F(QueueTestSmpl3, DefaultConstructor) &#123;   <br><span class="hljs-comment">// !!! åœ¨ TEST_F ä¸­å¯ä»¥ä½¿ç”¨ QueueTestSmpl3 çš„æˆå‘˜å˜é‡ã€æˆå‘˜å‡½æ•°    </span><br>  EXPECT_EQ(<span class="hljs-number">0u</span>, q0_.Size()); <br>&#125;  <br><br><span class="hljs-comment">// Tests Dequeue().</span><br>TEST_F(QueueTestSmpl3, Dequeue) &#123;   <br>  <span class="hljs-type">int</span> * n = q0_.Dequeue();   <br>  EXPECT_TRUE(n == nullptr);    <br>  n = q1_.Dequeue();   <br>  ASSERT_TRUE(n != nullptr);   <br>  EXPECT_EQ(<span class="hljs-number">1</span>, *n);   <br>  EXPECT_EQ(<span class="hljs-number">0u</span>, q1_.Size());  <br>  delete n;    <br>  n = q2_.Dequeue();   <br>  ASSERT_TRUE(n != nullptr);   <br>  EXPECT_EQ(<span class="hljs-number">2</span>, *n);   <br>  EXPECT_EQ(<span class="hljs-number">1u</span>, q2_.Size());   <br>  delete n; <br>&#125;  <br><span class="hljs-comment">// Tests the Queue::Map() function.</span><br>TEST_F(QueueTestSmpl3, Map) &#123;   <br>  MapTester(&amp;q0_);   <br>  MapTester(&amp;q1_);   <br>  MapTester(&amp;q2_); <br>&#125;<br></code></pre></td></tr></table></figure><p>ä»¥TEST_F(QueueTestSmpl3, DefaultConstructor)ä¸ºä¾‹ï¼Œå†å…·ä½“è®²è§£ä¸‹TEST_Fçš„è¿è¡Œæµç¨‹ï¼š</p><p>gtestæ„é€ ä¸€ä¸ªQueueTestSmpl3å¯¹è±¡t1ï¼› t1.setUpåˆå§‹åŒ–t1 ç¬¬ä¸€ä¸ªTEST_Få³DefaultConstructorå¼€å§‹è¿è¡Œå¹¶ç»“æŸ t1.TearDwonè¿è¡Œï¼Œç”¨äºæ¸…ç†å·¥ä½œ t1è¢«ææ„ å› æ­¤ï¼Œsample3_unittest.ccè¾“å‡ºå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c">% ./sample3_unittest Running <span class="hljs-title function_">main</span><span class="hljs-params">()</span> from /Users/self_study/Cpp/OpenSource/demo/include/googletest/googletest/samples/sample3_unittest.cc <br>[==========] Running <span class="hljs-number">3</span> tests from <span class="hljs-number">1</span> test suite. <br>[----------] Global test environment <span class="hljs-built_in">set</span>-up. <br>[----------] <span class="hljs-number">3</span> tests from QueueTestSmpl3 run before first <span class="hljs-keyword">case</span>...    # æ‰€æœ‰çš„test <span class="hljs-keyword">case</span> ä¹‹å‰è¿è¡Œ [ RUN      ] QueueTestSmpl3.DefaultConstructor enter into SetUp()          # æ¯æ¬¡éƒ½ä¼šè¿è¡Œ <span class="hljs-built_in">exit</span> from TearDown <br>[       OK ] QueueTestSmpl3.DefaultConstructor (<span class="hljs-number">0</span> ms) <br>[ RUN      ] QueueTestSmpl3.Dequeue enter into SetUp()          # æ¯æ¬¡éƒ½ä¼šè¿è¡Œ <span class="hljs-built_in">exit</span> from TearDown <br>[       OK ] QueueTestSmpl3.Dequeue (<span class="hljs-number">0</span> ms) <br>[ RUN      ] QueueTestSmpl3.Map enter into SetUp()          # æ¯æ¬¡éƒ½ä¼šè¿è¡Œ <span class="hljs-built_in">exit</span> from TearDown [       OK ] QueueTestSmpl3.Map (<span class="hljs-number">0</span> ms) run after last <span class="hljs-keyword">case</span>...      # æ‰€æœ‰test <span class="hljs-keyword">case</span>ç»“æŸä¹‹åè¿è¡Œ [----------] <span class="hljs-number">3</span> tests from QueueTestSmpl3 (<span class="hljs-number">0</span> ms total)  <br>[----------] Global test environment tear-down [==========] <span class="hljs-number">3</span> tests from <span class="hljs-number">1</span> test suite ran. (<span class="hljs-number">0</span> ms total) [  PASSED  ] <span class="hljs-number">3</span> tests.<br></code></pre></td></tr></table></figure><p>TEST_Fç›¸æ¯”è¾ƒTESTå¯ä»¥æ›´åŠ ç®€æ´åœ°å®ç°åŠŸèƒ½æµ‹è¯•ã€‚</p><p>gtestçš„åŸºç¡€å…¥é—¨æ•™ç¨‹å°±åˆ°æ­¤ä¸ºæ­¢</p><h2 id="å…­ã€MOCKER"><a href="#å…­ã€MOCKER" class="headerlink" title="å…­ã€MOCKER"></a>å…­ã€MOCKER</h2><p>å¯¹æ‰“æ¡©çš„å‡½æ•°ï¼Œä½¿ç”¨MOCKERï¼Œå¯ä»¥æŒ‰ç…§é¢„æœŸå€¼è¿”å›</p><p>ç¤ºä¾‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;gtest/gtest.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;mockercpp/mockercpp.hpp&quot;</span></span><br><br>TEST_F(QueueTestSmpl3, xxx_test)<br>&#123;<br>  MOCKER(hal_kernel_get_soc_type)<br>  .stub()<br>  .with(any(), outBoundP())<br>  .will(<span class="hljs-keyword">return</span> (<span class="hljs-number">0</span>));<br><br>  xxx_test();<br>  GlobalMockObject::verify();<br>&#125;<br></code></pre></td></tr></table></figure><p>C++ä¸­MOCKERç±»ä¸­çš„å‡½æ•°å¯ä»¥ä½¿ç”¨MOCKERCPP</p><p>GlobalMockObject::verify();æ˜¯éªŒè¯mockæ˜¯å¦æ­£å¸¸æŒ‰ç…§é¢„æœŸä¼ å…¥å‚æ•°ï¼Œæ¸…é™¤åç»­mocker</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;ä¸€ã€æ„å»ºgtest&quot;&gt;&lt;a href=&quot;#ä¸€ã€æ„å»ºgtest&quot; class=&quot;headerlink&quot; title=&quot;ä¸€ã€æ„å»ºgtest&quot;&gt;&lt;/a&gt;ä¸€ã€æ„å»ºgtest&lt;/h2&gt;&lt;p&gt;æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤åï¼Œå°±ä¼šåœ¨ç³»ç»Ÿç›®å½•ä¸‹ç”Ÿæˆå¯¹åº”çš„å¤´æ–‡ä»¶å’Œé™æ€åº“ï¼Œå¯ä»¥ç›´æ¥åœ¨ä»£ç ä¸­å¼•ç”¨äº†ã€‚&lt;</summary>
      
    
    
    
    <category term="Cè¯­è¨€" scheme="http://example.com/categories/C%E8%AF%AD%E8%A8%80/"/>
    
    
    <category term="Cè¯­è¨€" scheme="http://example.com/tags/C%E8%AF%AD%E8%A8%80/"/>
    
  </entry>
  
  <entry>
    <title>pollã€epoll</title>
    <link href="http://example.com/posts/poll%E3%80%81epoll.html"/>
    <id>http://example.com/posts/poll%E3%80%81epoll.html</id>
    <published>2024-11-25T14:47:23.000Z</published>
    <updated>2024-11-25T14:47:48.216Z</updated>
    
    <content type="html"><![CDATA[<h3 id="ä¸€ã€pollä»‹ç»"><a href="#ä¸€ã€pollä»‹ç»" class="headerlink" title="ä¸€ã€pollä»‹ç»"></a>ä¸€ã€pollä»‹ç»</h3><p>pollä¸selectä¸€æ ·ï¼Œåªè´Ÿè´£IOçš„ç­‰çš„è¿‡ç¨‹ï¼Œåªä¸è¿‡ä¸€æ¬¡å¯ä»¥ç­‰å¾…å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œä»–çš„ä½œç”¨æ˜¯è®©readå’Œwriteä¸å†é˜»å¡ã€‚</p><p>æ˜¯ç”¨æ¥ç›‘è§†å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦çš„çŠ¶æ€å˜åŒ–çš„<br>ç¨‹åºä¼šåœåœ¨pollè¿™é‡Œç­‰å¾…ï¼Œç›´åˆ°è¢«ç›‘è§†çš„æ–‡ä»¶æè¿°ç¬¦æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªå‘ç”Ÿäº†çŠ¶æ€æ”¹å˜</p><h3 id="äºŒã€pollçš„æ¥å£"><a href="#äºŒã€pollçš„æ¥å£" class="headerlink" title="äºŒã€pollçš„æ¥å£"></a>äºŒã€pollçš„æ¥å£</h3><p>pollçš„æ¥å£å¦‚ä¸‹ï¼Œæ¯”selectè¦è½»é‡åŒ–å¾ˆå¤šï¼Œåªæœ‰ä¸‰ä¸ªå‚æ•°<br><img src="https://i-blog.csdnimg.cn/direct/899a62e984c7418f8e6c3ed248b59676.png"></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c">å‚æ•°<span class="hljs-number">1</span>ï¼š<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pollfd</span> *<span class="hljs-title">fds</span>ï¼Œ<span class="hljs-title">pollfd</span>æ•°ç»„é¦–å…ƒç´ åœ°å€ï¼Œ</span><br><span class="hljs-class"></span><br><span class="hljs-class">  <span class="hljs-title">pollfd</span>æ˜¯æ“ä½œç³»ç»Ÿç»™æˆ‘ä»¬æä¾›çš„ç»“æ„ä½“ï¼Œä¸»è¦æˆå‘˜å¦‚ä¸‹</span><br><span class="hljs-class">  <span class="hljs-title">fd</span>ï¼šæ–‡ä»¶æè¿°ç¬¦</span><br><span class="hljs-class">  <span class="hljs-title">events</span>ï¼šç”¨æˆ·å‘Šè¯‰å†…æ ¸ï¼Œéœ€è¦å…³å¿ƒçš„<span class="hljs-title">fd</span>ï¼Œä¸Šé¢çš„äº‹ä»¶</span><br><span class="hljs-class">  <span class="hljs-title">revents</span>ï¼š<span class="hljs-title">poll</span>è¿”å›ï¼Œå†…æ ¸å‘Šè¯‰ç”¨æˆ·ï¼Œå…³å¿ƒçš„<span class="hljs-title">fd</span>ï¼Œé‚£äº›äº‹ä»¶å°±ç»ª</span><br><span class="hljs-class"></span><br><span class="hljs-class">å‚æ•°2ï¼š<span class="hljs-title">nfds_t</span> <span class="hljs-title">nfds</span>ï¼Œæ•°ç»„å…ƒç´ ä¸ªæ•°</span><br><span class="hljs-class"></span><br><span class="hljs-class">å‚æ•°3ï¼š<span class="hljs-title">int</span> <span class="hljs-title">timeout</span>ï¼Œæ¯«ç§’çº§çš„ç­‰å¾…æ—¶é—´</span><br><span class="hljs-class"><span class="hljs-title">timeout</span> &gt;</span> <span class="hljs-number">0</span> ç­‰å¾…timeoutæ¯«ç§’æˆ–è€…æœ‰fdå°±ç»ªå†è¿”å›ã€‚<br>timeout == <span class="hljs-number">0</span> éé˜»å¡è½®è¯¢ã€‚<br>timeout == <span class="hljs-number">-1</span> é˜»å¡ç­‰å¾…ï¼Œç›´åˆ°æœ‰fdå°±ç»ªã€‚<br><br>è¿”å›å€¼ï¼š<br>ret  &gt;  <span class="hljs-number">0</span> ï¼špollç­‰å¾…çš„å¤šä¸ªfdä¸­ï¼Œå·²ç»å°±éœ€è¦çš„fdä¸ªæ•°<br>ret == <span class="hljs-number">0</span> ï¼špollè¶…æ—¶è¿”å›<br>ret  &lt;  <span class="hljs-number">0</span> ï¼špollå‡ºé”™<br></code></pre></td></tr></table></figure><p>pollçš„äº‹ä»¶å¦‚ä¸‹ï¼Œè¿™äº›å€¼æ˜¯bitä½ï¼Œå¯ä»¥é€šè¿‡  |ï¼ˆæˆ–è¿ç®—ï¼‰  çš„æ–¹å¼å†™å…¥åˆ°eventsä¸­ï¼Œæˆ‘ä»¬ç€é‡å­¦ä¹ POLLINå’ŒPOLLOUT</p><p><img src="https://i-blog.csdnimg.cn/direct/a866b6a4129643debaa03017a1f5fb47.png"></p><p><img src="https://i-blog.csdnimg.cn/direct/3480236feb334bfcaaae5a49c04bb9aa.png"></p><h3 id="ä¸‰ã€pollä½¿ç”¨ä¾‹å­"><a href="#ä¸‰ã€pollä½¿ç”¨ä¾‹å­" class="headerlink" title="ä¸‰ã€pollä½¿ç”¨ä¾‹å­"></a>ä¸‰ã€pollä½¿ç”¨ä¾‹å­</h3><p>Log.hpp</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> once</span><br> <br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cstdarg&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/stat.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br>using namespace <span class="hljs-built_in">std</span>;<br> <br><span class="hljs-class"><span class="hljs-keyword">enum</span></span><br><span class="hljs-class">&#123;</span><br>    Debug = <span class="hljs-number">0</span>,<br>    Info,<br>    Warning,<br>    Error,<br>    Fatal<br>&#125;;<br> <br><span class="hljs-class"><span class="hljs-keyword">enum</span></span><br><span class="hljs-class">&#123;</span><br>    Screen = <span class="hljs-number">10</span>,<br>    OneFile,<br>    ClassFile<br>&#125;;<br> <br><span class="hljs-built_in">string</span> <span class="hljs-title function_">LevelToString</span><span class="hljs-params">(<span class="hljs-type">int</span> level)</span><br>&#123;<br>    <span class="hljs-keyword">switch</span> (level)<br>    &#123;<br>    <span class="hljs-keyword">case</span> Debug:<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Debug&quot;</span>;<br>    <span class="hljs-keyword">case</span> Info:<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Info&quot;</span>;<br>    <span class="hljs-keyword">case</span> Warning:<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Warning&quot;</span>;<br>    <span class="hljs-keyword">case</span> Error:<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Error&quot;</span>;<br>    <span class="hljs-keyword">case</span> Fatal:<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Fatal&quot;</span>;<br> <br>    <span class="hljs-keyword">default</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Unknown&quot;</span>;<br>    &#125;<br>&#125;<br> <br><span class="hljs-type">const</span> <span class="hljs-type">int</span> default_style = Screen;<br><span class="hljs-type">const</span> <span class="hljs-built_in">string</span> default_filename = <span class="hljs-string">&quot;Log.&quot;</span>;<br><span class="hljs-type">const</span> <span class="hljs-built_in">string</span> logdir = <span class="hljs-string">&quot;log&quot;</span>;<br> <br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Log</span></span><br><span class="hljs-class">&#123;</span><br>public:<br>    Log(<span class="hljs-type">int</span> style = default_style, <span class="hljs-built_in">string</span> filename = default_filename)<br>        : _style(style), _filename(filename)<br>    &#123;<br>        <span class="hljs-keyword">if</span> (_style != Screen)<br>            mkdir(logdir.c_str(), <span class="hljs-number">0775</span>);<br>    &#125;<br> <br>    <span class="hljs-comment">// æ›´æ”¹æ‰“å°æ–¹å¼</span><br>    <span class="hljs-type">void</span> <span class="hljs-title function_">Enable</span><span class="hljs-params">(<span class="hljs-type">int</span> style)</span><br>    &#123;<br>        _style = style;<br>        <span class="hljs-keyword">if</span> (_style != Screen)<br>            mkdir(logdir.c_str(), <span class="hljs-number">0775</span>);<br>    &#125;<br> <br>    <span class="hljs-comment">// æ—¶é—´æˆ³è½¬åŒ–ä¸ºå¹´æœˆæ—¥æ—¶åˆ†ç§’</span><br>    <span class="hljs-built_in">string</span> <span class="hljs-title function_">GetTime</span><span class="hljs-params">()</span><br>    &#123;<br>        <span class="hljs-type">time_t</span> currtime = time(nullptr);<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tm</span> *<span class="hljs-title">curr</span> =</span> localtime(&amp;currtime);<br>        <span class="hljs-type">char</span> time_buffer[<span class="hljs-number">128</span>];<br>        <span class="hljs-built_in">snprintf</span>(time_buffer, <span class="hljs-keyword">sizeof</span>(time_buffer), <span class="hljs-string">&quot;%d-%d-%d %d:%d:%d&quot;</span>,<br>                 curr-&gt;tm_year + <span class="hljs-number">1900</span>, curr-&gt;tm_mon + <span class="hljs-number">1</span>, curr-&gt;tm_mday, curr-&gt;tm_hour, curr-&gt;tm_min, curr-&gt;tm_sec);<br>        <span class="hljs-keyword">return</span> time_buffer;<br>    &#125;<br> <br>    <span class="hljs-comment">// å†™å…¥åˆ°æ–‡ä»¶ä¸­</span><br>    <span class="hljs-type">void</span> <span class="hljs-title function_">WriteLogToOneFile</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-built_in">string</span> &amp;logname, <span class="hljs-type">const</span> <span class="hljs-built_in">string</span> &amp;message)</span><br>    &#123;<br>        FILE *fp = fopen(logname.c_str(), <span class="hljs-string">&quot;a&quot;</span>);<br>        <span class="hljs-keyword">if</span> (fp == nullptr)<br>        &#123;<br>            perror(<span class="hljs-string">&quot;fopen failed&quot;</span>);<br>            <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>        &#125;<br>        <span class="hljs-built_in">fprintf</span>(fp, <span class="hljs-string">&quot;%s\n&quot;</span>, message.c_str());<br> <br>        fclose(fp);<br>    &#125;<br> <br>    <span class="hljs-comment">// æ‰“å°æ—¥å¿—</span><br>    <span class="hljs-type">void</span> <span class="hljs-title function_">WriteLogToClassFile</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-built_in">string</span> &amp;levelstr, <span class="hljs-type">const</span> <span class="hljs-built_in">string</span> &amp;message)</span><br>    &#123;<br>        <span class="hljs-built_in">string</span> logname = logdir;<br>        logname += <span class="hljs-string">&quot;/&quot;</span>;<br>        logname += _filename;<br>        logname += levelstr;<br>        WriteLogToOneFile(logname, message);<br>    &#125;<br> <br>    <span class="hljs-type">pthread_mutex_t</span> lock = PTHREAD_MUTEX_INITIALIZER;<br>    <span class="hljs-type">void</span> <span class="hljs-title function_">WriteLog</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-built_in">string</span> &amp;levelstr, <span class="hljs-type">const</span> <span class="hljs-built_in">string</span> &amp;message)</span><br>    &#123;<br>        pthread_mutex_lock(&amp;lock);<br>        <span class="hljs-keyword">switch</span> (_style)<br>        &#123;<br>        <span class="hljs-keyword">case</span> Screen:<br>            <span class="hljs-built_in">cout</span> &lt;&lt; message &lt;&lt; <span class="hljs-built_in">endl</span>; <span class="hljs-comment">// æ‰“å°åˆ°å±å¹•ä¸­</span><br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> OneFile:<br>            WriteLogToClassFile(<span class="hljs-string">&quot;all&quot;</span>, message); <span class="hljs-comment">// ç»™å®šallï¼Œç›´æ¥å†™åˆ°allé‡Œ</span><br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> ClassFile:<br>            WriteLogToClassFile(levelstr, message); <span class="hljs-comment">// å†™å…¥levelstré‡Œ</span><br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">default</span>:<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>        pthread_mutex_unlock(&amp;lock);<br>    &#125;<br> <br>    <span class="hljs-comment">// æä¾›æ¥å£ç»™è¿ç®—ç¬¦é‡è½½ä½¿ç”¨</span><br>    <span class="hljs-type">void</span> _LogMessage(<span class="hljs-type">int</span> level, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *file, <span class="hljs-type">int</span> line, <span class="hljs-type">char</span> *rightbuffer)<br>    &#123;<br>        <span class="hljs-type">char</span> leftbuffer[<span class="hljs-number">1024</span>];<br>        <span class="hljs-built_in">string</span> levelstr = LevelToString(level);<br>        <span class="hljs-built_in">string</span> currtime = GetTime();<br>        <span class="hljs-built_in">string</span>  idstr = to_string(getpid());<br> <br>        <span class="hljs-built_in">snprintf</span>(leftbuffer, <span class="hljs-keyword">sizeof</span>(leftbuffer), <span class="hljs-string">&quot;[%s][%s][%s][%s:%d]&quot;</span>, levelstr.c_str(), currtime.c_str(), idstr.c_str(), file, line);<br> <br>        <span class="hljs-built_in">string</span> messages = leftbuffer;<br>        messages += rightbuffer;<br>        WriteLog(levelstr, messages);<br>    &#125;<br> <br>    <span class="hljs-comment">// è¿ç®—ç¬¦é‡è½½</span><br>    <span class="hljs-type">void</span> <span class="hljs-title function_">operator</span><span class="hljs-params">()</span><span class="hljs-params">(<span class="hljs-type">int</span> level, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *file, <span class="hljs-type">int</span> line, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *format, ...)</span><br>    &#123;<br>        <span class="hljs-type">char</span> rightbuffer[<span class="hljs-number">1024</span>];<br>        va_list args;                                              <span class="hljs-comment">// va_list æ˜¯æŒ‡é’ˆ</span><br>        va_start(args, format);                                    <span class="hljs-comment">// åˆå§‹åŒ–va_listå¯¹è±¡ï¼Œformatæ˜¯æœ€åä¸€ä¸ªç¡®å®šçš„å‚æ•°</span><br>        vsnprintf(rightbuffer, <span class="hljs-keyword">sizeof</span>(rightbuffer), format, args); <span class="hljs-comment">// å†™å…¥åˆ°rightbufferä¸­</span><br>        va_end(args);<br>        _LogMessage(level, file, line, rightbuffer);<br>    &#125;<br> <br>    ~Log()<br>    &#123;<br>    &#125;<br> <br>private:<br>    <span class="hljs-type">int</span> _style;<br>    <span class="hljs-built_in">string</span> _filename;<br>&#125;;<br> <br>Log lg;<br> <br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Conf</span></span><br><span class="hljs-class">&#123;</span><br>public:<br>    Conf()<br>    &#123;<br>        lg.Enable(Screen);<br>    &#125;<br>    ~Conf()<br>    &#123;<br>    &#125;<br>&#125;;<br> <br>Conf conf;<br> <br><span class="hljs-comment">// è¾…åŠ©å®</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> lg(level, format, ...) lg(level, __FILE__, __LINE__, format, ##__VA_ARGS__)</span><br></code></pre></td></tr></table></figure><p>Socket.hpp</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> once</span><br> <br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;netinet/in.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;arpa/inet.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cstring&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br>using namespace <span class="hljs-built_in">std</span>;<br>namespace Net_Work<br>&#123;<br>    <span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">int</span> default_backlog = <span class="hljs-number">5</span>;<br>    <span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">int</span> default_sockfd = <span class="hljs-number">-1</span>;<br>    using namespace <span class="hljs-built_in">std</span>;<br> <br>    <span class="hljs-class"><span class="hljs-keyword">enum</span></span><br><span class="hljs-class">    &#123;</span><br>        SocketError = <span class="hljs-number">1</span>,<br>        BindError,<br>        ListenError,<br>        ConnectError,<br>    &#125;;<br> <br>    <span class="hljs-comment">// å°è£…å¥—æ¥å­—æ¥å£åŸºç±»</span><br>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Socket</span></span><br><span class="hljs-class">    &#123;</span><br>    public:<br>        <span class="hljs-comment">// å°è£…äº†socketç›¸å…³æ–¹æ³•</span><br>        virtual ~Socket() &#123;&#125;<br>        virtual <span class="hljs-type">void</span> <span class="hljs-title function_">CreateSocket</span><span class="hljs-params">()</span> = <span class="hljs-number">0</span>;<br>        virtual <span class="hljs-type">void</span> <span class="hljs-title function_">BindSocket</span><span class="hljs-params">(<span class="hljs-type">uint16_t</span> port)</span> = <span class="hljs-number">0</span>;<br>        virtual <span class="hljs-type">void</span> <span class="hljs-title function_">ListenSocket</span><span class="hljs-params">(<span class="hljs-type">int</span> backlog)</span> = <span class="hljs-number">0</span>;<br>        virtual <span class="hljs-type">bool</span> <span class="hljs-title function_">ConnectSocket</span><span class="hljs-params">(<span class="hljs-built_in">string</span> &amp;serverip, <span class="hljs-type">uint16_t</span> serverport)</span> = <span class="hljs-number">0</span>;<br>        virtual <span class="hljs-type">int</span> <span class="hljs-title function_">AcceptSocket</span><span class="hljs-params">(<span class="hljs-built_in">string</span> *peerip, <span class="hljs-type">uint16_t</span> *peerport)</span> = <span class="hljs-number">0</span>;<br>        virtual <span class="hljs-type">int</span> <span class="hljs-title function_">GetSockFd</span><span class="hljs-params">()</span> = <span class="hljs-number">0</span>;<br>        virtual <span class="hljs-type">void</span> <span class="hljs-title function_">SetSockFd</span><span class="hljs-params">(<span class="hljs-type">int</span> sockfd)</span> = <span class="hljs-number">0</span>;<br>        virtual <span class="hljs-type">void</span> <span class="hljs-title function_">CloseSocket</span><span class="hljs-params">()</span> = <span class="hljs-number">0</span>;<br>        virtual <span class="hljs-type">bool</span> <span class="hljs-title function_">Recv</span><span class="hljs-params">(<span class="hljs-built_in">string</span> *buff, <span class="hljs-type">int</span> size)</span> = <span class="hljs-number">0</span>;<br>        virtual <span class="hljs-type">void</span> <span class="hljs-title function_">Send</span><span class="hljs-params">(<span class="hljs-built_in">string</span> &amp;send_string)</span> = <span class="hljs-number">0</span>;<br> <br>        <span class="hljs-comment">// æ–¹æ³•çš„é›†ä¸­åœ¨ä¸€èµ·ä½¿ç”¨</span><br>    public:<br>        <span class="hljs-type">void</span> <span class="hljs-title function_">BuildListenSocket</span><span class="hljs-params">(<span class="hljs-type">uint16_t</span> port, <span class="hljs-type">int</span> backlog = default_backlog)</span><br>        &#123;<br>            CreateSocket();<br>            BindSocket(port);<br>            ListenSocket(backlog);<br>        &#125;<br> <br>        <span class="hljs-type">bool</span> <span class="hljs-title function_">BuildConnectSocket</span><span class="hljs-params">(<span class="hljs-built_in">string</span> &amp;serverip, <span class="hljs-type">uint16_t</span> serverport)</span><br>        &#123;<br>            CreateSocket();<br>            <span class="hljs-keyword">return</span> ConnectSocket(serverip, serverport);<br>        &#125;<br> <br>        <span class="hljs-type">void</span> <span class="hljs-title function_">BuildNormalSocket</span><span class="hljs-params">(<span class="hljs-type">int</span> sockfd)</span><br>        &#123;<br>            SetSockFd(sockfd);<br>        &#125;<br>    &#125;;<br> <br>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TcpSocket</span> :</span> public Socket<br>    &#123;<br>    public:<br>        TcpSocket(<span class="hljs-type">int</span> sockfd = default_sockfd)<br>            : _sockfd(sockfd)<br>        &#123;<br>        &#125;<br>        ~TcpSocket() &#123;&#125;<br> <br>        <span class="hljs-type">void</span> <span class="hljs-title function_">CreateSocket</span><span class="hljs-params">()</span> override<br>        &#123;<br>            _sockfd = socket(AF_INET, SOCK_STREAM, <span class="hljs-number">0</span>);<br>            <span class="hljs-keyword">if</span> (_sockfd &lt; <span class="hljs-number">0</span>)<br>                <span class="hljs-built_in">exit</span>(SocketError);<br>        &#125;<br>        <span class="hljs-type">void</span> <span class="hljs-title function_">BindSocket</span><span class="hljs-params">(<span class="hljs-type">uint16_t</span> port)</span> override<br>        &#123;<br>            <span class="hljs-type">int</span> opt = <span class="hljs-number">1</span>;<br>            setsockopt(_sockfd, SOL_SOCKET, SO_REUSEADDR | SO_REUSEPORT, &amp;opt, <span class="hljs-keyword">sizeof</span>(opt));<br> <br>            <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr_in</span> <span class="hljs-title">local</span>;</span><br>            <span class="hljs-built_in">memset</span>(&amp;local, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(local));<br>            local.sin_family = AF_INET;<br>            local.sin_port = htons(port);<br>            local.sin_addr.s_addr = INADDR_ANY;<br> <br>            <span class="hljs-type">int</span> n = bind(_sockfd, (<span class="hljs-keyword">struct</span> sockaddr *)&amp;local, <span class="hljs-keyword">sizeof</span>(local));<br>            <span class="hljs-keyword">if</span> (n &lt; <span class="hljs-number">0</span>)<br>                <span class="hljs-built_in">exit</span>(BindError);<br>        &#125;<br>        <span class="hljs-type">void</span> <span class="hljs-title function_">ListenSocket</span><span class="hljs-params">(<span class="hljs-type">int</span> backlog)</span> override<br>        &#123;<br>            <span class="hljs-type">int</span> n = listen(_sockfd, backlog);<br>            <span class="hljs-keyword">if</span> (n &lt; <span class="hljs-number">0</span>)<br>                <span class="hljs-built_in">exit</span>(ListenError);<br>        &#125;<br>        <span class="hljs-type">bool</span> <span class="hljs-title function_">ConnectSocket</span><span class="hljs-params">(<span class="hljs-built_in">string</span> &amp;serverip, <span class="hljs-type">uint16_t</span> serverport)</span> override<br>        &#123;<br>            <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr_in</span> <span class="hljs-title">addr</span>;</span><br>            <span class="hljs-built_in">memset</span>(&amp;addr, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(addr));<br>            addr.sin_family = AF_INET;<br>            addr.sin_port = htons(serverport);<br>            <span class="hljs-comment">// addr.sin_addr.s_addr = inet_addr(serverip.c_str());</span><br>            inet_pton(AF_INET, serverip.c_str(), &amp;addr.sin_addr);<br>            <span class="hljs-type">int</span> n = connect(_sockfd, (sockaddr *)&amp;addr, <span class="hljs-keyword">sizeof</span>(addr));<br> <br>            <span class="hljs-keyword">if</span> (n == <span class="hljs-number">0</span>)<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>        <span class="hljs-type">int</span> <span class="hljs-title function_">AcceptSocket</span><span class="hljs-params">(<span class="hljs-built_in">string</span> *peerip, <span class="hljs-type">uint16_t</span> *peerport)</span> override<br>        &#123;<br>            <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr_in</span> <span class="hljs-title">addr</span>;</span><br>            <span class="hljs-type">socklen_t</span> len = <span class="hljs-keyword">sizeof</span>(addr);<br>            <span class="hljs-type">int</span> newsockfd = accept(_sockfd, (sockaddr *)&amp;addr, &amp;len);<br>            <span class="hljs-keyword">if</span> (newsockfd &lt; <span class="hljs-number">0</span>)<br>                <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br> <br>            <span class="hljs-comment">// *peerip = inet_ntoa(addr.sin_addr);</span><br> <br>            <span class="hljs-comment">// INET_ADDRSTRLEN æ˜¯ä¸€ä¸ªå®šä¹‰åœ¨å¤´æ–‡ä»¶ä¸­çš„å®ï¼Œè¡¨ç¤º IPv4 åœ°å€çš„æœ€å¤§é•¿åº¦</span><br>            <span class="hljs-type">char</span> ip_str[INET_ADDRSTRLEN];<br>            inet_ntop(AF_INET, &amp;addr.sin_addr, ip_str, INET_ADDRSTRLEN);<br>            *peerip = ip_str;<br> <br>            *peerport = ntohs(addr.sin_port);<br>            <span class="hljs-keyword">return</span> newsockfd;<br>        &#125;<br>        <span class="hljs-type">int</span> <span class="hljs-title function_">GetSockFd</span><span class="hljs-params">()</span> override<br>        &#123;<br>            <span class="hljs-keyword">return</span> _sockfd;<br>        &#125;<br>        <span class="hljs-type">void</span> <span class="hljs-title function_">SetSockFd</span><span class="hljs-params">(<span class="hljs-type">int</span> sockfd)</span> override<br>        &#123;<br>            _sockfd = sockfd;<br>        &#125;<br>        <span class="hljs-type">void</span> <span class="hljs-title function_">CloseSocket</span><span class="hljs-params">()</span> override<br>        &#123;<br>            <span class="hljs-keyword">if</span> (_sockfd &gt; default_sockfd)<br>                close(_sockfd);<br>        &#125;<br> <br>        <span class="hljs-type">bool</span> <span class="hljs-title function_">Recv</span><span class="hljs-params">(<span class="hljs-built_in">string</span> *buff, <span class="hljs-type">int</span> size)</span> override<br>        &#123;<br>            <span class="hljs-type">char</span> inbuffer[size];<br>            <span class="hljs-type">ssize_t</span> n = recv(_sockfd, inbuffer, size - <span class="hljs-number">1</span>, <span class="hljs-number">0</span>);<br>            <span class="hljs-keyword">if</span> (n &gt; <span class="hljs-number">0</span>)<br>            &#123;<br>                inbuffer[n] = <span class="hljs-number">0</span>;<br>                *buff += inbuffer;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>            &#125;<br>            <span class="hljs-keyword">else</span><br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br> <br>        <span class="hljs-type">void</span> <span class="hljs-title function_">Send</span><span class="hljs-params">(<span class="hljs-built_in">string</span> &amp;send_string)</span> override<br>        &#123;<br>            send(_sockfd, send_string.c_str(),send_string.size(),<span class="hljs-number">0</span>);<br>        &#125;<br> <br>    private:<br>        <span class="hljs-type">int</span> _sockfd;<br>        <span class="hljs-built_in">string</span> _ip;<br>        <span class="hljs-type">uint16_t</span> _port;<br>    &#125;;<br>&#125;<br></code></pre></td></tr></table></figure><p>PollServer.hpp</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> once</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;poll.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;memory&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;Log.hpp&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;Socket.hpp&quot;</span></span><br> <br>using namespace Net_Work;<br><span class="hljs-type">const</span> <span class="hljs-type">static</span> <span class="hljs-type">int</span> gdefaultport = <span class="hljs-number">8888</span>;<br><span class="hljs-type">const</span> <span class="hljs-type">static</span> <span class="hljs-type">int</span> gbacklog = <span class="hljs-number">8</span>;<br><span class="hljs-type">const</span> <span class="hljs-type">static</span> <span class="hljs-type">int</span> gnum = <span class="hljs-number">1024</span>;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PollServer</span></span><br><span class="hljs-class">&#123;</span><br>public:<br>    PollServer(<span class="hljs-type">int</span> port) : _port(port), _num(gnum), _listensock(new TcpSocket())<br>    &#123;<br>    &#125;<br>    <span class="hljs-type">void</span> <span class="hljs-title function_">HandlerEvent</span><span class="hljs-params">()</span><br>    &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; _num; i++)<br>        &#123;<br>            <span class="hljs-keyword">if</span> (_rfds[i].fd == <span class="hljs-number">-1</span>)<br>                <span class="hljs-keyword">continue</span>;<br> <br>            <span class="hljs-type">int</span> fd = _rfds[i].fd;<br>            <span class="hljs-type">short</span> revents = _rfds[i].revents;<br>            <span class="hljs-comment">// åˆ¤æ–­äº‹ä»¶æ˜¯å¦å°±ç»ª</span><br>            <span class="hljs-keyword">if</span> (revents &amp; POLLIN)<br>            &#123;<br>                <span class="hljs-comment">// è¯»äº‹ä»¶åˆ†ä¸¤ç±»ï¼Œä¸€ç±»æ˜¯æ–°é“¾æ¥åˆ°æ¥ï¼Œä¸€ç±»æ˜¯æ–°æ•°æ®åˆ°æ¥</span><br>                <span class="hljs-keyword">if</span> (fd == _listensock-&gt;GetSockFd())<br>                &#123;<br>                    <span class="hljs-comment">// æ–°é“¾æ¥åˆ°æ¥</span><br>                    lg(Info, <span class="hljs-string">&quot;get a new link&quot;</span>);<br>                    <span class="hljs-comment">// è·å–è¿æ¥</span><br>                    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> clientip;<br>                    <span class="hljs-type">uint16_t</span> clientport;<br>                    <span class="hljs-type">int</span> sockfd = _listensock-&gt;AcceptSocket(&amp;clientip, &amp;clientport);<br>                    <span class="hljs-keyword">if</span> (sockfd == <span class="hljs-number">-1</span>)<br>                    &#123;<br>                        lg(Error, <span class="hljs-string">&quot;accept error&quot;</span>);<br>                        <span class="hljs-keyword">continue</span>;<br>                    &#125;<br>                    lg(Info, <span class="hljs-string">&quot;get a client,client info is# %s:%d,fd: %d&quot;</span>, clientip.c_str(), clientport, sockfd);<br>                    <span class="hljs-comment">// æ­¤æ—¶è·å–è¿æ¥æˆåŠŸäº†ï¼Œä½†æ˜¯ä¸èƒ½ç›´æ¥read write,sockfdä»éœ€è¦äº¤ç»™pollæ‰˜ç®¡ -- æ·»åŠ åˆ°æ•°ç»„_rfdsä¸­</span><br>                    <span class="hljs-type">int</span> pos = <span class="hljs-number">0</span>;<br>                    <span class="hljs-keyword">for</span> (; pos &lt; _num; pos++)<br>                    &#123;<br>                        <span class="hljs-keyword">if</span> (_rfds[pos].fd == <span class="hljs-number">-1</span>)<br>                        &#123;<br>                            _rfds[pos].fd = sockfd;<br>                            _rfds[pos].events = POLLIN;<br>                            lg(Info, <span class="hljs-string">&quot;get a new link, fd is : %d&quot;</span>, sockfd);<br>                            <span class="hljs-keyword">break</span>;<br>                        &#125;<br>                    &#125;<br>                    <span class="hljs-keyword">if</span> (pos == _num)<br>                    &#123;<br>                        <span class="hljs-comment">// 1.æ‰©å®¹</span><br>                        <span class="hljs-comment">// 2.å…³é—­</span><br>                        close(sockfd);<br>                        lg(Warning, <span class="hljs-string">&quot;server is full, be carefull...&quot;</span>);<br>                    &#125;<br>                &#125;<br>                <span class="hljs-keyword">else</span><br>                &#123;<br>                    <span class="hljs-comment">// æ™®é€šçš„è¯»äº‹ä»¶å°±ç»ª</span><br>                    <span class="hljs-type">char</span> buffer[<span class="hljs-number">1024</span>];<br>                    <span class="hljs-type">ssize_t</span> n = recv(fd, buffer, <span class="hljs-keyword">sizeof</span>(buffer<span class="hljs-number">-1</span>), <span class="hljs-number">0</span>);<br>                    <span class="hljs-keyword">if</span> (n &gt; <span class="hljs-number">0</span>)<br>                    &#123;<br>                        buffer[n] = <span class="hljs-number">0</span>;<br>                        lg(Info, <span class="hljs-string">&quot;client say# %s&quot;</span>, buffer);<br>                        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> message = <span class="hljs-string">&quot;ä½ å¥½,åŒå¿—&quot;</span>;<br>                        message += buffer;<br>                        send(fd, message.c_str(), message.size(), <span class="hljs-number">0</span>);<br>                    &#125;<br>                    <span class="hljs-keyword">else</span><br>                    &#123;<br>                        lg(Warning, <span class="hljs-string">&quot;client quit ,maybe close or error,close fd: %d&quot;</span>, fd);<br>                        close(fd);<br>                        <span class="hljs-comment">// è¿˜è¦å–æ¶ˆpollçš„å…³å¿ƒ</span><br>                        _rfds[i].fd = <span class="hljs-number">-1</span>;<br>                        _rfds[i].events = <span class="hljs-number">0</span>;<br>                        _rfds[i].revents = <span class="hljs-number">0</span>;<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-type">void</span> <span class="hljs-title function_">InitServer</span><span class="hljs-params">()</span><br>    &#123;<br>        _listensock-&gt;BuildListenSocket(_port, gbacklog);<br>        _rfds = new <span class="hljs-keyword">struct</span> pollfd[_num];<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; _num; i++)<br>        &#123;<br>            _rfds[i].fd = <span class="hljs-number">-1</span>;<br>            _rfds[i].events = <span class="hljs-number">0</span>;<br>            _rfds[i].revents = <span class="hljs-number">0</span>;<br>        &#125;<br>        <span class="hljs-comment">// æœ€å¼€å§‹çš„æ—¶å€™ï¼Œåªæœ‰ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼ŒListensock</span><br>        _rfds[<span class="hljs-number">0</span>].fd = _listensock-&gt;GetSockFd();<br>        _rfds[<span class="hljs-number">0</span>].events |= POLLIN;<br>    &#125;<br> <br>    <span class="hljs-type">void</span> <span class="hljs-title function_">Loop</span><span class="hljs-params">()</span><br>    &#123;<br>        _isrunning = <span class="hljs-literal">true</span>;<br>        <span class="hljs-comment">// å¾ªç¯é‡ç½®selectéœ€è¦çš„rfds</span><br>        <span class="hljs-keyword">while</span> (_isrunning)<br>        &#123;<br>            <span class="hljs-comment">// å®šä¹‰æ—¶é—´</span><br>            <span class="hljs-type">int</span> timeout = <span class="hljs-number">1000</span>;<br> <br>            <span class="hljs-comment">//PrintDebug();</span><br> <br>            <span class="hljs-comment">// rfdsæ˜¯è¾“å…¥è¾“å‡ºå‹å‚æ•°ï¼Œrfdsæ˜¯åœ¨selectè°ƒç”¨è¿”å›æ—¶ï¼Œä¸æ–­è¢«ä¿®æ”¹ï¼Œæ‰€ä»¥æ¯æ¬¡éœ€è¦é‡ç½®rfds</span><br>            <span class="hljs-type">int</span> n = poll(_rfds, _num, timeout);<br>            <span class="hljs-keyword">switch</span> (n)<br>            &#123;<br>            <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:<br>                lg(Info, <span class="hljs-string">&quot;select timeout...&quot;</span>);<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> <span class="hljs-number">-1</span>:<br>                lg(Error, <span class="hljs-string">&quot;select error!!!&quot;</span>);<br>            <span class="hljs-keyword">default</span>:<br>                <span class="hljs-comment">// æ­£å¸¸å°±ç»ªçš„fd</span><br>                lg(Info, <span class="hljs-string">&quot;select success,begin event handler&quot;</span>);<br>                HandlerEvent();<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>        _isrunning = <span class="hljs-literal">false</span>;<br>    &#125;<br> <br>    <span class="hljs-type">void</span> <span class="hljs-title function_">Stop</span><span class="hljs-params">()</span><br>    &#123;<br>        _isrunning = <span class="hljs-literal">false</span>;<br>    &#125;<br> <br>    <span class="hljs-type">void</span> <span class="hljs-title function_">PrintDebug</span><span class="hljs-params">()</span><br>    &#123;<br>        <span class="hljs-comment">// std::cout &lt;&lt; &quot;current select rfds list is :&quot;;</span><br>        <span class="hljs-comment">// for (int i = 0; i &lt; num; i++)</span><br>        <span class="hljs-comment">// &#123;</span><br>        <span class="hljs-comment">//     if (_rfds_array[i] == nullptr)</span><br>        <span class="hljs-comment">//         continue;</span><br>        <span class="hljs-comment">//     else</span><br>        <span class="hljs-comment">//         std::cout &lt;&lt; _rfds_array[i]-&gt;GetSockFd() &lt;&lt; &quot; &quot;;</span><br>        <span class="hljs-comment">// &#125;</span><br>        <span class="hljs-comment">// std::cout &lt;&lt; std::endl;</span><br>    &#125;<br> <br>private:<br>    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">unique_ptr</span>&lt;Socket&gt; _listensock;<br>    <span class="hljs-type">int</span> _port;<br>    <span class="hljs-type">bool</span> _isrunning;<br> <br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pollfd</span> *_<span class="hljs-title">rfds</span>;</span><br>    <span class="hljs-type">int</span> _num;<br>&#125;;<br></code></pre></td></tr></table></figure><p> Main.cc</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;memory&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;PollServer.hpp&quot;</span></span><br> <br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Usage</span><span class="hljs-params">(<span class="hljs-type">char</span>* argv)</span></span><br><span class="hljs-function"></span>&#123;<br>  <br>    std::cout&lt;&lt;<span class="hljs-string">&quot;Usage: \n\t&quot;</span>&lt;&lt;argv&lt;&lt;<span class="hljs-string">&quot; port\n&quot;</span>&lt;&lt;std::endl;<br>&#125;<br><span class="hljs-comment">// ./select_server 8080</span><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc,<span class="hljs-type">char</span>* argv[])</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-comment">// std::cout&lt;&lt;num&lt;&lt;std::endl;       1024</span><br>    <span class="hljs-keyword">if</span>(argc!=<span class="hljs-number">2</span>)<br>    &#123;<br>        <span class="hljs-built_in">Usage</span>(argv[<span class="hljs-number">0</span>]);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br>    <span class="hljs-type">uint16_t</span> localport = std::<span class="hljs-built_in">stoi</span>(argv[<span class="hljs-number">1</span>]);<br>    std::unique_ptr&lt;PollServer&gt; svr = std::<span class="hljs-built_in">make_unique</span>&lt;PollServer&gt;(localport);<br>    svr-&gt;<span class="hljs-built_in">InitServer</span>();<br>    svr-&gt;<span class="hljs-built_in">Loop</span>();<br> <br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿è¡Œç»“æœå¦‚ä¸‹ï¼Œç”±äºæˆ‘ä»¬pollç¬¬ä¸‰ä¸ªå‚æ•°è®¾ç½®çš„æ˜¯1000msï¼Œå› æ­¤æ¯ä¸€ç§’polléƒ½ä¼šè¿”å›ï¼Œå½“å‘ç°æœ‰æ–°é“¾æ¥çš„æ—¶å€™ï¼Œå°±å›å»æ‰§è¡Œå‡½æ•°ï¼Œåœ¨å‡½æ•°ä¸­è°ƒç”¨writeæˆ–è€…readå˜ä¸ä¼šå†é˜»å¡äº†ã€‚ </p><p><img src="https://raw.githubusercontent.com/mengchao666/picture/main/blog03c25829c18e4621add56de57fd2a1aa.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;ä¸€ã€pollä»‹ç»&quot;&gt;&lt;a href=&quot;#ä¸€ã€pollä»‹ç»&quot; class=&quot;headerlink&quot; title=&quot;ä¸€ã€pollä»‹ç»&quot;&gt;&lt;/a&gt;ä¸€ã€pollä»‹ç»&lt;/h3&gt;&lt;p&gt;pollä¸selectä¸€æ ·ï¼Œåªè´Ÿè´£IOçš„ç­‰çš„è¿‡ç¨‹ï¼Œåªä¸è¿‡ä¸€æ¬¡å¯ä»¥ç­‰å¾…å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œä»–çš„ä½œç”¨</summary>
      
    
    
    
    <category term="Cè¯­è¨€" scheme="http://example.com/categories/C%E8%AF%AD%E8%A8%80/"/>
    
    
    <category term="Cè¯­è¨€" scheme="http://example.com/tags/C%E8%AF%AD%E8%A8%80/"/>
    
  </entry>
  
  <entry>
    <title>è¿›ç¨‹é—´é€šä¿¡</title>
    <link href="http://example.com/posts/%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1.html"/>
    <id>http://example.com/posts/%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1.html</id>
    <published>2024-11-25T14:46:19.000Z</published>
    <updated>2024-11-25T14:46:36.963Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ä¸€ã€ä»€ä¹ˆæ˜¯æ¶ˆæ¯é˜Ÿåˆ—"><a href="#ä¸€ã€ä»€ä¹ˆæ˜¯æ¶ˆæ¯é˜Ÿåˆ—" class="headerlink" title="ä¸€ã€ä»€ä¹ˆæ˜¯æ¶ˆæ¯é˜Ÿåˆ—"></a>ä¸€ã€ä»€ä¹ˆæ˜¯æ¶ˆæ¯é˜Ÿåˆ—</h2><p>æ¶ˆæ¯é˜Ÿåˆ—æä¾›äº†ä¸€ç§ä»ä¸€ä¸ªè¿›ç¨‹å‘å¦ä¸€ä¸ªè¿›ç¨‹å‘é€ä¸€ä¸ªæ•°æ®å—çš„æ–¹æ³•ã€‚  æ¯ä¸ªæ•°æ®å—éƒ½è¢«è®¤ä¸ºå«æœ‰ä¸€ä¸ªç±»å‹ï¼Œæ¥æ”¶è¿›ç¨‹å¯ä»¥ç‹¬ç«‹åœ°æ¥æ”¶å«æœ‰ä¸åŒç±»å‹çš„æ•°æ®ç»“æ„ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡å‘é€æ¶ˆæ¯æ¥é¿å…å‘½åç®¡é“çš„åŒæ­¥å’Œé˜»å¡é—®é¢˜ã€‚ä½†æ˜¯æ¶ˆæ¯é˜Ÿåˆ—ä¸å‘½åç®¡é“ä¸€æ ·ï¼Œæ¯ä¸ªæ•°æ®å—éƒ½æœ‰ä¸€ä¸ªæœ€å¤§é•¿åº¦çš„é™åˆ¶ã€‚</p><p>Linuxç”¨å®MSGMAXå’ŒMSGMNBæ¥é™åˆ¶ä¸€æ¡æ¶ˆæ¯çš„æœ€å¤§é•¿åº¦å’Œä¸€ä¸ªé˜Ÿåˆ—çš„æœ€å¤§é•¿åº¦ã€‚</p><h2 id="äºŒã€åœ¨Linuxä¸­ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—"><a href="#äºŒã€åœ¨Linuxä¸­ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—" class="headerlink" title="äºŒã€åœ¨Linuxä¸­ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—"></a>äºŒã€åœ¨Linuxä¸­ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—</h2><p>Linuxæä¾›äº†ä¸€ç³»åˆ—æ¶ˆæ¯é˜Ÿåˆ—çš„å‡½æ•°æ¥å£æ¥è®©æˆ‘ä»¬æ–¹ä¾¿åœ°ä½¿ç”¨å®ƒæ¥å®ç°è¿›ç¨‹é—´çš„é€šä¿¡ã€‚å®ƒçš„ç”¨æ³•ä¸å…¶ä»–ä¸¤ä¸ªSystem V PICæœºåˆ¶ï¼Œå³ä¿¡å·é‡å’Œå…±äº«å†…å­˜ç›¸ä¼¼ã€‚</p><h3 id="1ã€msggetå‡½æ•°"><a href="#1ã€msggetå‡½æ•°" class="headerlink" title="1ã€msggetå‡½æ•°"></a>1ã€msggetå‡½æ•°</h3><p>è¯¥å‡½æ•°ç”¨æ¥åˆ›å»ºå’Œè®¿é—®ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ã€‚å®ƒçš„åŸå‹ä¸ºï¼š</p><p><code>int msgget(key_t, key, int msgflg);</code></p><p>ä¸å…¶ä»–çš„IPCæœºåˆ¶ä¸€æ ·ï¼Œç¨‹åºå¿…é¡»æä¾›ä¸€ä¸ªé”®æ¥å‘½åæŸä¸ªç‰¹å®šçš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚msgflgæ˜¯ä¸€ä¸ªæƒé™æ ‡å¿—ï¼Œè¡¨ç¤ºæ¶ˆæ¯é˜Ÿåˆ—çš„è®¿é—®æƒé™ï¼Œå®ƒä¸æ–‡ä»¶çš„è®¿é—®æƒé™ä¸€æ ·ã€‚msgflgå¯ä»¥ä¸IPC_CREATåšæˆ–æ“ä½œï¼Œè¡¨ç¤ºå½“keyæ‰€å‘½åçš„æ¶ˆæ¯é˜Ÿåˆ—ä¸å­˜åœ¨æ—¶åˆ›å»ºä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¦‚æœkeyæ‰€å‘½åçš„æ¶ˆæ¯é˜Ÿåˆ—å­˜åœ¨æ—¶ï¼ŒIPC_CREATæ ‡å¿—ä¼šè¢«å¿½ç•¥ï¼Œè€Œåªè¿”å›ä¸€ä¸ªæ ‡è¯†ç¬¦ã€‚</p><p>å®ƒè¿”å›ä¸€ä¸ªä»¥keyå‘½åçš„æ¶ˆæ¯é˜Ÿåˆ—çš„æ ‡è¯†ç¬¦ï¼ˆéé›¶æ•´æ•°ï¼‰ï¼Œå¤±è´¥æ—¶è¿”å›-1.</p><h3 id="2ã€msgsndå‡½æ•°"><a href="#2ã€msgsndå‡½æ•°" class="headerlink" title="2ã€msgsndå‡½æ•°"></a>2ã€msgsndå‡½æ•°</h3><p>è¯¥å‡½æ•°ç”¨æ¥æŠŠæ¶ˆæ¯æ·»åŠ åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­ã€‚å®ƒçš„åŸå‹ä¸ºï¼š</p><p><code>int msgsend(int msgid, const void *msg_ptr, size_t msg_sz, int msgflg);</code></p><p>msgidæ˜¯ç”±msggetå‡½æ•°è¿”å›çš„æ¶ˆæ¯é˜Ÿåˆ—æ ‡è¯†ç¬¦ã€‚</p><p><strong>msg_ptræ˜¯ä¸€ä¸ªæŒ‡å‘å‡†å¤‡å‘é€æ¶ˆæ¯çš„æŒ‡é’ˆï¼Œä½†æ˜¯æ¶ˆæ¯çš„æ•°æ®ç»“æ„å´æœ‰ä¸€å®šçš„è¦æ±‚ï¼ŒæŒ‡é’ˆmsg_ptræ‰€æŒ‡å‘çš„æ¶ˆæ¯ç»“æ„ä¸€å®šè¦æ˜¯ä»¥ä¸€ä¸ªé•¿æ•´å‹æˆå‘˜å˜é‡å¼€å§‹çš„ç»“æ„ä½“ï¼Œæ¥æ”¶å‡½æ•°å°†ç”¨è¿™ä¸ªæˆå‘˜æ¥ç¡®å®šæ¶ˆæ¯çš„ç±»å‹ã€‚æ‰€ä»¥æ¶ˆæ¯ç»“æ„è¦å®šä¹‰æˆè¿™æ ·</strong>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">my_message</span>&#123;</span>     <br>  <span class="hljs-type">long</span> <span class="hljs-type">int</span> message_type;     <br>  <span class="hljs-comment">/* The data you wish to transfer*/</span> <br>&#125;;<br></code></pre></td></tr></table></figure><p>msg_szæ˜¯msg_ptræŒ‡å‘çš„æ¶ˆæ¯çš„é•¿åº¦ï¼Œæ³¨æ„æ˜¯æ¶ˆæ¯çš„é•¿åº¦ï¼Œè€Œä¸æ˜¯æ•´ä¸ªç»“æ„ä½“çš„é•¿åº¦ï¼Œä¹Ÿå°±æ˜¯è¯´msg_szæ˜¯ä¸åŒ…æ‹¬é•¿æ•´å‹æ¶ˆæ¯ç±»å‹æˆå‘˜å˜é‡çš„é•¿åº¦ã€‚</p><p>msgflgç”¨äºæ§åˆ¶å½“å‰æ¶ˆæ¯é˜Ÿåˆ—æ»¡æˆ–é˜Ÿåˆ—æ¶ˆæ¯åˆ°è¾¾ç³»ç»ŸèŒƒå›´çš„é™åˆ¶æ—¶å°†è¦å‘ç”Ÿçš„äº‹æƒ…ã€‚</p><p>å¦‚æœè°ƒç”¨æˆåŠŸï¼Œæ¶ˆæ¯æ•°æ®çš„ä¸€åˆ†å‰¯æœ¬å°†è¢«æ”¾åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œå¹¶è¿”å›0ï¼Œå¤±è´¥æ—¶è¿”å›-1.</p><h3 id="3ã€msgrcvå‡½æ•°"><a href="#3ã€msgrcvå‡½æ•°" class="headerlink" title="3ã€msgrcvå‡½æ•°"></a>3ã€msgrcvå‡½æ•°</h3><p>è¯¥å‡½æ•°ç”¨æ¥ä»ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—è·å–æ¶ˆæ¯ï¼Œå®ƒçš„åŸå‹ä¸º</p><p><code>int msgrcv(int msgid, void *msg_ptr, size_t msg_st, long int msgtype, int msgflg);</code></p><p>msgid, msg_ptr, msg_stçš„ä½œç”¨ä¹Ÿå‡½æ•°msgsndå‡½æ•°çš„ä¸€æ ·ã€‚</p><p>msgtypeå¯ä»¥å®ç°ä¸€ç§ç®€å•çš„æ¥æ”¶ä¼˜å…ˆçº§ã€‚å¦‚æœmsgtypeä¸º0ï¼Œå°±è·å–é˜Ÿåˆ—ä¸­çš„ç¬¬ä¸€ä¸ªæ¶ˆæ¯ã€‚å¦‚æœå®ƒçš„å€¼å¤§äºé›¶ï¼Œå°†è·å–å…·æœ‰ç›¸åŒæ¶ˆæ¯ç±»å‹çš„ç¬¬ä¸€ä¸ªä¿¡æ¯ã€‚å¦‚æœå®ƒå°äºé›¶ï¼Œå°±è·å–ç±»å‹ç­‰äºæˆ–å°äºmsgtypeçš„ç»å¯¹å€¼çš„ç¬¬ä¸€ä¸ªæ¶ˆæ¯ã€‚</p><p>msgflgç”¨äºæ§åˆ¶å½“é˜Ÿåˆ—ä¸­æ²¡æœ‰ç›¸åº”ç±»å‹çš„æ¶ˆæ¯å¯ä»¥æ¥æ”¶æ—¶å°†å‘ç”Ÿçš„äº‹æƒ…ã€‚</p><p>è°ƒç”¨æˆåŠŸæ—¶ï¼Œè¯¥å‡½æ•°è¿”å›æ”¾åˆ°æ¥æ”¶ç¼“å­˜åŒºä¸­çš„å­—èŠ‚æ•°ï¼Œæ¶ˆæ¯è¢«å¤åˆ¶åˆ°ç”±msg_ptræŒ‡å‘çš„ç”¨æˆ·åˆ†é…çš„ç¼“å­˜åŒºä¸­ï¼Œç„¶ååˆ é™¤æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„å¯¹åº”æ¶ˆæ¯ã€‚å¤±è´¥æ—¶è¿”å›-1.</p><h3 id="4ã€msgctlå‡½æ•°"><a href="#4ã€msgctlå‡½æ•°" class="headerlink" title="4ã€msgctlå‡½æ•°"></a>4ã€msgctlå‡½æ•°</h3><p>è¯¥å‡½æ•°ç”¨æ¥æ§åˆ¶æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå®ƒä¸å…±äº«å†…å­˜çš„shmctlå‡½æ•°ç›¸ä¼¼ï¼Œå®ƒçš„åŸå‹ä¸ºï¼š</p><p><code>int msgctl(int msgid, int command, struct msgid_ds *buf);</code></p><p>commandæ˜¯å°†è¦é‡‡å–çš„åŠ¨ä½œï¼Œå®ƒå¯ä»¥å–3ä¸ªå€¼ï¼Œ     IPC_STATï¼šæŠŠmsgid_dsç»“æ„ä¸­çš„æ•°æ®è®¾ç½®ä¸ºæ¶ˆæ¯é˜Ÿåˆ—çš„å½“å‰å…³è”å€¼ï¼Œå³ç”¨æ¶ˆæ¯é˜Ÿåˆ—çš„å½“å‰å…³è”å€¼è¦†ç›–msgid_dsçš„å€¼ã€‚     IPC_SETï¼šå¦‚æœè¿›ç¨‹æœ‰è¶³å¤Ÿçš„æƒé™ï¼Œå°±æŠŠæ¶ˆæ¯åˆ—é˜Ÿçš„å½“å‰å…³è”å€¼è®¾ç½®ä¸ºmsgid_dsç»“æ„ä¸­ç»™å‡ºçš„å€¼     IPC_RMIDï¼šåˆ é™¤æ¶ˆæ¯é˜Ÿåˆ—</p><p>bufæ˜¯æŒ‡å‘msgid_dsç»“æ„çš„æŒ‡é’ˆï¼Œå®ƒæŒ‡å‘æ¶ˆæ¯é˜Ÿåˆ—æ¨¡å¼å’Œè®¿é—®æƒé™çš„ç»“æ„ã€‚msgid_dsç»“æ„è‡³å°‘åŒ…æ‹¬ä»¥ä¸‹æˆå‘˜ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msgid_ds</span> </span><br><span class="hljs-class">&#123;</span>     <br>  <span class="hljs-type">uid_t</span> shm_perm.uid;     <br>  <span class="hljs-type">uid_t</span> shm_perm.gid;     <br>  <span class="hljs-type">mode_t</span> shm_perm.mode; <br>&#125;;<br></code></pre></td></tr></table></figure><p>æˆåŠŸæ—¶è¿”å›0ï¼Œå¤±è´¥æ—¶è¿”å›-1.</p><h2 id="ä¸‰ã€ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—è¿›è¡Œè¿›ç¨‹é—´é€šä¿¡"><a href="#ä¸‰ã€ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—è¿›è¡Œè¿›ç¨‹é—´é€šä¿¡" class="headerlink" title="ä¸‰ã€ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—è¿›è¡Œè¿›ç¨‹é—´é€šä¿¡"></a>ä¸‰ã€ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—è¿›è¡Œè¿›ç¨‹é—´é€šä¿¡</h2><p>é©¬ä¸åœè¹„ï¼Œä»‹ç»å®Œæ¶ˆæ¯é˜Ÿåˆ—çš„å®šä¹‰å’Œå¯ä½¿ç”¨çš„æ¥å£ä¹‹åï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹å®ƒæ˜¯æ€ä¹ˆè®©è¿›ç¨‹è¿›è¡Œé€šä¿¡çš„ã€‚ç”±äºå¯ä»¥è®©ä¸ç›¸å…³çš„è¿›ç¨‹è¿›è¡Œè¡Œé€šä¿¡ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨è¿™é‡Œå°†ä¼šç¼–å†™ä¸¤ä¸ªç¨‹åºï¼Œmsgreceiveå’Œmsgsnedæ¥è¡¨ç¤ºæ¥æ”¶å’Œå‘é€ä¿¡æ¯ã€‚æ ¹æ®æ­£å¸¸çš„æƒ…å†µï¼Œæˆ‘ä»¬å…è®¸ä¸¤ä¸ªç¨‹åºéƒ½å¯ä»¥åˆ›å»ºæ¶ˆæ¯ï¼Œä½†åªæœ‰æ¥æ”¶è€…åœ¨æ¥æ”¶å®Œæœ€åä¸€ä¸ªæ¶ˆæ¯ä¹‹åï¼Œå®ƒæ‰æŠŠå®ƒåˆ é™¤ã€‚</p><p>æ¥æ”¶ä¿¡æ¯çš„ç¨‹åºæºæ–‡ä»¶ä¸ºmsgreceive.cçš„æºä»£ç ä¸ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span> </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span> </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span> </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span> </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span> </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/msg.h&gt;</span>   </span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_st</span> &#123;</span>  <br>  <span class="hljs-type">long</span> <span class="hljs-type">int</span> msg_type;  <br>  <span class="hljs-type">char</span> text[BUFSIZ]; <br>&#125;;   <br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;  <br>  <span class="hljs-type">int</span> running = <span class="hljs-number">1</span>;  <br>  <span class="hljs-type">int</span> msgid = <span class="hljs-number">-1</span>;  <br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_st</span> <span class="hljs-title">data</span>;</span>  <br>  <span class="hljs-type">long</span> <span class="hljs-type">int</span> msgtype = <span class="hljs-number">0</span>; <span class="hljs-comment">//æ³¨æ„1    </span><br><br>  <span class="hljs-comment">//å»ºç«‹æ¶ˆæ¯é˜Ÿåˆ—  </span><br>  msgid = msgget((<span class="hljs-type">key_t</span>)<span class="hljs-number">1234</span>, <span class="hljs-number">0666</span> | IPC_CREAT);  <br>  <span class="hljs-keyword">if</span>(msgid == <span class="hljs-number">-1</span>)  &#123;   <br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;msgget failed with error: %d\n&quot;</span>, errno);   <br>    <span class="hljs-built_in">exit</span>(EXIT_FAILURE);  <br>  &#125;  <br><br>  <span class="hljs-comment">//ä»é˜Ÿåˆ—ä¸­è·å–æ¶ˆæ¯ï¼Œç›´åˆ°é‡åˆ°endæ¶ˆæ¯ä¸ºæ­¢  </span><br>  <span class="hljs-keyword">while</span>(running)  &#123;   <br>    <span class="hljs-keyword">if</span>(msgrcv(msgid, (<span class="hljs-type">void</span>*)&amp;data, BUFSIZ, msgtype, <span class="hljs-number">0</span>) == <span class="hljs-number">-1</span>)   <br>    &#123;    <br>      <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;msgrcv failed with errno: %d\n&quot;</span>, errno);    <br>      <span class="hljs-built_in">exit</span>(EXIT_FAILURE);   <br>    &#125;   <br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;You wrote: %s\n&quot;</span>,data.text);   <br>    <span class="hljs-comment">//é‡åˆ°endç»“æŸ</span><br>    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">strncmp</span>(data.text, <span class="hljs-string">&quot;end&quot;</span>, <span class="hljs-number">3</span>) == <span class="hljs-number">0</span>)    <br>      running = <span class="hljs-number">0</span>;  <br>  &#125;  <br>  <span class="hljs-comment">//åˆ é™¤æ¶ˆæ¯é˜Ÿåˆ—  </span><br>  <span class="hljs-keyword">if</span>(msgctl(msgid, IPC_RMID, <span class="hljs-number">0</span>) == <span class="hljs-number">-1</span>)  &#123;   <br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;msgctl(IPC_RMID) failed\n&quot;</span>);   <br>    <span class="hljs-built_in">exit</span>(EXIT_FAILURE);  <br>  &#125;  <br>  <span class="hljs-built_in">exit</span>(EXIT_SUCCESS); <br>&#125;<br></code></pre></td></tr></table></figure><p>å‘é€ä¿¡æ¯çš„ç¨‹åºçš„æºæ–‡ä»¶msgsend.cçš„æºä»£ç ä¸ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span> </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span> </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span> </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span> </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/msg.h&gt;</span> </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span>   </span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAX_TEXT 512 </span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_st</span> &#123;</span>  <br>  <span class="hljs-type">long</span> <span class="hljs-type">int</span> msg_type;  <br>  <span class="hljs-type">char</span> text[MAX_TEXT]; <br>&#125;;   <br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;  <br>  <span class="hljs-type">int</span> running = <span class="hljs-number">1</span>;  <br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msg_st</span> <span class="hljs-title">data</span>;</span>  <br>  <span class="hljs-type">char</span> buffer[BUFSIZ];  <br>  <span class="hljs-type">int</span> msgid = <span class="hljs-number">-1</span>;    <br><br>  <span class="hljs-comment">//å»ºç«‹æ¶ˆæ¯é˜Ÿåˆ—  </span><br>  msgid = msgget((<span class="hljs-type">key_t</span>)<span class="hljs-number">1234</span>, <span class="hljs-number">0666</span> | IPC_CREAT);  <br>  <span class="hljs-keyword">if</span>(msgid == <span class="hljs-number">-1</span>)  &#123;   <br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;msgget failed with error: %d\n&quot;</span>, errno);   <br>    <span class="hljs-built_in">exit</span>(EXIT_FAILURE);  <br>  &#125;    <br><br>  <span class="hljs-comment">//å‘æ¶ˆæ¯é˜Ÿåˆ—ä¸­å†™æ¶ˆæ¯ï¼Œç›´åˆ°å†™å…¥end  </span><br>  <span class="hljs-keyword">while</span>(running)  &#123;   <br>  <span class="hljs-comment">//è¾“å…¥æ•°æ®   </span><br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Enter some text: &quot;</span>);   <br>  fgets(buffer, BUFSIZ, <span class="hljs-built_in">stdin</span>);   <br>  data.msg_type = <span class="hljs-number">1</span>;    <span class="hljs-comment">//æ³¨æ„2   </span><br>  <span class="hljs-built_in">strcpy</span>(data.text, buffer);   <br>  <br>  <span class="hljs-comment">//å‘é˜Ÿåˆ—å‘é€æ•°æ®   </span><br>  <span class="hljs-keyword">if</span>(msgsnd(msgid, (<span class="hljs-type">void</span>*)&amp;data, MAX_TEXT, <span class="hljs-number">0</span>) == <span class="hljs-number">-1</span>)   <br>  &#123;    <br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;msgsnd failed\n&quot;</span>);    <br>    <span class="hljs-built_in">exit</span>(EXIT_FAILURE);   <br>  &#125;  <br><br>  <span class="hljs-comment">//è¾“å…¥endç»“æŸè¾“å…¥   </span><br>  <span class="hljs-keyword">if</span>(<span class="hljs-built_in">strncmp</span>(buffer, <span class="hljs-string">&quot;end&quot;</span>, <span class="hljs-number">3</span>) == <span class="hljs-number">0</span>)    <br>    running = <span class="hljs-number">0</span>;   <br>  sleep(<span class="hljs-number">1</span>);  <br>  &#125;  <br>  <span class="hljs-built_in">exit</span>(EXIT_SUCCESS); <br>&#125;<br></code></pre></td></tr></table></figure><h2 id="å››ã€ä¾‹å­åˆ†æâ€”â€”æ¶ˆæ¯ç±»å‹"><a href="#å››ã€ä¾‹å­åˆ†æâ€”â€”æ¶ˆæ¯ç±»å‹" class="headerlink" title="å››ã€ä¾‹å­åˆ†æâ€”â€”æ¶ˆæ¯ç±»å‹"></a>å››ã€ä¾‹å­åˆ†æâ€”â€”æ¶ˆæ¯ç±»å‹</h2><p>è¿™é‡Œä¸»è¦è¯´æ˜ä¸€ä¸‹æ¶ˆæ¯ç±»å‹æ˜¯æ€ä¹ˆä¸€å›äº‹ï¼Œæ³¨æ„msgreceive.cæ–‡ä»¶mainå‡½æ•°ä¸­å®šä¹‰çš„å˜é‡msgtypeï¼ˆæ³¨é‡Šä¸ºæ³¨æ„1ï¼‰ï¼Œå®ƒä½œä¸ºmsgrcvå‡½æ•°çš„æ¥æ”¶ä¿¡æ¯ç±»å‹å‚æ•°çš„å€¼ï¼Œå…¶å€¼ä¸º0ï¼Œè¡¨ç¤ºè·å–é˜Ÿåˆ—ä¸­ç¬¬ä¸€ä¸ªå¯ç”¨çš„æ¶ˆæ¯ã€‚å†æ¥çœ‹çœ‹msgsend.cæ–‡ä»¶ä¸­whileå¾ªç¯ä¸­çš„è¯­å¥data.msg_type &#x3D; 1ï¼ˆæ³¨é‡Šä¸ºæ³¨æ„2ï¼‰ï¼Œå®ƒç”¨æ¥è®¾ç½®å‘é€çš„ä¿¡æ¯çš„ä¿¡æ¯ç±»å‹ï¼Œå³å…¶å‘é€çš„ä¿¡æ¯çš„ç±»å‹ä¸º1ã€‚æ‰€ä»¥ç¨‹åºmsgreceiveèƒ½å¤Ÿæ¥æ”¶åˆ°ç¨‹åºmsgsendå‘é€çš„ä¿¡æ¯ã€‚</p><p>å¦‚æœæŠŠæ³¨æ„1ï¼Œå³msgreceive.cæ–‡ä»¶mainå‡½æ•°ä¸­çš„è¯­å¥ç”± long int msgtype &#x3D; 0;æ”¹å˜ä¸ºlong int msgtype &#x3D; 2;ä¼šå‘ç”Ÿä»€ä¹ˆæƒ…å†µï¼Œmsgreceiveå°†ä¸èƒ½æ¥æ”¶åˆ°ç¨‹åºmsgsendå‘é€çš„ä¿¡æ¯ã€‚å› ä¸ºåœ¨è°ƒç”¨msgrcvå‡½æ•°æ—¶ï¼Œå¦‚æœmsgtypeï¼ˆç¬¬å››ä¸ªå‚æ•°ï¼‰å¤§äºé›¶ï¼Œåˆ™å°†åªè·å–å…·æœ‰ç›¸åŒæ¶ˆæ¯ç±»å‹çš„ç¬¬ä¸€ä¸ªæ¶ˆæ¯ï¼Œä¿®æ”¹åè·å–çš„æ¶ˆæ¯ç±»å‹ä¸º2ï¼Œè€Œmsgsendå‘é€çš„æ¶ˆæ¯ç±»å‹ä¸º1ï¼Œæ‰€ä»¥ä¸èƒ½è¢«msgreceiveç¨‹åºæ¥æ”¶ã€‚é‡æ–°ç¼–è¯‘msgreceive.cæ–‡ä»¶å¹¶å†æ¬¡æ‰§è¡Œ</p><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œmsgreceiveå¹¶æ²¡æœ‰æ¥æ”¶åˆ°ä¿¡æ¯å’Œè¾“å‡ºï¼Œè€Œä¸”å½“msgsendè¾“å…¥endç»“æŸåï¼Œmsgreceiveä¹Ÿæ²¡æœ‰ç»“æŸï¼Œé€šè¿‡jobså‘½ä»¤æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å®ƒè¿˜åœ¨åå°è¿è¡Œç€ã€‚</p><h2 id="äº”ã€æ¶ˆæ¯é˜Ÿåˆ—ä¸å‘½åç®¡é“çš„æ¯”è¾ƒ"><a href="#äº”ã€æ¶ˆæ¯é˜Ÿåˆ—ä¸å‘½åç®¡é“çš„æ¯”è¾ƒ" class="headerlink" title="äº”ã€æ¶ˆæ¯é˜Ÿåˆ—ä¸å‘½åç®¡é“çš„æ¯”è¾ƒ"></a>äº”ã€æ¶ˆæ¯é˜Ÿåˆ—ä¸å‘½åç®¡é“çš„æ¯”è¾ƒ</h2><p>æ¶ˆæ¯é˜Ÿåˆ—è·Ÿå‘½åç®¡é“æœ‰ä¸å°‘çš„ç›¸åŒä¹‹å¤„ï¼Œé€šè¿‡ä¸å‘½åç®¡é“ä¸€æ ·ï¼Œæ¶ˆæ¯é˜Ÿåˆ—è¿›è¡Œé€šä¿¡çš„è¿›ç¨‹å¯ä»¥æ˜¯ä¸ç›¸å…³çš„è¿›ç¨‹ï¼ŒåŒæ—¶å®ƒä»¬éƒ½æ˜¯é€šè¿‡å‘é€å’Œæ¥æ”¶çš„æ–¹å¼æ¥ä¼ é€’æ•°æ®çš„ã€‚åœ¨å‘½åç®¡é“ä¸­ï¼Œå‘é€æ•°æ®ç”¨writeï¼Œæ¥æ”¶æ•°æ®ç”¨readï¼Œåˆ™åœ¨æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œå‘é€æ•°æ®ç”¨msgsndï¼Œæ¥æ”¶æ•°æ®ç”¨msgrcvã€‚è€Œä¸”å®ƒä»¬å¯¹æ¯ä¸ªæ•°æ®éƒ½æœ‰ä¸€ä¸ªæœ€å¤§é•¿åº¦çš„é™åˆ¶ã€‚</p><p>ä¸å‘½åç®¡é“ç›¸æ¯”ï¼Œæ¶ˆæ¯é˜Ÿåˆ—çš„ä¼˜åŠ¿åœ¨äºï¼Œ 1ã€æ¶ˆæ¯é˜Ÿåˆ—ä¹Ÿå¯ä»¥ç‹¬ç«‹äºå‘é€å’Œæ¥æ”¶è¿›ç¨‹è€Œå­˜åœ¨ï¼Œä»è€Œæ¶ˆé™¤äº†åœ¨åŒæ­¥å‘½åç®¡é“çš„æ‰“å¼€å’Œå…³é—­æ—¶å¯èƒ½äº§ç”Ÿçš„å›°éš¾ã€‚</p><p>2ã€åŒæ—¶é€šè¿‡å‘é€æ¶ˆæ¯è¿˜å¯ä»¥é¿å…å‘½åç®¡é“çš„åŒæ­¥å’Œé˜»å¡é—®é¢˜ï¼Œä¸éœ€è¦ç”±è¿›ç¨‹è‡ªå·±æ¥æä¾›åŒæ­¥æ–¹æ³•ã€‚</p><p>3ã€æ¥æ”¶ç¨‹åºå¯ä»¥é€šè¿‡æ¶ˆæ¯ç±»å‹æœ‰é€‰æ‹©åœ°æ¥æ”¶æ•°æ®ï¼Œè€Œä¸æ˜¯åƒå‘½åç®¡é“ä¸­é‚£æ ·ï¼Œåªèƒ½é»˜è®¤åœ°æ¥æ”¶ã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;ä¸€ã€ä»€ä¹ˆæ˜¯æ¶ˆæ¯é˜Ÿåˆ—&quot;&gt;&lt;a href=&quot;#ä¸€ã€ä»€ä¹ˆæ˜¯æ¶ˆæ¯é˜Ÿåˆ—&quot; class=&quot;headerlink&quot; title=&quot;ä¸€ã€ä»€ä¹ˆæ˜¯æ¶ˆæ¯é˜Ÿåˆ—&quot;&gt;&lt;/a&gt;ä¸€ã€ä»€ä¹ˆæ˜¯æ¶ˆæ¯é˜Ÿåˆ—&lt;/h2&gt;&lt;p&gt;æ¶ˆæ¯é˜Ÿåˆ—æä¾›äº†ä¸€ç§ä»ä¸€ä¸ªè¿›ç¨‹å‘å¦ä¸€ä¸ªè¿›ç¨‹å‘é€ä¸€ä¸ªæ•°æ®å—çš„æ–¹æ³•ã€‚  æ¯ä¸ªæ•°æ®å—éƒ½è¢«è®¤ä¸º</summary>
      
    
    
    
    <category term="Cè¯­è¨€" scheme="http://example.com/categories/C%E8%AF%AD%E8%A8%80/"/>
    
    
    <category term="Cè¯­è¨€" scheme="http://example.com/tags/C%E8%AF%AD%E8%A8%80/"/>
    
  </entry>
  
  <entry>
    <title>é”ã€ä¿¡å·é‡</title>
    <link href="http://example.com/posts/%E9%94%81%E3%80%81%E4%BF%A1%E5%8F%B7%E9%87%8F.html"/>
    <id>http://example.com/posts/%E9%94%81%E3%80%81%E4%BF%A1%E5%8F%B7%E9%87%8F.html</id>
    <published>2024-11-25T14:45:35.000Z</published>
    <updated>2024-11-25T14:45:57.635Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ä¸€ã€ä¿¡å·é‡"><a href="#ä¸€ã€ä¿¡å·é‡" class="headerlink" title="ä¸€ã€ä¿¡å·é‡"></a>ä¸€ã€ä¿¡å·é‡</h2><p>çº¿ç¨‹çš„ä¿¡å·é‡ä¸è¿›ç¨‹é—´é€šä¿¡ä¸­ä½¿ç”¨çš„ä¿¡å·é‡çš„æ¦‚å¿µæ˜¯ä¸€æ ·ï¼Œå®ƒæ˜¯ä¸€ç§ç‰¹æ®Šçš„å˜é‡ï¼Œå®ƒå¯ä»¥è¢«å¢åŠ æˆ–å‡å°‘ï¼Œä½†å¯¹å…¶çš„å…³é”®è®¿é—®è¢«ä¿è¯æ˜¯åŸå­æ“ä½œã€‚å¦‚æœä¸€ä¸ªç¨‹åºä¸­æœ‰å¤šä¸ªçº¿ç¨‹è¯•å›¾æ”¹å˜ä¸€ä¸ªä¿¡å·é‡çš„å€¼ï¼Œç³»ç»Ÿå°†ä¿è¯æ‰€æœ‰çš„æ“ä½œéƒ½å°†ä¾æ¬¡è¿›è¡Œã€‚</p><p>è€Œåªæœ‰0å’Œ1ä¸¤ç§å–å€¼çš„ä¿¡å·é‡å«åšäºŒè¿›åˆ¶ä¿¡å·é‡ï¼Œåœ¨è¿™é‡Œå°†é‡ç‚¹ä»‹ç»ã€‚è€Œä¿¡å·é‡ä¸€èˆ¬å¸¸ç”¨äºä¿æŠ¤ä¸€æ®µä»£ç ï¼Œä½¿å…¶æ¯æ¬¡åªè¢«ä¸€ä¸ªæ‰§è¡Œçº¿ç¨‹è¿è¡Œã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨äºŒè¿›åˆ¶ä¿¡å·é‡æ¥å®Œæˆè¿™ä¸ªå·¥ä½œã€‚</p><p>Cè¯­è¨€ä¸­çš„ä¿¡å·é‡åˆ†ä¸ºä¸¤ç§ï¼ŒPOSIXä¿¡å·é‡å’ŒSyetem -Vä¿¡å·é‡</p><h2 id="äºŒã€POSIXä¿¡å·é‡"><a href="#äºŒã€POSIXä¿¡å·é‡" class="headerlink" title="äºŒã€POSIXä¿¡å·é‡"></a>äºŒã€POSIXä¿¡å·é‡</h2><p>ä¿¡å·é‡çš„å‡½æ•°éƒ½ä»¥sem_å¼€å¤´ï¼Œçº¿ç¨‹ä¸­ä½¿ç”¨çš„åŸºæœ¬ä¿¡å·é‡å‡½æ•°æœ‰4ä¸ªï¼Œå®ƒä»¬éƒ½å£°æ˜åœ¨å¤´æ–‡ä»¶semaphore.hä¸­ã€‚</p><h4 id="1ã€sem-initå‡½æ•°"><a href="#1ã€sem-initå‡½æ•°" class="headerlink" title="1ã€sem_initå‡½æ•°"></a>1ã€sem_initå‡½æ•°</h4><p>è¯¥å‡½æ•°ç”¨äºåˆ›å»ºä¿¡å·é‡ï¼Œå…¶åŸå‹å¦‚ä¸‹</p><p><code>int sem_init(sem_t *sem,int pshared,unsigned int value);</code></p><p>è¯¥å‡½æ•°åˆå§‹åŒ–ç”±semæŒ‡å‘çš„ä¿¡å·å¯¹è±¡ï¼Œè®¾ç½®å®ƒçš„å…±äº«é€‰é¡¹ï¼Œå¹¶ç»™å®ƒä¸€ä¸ªåˆå§‹çš„æ•´æ•°å€¼ã€‚<br />psharedæ§åˆ¶ä¿¡å·é‡çš„ç±»å‹ï¼Œå¦‚æœå…¶å€¼ä¸º0ï¼Œå°±è¡¨ç¤ºè¿™ä¸ªä¿¡å·é‡æ˜¯å½“å‰è¿›ç¨‹çš„å±€éƒ¨ä¿¡å·é‡ï¼Œå¦åˆ™ä¿¡å·é‡å°±å¯ä»¥åœ¨å¤šä¸ªè¿›ç¨‹ä¹‹é—´å…±äº«ï¼Œvalueä¸ºsemçš„åˆå§‹å€¼ã€‚è°ƒç”¨æˆåŠŸæ—¶è¿”å›0ï¼Œå¤±è´¥è¿”å›-1.</p><h4 id="2ã€sem-waitå‡½æ•°"><a href="#2ã€sem-waitå‡½æ•°" class="headerlink" title="2ã€sem_waitå‡½æ•°"></a>2ã€sem_waitå‡½æ•°</h4><p>è¯¥å‡½æ•°ç”¨äºä»¥åŸå­æ“ä½œçš„æ–¹å¼å°†ä¿¡å·é‡çš„å€¼å‡1ã€‚åŸå­æ“ä½œå°±æ˜¯ï¼Œå¦‚æœä¸¤ä¸ªçº¿ç¨‹ä¼å›¾åŒæ—¶ç»™ä¸€ä¸ªä¿¡å·é‡åŠ 1æˆ–å‡1ï¼Œå®ƒä»¬ä¹‹é—´ä¸ä¼šäº’ç›¸å¹²æ‰°ã€‚å®ƒçš„åŸå‹å¦‚ä¸‹ï¼š</p><p><code>int sem_wait(sem_t *sem);</code></p><p>ç­‰å¾…ä¿¡å·é‡ï¼Œå¦‚æœä¿¡å·é‡çš„å€¼å¤§äº0ï¼Œå°†ä¿¡å·é‡çš„å€¼å‡1ï¼Œç«‹å³è¿”å›ã€‚å¦‚æœä¿¡å·é‡çš„å€¼ä¸º0ï¼Œåˆ™çº¿ç¨‹é˜»å¡ã€‚ç›¸å½“äºPæ“ä½œã€‚æˆåŠŸè¿”å›0ï¼Œå¤±è´¥è¿”å›-1ã€‚semæŒ‡å‘çš„å¯¹è±¡æ˜¯ç”±sem_initè°ƒç”¨åˆå§‹åŒ–çš„ä¿¡å·é‡ã€‚</p><h4 id="3ã€-sem-postå‡½æ•°"><a href="#3ã€-sem-postå‡½æ•°" class="headerlink" title="3ã€ sem_postå‡½æ•°"></a>3ã€ sem_postå‡½æ•°</h4><p>è¯¥å‡½æ•°ç”¨äºä»¥åŸå­æ“ä½œçš„æ–¹å¼å°†ä¿¡å·é‡çš„å€¼åŠ 1ã€‚å®ƒçš„åŸå‹å¦‚ä¸‹ï¼š</p><p><code>int sem_post(sem_t *sem);</code></p><p>é‡Šæ”¾ä¿¡å·é‡ï¼Œè®©ä¿¡å·é‡çš„å€¼åŠ 1ã€‚ç›¸å½“äºVæ“ä½œã€‚ä¸sem_waitä¸€æ ·ï¼ŒsemæŒ‡å‘çš„å¯¹è±¡æ˜¯ç”±sem_initè°ƒç”¨åˆå§‹åŒ–çš„ä¿¡å·é‡ã€‚è°ƒç”¨æˆåŠŸæ—¶è¿”å›0ï¼Œå¤±è´¥è¿”å›-1.</p><h4 id="4ã€sem-destroyå‡½æ•°"><a href="#4ã€sem-destroyå‡½æ•°" class="headerlink" title="4ã€sem_destroyå‡½æ•°"></a>4ã€sem_destroyå‡½æ•°</h4><p>è¯¥å‡½æ•°ç”¨äºå¯¹ç”¨å®Œçš„ä¿¡å·é‡çš„æ¸…ç†ã€‚å®ƒçš„åŸå‹å¦‚ä¸‹ï¼š</p><p><code>int sem_destroy(sem_t *sem);</code></p><p>æˆåŠŸæ—¶è¿”å›0ï¼Œå¤±è´¥æ—¶è¿”å›-1.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;semaphore.h&gt;</span></span><br><br>  <span class="hljs-type">sem_t</span> sem;<br><br>  <span class="hljs-type">void</span> <span class="hljs-title function_">func1</span><span class="hljs-params">(<span class="hljs-type">void</span>* arg)</span><br>  &#123;<br>      sem_wait(&amp;sem);<br>      <span class="hljs-type">int</span> *running=arg;<br>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;thread running1\n&quot;</span>);<br>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d\n&quot;</span>,*running);<br>  &#125;<br><br>  <span class="hljs-type">void</span> <span class="hljs-title function_">func2</span><span class="hljs-params">(<span class="hljs-type">void</span>* arg)</span><br>  &#123;<br>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;pthread2 running\n&quot;</span>);<br>      sem_post(&amp;sem);<br>  &#125;<br><br>  <span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>  &#123;<br>      sem_init(&amp;sem,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>);<br>      <span class="hljs-type">pthread_t</span> thread[<span class="hljs-number">2</span>];<br>      <span class="hljs-type">int</span> a=<span class="hljs-number">5</span>;<br>      pthread_create(&amp;(thread[<span class="hljs-number">0</span>]),<span class="hljs-literal">NULL</span>,(<span class="hljs-type">void</span>*)func1,(<span class="hljs-type">void</span>*)&amp;a);<br>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;main thread running\n&quot;</span>);<br>      sleep(<span class="hljs-number">10</span>);<br>      pthread_create(&amp;(thread[<span class="hljs-number">1</span>]),<span class="hljs-literal">NULL</span>,(<span class="hljs-type">void</span>*)func2,(<span class="hljs-type">void</span>*)&amp;a);<br>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;main thread running2\n&quot;</span>);<br>      pthread_join(thread[<span class="hljs-number">0</span>],<span class="hljs-literal">NULL</span>);<br>      pthread_join(thread[<span class="hljs-number">1</span>],<span class="hljs-literal">NULL</span>);<br>      sem_destroy(&amp;sem);<br><br>      <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>  &#125;<br></code></pre></td></tr></table></figure><p>é¦–å…ˆåˆ›å»ºä¿¡å·é‡ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸º0ï¼Œè¡¨ç¤ºè¿™ä¸ªä¿¡å·é‡æ˜¯å½“å‰è¿›ç¨‹çš„å±€éƒ¨ä¿¡å·é‡ï¼Œåˆå§‹å€¼ä¸º0ã€‚</p><p>ç„¶åä½¿ç”¨pthread_create()å‡½æ•°åˆ›å»ºä¸¤ä¸ªçº¿ç¨‹ï¼Œä¼ å…¥å‚æ•°aã€‚</p><p>çº¿ç¨‹1åˆ›å»ºå®Œæˆåï¼Œç”±äºä¿¡å·é‡åˆå§‹åŒ–value&#x3D;0ï¼Œè°ƒç”¨sem_waitä¼šé˜»å¡è¿™ä¸ªçº¿ç¨‹ï¼Œä¿¡å·é‡çš„å€¼å°†å‡å°‘1ï¼ˆæ­¤æ—¶&lt;0ï¼‰ï¼Œè¿™ä¸ªçº¿ç¨‹å‡½æ•°å°±ä¼šç­‰å¾…ã€‚</p><p>ä¸»çº¿ç¨‹sleep(10)åï¼Œçº¿ç¨‹2åˆ›å»ºå¹¶æ‰§è¡Œè°ƒç”¨ï¼Œsem_postç”¨äºä½¿ä¿¡å·é‡çš„å€¼å¢åŠ 1ï¼Œæ­¤æ—¶çº¿ç¨‹1å¯ä»¥æ‰§è¡Œã€‚</p><p>ä½¿ç”¨pthread_joinç­‰å¾…æ‰€åˆ›å»ºçš„ä¸¤ä¸ªçº¿ç¨‹çš„ç»“æŸã€‚</p><p>ä»¥ä¸Šä»£ç è¾“å‡ºä¸ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c">main thread running<br>main thread running2<br>pthread2 running<br>thread running1<br><span class="hljs-number">5</span><br></code></pre></td></tr></table></figure><p>å¯ä»¥ç”¨æ¥åšçº¿ç¨‹åŒæ­¥ä½¿ç”¨ï¼Œæ¯”å¦‚å‡çº§æµç¨‹ä»£ç ä¸­ï¼Œå¯ä»¥åœ¨å‡çº§çš„åˆå§‹åŒ–ä»£ç ä¸­ä½¿ç”¨sem_waitï¼Œæœ€ç»ˆè¢«é˜»å¡åœ¨é‚£é‡Œï¼Œè€Œç”¨æˆ·æ‰§è¡Œå‡çº§å‘½ä»¤çš„æµç¨‹ä¸­æ‰ä¼šæ‰§è¡Œåˆ°sem_postå‡½æ•°ï¼Œä»è€Œè§¦å‘åˆ°sem_waitåé¢çš„æµç¨‹ç»§ç»­æ‰§è¡Œã€‚</p><h2 id="ä¸‰ã€System-Vä¿¡å·é‡"><a href="#ä¸‰ã€System-Vä¿¡å·é‡" class="headerlink" title="ä¸‰ã€System -Vä¿¡å·é‡"></a>ä¸‰ã€System -Vä¿¡å·é‡</h2><h4 id="1ã€åˆ›å»ºSEM"><a href="#1ã€åˆ›å»ºSEM" class="headerlink" title="1ã€åˆ›å»ºSEM"></a>1ã€åˆ›å»ºSEM</h4><p>åŠŸèƒ½ï¼šè·å–ä¿¡å·é‡ID</p><p><code>int semget(key_t key,int nsems,int semflg);</code></p><p>è¿”å›å€¼ï¼š<br>æˆåŠŸï¼šä¿¡å·é‡ID<br>å¤±è´¥ï¼š-1<br>å‚æ•°ï¼š<br>keyï¼šä¿¡å·é‡çš„é”®å€¼<br>nsemsï¼šä¿¡å·é‡å…ƒç´ çš„ä¸ªæ•°<br>semflgï¼šåˆ›å»ºé€‰é¡¹<br>IPC_CREATï¼šå¦‚æœkeyå¯¹åº”çš„ä¿¡å·é‡ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»º<br>IPC_EXCLï¼šå¦‚æœkeyå¯¹åº”çš„ä¿¡å·é‡å­˜åœ¨ï¼Œåˆ™æŠ¥é”™<br>modeï¼šä¿¡å·é‡çš„è®¿é—®æƒé™<br>åˆ›å»ºä¿¡å·é‡æ—¶ï¼Œè¿˜å—åˆ°ä»¥ä¸‹ç³»ç»Ÿä¿¡æ¯çš„å½±å“</p><p>SEMMNIï¼šç³»ç»Ÿä¸­ä¿¡å·é‡çš„æ€»æ•°æœ€å¤§å€¼<br>SEMMSLï¼šæ¯ä¸ªä¿¡å·é‡ä¸­ä¿¡å·é‡å…ƒç´ çš„ä¸ªæ•°æœ€å¤§å€¼<br>SEMMNSï¼šç³»ç»Ÿä¸­ç´ æœ‰ä¿¡å·é‡ä¸­çš„ä¿¡å·é‡å…ƒç´ çš„æ€»æ•°æœ€å¤§å€¼<br>å®ä¾‹ä»£ç ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> <br>&#123; <br>    <span class="hljs-type">key_t</span> key = ftok(<span class="hljs-string">&quot;.&quot;</span>,<span class="hljs-number">1</span>); <br>    <span class="hljs-type">int</span> semid = semget(key,<span class="hljs-number">2</span>,IPC_CREATE|<span class="hljs-number">0666</span>); <br>&#125;<br></code></pre></td></tr></table></figure><h4 id="2ã€PVæ“ä½œ"><a href="#2ã€PVæ“ä½œ" class="headerlink" title="2ã€PVæ“ä½œ"></a>2ã€PVæ“ä½œ</h4><p>åŠŸèƒ½ï¼šå¯¹ä¿¡å·é‡è¿›è¡ŒPVæ“ä½œï¼Œæˆ–è€…ç­‰é›¶æ“ä½œ</p><p><code>int semop(int semid,struct sembuf sops[],unsigned nsops);</code></p><p>è¿”å›å€¼ï¼š<br>æˆåŠŸï¼š0<br>å¤±è´¥ï¼š-1</p><p>å‚æ•°ï¼š<br>semidï¼šä¿¡å·é‡ID<br>sopsï¼šä¿¡å·é‡æ“ä½œç»“æ„ä½“æ•°ç»„<br>nsopsç»“æœä½“æ•°ç»„å…ƒç´ ä¸ªæ•°<br>ä¿¡å·é‡æ“ä½œç»“æ„ä½“</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sembuf</span> &#123;</span> <br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">short</span> sem_num;<span class="hljs-comment">//ä¿¡å·é‡å…ƒç´ åºå·     </span><br>    <span class="hljs-type">short</span> sem_op;<span class="hljs-comment">//æ“ä½œå‚æ•° </span><br>    <span class="hljs-type">short</span> sem_flg;<span class="hljs-comment">//æ“ä½œé€‰é¡¹ </span><br>&#125;<br></code></pre></td></tr></table></figure><p>æ ¹æ®sem_opçš„å€¼ï¼Œä¿¡å·é‡æ“ä½œåˆ†ä¸º3ä¸­æƒ…å†µï¼š<br>sem_op&gt;0ï¼šVæ“ä½œ<br>sem_op&#x3D;0ï¼šç­‰é›¶æ“ä½œ<br>sem_op<br>ç¤ºä¾‹ä»£ç </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123; <br>    <span class="hljs-type">key_t</span> key = ftok(<span class="hljs-string">&quot;.&quot;</span>, <span class="hljs-number">1</span>); <span class="hljs-comment">// åˆ›å»ºï¼ˆè‹¥å·²æœ‰åˆ™æ‰“å¼€ï¼‰ä¸€ä¸ªåŒ…å«2ä¸ªå…ƒç´ çš„ä¿¡å·é‡ç»„ </span><br>    <span class="hljs-type">int</span> id = semget(key, <span class="hljs-number">2</span>, IPC_CREAT|<span class="hljs-number">0666</span>); <span class="hljs-comment">// å®šä¹‰åŒ…å«ä¸¤ä¸ªP/Væ“ä½œçš„ç»“æ„ä½“æ•°ç»„ </span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sembuf</span> <span class="hljs-title">op</span>[2];</span> <br>    op[<span class="hljs-number">0</span>].sem_num = <span class="hljs-number">0</span>; <span class="hljs-comment">// ä¿¡å·é‡å…ƒç´ åºå· </span><br>    op[<span class="hljs-number">0</span>].sem_op = <span class="hljs-number">-2</span>; <span class="hljs-comment">// Pæ“ä½œ </span><br>    op[<span class="hljs-number">0</span>].sem_num = <span class="hljs-number">0</span>; <span class="hljs-comment">// é€‰é¡¹é»˜è®¤0 </span><br>    op[<span class="hljs-number">1</span>].sem_num = <span class="hljs-number">1</span>; <span class="hljs-comment">// ä¿¡å·é‡å…ƒç´ åºå· </span><br>    op[<span class="hljs-number">1</span>].sem_op = +<span class="hljs-number">3</span>; <span class="hljs-comment">// Væ“ä½œ </span><br>    op[<span class="hljs-number">1</span>].sem_num = <span class="hljs-number">0</span>; <span class="hljs-comment">// é€‰é¡¹é»˜è®¤0 </span><br>    <span class="hljs-comment">// åŒæ—¶å¯¹ç¬¬0ã€1å·ä¿¡å·é‡å…ƒç´ åˆ†åˆ«è¿›è¡ŒPã€Væ“ä½œ </span><br>    semop(id, op, <span class="hljs-number">2</span>);<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="3ã€è·å–æˆ–è®¾ç½®ä¿¡å·é‡çš„ç›¸å…³å±æ€§"><a href="#3ã€è·å–æˆ–è®¾ç½®ä¿¡å·é‡çš„ç›¸å…³å±æ€§" class="headerlink" title="3ã€è·å–æˆ–è®¾ç½®ä¿¡å·é‡çš„ç›¸å…³å±æ€§"></a>3ã€è·å–æˆ–è®¾ç½®ä¿¡å·é‡çš„ç›¸å…³å±æ€§</h4><p><code>int semctl(int semid,int semnum,int cmd....)</code></p><p>å‚æ•°ï¼š<br>semidï¼šä¿¡å·é‡ID<br>semnumï¼šä¿¡å·é‡å…ƒç´ åºå·<br>cmd<br>IPC_STATï¼šè·å–å±æ€§ä¿¡æ¯<br>IPC_SETï¼šè®¾ç½®å±æ€§ä¿¡æ¯<br>IPC_RMIDï¼šç«‹å³åˆ é™¤è¯¥ä¿¡å·é‡ï¼Œå‚æ•°semnumå°†è¢«å¿½ç•¥<br>IPC_INFOï¼šè·å¾—å…³äºä¿¡å·é‡çš„ç³»ç»Ÿé™åˆ¶ä¿¡æ¯<br>SEM_INFOï¼šè·å¾—ç³»ç»Ÿä¸ºå…±äº«å†…å­˜æ¶ˆè€—çš„èµ„æºä¿¡æ¯<br>SEM_STATï¼šè·å¾—ç³»ç»Ÿä¸­æ‰€æœ‰SEMçš„ç›¸å…³ä¿¡æ¯<br>GETALLï¼šè¿”å›æ‰€æœ‰ä¿¡å·é‡å…ƒç´ çš„å€¼ï¼Œå‚æ•°semnumå°†è¢«å¿½ç•¥<br>GETNCNTï¼šè¿”å›æ­£é˜»å¡åœ¨å¯¹è¯¥å¸çº³åé‡å…ƒç´ Pæ“ä½œçš„è¿›ç¨‹æ€»æ•°<br>GETPIDï¼šè¿”å›æœ€åä¸€ä¸ªé˜Ÿè¯¥ä¿¡å·é‡å…ƒç´ æ“ä½œçš„è¿›ç¨‹PID<br>GETVALï¼šè¿”å›è¯¥ä¿¡å·é‡å…ƒç´ çš„å€¼<br>GETZCNTï¼šè¿”å›æ­£é˜»å¡å¯¹è¯¥ä¿¡å·é‡å…ƒç´ ç­‰é›¶æ“ä½œçš„è¿›ç¨‹æ€»æ•°<br>SETALLï¼šè¿”å›æ‰€æœ‰ä¿¡å·é‡å…ƒç´ çš„å€¼ï¼Œå‚æ•°semnumå°†è¢«å¿½ç•¥<br>SETVALï¼šè®¾ç½®è¯¥ä¿¡å·é‡å…ƒç´ çš„å€¼<br>è¿”å›å€¼<br>GETNCNTï¼šsemncnt<br>GETPIDï¼šsempid<br>GETVALï¼šsemval<br>GETZCNTï¼šsemzcnt<br>IPC_INFOï¼šå†…æ ¸ä¸­è®°å½•æ‰€æœ‰SEMä¿¡æ¯çš„æ•°ç»„çš„ä¸‹æ ‡æœ€å¤§å€¼<br>SEM_INFOï¼šåŒIPC_INFO<br>SEM_STATï¼šå†…æ ¸ä¸­çœ‹iè·¯æ‰€æœ‰SEMä¿¡æ¯çš„æ•°ç»„<br>å¤±è´¥ï¼š-1<br>è¿™æ˜¯ä¸€ä¸ªå˜å‚å‡½æ•°ï¼Œæ ¹æ®cmdçš„ä¸åŒï¼Œå¯èƒ½éœ€è¦ç¬¬å››ä¸ªå‚æ•°ï¼Œç¬¬å››ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå¦‚ä¸‹æ‰€ç¤ºçš„è”åˆä½“ï¼Œç”¨æˆ·éœ€è¦è‡ªå·±å®šä¹‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">union</span> <span class="hljs-title">semun</span> &#123;</span> <br>    <span class="hljs-type">int</span> val;<span class="hljs-comment">//å½“cmdä¸ºSERVALæ—¶ä½¿ç”¨ </span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">semid_ds</span> *<span class="hljs-title">buf</span>;</span><span class="hljs-comment">//å½“cmdä¸ºIPC_STATæˆ–IPC_SETæ—¶ä½¿ç”¨ </span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">short</span> *<span class="hljs-built_in">array</span>;<span class="hljs-comment">//å½“cmdä¸ºGETALLæˆ–SETALLæ—¶ä½¿ç”¨ </span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">seminfo</span> *_<span class="hljs-title">buf</span>;</span><span class="hljs-comment">//å½“cmdä¸ºIPC_INFOæ—¶ä½¿ç”¨ </span><br>&#125;<br></code></pre></td></tr></table></figure><p>å½“cmdä¸ºIPC_STATæˆ–IPC_SETæ—¶,éœ€è¦ç”¨åˆ°ä¸€ä¸‹å±æ€§ä¿¡æ¯ç»“æ„ä½“</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">semid_ds</span> &#123;</span> <br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ipc_perm</span> <span class="hljs-title">sem_perm</span>;</span><span class="hljs-comment">//æƒé™ç›¸å…³ä¿¡æ¯ </span><br>    <span class="hljs-type">time_t</span> sem_otime;<span class="hljs-comment">//æœ€åä¸€æ¬¡semop()çš„ä¿¡æ¯ </span><br>    <span class="hljs-type">tien_t</span> sem_ctime;<span class="hljs-comment">//æœ€åä¸€æ¬¡çŠ¶æ€æ”¹å˜æ—¶é—´ </span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">short</span> sem_nsems;<span class="hljs-comment">//ä¿¡å·é‡å…ƒç´ ä¸ªæ•° </span><br>&#125;<br></code></pre></td></tr></table></figure><p>ä½¿ç”¨ä¾‹å­ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">mutex_p</span><span class="hljs-params">(<span class="hljs-type">key_t</span> sem_tag, <span class="hljs-type">int</span> *sem_id, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> timeout)</span><br>&#123;<br>  <span class="hljs-type">int</span> ret;<br>  <span class="hljs-type">int</span> semid =<span class="hljs-number">0</span>;<br>  <span class="hljs-type">int</span> semno = <span class="hljs-number">0</span>;<br>  <span class="hljs-type">int</span> val;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sembuf</span> <span class="hljs-title">smbf</span>[2] =</span> &#123;&#123;<span class="hljs-number">0</span>&#125;&#125;;<br><br>  DRV_CHECK_RETV(sem_id != <span class="hljs-literal">NULL</span>, -EINVAL);<br>  ret = semget(sem_tag, <span class="hljs-number">1</span>, IPC_CREAT | IPC_EXCL | MSG_SEM_PERMISSION_RW_GROUP);<br>  <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) &#123;<br>    <span class="hljs-keyword">if</span> (errno == EEXIST) &#123;<br>      semid = semget(sem_tag, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>);<br>      <span class="hljs-keyword">if</span> (semid &lt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">return</span> -EINVAL;<br>      &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">return</span> -EINVAL;<br>    &#125;<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    semid = ret;<br>    val = <span class="hljs-number">1</span>;<br>    ret = semctl(semid, semno, SETVAL, val);<br>    <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) &#123;<br>      <span class="hljs-keyword">return</span> -EINVAL;<br>    &#125;<br>  &#125;<br>  *sem_id = semid;<br>  smbf[<span class="hljs-number">0</span>].sem_num = <span class="hljs-number">0</span>;<br>  smbf[<span class="hljs-number">0</span>].sem_op = <span class="hljs-number">-1</span>;<br>  smbf[<span class="hljs-number">0</span>].sem_flg = (timeout == MUTEX_WAIT_FOR_EVER) ? SEM_UNDO : (SEM_UNDO | IPC_NOWAIT);<br><br>  ret = semop(semid, smbf, <span class="hljs-number">1</span>);<br>  <span class="hljs-keyword">if</span> (ret == <span class="hljs-number">0</span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (errno == EAGAIN) &#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;have another process use\n&quot;</span>);<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;semop fail\n&quot;</span>);<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> -EINVAL;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">mutex_v</span><span class="hljs-params">(<span class="hljs-type">int</span> sem_id)</span><br>&#123;<br>  <span class="hljs-type">int</span> ret;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sembuf</span> <span class="hljs-title">smbf</span>;</span><br>  smbf[<span class="hljs-number">0</span>].sem_num = <span class="hljs-number">0</span>;<br>  smbf[<span class="hljs-number">0</span>].sem_op = <span class="hljs-number">1</span>;<br>  smbf[<span class="hljs-number">0</span>].sem_flg = SEM_UNDO | IPC_NOWAIT;<br><br>  ret = semop(semid, &amp;smbf, <span class="hljs-number">1</span>);<br>  <span class="hljs-keyword">if</span> (ret != <span class="hljs-number">0</span>) &#123;<br>    <span class="hljs-keyword">return</span> -EINVAL;<br>  &#125;<br>  <span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="å››ã€é”"><a href="#å››ã€é”" class="headerlink" title="å››ã€é”"></a>å››ã€é”</h2><p>äº’æ–¥é‡ä»æœ¬è´¨ä¸Šè¯´å°±æ˜¯ä¸€æŠŠé”, æä¾›å¯¹å…±äº«èµ„æºçš„ä¿æŠ¤è®¿é—®ã€‚</p><h4 id="1ã€åˆå§‹åŒ–"><a href="#1ã€åˆå§‹åŒ–" class="headerlink" title="1ã€åˆå§‹åŒ–"></a>1ã€åˆå§‹åŒ–</h4><p>åœ¨Linuxä¸‹, çº¿ç¨‹çš„äº’æ–¥é‡æ•°æ®ç±»å‹æ˜¯pthread_mutex_t. åœ¨ä½¿ç”¨å‰, è¦å¯¹å®ƒè¿›è¡Œåˆå§‹åŒ–:</p><p>å¯¹äºé™æ€åˆ†é…çš„äº’æ–¥é‡, å¯ä»¥æŠŠå®ƒè®¾ç½®ä¸º<strong>PTHREAD_MUTEX_INITIALIZER</strong>, æˆ–è€…è°ƒç”¨pthread_mutex_init.<br>å¯¹äºåŠ¨æ€åˆ†é…çš„äº’æ–¥é‡, åœ¨ç”³è¯·å†…å­˜(malloc)ä¹‹å, é€šè¿‡pthread_mutex_initè¿›è¡Œåˆå§‹åŒ–, å¹¶ä¸”åœ¨é‡Šæ”¾å†…å­˜(free)å‰éœ€è¦è°ƒç”¨pthread_mutex_destroy.</p><p>åŸå‹:</p><p>&#96;int pthread_mutex_init(pthread_mutex_t *restrict mutex, const pthread_mutexattr_t *restric attr);</p><p><code>int pthread_mutex_destroy(pthread_mutex_t *mutex);</code></p><p>å¤´æ–‡ä»¶:#include&lt;pthread.h&gt;</p><p>è¿”å›å€¼: æˆåŠŸåˆ™è¿”å›0, å‡ºé”™åˆ™è¿”å›é”™è¯¯ç¼–å·.</p><p>è¯´æ˜: å¦‚æœä½¿ç”¨é»˜è®¤çš„å±æ€§åˆå§‹åŒ–äº’æ–¥é‡, åªéœ€æŠŠattrè®¾ä¸ºNULL. å…¶ä»–å€¼åœ¨ä»¥åè®²è§£ã€‚</p><h4 id="2ã€äº’æ–¥æ“ä½œ"><a href="#2ã€äº’æ–¥æ“ä½œ" class="headerlink" title="2ã€äº’æ–¥æ“ä½œ:"></a>2ã€äº’æ–¥æ“ä½œ:</h4><p>å¯¹å…±äº«èµ„æºçš„è®¿é—®, è¦å¯¹äº’æ–¥é‡è¿›è¡ŒåŠ é”, å¦‚æœäº’æ–¥é‡å·²ç»ä¸Šäº†é”, è°ƒç”¨çº¿ç¨‹ä¼šé˜»å¡, ç›´åˆ°äº’æ–¥é‡è¢«è§£é”. åœ¨å®Œæˆäº†å¯¹å…±äº«èµ„æºçš„è®¿é—®å, è¦å¯¹äº’æ–¥é‡è¿›è¡Œè§£é”ã€‚</p><p>é¦–å…ˆè¯´ä¸€ä¸‹åŠ é”å‡½æ•°:</p><p>å¤´æ–‡ä»¶:#include&lt;pthread.h&gt;</p><p>åŸå‹:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">pthread_mutex_lock</span><span class="hljs-params">(<span class="hljs-type">pthread_mutex_t</span> *mutex)</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">pthread_mutex_trylock</span><span class="hljs-params">(<span class="hljs-type">pthread_mutex_t</span> *mutex)</span>;<br></code></pre></td></tr></table></figure><p>è¿”å›å€¼: æˆåŠŸåˆ™è¿”å›0, å‡ºé”™åˆ™è¿”å›é”™è¯¯ç¼–å·.</p><p>è¯´æ˜: å…·ä½“è¯´ä¸€ä¸‹trylockå‡½æ•°, è¿™ä¸ªå‡½æ•°æ˜¯éé˜»å¡è°ƒç”¨æ¨¡å¼, ä¹Ÿå°±æ˜¯è¯´, å¦‚æœäº’æ–¥é‡æ²¡è¢«é”ä½, trylockå‡½æ•°å°†æŠŠäº’æ–¥é‡åŠ é”, å¹¶è·å¾—å¯¹å…±äº«èµ„æºçš„è®¿é—®æƒé™; å¦‚æœäº’æ–¥é‡è¢«é”ä½äº†, trylockå‡½æ•°å°†ä¸ä¼šé˜»å¡ç­‰å¾…è€Œç›´æ¥è¿”å›EBUSY, è¡¨ç¤ºå…±äº«èµ„æºå¤„äºå¿™çŠ¶æ€ã€‚</p><p>å†è¯´ä¸€ä¸‹è§£é”å‡½æ•°:<br>åŸå‹: </p><p><code>int pthread_mutex_unlock(pthread_mutex_t *mutex);</code></p><p>è¿”å›å€¼: æˆåŠŸåˆ™è¿”å›0, å‡ºé”™åˆ™è¿”å›é”™è¯¯ç¼–å·.</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;ä¸€ã€ä¿¡å·é‡&quot;&gt;&lt;a href=&quot;#ä¸€ã€ä¿¡å·é‡&quot; class=&quot;headerlink&quot; title=&quot;ä¸€ã€ä¿¡å·é‡&quot;&gt;&lt;/a&gt;ä¸€ã€ä¿¡å·é‡&lt;/h2&gt;&lt;p&gt;çº¿ç¨‹çš„ä¿¡å·é‡ä¸è¿›ç¨‹é—´é€šä¿¡ä¸­ä½¿ç”¨çš„ä¿¡å·é‡çš„æ¦‚å¿µæ˜¯ä¸€æ ·ï¼Œå®ƒæ˜¯ä¸€ç§ç‰¹æ®Šçš„å˜é‡ï¼Œå®ƒå¯ä»¥è¢«å¢åŠ æˆ–å‡å°‘ï¼Œä½†å¯¹å…¶çš„å…³é”®è®¿é—®è¢«ä¿è¯æ˜¯</summary>
      
    
    
    
    <category term="Cè¯­è¨€" scheme="http://example.com/categories/C%E8%AF%AD%E8%A8%80/"/>
    
    
    <category term="Cè¯­è¨€" scheme="http://example.com/tags/C%E8%AF%AD%E8%A8%80/"/>
    
  </entry>
  
  <entry>
    <title>çº¿ç¨‹</title>
    <link href="http://example.com/posts/%E7%BA%BF%E7%A8%8B.html"/>
    <id>http://example.com/posts/%E7%BA%BF%E7%A8%8B.html</id>
    <published>2024-11-25T14:43:44.000Z</published>
    <updated>2024-11-25T14:44:07.572Z</updated>
    
    <content type="html"><![CDATA[<p>æˆ‘ä»¬çŸ¥é“ï¼Œåœ¨åˆ›å»ºçº¿ç¨‹æ—¶ï¼Œä¼šç”¨åˆ°pthread_create()å‡½æ•° ï¼Œæˆ‘ä»¬æ¥ç®€å•ä»‹ç»ä¸€ä¸‹è¯¥å‡½æ•°ï¼š</p><p><code>pthread_create(çº¿ç¨‹çš„tid ï¼Œ çº¿ç¨‹å±æ€§ ï¼Œ å·¥ä½œå‡½æ•°å ï¼Œ å‡½æ•°éœ€è¦çš„å‚æ•°);</code></p><p>è¿™ç¯‡åšå®¢è¦è®²çš„çº¿ç¨‹å±æ€§ï¼Œä¾¿æ˜¯ç”¨äºè¿›è¡Œçº¿ç¨‹çš„åˆå§‹åŒ–çš„ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å¯¹çº¿ç¨‹å±æ€§çš„ä¿®æ”¹æ¥è‡ªå®šä¹‰çº¿ç¨‹</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥äº†è§£ä¸€ä¸‹ä»€ä¹ˆçº¿ç¨‹å±æ€§</p><h3 id="ä¸€ã€çº¿ç¨‹å±æ€§ä¸­çš„æˆå‘˜"><a href="#ä¸€ã€çº¿ç¨‹å±æ€§ä¸­çš„æˆå‘˜" class="headerlink" title="ä¸€ã€çº¿ç¨‹å±æ€§ä¸­çš„æˆå‘˜"></a>ä¸€ã€çº¿ç¨‹å±æ€§ä¸­çš„æˆå‘˜</h3><p>çº¿ç¨‹å±æ€§æ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼Œç”¨æ³•ä¸º pthread_attr_t å˜é‡åï¼ˆæœ¬ç¯‡åšå®¢é‡Œé»˜è®¤å˜é‡åä¸ºattrï¼‰</p><p>çº¿ç¨‹å±æ€§ç»“æ„ä½“ä¸­çš„æˆå‘˜åˆ†åˆ«æœ‰ï¼šçº¿ç¨‹çš„è­¦æˆ’ç¼“å†²åŒºã€çº¿ç¨‹çš„ä¼˜å…ˆçº§æŒ‡é’ˆã€çº¿ç¨‹çš„é€€å‡ºçŠ¶æ€ã€çº¿ç¨‹æ ˆåœ°å€ã€çº¿ç¨‹æ ˆå¤§å°</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥ä»‹ç»ä¸€ä¸‹è¯¥ç»“æ„ä½“ä¸­çš„è¿™å‡ ä¸ªæˆå‘˜</p><p>çº¿ç¨‹çš„è­¦æˆ’ç¼“å†²åŒº<br>é¦–å…ˆæˆ‘ä»¬è¦çŸ¥é“ï¼Œæ¯å½“ä¸€ä¸ªçº¿ç¨‹è¢«åˆ›å»ºå‡ºæ¥çš„æ—¶å€™ï¼Œéƒ½ä¼šæœ‰ä¸€ä¸ªç›¸åº”çš„çº¿ç¨‹æ ˆå‡ºç°ï¼Œè€Œæ ˆå­˜åœ¨æº¢å‡ºé—®é¢˜ï¼ˆæ ˆçš„æº¢å‡ºéƒ½æ˜¯ä¸Šæº¢ï¼‰ï¼Œçº¿ç¨‹æ ˆæ˜¯ç”³è¯·åœ¨å †ç©ºé—´çš„<br><img src="https://raw.githubusercontent.com/mengchao666/picture/main/blog7f0a34127f2230b970ea8c48ff144552.png"></p><p>ä¸€æ—¦æ ˆå‘ç”Ÿæº¢å‡ºï¼Œæ•°æ®å°±ä¼šå‘ä¸Šè¦†ç›–ï¼Œå½±å“ç”šè‡³ç ´ååˆ°åº“ã€æ ˆåŒºç­‰ç©ºé—´ä¸­çš„æ•°æ®ã€‚ä½†æ›´å¯æ€•çš„æ˜¯ï¼Œç”±äºç”¨æˆ·å¯¹ç”¨æˆ·ç©ºé—´ä¸­çš„å†…å®¹å…·æœ‰è¯»å†™æƒé™ï¼Œçº¿ç¨‹æ ˆä¸Šæº¢æ‰€å¯¼è‡´çš„å¯¹è¿™äº›å†…å®¹çš„ä¿®æ”¹ï¼Œç³»ç»Ÿæ˜¯ä¸ä¼šæŠ¥é”™çš„ï¼Œåªæœ‰å½“æ•°æ®æº¢å‡ºåˆ°å†…æ ¸å±‚æ—¶ï¼Œæˆ‘ä»¬æ‰èƒ½å¤Ÿå‘ç°é—®é¢˜ï¼Œä½†æ­¤æ—¶å·²ç»æ™šäº†ï¼Œæ•°æ®å·²ç»å…¨è¢«ç ´åäº†ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æ¥ç»™æ¯ä¸ªçº¿ç¨‹æ ˆâ€œåŠ ä¸ªç›–å­â€ï¼Œä¹Ÿå°±æ˜¯æ‰€è°“çš„â€œè­¦æˆ’ç¼“å†²åŒºâ€ã€‚</p><p>è­¦æˆ’ç¼“å†²åŒºçš„å¤§å°ä¸€èˆ¬ä¸º4Kï¼Œè¿™å—å†…å­˜æ˜¯ä¸å¯è¯»å†™çš„ï¼Œæ‰€ä»¥å½“çº¿ç¨‹æ ˆå‘ç”Ÿä¸Šæº¢ï¼Œæƒ³è¦ä¿®æ”¹è¿™å—å†…å­˜ä¸­çš„å†…å®¹æ—¶ï¼Œç³»ç»Ÿå°±ä¼šå‘ç°æœ‰çº¿ç¨‹éæ³•æ“ä½œå†…å­˜ï¼Œå¹¶æ€æ­»è¯¥çº¿ç¨‹ï¼Œè¿™æ ·å°±å¯ä»¥ä¿æŠ¤å…¶ä»–å†…å­˜ä¸­çš„æ•°æ®</p><p>çº¿ç¨‹çš„ä¼˜å…ˆçº§æŒ‡é’ˆ<br>è¡¨ç¤ºçº¿ç¨‹çš„ä¼˜å…ˆçº§ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ä¸å»ºè®®ä¿®æ”¹ï¼Œå› ä¸ºä¼šå½±å“ç³»ç»Ÿçš„ç¨³å®šæ€§ï¼Œä¸€èˆ¬åªæœ‰æ€æ¯’è½¯ä»¶æˆ–ç³»ç»Ÿçš„é˜²å¾¡è½¯ä»¶æ‰ä¼šä¿®æ”¹å…¶ä¼˜å…ˆçº§</p><h3 id="äºŒã€çº¿ç¨‹é€€å‡ºçŠ¶æ€"><a href="#äºŒã€çº¿ç¨‹é€€å‡ºçŠ¶æ€" class="headerlink" title="äºŒã€çº¿ç¨‹é€€å‡ºçŠ¶æ€"></a>äºŒã€çº¿ç¨‹é€€å‡ºçŠ¶æ€</h3><p>çº¿ç¨‹çš„é€€å‡ºçŠ¶æ€æœ‰ä¸¤ç§ï¼Œåˆ†åˆ«æ˜¯å›æ”¶æ€(PTHREAD_JOINABLE)å’Œåˆ†ç¦»æ€(PTHREAD_DETACH)<br><img src="https://raw.githubusercontent.com/mengchao666/picture/main/blogd60237bec9fd90d5c7d6bb8cfc2d90f6.png"></p><p>çº¿ç¨‹æ ˆåœ°å€<br>ç”±äºå½“ä¿®æ”¹çº¿ç¨‹å±æ€§æ—¶ï¼Œçº¿ç¨‹è¿˜æ²¡æœ‰è¢«åˆ›å»ºï¼Œè‡ªç„¶ä¹Ÿå°±æ²¡æœ‰åœ°å€å¯å­˜ï¼Œæ‰€ä»¥é»˜è®¤æƒ…å†µä¸‹éƒ½æ˜¯nilï¼Œè¡¨ç¤ºç©º</p><p>çº¿ç¨‹æ ˆå¤§å°<br>çº¿ç¨‹æ ˆå¤§å°ä¸€èˆ¬æƒ…å†µä¸‹éƒ½æ˜¯8Mï¼Œä½†æ˜¯æˆ‘ä»¬çŸ¥é“ï¼Œ8Må¦‚æœç”¨äºŒè¿›åˆ¶è¡¨ç¤ºæ—¶éå¸¸å¤§çš„æ•°ï¼Œå°†è¿™ä¹ˆå¤§çš„æ•°æ”¾è¿›å»ä»…ä»…è¡¨ç¤ºçº¿ç¨‹æ ˆçš„å¤§å°å…¶å®æ²¡ä»€ä¹ˆæ„ä¹‰ï¼Œæ‰€ä»¥é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿™é‡Œå­˜æ”¾çš„æ•°æ®å°±æ˜¯0ï¼Œè¡¨ç¤º8Mï¼Œç”³è¯·ç©ºé—´æ—¶ä¹Ÿæ˜¯ç”³è¯·8Må¤§å°çš„ç©ºé—´</p><h3 id="ä¸‰ã€ä¿®æ”¹çº¿ç¨‹å±æ€§çš„ç›¸å…³å‡½æ•°"><a href="#ä¸‰ã€ä¿®æ”¹çº¿ç¨‹å±æ€§çš„ç›¸å…³å‡½æ•°" class="headerlink" title="ä¸‰ã€ä¿®æ”¹çº¿ç¨‹å±æ€§çš„ç›¸å…³å‡½æ•°"></a>ä¸‰ã€ä¿®æ”¹çº¿ç¨‹å±æ€§çš„ç›¸å…³å‡½æ•°</h3><p>åœ¨äº†è§£äº†çº¿ç¨‹å±æ€§çš„ç»„æˆä¹‹åï¼Œæˆ‘ä»¬å°±è¦æ¥äº†è§£ä¸€ä¸‹ä¿®æ”¹çº¿ç¨‹å±æ€§çš„ç›¸å…³å‡½æ•°äº†</p><p>å…ˆä»‹ç»ä¸‹ä¸€ä¼šä¼šç”¨åˆ°çš„å‡ ä¸ªå˜é‡ï¼š</p><ul><li>pthread_attr_t attr ; &#x2F;&#x2F;å®šä¹‰ä¸€ä¸ªçº¿ç¨‹å±æ€§ç»“æ„ä½“</li><li>int exit_state ; &#x2F;&#x2F;çº¿ç¨‹å±æ€§ä¸­çš„é€€å‡ºçŠ¶æ€</li><li>void* thread_stack_addr ; &#x2F;&#x2F;çº¿ç¨‹å±æ€§ä¸­çš„çº¿ç¨‹æ ˆåœ°å€</li><li>size_t thread_stack_size ; &#x2F;&#x2F;çº¿ç¨‹å±æ€§ä¸­çš„çº¿ç¨‹æ ˆå¤§å°</li></ul><table><thead><tr><th>å‡½æ•°</th><th>åŠŸèƒ½</th><th>è¿”å›å€¼</th></tr></thead><tbody><tr><td>pthread_attr_getdetachstate(&amp;attr , &amp;exit_state);</td><td>exit_stateä½œä¸ºä¼ å‡ºå‚æ•°ï¼Œå¯ä»¥è·å–çº¿ç¨‹å±æ€§ä¸­çš„é€€å‡ºçŠ¶æ€</td><td>å›æ”¶æ€è¿”å› PTHREAD_CREATE_JOINABLE<br /><br />åˆ†ç¦»æ€è¿”å› PTHREAD_CREATE_DETACHED</td></tr><tr><td>pthread_attr_setdetachstate(&amp;attr , exit_state);</td><td>é€šè¿‡ä¼ å…¥å‚æ•°exit_stateï¼Œè®¾ç½®çº¿ç¨‹å±æ€§ä¸­çš„é€€å‡ºçŠ¶æ€</td><td>æˆåŠŸè¿”å›0ï¼Œå¤±è´¥è¿”å›é0é”™è¯¯ç </td></tr><tr><td>pthread_attr_getstack(&amp;attr , &amp;thread_stack_addr , &amp;thread_stack_size);</td><td>thread_stack_addrã€thread_stack_sizeä½œä¸ºä¼ å‡ºå‚æ•°ï¼Œå¯ä»¥è·å–çº¿ç¨‹å±æ€§ä¸­çš„æ ˆåœ°å€ä¸æ ˆå¤§å°</td><td>è¿”å›ä¸¤ä¸ªå‚æ•°â€”â€”çº¿ç¨‹æ ˆåœ°å€ä¸çº¿ç¨‹æ ˆå¤§å°</td></tr><tr><td>pthread_attr_setstack(&amp;attr , thread_stack_addr , thread_stack_size);</td><td>é€šè¿‡ä¼ å…¥å‚æ•°thread_stack_addrã€thread_stack_sizeï¼Œå¯ä»¥è®¾ç½®çº¿ç¨‹å±æ€§ä¸­çš„æ ˆåœ°å€ä¸æ ˆå¤§å°</td><td>æˆåŠŸè¿”å›0ï¼Œå¤±è´¥è¿”å›é0é”™è¯¯ç </td></tr><tr><td>pthread_attr_init(&amp;attr);</td><td>åˆå§‹åŒ–çº¿ç¨‹å±æ€§ç»“æ„ä½“</td><td>æˆåŠŸè¿”å›0ï¼Œå¤±è´¥è¿”å›-1</td></tr><tr><td>pthread_attr_destroy(&amp;attr);</td><td>é‡Šæ”¾çº¿ç¨‹å±æ€§ç»“æ„ä½“å†…å­˜</td><td>æˆåŠŸè¿”å›0ï¼Œå¤±è´¥è¿”å›-1</td></tr></tbody></table><h3 id="å››ã€ä¿®æ”¹çº¿ç¨‹å±æ€§çš„å…·ä½“å®ç°"><a href="#å››ã€ä¿®æ”¹çº¿ç¨‹å±æ€§çš„å…·ä½“å®ç°" class="headerlink" title="å››ã€ä¿®æ”¹çº¿ç¨‹å±æ€§çš„å…·ä½“å®ç°"></a>å››ã€ä¿®æ”¹çº¿ç¨‹å±æ€§çš„å…·ä½“å®ç°</h3><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®è¿™äº›å‡½æ•°æ¥å®é™…æ“ä½œä¸€ä¸‹ï¼Œå®Œæˆä»¥ä¸‹ä¸¤ä¸ªå°ä»»åŠ¡</p><p>è·å–çº¿ç¨‹å±æ€§ä¸­é»˜è®¤çš„é€€å‡ºçŠ¶æ€ï¼ˆéš¾åº¦ï¼šâ­ï¼‰<br>è·å–é»˜è®¤çŠ¶æ€ä¸‹çº¿ç¨‹å±æ€§ä¸­çš„çº¿ç¨‹æ ˆåœ°å€ä¸å¤§å°ã€‚å°†çº¿ç¨‹å±æ€§ä¸­çš„é€€å‡ºçŠ¶æ€è®¾ç½®ä¸ºåˆ†ç¦»æ€ï¼Œä¿®æ”¹çº¿ç¨‹æ ˆåœ°å€ï¼Œä¿®æ”¹çº¿ç¨‹æ ˆå¤§å°ä¸º1Mï¼Œå¹¶æµ‹è¯•ä½¿ç”¨è¿™ç§çº¿ç¨‹å±æ€§çš„çº¿ç¨‹ï¼Œç³»ç»Ÿä¸€å…±èƒ½å¤Ÿåˆ›å»ºå¤šå°‘ä¸ªï¼Ÿï¼ˆéš¾åº¦ï¼šâ­â­â­â­ï¼‰<br>PSï¼š64ä½æœºä¸‹ï¼Œå³ä½¿ä½ ä¿®æ”¹äº†çº¿ç¨‹æ ˆå¤§å°ï¼Œåˆ›å»ºçš„æ•°ç›®å’ŒåŸæ¥è¿˜æ˜¯ä¸€æ ·çš„ï¼Œå› ä¸ºä½ çš„ä¿®æ”¹æ˜¯æ— æ•ˆçš„ï¼Œç³»ç»Ÿåˆ›å»ºçš„çº¿ç¨‹æ ˆå¤§å°è¿˜æ˜¯8Mï¼Œä¿®æ”¹çº¿ç¨‹æ ˆå¤§å°åªæœ‰32ä½æœºæœ‰æ•ˆ</p><p>1ã€è·å–çº¿ç¨‹å±æ€§ä¸­é»˜è®¤çš„é€€å‡ºçŠ¶æ€ï¼Œä»¥ä¸‹æ˜¯ä»£ç å®ç°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/stat.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br> <br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-type">pthread_attr_t</span> attr;<br>    <span class="hljs-comment">//1.åˆå§‹åŒ–çº¿ç¨‹å±æ€§</span><br>    pthread_attr_init(&amp;attr);<br>    <span class="hljs-comment">//2.æ£€æµ‹çº¿ç¨‹å±æ€§ä¸­çš„çº¿ç¨‹é€€å‡ºçŠ¶æ€</span><br>    <span class="hljs-type">int</span> detach_status;<br>    pthread_attr_getdetachstate(&amp;attr , &amp;detach_status);<br>    <span class="hljs-comment">//3.åˆ¤æ–­æ˜¯å›æ”¶æ€è¿˜æ˜¯åˆ†ç¦»æ€</span><br>    <span class="hljs-keyword">if</span>(detach_status == PTHREAD_CREATE_JOINABLE)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;çº¿ç¨‹å±æ€§é»˜è®¤ä¸ºå›æ”¶æ€\n&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">else</span><br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;çº¿ç¨‹å±æ€§é»˜è®¤ä¸ºåˆ†ç¦»æ€\n&quot;</span>);<br>    &#125;<br>    <span class="hljs-comment">//4.é‡Šæ”¾çº¿ç¨‹å±æ€§ç»“æ„ä½“å†…å­˜</span><br>    pthread_attr_destroy(&amp;attr);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;è¿›ç¨‹é€€å‡ºï¼\n&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>æ€ä¹ˆæ ·ï¼Œæ˜¯ä¸æ˜¯å¾ˆç®€å•å‘¢ï¼Ÿ  æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥å®Œæˆç¬¬äºŒä¸ªå°ä»»åŠ¡</p><p>2ã€è·å–é»˜è®¤çŠ¶æ€ä¸‹çº¿ç¨‹å±æ€§ä¸­çš„çº¿ç¨‹æ ˆåœ°å€ä¸å¤§å°ã€‚å°†çº¿ç¨‹å±æ€§ä¸­çš„é€€å‡ºçŠ¶æ€è®¾ç½®ä¸ºåˆ†ç¦»æ€ï¼Œä¿®æ”¹çº¿ç¨‹æ ˆåœ°å€ï¼Œä¿®æ”¹çº¿ç¨‹æ ˆå¤§å°ä¸º1Mï¼Œå¹¶æµ‹è¯•ä½¿ç”¨è¿™ç§çº¿ç¨‹å±æ€§çš„çº¿ç¨‹ï¼Œç³»ç»Ÿä¸€å…±èƒ½å¤Ÿåˆ›å»ºå¤šå°‘ä¸ªï¼Œä»¥ä¸‹æ˜¯ä»£ç å®ç°</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">//pthread_addr_change.c</span><br> <br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/wait.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/stat.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br> <br><span class="hljs-function"><span class="hljs-type">void</span>* <span class="hljs-title">thread_jobs</span><span class="hljs-params">(<span class="hljs-type">void</span>* arg)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>)<br>    &#123;<br>        <span class="hljs-built_in">sleep</span>(<span class="hljs-number">1</span>);<br>    &#125;<br>    <span class="hljs-built_in">pthread_exit</span>(<span class="hljs-literal">NULL</span>);<br>&#125;<br> <br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-type">pthread_attr_t</span> attr;<br>    <span class="hljs-comment">//1.åˆå§‹åŒ–çº¿ç¨‹å±æ€§</span><br>    <span class="hljs-built_in">pthread_attr_init</span>(&amp;attr);<br>    <span class="hljs-comment">//2.æ£€æµ‹çº¿ç¨‹å±æ€§ä¸­çš„çº¿ç¨‹é€€å‡ºçŠ¶æ€</span><br>    <span class="hljs-type">int</span> detach_status;<br>    <span class="hljs-built_in">pthread_attr_getdetachstate</span>(&amp;attr , &amp;detach_status);<br>    <span class="hljs-comment">//3.åˆ¤æ–­æ˜¯å›æ”¶æ€è¿˜æ˜¯åˆ†ç¦»æ€å¹¶æ‰“å°</span><br>    <span class="hljs-keyword">if</span>(detach_status == PTHREAD_CREATE_JOINABLE)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;çº¿ç¨‹å±æ€§é»˜è®¤ä¸ºå›æ”¶æ€\n&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">else</span><br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;çº¿ç¨‹å±æ€§é»˜è®¤ä¸ºåˆ†ç¦»æ€\n&quot;</span>);<br>    &#125;<br>    <span class="hljs-comment">//4.å°†çº¿ç¨‹å±æ€§ä¸­çš„é€€å‡ºæ€ä¿®æ”¹ä¸ºåˆ†ç¦»æ€</span><br>    <span class="hljs-built_in">pthread_attr_setdetachstate</span>(&amp;attr , PTHREAD_CREATE_DETACHED);<br>    <span class="hljs-comment">//5.è·å–çº¿ç¨‹å±æ€§ä¸­çº¿ç¨‹æ ˆçš„åˆå§‹åœ°å€ä¸å¤§å°å¹¶æ‰“å°</span><br>    <span class="hljs-type">void</span>* thread_stack_addr;<br>    <span class="hljs-type">size_t</span> thread_stack_size;<br>    <span class="hljs-built_in">pthread_attr_getstack</span>(&amp;attr , &amp;thread_stack_addr , &amp;thread_stack_size);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;çº¿ç¨‹æ ˆåœ°å€ä¸º %p , çº¿ç¨‹æ ˆå¤§å°ä¸º %d \n&quot;</span> , thread_stack_addr , (<span class="hljs-type">int</span>)thread_stack_size);<br>    <span class="hljs-comment">//6.é€šè¿‡mallocå‡½æ•°ä¿®æ”¹çº¿ç¨‹æ ˆçš„åˆå§‹åœ°å€ï¼Œå¹¶å°†çº¿ç¨‹æ ˆå¤§å°æ”¹ä¸º1M</span><br>    <span class="hljs-type">pthread_t</span> tid;<br>    thread_stack_size = <span class="hljs-number">0x100000</span>;<span class="hljs-comment">//0x100000ä»£è¡¨1M</span><br>    <span class="hljs-type">int</span> flag = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">int</span> errno;<br>    <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>)<br>    &#123;<br>        <span class="hljs-comment">//å¦‚æœmallocå‡½æ•°çš„è¿”å›å€¼ä¸ºNULLï¼Œå°±è¯´æ˜åˆ†é…å¤±è´¥ï¼Œå†…å­˜å·²ç»ç”¨å®Œ</span><br>        <span class="hljs-keyword">if</span>((thread_stack_addr = (<span class="hljs-type">void</span>*)<span class="hljs-built_in">malloc</span>(thread_stack_size)) == <span class="hljs-literal">NULL</span>)<br>        &#123;<br>            <span class="hljs-built_in">perror</span>(<span class="hljs-string">&quot;thread_addr malloc failed!\n&quot;</span>);<br>            <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<span class="hljs-comment">//è¿›ç¨‹é€€å‡º</span><br>        &#125;<br>        <span class="hljs-comment">//ä¿®æ”¹æ ˆåˆå§‹åœ°å€å’Œå¤§å°</span><br>        <span class="hljs-built_in">pthread_attr_setstack</span>(&amp;attr , thread_stack_addr , thread_stack_size);<br>        <span class="hljs-comment">//åˆ›å»ºçº¿ç¨‹ï¼Œå¹¶åˆ¤æ–­æ˜¯å¦åˆ›å»ºå¤±è´¥</span><br>        <span class="hljs-keyword">if</span>((errno = <span class="hljs-built_in">pthread_create</span>(&amp;tid , &amp;attr , thread_jobs , <span class="hljs-literal">NULL</span>)) &gt; <span class="hljs-number">0</span>)<br>        &#123;<br>            <span class="hljs-built_in">perror</span>(<span class="hljs-string">&quot;thread create failed!\n&quot;</span>);<br>            <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<span class="hljs-comment">//è¿›ç¨‹ç›´æ¥é€€å‡º</span><br>        &#125;<br>        <span class="hljs-keyword">else</span><br>        &#123;<br>            flag++;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;flag = %d\n&quot;</span>,flag);<br>        &#125;<br>    &#125;<br>    <span class="hljs-built_in">pthread_attr_destroy</span>(&amp;attr);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;  <br>&#125;<br></code></pre></td></tr></table></figure><p>ç»“æœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://raw.githubusercontent.com/mengchao666/picture/main/blog341e2ea87aae2a77aa1cb50c3e74ccfd.png"></p><p><img src="https://raw.githubusercontent.com/mengchao666/picture/main/bloge74729526522782afec4fce8a96076cf.png"></p><h3 id="äº”ã€pthread-äº²å’Œæ€§è®¾ç½®"><a href="#äº”ã€pthread-äº²å’Œæ€§è®¾ç½®" class="headerlink" title="äº”ã€pthread äº²å’Œæ€§è®¾ç½®"></a>äº”ã€pthread äº²å’Œæ€§è®¾ç½®</h3><h4 id="1ã€pthread-attr-setaffinity-np"><a href="#1ã€pthread-attr-setaffinity-np" class="headerlink" title="1ã€pthread_attr_setaffinity_np"></a>1ã€pthread_attr_setaffinity_np</h4><p>å‡½æ•°åŸå‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">pthread_attr_setaffinity_np</span><span class="hljs-params">(<span class="hljs-type">pthread_attr_t</span> *attr, <span class="hljs-type">size_t</span> cpusetsize,</span><br><span class="hljs-params">    <span class="hljs-type">const</span> <span class="hljs-type">cpu_set_t</span> *cpuset)</span>;<br></code></pre></td></tr></table></figure><ul><li>attrï¼šæŒ‡å‘çº¿ç¨‹å±æ€§å¯¹è±¡çš„æŒ‡é’ˆã€‚</li><li>cpusetsizeï¼šCPU äº²å’Œæ€§é›†åˆçš„å¤§å°ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰ã€‚</li><li>cpusetï¼šæŒ‡å‘ CPU äº²å’Œæ€§é›†åˆçš„æŒ‡é’ˆï¼Œå…¶ä¸­åŒ…å«è¦ç»‘å®šçº¿ç¨‹çš„ CPUã€‚</li><li>è¿”å›å€¼ï¼šæˆåŠŸè¿”å› 0ï¼Œå¤±è´¥è¿”å›é”™è¯¯ä»£ç ã€‚</li><li>ç”¨äºè®¾ç½®çº¿ç¨‹çš„ CPU äº²å’Œæ€§ï¼ˆCPU Affinityï¼‰ã€‚</li></ul><p>å®ƒå…è®¸å°†çº¿ç¨‹ç»‘å®šåˆ°ç‰¹å®šçš„ CPU æ ¸å¿ƒæˆ– CPU é›†åˆä¸Šï¼Œä»¥æ§åˆ¶çº¿ç¨‹åœ¨å“ªäº› CPU ä¸Šè¿è¡Œã€‚</p><h4 id="2ã€pthread-setaffinity-np"><a href="#2ã€pthread-setaffinity-np" class="headerlink" title="2ã€pthread_setaffinity_np"></a>2ã€pthread_setaffinity_np</h4><p>å‡½æ•°åŸå‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">pthread_setaffinity_np</span><span class="hljs-params">(<span class="hljs-type">pthread_t</span> thread, <span class="hljs-type">size_t</span> cpusetsize,</span><br><span class="hljs-params">    <span class="hljs-type">const</span> <span class="hljs-type">cpu_set_t</span> *cpuset)</span>;<br></code></pre></td></tr></table></figure><ul><li>threadï¼šè¦è®¾ç½® CPU äº²å’Œæ€§çš„çº¿ç¨‹æ ‡è¯†ç¬¦ã€‚</li><li>cpusetsizeï¼šCPU äº²å’Œæ€§é›†åˆçš„å¤§å°ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰ã€‚</li><li>cpusetï¼šæŒ‡å‘ CPU äº²å’Œæ€§é›†åˆçš„æŒ‡é’ˆï¼Œå…¶ä¸­åŒ…å«è¦ç»‘å®šçº¿ç¨‹çš„ CPUã€‚</li><li>è¿”å›å€¼ï¼šæˆåŠŸè¿”å› 0ï¼Œå¤±è´¥è¿”å›é”™è¯¯ä»£ç ã€‚</li><li>ç”¨äºè®¾ç½®çº¿ç¨‹çš„ CPU äº²å’Œæ€§ï¼ˆCPU Affinityï¼‰ã€‚</li></ul><p>å®ƒå…è®¸å°†çº¿ç¨‹ç»‘å®šåˆ°ç‰¹å®šçš„ CPU æ ¸å¿ƒæˆ– CPU é›†åˆä¸Šï¼Œä»¥æ§åˆ¶çº¿ç¨‹åœ¨å“ªäº› CPU ä¸Šè¿è¡Œã€‚</p><p>ç¤ºä¾‹1ï¼ˆæ¨èï¼‰<br>æœ¬ç¤ºä¾‹æ¼”ç¤ºäº†å¦‚ä½•åœ¨åˆ›å»ºçº¿ç¨‹æ—¶é™åˆ¶å…¶åªèƒ½åœ¨ cpu1 ä¸Šè¿è¡Œã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sched.h&gt;</span></span><br><br><span class="hljs-type">void</span> *<span class="hljs-title function_">thread_func</span><span class="hljs-params">(<span class="hljs-type">void</span> *arg)</span><br>&#123;<br>    usleep(<span class="hljs-number">10000</span>);<br><br>    <span class="hljs-comment">// è·å–å½“å‰çº¿ç¨‹çš„ CPU äº²å’Œæ€§</span><br>    <span class="hljs-type">cpu_set_t</span> cpuset;<br>    CPU_ZERO(&amp;cpuset);<br>    pthread_getaffinity_np(pthread_self(), <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">cpu_set_t</span>), &amp;cpuset);<br>    <span class="hljs-comment">// æ‰“å°å½“å‰çº¿ç¨‹ç»‘å®šçš„ CPU</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; CPU_SETSIZE; i++) &#123;<br>        <span class="hljs-keyword">if</span> (CPU_ISSET(i, &amp;cpuset)) &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;thread is running on cpu %d\n&quot;</span>, i);<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">pthread_t</span> tid;<br>    <span class="hljs-type">pthread_attr_t</span> attr;<br>    pthread_attr_init(&amp;attr);<br><br>    <span class="hljs-comment">// åˆ›å»ºçº¿ç¨‹å¹¶è®¾ç½®å…¶åªèƒ½åœ¨ cpu1 ä¸Šè¿è¡Œ</span><br>    <span class="hljs-type">cpu_set_t</span> mask;<br>    CPU_ZERO(&amp;mask);<br>    CPU_SET(<span class="hljs-number">1</span>, &amp;mask);<br>    pthread_attr_setaffinity_np(&amp;attr, <span class="hljs-keyword">sizeof</span>(mask), &amp;mask);<br>    pthread_create(&amp;tid, &amp;attr, thread_func, <span class="hljs-literal">NULL</span>);<br><br>    pthread_attr_destroy(&amp;attr);<br>    pthread_join(tid, <span class="hljs-literal">NULL</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç¤ºä¾‹2ï¼šæœ¬ç¤ºä¾‹æ¼”ç¤ºäº†å¦‚ä½•åœ¨åˆ›å»ºçº¿ç¨‹åé™åˆ¶å…¶åªèƒ½åœ¨ cpu0 1 2 ä¸Šè¿è¡Œã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sched.h&gt;</span></span><br><br><span class="hljs-type">void</span> *<span class="hljs-title function_">thread_func</span><span class="hljs-params">(<span class="hljs-type">void</span> *arg)</span><br>&#123;<br>    usleep(<span class="hljs-number">10000</span>);<br><br>    <span class="hljs-comment">// è·å–å½“å‰çº¿ç¨‹çš„ CPU äº²å’Œæ€§</span><br>    <span class="hljs-type">cpu_set_t</span> cpuset;<br>    CPU_ZERO(&amp;cpuset);<br>    pthread_getaffinity_np(pthread_self(), <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">cpu_set_t</span>), &amp;cpuset);<br>    <span class="hljs-comment">// æ‰“å°å½“å‰çº¿ç¨‹ç»‘å®šçš„ CPU</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; CPU_SETSIZE; i++) &#123;<br>        <span class="hljs-keyword">if</span> (CPU_ISSET(i, &amp;cpuset)) &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;thread is running on cpu %d\n&quot;</span>, i);<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// åˆ›å»ºçº¿ç¨‹å¹¶è®¾ç½®å…¶åªèƒ½åœ¨ cpu0 1 2 ä¸Šè¿è¡Œ</span><br>    <span class="hljs-type">pthread_t</span> tid;<br>    <span class="hljs-type">cpu_set_t</span> mask;<br>    CPU_ZERO(&amp;mask);<br>    CPU_SET(<span class="hljs-number">0</span>, &amp;mask);<br>    CPU_SET(<span class="hljs-number">1</span>, &amp;mask);<br>    CPU_SET(<span class="hljs-number">2</span>, &amp;mask);<br>    pthread_create(&amp;tid, <span class="hljs-literal">NULL</span>, thread_func, <span class="hljs-literal">NULL</span>);<br>    pthread_setaffinity_np(tid, <span class="hljs-keyword">sizeof</span>(mask), &amp;mask);<br><br>    pthread_join(tid, <span class="hljs-literal">NULL</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;æˆ‘ä»¬çŸ¥é“ï¼Œåœ¨åˆ›å»ºçº¿ç¨‹æ—¶ï¼Œä¼šç”¨åˆ°pthread_create()å‡½æ•° ï¼Œæˆ‘ä»¬æ¥ç®€å•ä»‹ç»ä¸€ä¸‹è¯¥å‡½æ•°ï¼š&lt;/p&gt;
&lt;p&gt;&lt;code&gt;pthread_create(çº¿ç¨‹çš„tid ï¼Œ çº¿ç¨‹å±æ€§ ï¼Œ å·¥ä½œå‡½æ•°å ï¼Œ å‡½æ•°éœ€è¦çš„å‚æ•°);&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;è¿™ç¯‡åšå®¢è¦è®²çš„çº¿ç¨‹å±æ€§ï¼Œ</summary>
      
    
    
    
    <category term="Cè¯­è¨€" scheme="http://example.com/categories/C%E8%AF%AD%E8%A8%80/"/>
    
    
    <category term="Cè¯­è¨€" scheme="http://example.com/tags/C%E8%AF%AD%E8%A8%80/"/>
    
  </entry>
  
  <entry>
    <title>åŠ¨æ€é“¾æ¥åº“ã€é™æ€é“¾æ¥åº“</title>
    <link href="http://example.com/posts/%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93%E3%80%81%E9%9D%99%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93.html"/>
    <id>http://example.com/posts/%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93%E3%80%81%E9%9D%99%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93.html</id>
    <published>2024-11-24T16:03:41.000Z</published>
    <updated>2024-11-24T16:03:59.816Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ä¸€ã€ä»€ä¹ˆæ˜¯é“¾æ¥åº“"><a href="#ä¸€ã€ä»€ä¹ˆæ˜¯é“¾æ¥åº“" class="headerlink" title="ä¸€ã€ä»€ä¹ˆæ˜¯é“¾æ¥åº“"></a>ä¸€ã€ä»€ä¹ˆæ˜¯é“¾æ¥åº“</h1><p>æœ‰æ—¶å€™æˆ‘ä»¬å¯¹å¤–æä¾›åŠŸèƒ½çš„æ—¶å€™ï¼Œå¯èƒ½ä¸å¸Œæœ›å¯¹æ–¹çœ‹åˆ°æºç ï¼Œæˆ‘ä»¬å°±å¯ä»¥åˆ¶ä½œæˆåº“æ–‡ä»¶ï¼ŒæŠŠåº“æ–‡ä»¶å’Œå¤´æ–‡ä»¶ç»™åˆ°å¯¹æ–¹å°±å¯ä»¥è¾¾åˆ°æä¾›åŠŸèƒ½åˆä¸æš´éœ²æºç çš„ç›®çš„ã€‚é“¾æ¥åº“å°±æ˜¯æŒ‡å°†åº“æ–‡ä»¶ç¼–è¯‘åæ‰“åŒ…ä¸ºä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œè¿™äº›äºŒè¿›åˆ¶æ–‡ä»¶ä¼šåœ¨ç¨‹åºè°ƒç”¨çš„æ—¶å€™åŠ è½½åˆ°å†…å­˜ä¸­ã€‚å®é™…ä¸Šï¼Œä¸€ä¸ªæˆ–å¤šä¸ªæºæ–‡ä»¶ç¼–è¯‘ä¸ºç›®æ ‡æ–‡ä»¶åï¼Œè¿™ä¸ªæ–‡ä»¶ä¸­æ‰€å¼•ç”¨çš„å¤–éƒ¨çš„ç¬¦å·éœ€è¦é€šè¿‡é“¾æ¥æ¥æ‰¾åˆ°è¿™éƒ¨åˆ†ç¼ºå¤±çš„åœ°å€ã€‚è€Œé“¾æ¥çš„æ–¹å¼åˆåˆ†ä¸ºä¸¤ç§ï¼Œå¦‚æœæ˜¯åœ¨ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶ä¹‹å‰å°±å·²ç»æŠŠæ‰€æœ‰çš„é“¾æ¥æ“ä½œå®Œæˆäº†ï¼Œè¿™ç§é“¾æ¥ç§°ä¸ºé™æ€é“¾æ¥ï¼Œè¿™ç§åº“æ–‡ä»¶ç§°ä¸ºé™æ€é“¾æ¥åº“ï¼›å¦‚æœæ˜¯åœ¨ç¨‹åºæ‰§è¡Œçš„æ—¶å€™æ‰è¿›è¡Œé“¾æ¥ï¼Œè¿™ç§ç§°ä¸ºåŠ¨æ€é“¾æ¥ï¼Œå¯¹åº”çš„åº“æ–‡ä»¶ç§°ä¸ºåŠ¨æ€é“¾æ¥åº“ã€‚ä¹Ÿæ­£å› ä¸ºå¦‚æ­¤ï¼Œä½¿ç”¨é™æ€åº“æ—¶ç”Ÿæˆçš„å¯æ‰§è¡Œæ–‡ä»¶æ˜¯å¯ä»¥ç‹¬ç«‹è¿è¡Œçš„ï¼Œå› ä¸ºä»–ä¸å†éœ€è¦å¤–éƒ¨çš„å†…å®¹ï¼Œè€ŒåŠ¨æ€åº“ç¼–è¯‘ç”Ÿæˆçš„å¯æ‰§è¡Œæ–‡ä»¶å°±æ— æ³•å•ç‹¬è¿è¡Œï¼Œå› ä¸ºä»–åœ¨è¿è¡Œæ—¶ï¼Œæ‰ä¼šå»é“¾æ¥æ‰€å¼•ç”¨çš„å¤–éƒ¨åœ°å€ã€‚</p><h2 id="1-é™æ€é“¾æ¥åº“"><a href="#1-é™æ€é“¾æ¥åº“" class="headerlink" title="1. é™æ€é“¾æ¥åº“"></a>1. é™æ€é“¾æ¥åº“</h2><p>é™æ€åº“ä¼šç›´æ¥åŠ è½½åˆ°ä»£ç æ®µï¼Œä»–å’Œæ‰€æœ‰çš„ç›®æ ‡æ–‡ä»¶ä¸€èµ·é“¾æ¥æˆå¯æ‰§è¡Œæ–‡ä»¶ï¼Œç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶åå¯ä»¥ç‹¬ç«‹è¿è¡Œã€‚ä½†æ˜¯ï¼Œæ­£å› ä¸ºé™æ€åº“ä¼šç›´æ¥åŠ è½½åˆ°å†…å­˜çš„ä»£ç æ®µï¼Œå¯æ‰§è¡Œæ–‡ä»¶çš„å†…éƒ¨éƒ½æ‹·è´äº†æ‰€æœ‰ç›®æ ‡æ–‡ä»¶å’Œé™æ€åº“çš„æŒ‡ä»¤å’Œæ•°æ®ï¼Œç¼–è¯‘ç”Ÿæˆçš„å¯æ‰§è¡Œæ–‡ä»¶ä¼šæ¯”è¾ƒå¤§ã€‚å¹¶ä¸”ï¼Œå¦‚æœæ•´ä¸ªç³»ç»Ÿä¸­æœ‰å¤šä¸ªé“¾æ¥ç»Ÿä¸€é™æ€åº“çš„å¯æ‰§è¡Œæ–‡ä»¶æ—¶ï¼Œæ¯ä¸ªå¯æ‰§è¡Œæ–‡ä»¶éƒ½è¦æ‹·è´ä¸€ä»½é™æ€åº“çš„æŒ‡ä»¤å’Œæ•°æ®ï¼Œè¿™å°±é€ æˆäº†ç©ºé—´æµªè´¹ï¼Œå› ä¸ºä»–ä»¬æ‹·è´çš„æ•°æ®éƒ½æ˜¯åŒæ ·çš„å†…å®¹ã€‚æœ€åï¼Œå¦‚æœä¸€æ—¦é™æ€åº“æ–‡ä»¶æœ‰ä»£ç æ›´æ–°ï¼Œå°±éœ€è¦é‡æ–°ç¼–è¯‘é“¾æ¥é‡æ–°ç”Ÿæˆæ•´ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ï¼Œæ›´æ–°å‡çº§éº»çƒ¦ã€‚åœ¨ Linux ç³»ç»Ÿä¸­ï¼Œé™æ€é“¾æ¥åº“æ–‡ä»¶çš„åç§°é€šå¸¸ä¸º libxxx .aï¼Œåœ¨ Windows ç³»ç»Ÿä¸­ï¼Œé™æ€é“¾æ¥åº“æ–‡ä»¶çš„åç¼€åä¸º .libã€‚</p><h2 id="2-åŠ¨æ€é“¾æ¥åº“"><a href="#2-åŠ¨æ€é“¾æ¥åº“" class="headerlink" title="2. åŠ¨æ€é“¾æ¥åº“"></a>2. åŠ¨æ€é“¾æ¥åº“</h2><p>å…¶å®ï¼ŒåŠ¨æ€åº“è¿™ä¸ªç§°å‘¼æœ¬èº«æ˜¯å¯¹ Windows å¹³å°ä¸ŠåŠ¨æ€é“¾æ¥æ‰€ç”¨çš„åº“æ–‡ä»¶çš„ä¸€ç§ç§°å‘¼ï¼Œåœ¨ Linux ä¸‹ï¼Œä¸€èˆ¬ç§°ä¸ºå…±äº«åº“ã€‚åŠ¨æ€åº“æ˜¯åœ¨è¿è¡Œæ—¶åŠ è½½åˆ°å†…å­˜çš„å…±äº«åº“æ®µï¼Œè¿™æ ·ï¼Œå¦‚æœå¾ˆå¤šç¨‹åºéƒ½è¦ç”¨åˆ°é™æ€åº“çš„æ—¶å€™ï¼Œå°±ä¼šèŠ‚çœå¤§é‡å†…å­˜ï¼Œå› ä¸ºå®ƒä¸åƒé™æ€åº“é‚£æ ·åŠ è½½åˆ°ä»£ç æ®µï¼Œè€Œæ˜¯æ˜¯åœ¨è¿è¡Œæ—¶è½½å…¥å†…å­˜çš„å…±äº«åº“æ®µï¼Œå½“å¤šä¸ªç¨‹åºè¦ç”¨åˆ°åŒä¸€ä¸ªåŠ¨æ€åº“æ—¶ï¼Œæ‰€æœ‰ç¨‹åºå¯ä»¥å…±äº«è¿™ä¸ªå…±äº«åº“æ®µçš„æŒ‡ä»¤å’Œæ•°æ®ã€‚åŠ¨æ€é“¾æ¥çš„å®ç°æ˜¯è¿™æ ·çš„ï¼Œåœ¨ç¼–è¯‘æ—¶é¦–å…ˆç”±é™æ€é“¾æ¥å™¨å°†æ‰€æœ‰çš„ç›®æ ‡æ–‡ä»¶é“¾æ¥ä¸ºä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ï¼Œç­‰åˆ°ç¨‹åºè¿è¡Œæ—¶ä¼šå°†è¦ç”¨åˆ°çš„åŠ¨æ€åº“åŠ è½½åˆ°å†…å­˜çš„å…±äº«åº“æ®µï¼Œç”±åŠ¨æ€é“¾æ¥å™¨å®Œæˆå¯æ‰§è¡Œæ–‡ä»¶å’ŒåŠ¨æ€åº“æ–‡ä»¶çš„é“¾æ¥å·¥ä½œï¼Œå¯ä»¥ç†è§£ä¸ºæŒ‰éœ€è½½å…¥å†…å­˜ï¼ˆåœ¨éœ€è¦ç”¨åˆ°çš„æ—¶å€™ï¼Œæ‰ä¼šè½½å…¥å†…å­˜ï¼‰ã€‚åŠ¨æ€åº“å¤§å¤§æ–¹ä¾¿äº†ç¨‹åºçš„å‡çº§å’Œæ›´æ”¹ï¼Œåªè¦ç”¨æ–°çš„åŠ¨æ€åº“æ–‡ä»¶æ›¿æ¢æ—§çš„åŠ¨æ€åº“æ–‡ä»¶å³å¯ï¼Œåœ¨è¿è¡Œæ—¶ï¼Œä¼šè‡ªåŠ¨è¿æ¥æ–°çš„åº“æ–‡ä»¶ã€‚ä½†æ˜¯æ­£å› ä¸ºåŠ¨æ€åº“è¿è¡Œæ—¶è½½å…¥çš„è¿™ä¸ªç‰¹ç‚¹ï¼Œä½¿ç”¨åŠ¨æ€åº“çš„å¯æ‰§è¡Œæ–‡ä»¶åœ¨è¿è¡Œæ—¶ï¼Œä¼šç•¥æ…¢ä¸€äº›ï¼Œä½†æ•´ä½“æ¥è¯´ï¼Œè¿è¡Œé€Ÿåº¦çš„æ€§èƒ½æŸå¤±ï¼Œè¿œè¿œå°äºå†…å­˜èŠ‚çœå¸¦æ¥çš„æ”¶ç›Šã€‚åœ¨Linuxç³»ç»Ÿä¸­ï¼ŒåŠ¨æ€é“¾æ¥åº“çš„åç§°é€šå¸¸ä¸º libxxx.soï¼Œåœ¨ Windows ç³»ç»Ÿä¸­ï¼ŒåŠ¨æ€é“¾æ¥åº“çš„åç¼€åä¸º .dllã€‚GCC ç¼–è¯‘å™¨åœ¨ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶æ—¶ï¼Œé»˜è®¤ä¼šä¼˜å…ˆä½¿ç”¨åŠ¨æ€é“¾æ¥åº“å®Œæˆé“¾æ¥ï¼Œå¦‚æœå½“å‰ç³»ç»Ÿç¯å¢ƒä¸­æ²¡æœ‰ç¨‹åºæ–‡ä»¶æ‰€éœ€è¦çš„åŠ¨æ€é“¾æ¥åº“ï¼ŒGCC ä¾¿ä¼šé€‰æ‹©é™æ€é“¾æ¥åº“è¿›è¡Œé™æ€é“¾æ¥ã€‚å¦‚æœä¸¤ç§åº“æ–‡ä»¶éƒ½æ²¡æœ‰æ‰¾åˆ°ï¼Œåˆ™é“¾æ¥å¤±è´¥ã€‚</p><p><img src="https://raw.githubusercontent.com/mengchao666/picture/main/blog458378-20231222100407187-924921633.png"></p><h2 id="3-åº“æ–‡ä»¶ä¸å¤´æ–‡ä»¶"><a href="#3-åº“æ–‡ä»¶ä¸å¤´æ–‡ä»¶" class="headerlink" title="3. åº“æ–‡ä»¶ä¸å¤´æ–‡ä»¶"></a>3. åº“æ–‡ä»¶ä¸å¤´æ–‡ä»¶</h2><p>æˆ‘ä»¬åœ¨å‘å¸ƒåº“æ–‡ä»¶çš„åŒæ—¶ï¼Œè¦å°†åº“æ–‡ä»¶å’Œå¤´æ–‡ä»¶ä¸€èµ·å‘å¸ƒï¼Œå¤´æ–‡ä»¶ä¸­å­˜å‚¨äº†å˜é‡ã€å‡½æ•°æˆ–è€…ç±»ç­‰è¿™äº›åŠŸèƒ½æ¨¡å—çš„å£°æ˜éƒ¨åˆ†ï¼Œåº“æ–‡ä»¶ä¸­å­˜å‚¨äº†å„æ¨¡å—å…·ä½“çš„å®ç°éƒ¨åˆ†ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¤´æ–‡ä»¶ä¸­å®šä¹‰äº†è°ƒç”¨åº“æ–‡ä»¶ä¸­åŠŸèƒ½æ¨¡å—çš„æ¥å£ã€‚å¤´æ–‡ä»¶çš„å­˜åœ¨ä¹Ÿå®ç°äº†è¿™æ ·ä¸€ç§åŠŸèƒ½ï¼Œå½“æˆ‘ä»¬å¯¹å¤–æä¾›åŠŸèƒ½æ—¶ï¼Œå¯ä»¥é€šè¿‡åº“æ–‡ä»¶æ¥éšè—æºç å®ç°ï¼ŒåŠŸèƒ½çš„ä½¿ç”¨æ–¹åªéœ€è¦æ ¹æ®å¤´æ–‡ä»¶æ‰€æä¾›çš„æ¥å£æ¥è°ƒç”¨åŠŸèƒ½æ¨¡å—å³å¯ã€‚</p><h2 id="4-åº“æ–‡ä»¶çš„å¼•ç”¨"><a href="#4-åº“æ–‡ä»¶çš„å¼•ç”¨" class="headerlink" title="4. åº“æ–‡ä»¶çš„å¼•ç”¨"></a>4. åº“æ–‡ä»¶çš„å¼•ç”¨</h2><p>å½“æˆ‘ä»¬ä½¿ç”¨ GCC ç¼–è¯‘å’Œé“¾æ¥ç¨‹åºæ—¶ï¼ŒGCC é»˜è®¤ä¼šé“¾æ¥ libc.a æˆ–è€… libc.soè¿™ä¸¤ä¸ªæ ‡å‡†åº“ï¼Œä½†æ˜¯å¯¹äºå…¶ä»–çš„åº“ï¼ˆéæ ‡å‡†åº“ã€ç¬¬ä¸‰æ–¹åº“ç­‰ï¼‰ï¼Œå°±éœ€è¦æ‰‹åŠ¨å»æ·»åŠ é“¾æ¥åº“ã€‚é€šè¿‡ GCC -l é€‰é¡¹æ¥æŒ‡å®šåº“åï¼Œç›´æ¥åœ¨ -l åé¢åŠ åº“åå³å¯ã€‚ï¼ˆ -l æ˜¯å°å†™çš„ L ï¼‰<br />æ­£å¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬æŒ‡å®šäº†è¦ä½¿ç”¨çš„åº“åæ—¶ï¼ŒGCC ä¼šè‡ªåŠ¨åœ¨æ ‡å‡†åº“ç›®å½•ä¸­æœç´¢æ–‡ä»¶ï¼Œä¾‹å¦‚åœ¨CentOSä¸­æ˜¯ &#x2F;usr&#x2F;lib ç›®å½•ã€‚ä½†æ˜¯ï¼Œå¦‚æœæƒ³é“¾æ¥ä½äºå…¶å®ƒç›®å½•ä¸­çš„åº“ï¼Œæ¯”å¦‚è¯´æˆ‘ä»¬è‡ªå·±å»ºçš„åº“ï¼Œæˆ–è€…æˆ‘ä»¬è¦å¼•ç”¨åˆ«äººæä¾›çš„åº“ï¼Œå°±éœ€è¦åœ¨ç¼–è¯‘æ—¶æ˜¾ç¤ºæŒ‡å®šåº“çš„è·¯å¾„ã€‚æŒ‡å®šæ–¹æ³•æœ‰ä¸‰ç§ï¼š<br />â‘  åƒæŒ‡å®šæ™®é€šå¤´æ–‡ä»¶çš„è·¯å¾„ä¸€æ ·ï¼Œä¸º GCC æ˜¾ç¤ºæŒ‡å®šè¯¥åº“æ–‡ä»¶çš„å®Œæ•´è·¯å¾„ä¸æ–‡ä»¶å -I &#x2F;ç›®å½•å ã€‚<br />â‘¡ é€šè¿‡ GCC çš„ -L é€‰é¡¹ï¼Œä¸ºGCCå¢åŠ æœç´¢ç›®å½•ï¼Œå¯ä»¥ä½¿ç”¨å¤šä¸ª -L é€‰é¡¹ï¼Œæˆ–è€…åœ¨ä¸€ä¸ªé€‰é¡¹å†…ä½¿ç”¨å†’å· : åˆ†å‰²æ¥æŒ‡å®šå¤šä¸ªæœç´¢è·¯å¾„ã€‚<br />â‘¢ æŠŠåº“æ–‡ä»¶æ‰€åœ¨çš„ç›®å½•åŠ åˆ°ç¯å¢ƒå˜é‡ LIBRARYPATH ä¸­ã€‚</p><h1 id="äºŒã€è‡ªå·±åŠ¨æ‰‹åˆ¶ä½œé™æ€é“¾æ¥åº“"><a href="#äºŒã€è‡ªå·±åŠ¨æ‰‹åˆ¶ä½œé™æ€é“¾æ¥åº“" class="headerlink" title="äºŒã€è‡ªå·±åŠ¨æ‰‹åˆ¶ä½œé™æ€é“¾æ¥åº“"></a>äºŒã€è‡ªå·±åŠ¨æ‰‹åˆ¶ä½œé™æ€é“¾æ¥åº“</h1><p>å‡†å¤‡å·¥ä½œï¼Œå…±å‡†å¤‡4ä¸ªæ–‡ä»¶ï¼Œç›®å½•ç»“æ„å¦‚ä¸‹</p><p><img src="https://raw.githubusercontent.com/mengchao666/picture/main/blog458378-20231222100406820-895205743.png"></p><p>my_print.h æ–‡ä»¶å†…å®¹å¦‚ä¸‹</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> _TEST_H</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _TEST_H</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;stdio.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;stdlib.h&quot;</span></span><br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">print_array_int</span><span class="hljs-params">(<span class="hljs-type">int</span>* array, <span class="hljs-type">int</span> len)</span></span>;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">print_array_char</span><span class="hljs-params">(<span class="hljs-type">char</span>* array, <span class="hljs-type">int</span> len)</span></span>;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">print_array_string</span><span class="hljs-params">(<span class="hljs-type">char</span>* array[], <span class="hljs-type">int</span> len)</span></span>;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">print_hello</span><span class="hljs-params">()</span></span>;<br><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure><p>my_print.c æ–‡ä»¶å†…å®¹å¦‚ä¸‹</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;my_print.h&quot;</span></span><br>  <br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">print_array_int</span><span class="hljs-params">(<span class="hljs-type">int</span>* array, <span class="hljs-type">int</span> len)</span></span><br><span class="hljs-function"></span>&#123;   <br>    <span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; <br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;array: &quot;</span>);<br>    <span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>; i &lt; len; i++)<br>    &#123;   <br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d &quot;</span>, array[i]);<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\n&quot;</span>);<br>&#125;<br> <br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">print_array_char</span><span class="hljs-params">(<span class="hljs-type">char</span>* array, <span class="hljs-type">int</span> len)</span></span><br><span class="hljs-function"></span>&#123;<br>  i = <span class="hljs-number">0</span>;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;array: &quot;</span>);<br>    <span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>; i &lt; len; i++)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%c &quot;</span>, array[i]);<br>    &#125;<br>     <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\n&quot;</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">print_array_string</span><span class="hljs-params">(<span class="hljs-type">char</span>* array[], <span class="hljs-type">int</span> len)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-type">int</span> i = <span class="hljs-number">0</span>;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;array: &quot;</span>);<br>    <span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>; i &lt; len; i++)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s &quot;</span>, array[i]);<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\n&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>main.c æ–‡ä»¶å†…å®¹å¦‚ä¸‹</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br> <br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;my_print.h&quot;</span></span><br> <br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-type">int</span> a1[<span class="hljs-number">10</span>];<br>    <span class="hljs-type">int</span> i = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++)<br>    &#123;<br>       a1[i] = i + <span class="hljs-number">1</span>;<br>    &#125;<br>    <span class="hljs-built_in">print_array_int</span>(a1, <span class="hljs-number">10</span>);<br>    <span class="hljs-built_in">print_hello</span>();<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>print_hello.c æ–‡ä»¶å†…å®¹å¦‚ä¸‹</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;my_print.h&quot;</span></span><br> <br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">print_hello</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;hello Linux ...\n&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="1-é™æ€åº“çš„åˆ¶ä½œ"><a href="#1-é™æ€åº“çš„åˆ¶ä½œ" class="headerlink" title="1. é™æ€åº“çš„åˆ¶ä½œ"></a>1. é™æ€åº“çš„åˆ¶ä½œ</h2><p>â‘  é¦–å…ˆæŠŠæ‰€æœ‰ .c æ–‡ä»¶ç¼–è¯‘ä¸º .o æ–‡ä»¶</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css">gcc -c *<span class="hljs-selector-class">.c</span> -<span class="hljs-selector-tag">I</span> ../<span class="hljs-selector-tag">header</span>/<br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/mengchao666/picture/main/blog458378-20231222100406469-1794039349.png"></p><p>ä¸€å®šè¦ä» .o æ–‡ä»¶å»ç”Ÿæˆ .a æ–‡ä»¶ï¼Œå¦åˆ™å³ä½¿ä½ ç”Ÿæˆäº†åº“ï¼Œåœ¨ä½¿ç”¨æ—¶ä¹Ÿå¯èƒ½å‡ºç°æœªçŸ¥çš„é”™è¯¯ã€‚<br />â‘¡ å°† .o æ–‡ä»¶æ‰“åŒ…ä¸º .a æ–‡ä»¶<br />è¿™ä¸€æ­¥éœ€è¦ä½¿ç”¨ ar å·¥å…·æ¥å®Œæˆã€‚ar å·¥å…·æ˜¯ç”¨æ¥åˆ›å»º, ä¿®æ”¹å’Œæå–æ¡£æ¡ˆçš„å·¥å…·ï¼Œar æ˜¯ archive çš„ç¼©å†™ã€‚å½’æ¡£æ˜¯æŒ‡å°†å¤šä¸ªæ–‡ä»¶ï¼ˆæˆ–ä¸€ä¸ªæ–‡ä»¶ï¼‰æ”¾åˆ°å•ä¸ªæ–‡ä»¶ä¸­ï¼Œä¸è¿›è¡Œå…¶ä»–é¢å¤–çš„æ“ä½œã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå½’æ¡£å¹¶ä¸ç­‰åŒäºå‹ç¼©ï¼Œå‹ç¼©ä¼šä½¿æ–‡ä»¶çš„å¤§å°å‡å°ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs undefined">ar rcs libmprint.a *.o<br></code></pre></td></tr></table></figure><ul><li>å‚æ•° r ï¼šåœ¨åº“ä¸­æ’å…¥æ¨¡å—ï¼ˆæ›¿æ¢ï¼‰ã€‚å½“æ’å…¥çš„æ¨¡å—åå·²ç»åœ¨åº“ä¸­å­˜åœ¨ï¼Œåˆ™æ›¿æ¢åŒåçš„æ¨¡å—ã€‚å¦‚æœè‹¥å¹²æ¨¡å—ä¸­æœ‰ä¸€ä¸ªæ¨¡å—åœ¨åº“ä¸­ä¸å­˜åœ¨ï¼Œar æ˜¾ç¤ºä¸€ä¸ªé”™è¯¯æ¶ˆæ¯ï¼Œå¹¶ä¸æ›¿æ¢å…¶ä»–åŒåæ¨¡å—ã€‚é»˜è®¤çš„æƒ…å†µä¸‹ï¼Œæ–°çš„æˆå‘˜å¢åŠ åœ¨åº“çš„ç»“å°¾å¤„ï¼Œå¯ä»¥ä½¿ç”¨å…¶ä»–ä»»é€‰é¡¹æ¥æ”¹å˜å¢åŠ çš„ä½ç½®ã€‚</li><li>å‚æ•° c ï¼šåˆ›å»ºä¸€ä¸ªåº“ã€‚ä¸ç®¡åº“æ˜¯å¦å­˜åœ¨ï¼Œéƒ½å°†åˆ›å»ºã€‚</li><li>å‚æ•° s ï¼šåˆ›å»ºç›®æ ‡æ–‡ä»¶ç´¢å¼•ï¼Œè¿™åœ¨åˆ›å»ºè¾ƒå¤§çš„åº“æ—¶èƒ½åŠ å¿«æ—¶é—´ã€‚å¦‚æœä¸éœ€è¦åˆ›å»ºç´¢å¼•ï¼Œå¯æ”¹æˆå¤§å†™ S å‚æ•°ã€‚å¦‚æœ .a æ–‡ä»¶ç¼ºå°‘ç´¢å¼•ï¼Œå¯ä»¥ä½¿ç”¨ ranlib å‘½ä»¤æ·»åŠ ï¼‰ã€‚</li></ul><p>ä¸€èˆ¬æˆ‘ä»¬å‘½ä»¤é™æ€åº“çš„æ—¶å€™æ˜¯è¿™æ ·çš„ï¼Œå‰é¢æ˜¯ lib ä¸­é—´åŠ ä¸Šæˆ‘ä»¬è‡ªå·±ç»™é™æ€åº“æ–‡ä»¶çš„åç§°ï¼Œåé¢åŠ åç¼€ .a ï¼Œä¹Ÿå°±æ˜¯ libxxx.a ï¼Œå®é™…ä¸Šï¼Œ xxx æ‰æ˜¯é™æ€åº“æ–‡ä»¶çš„åç§°ã€‚</p><p><img src="https://raw.githubusercontent.com/mengchao666/picture/main/blog458378-20231222100406102-983046895.png"></p><p>å¯ä»¥æŸ¥çœ‹ä¸€ä¸‹ç”Ÿæˆçš„ libmprint.a çš„å†…å®¹ï¼Œä¸€å †ä¹±ç </p><p><img src="https://raw.githubusercontent.com/mengchao666/picture/main/blog458378-20231222100400726-123184020.png"></p><p>æˆ‘ä»¬å¯ä»¥ç”¨ nm å‘½ä»¤æŸ¥çœ‹åº“æ–‡ä»¶çš„ä¿¡æ¯ï¼Œå¯ä»¥çœ‹åˆ°å®ƒæ˜¯ç”± my_print.o å’Œ print_hello.o ç”Ÿæˆçš„ã€‚</p><p><img src="https://raw.githubusercontent.com/mengchao666/picture/main/blog458378-20231222100400331-1423504129.png"></p><h2 id="2-é™æ€åº“çš„ä½¿ç”¨"><a href="#2-é™æ€åº“çš„ä½¿ç”¨" class="headerlink" title="2. é™æ€åº“çš„ä½¿ç”¨"></a>2. é™æ€åº“çš„ä½¿ç”¨</h2><p>é™æ€åº“çš„ä½¿ç”¨æ–¹æ³•</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css">gcc <span class="hljs-selector-tag">main</span><span class="hljs-selector-class">.c</span> -o exe -lmyprint -L ../lib/ -<span class="hljs-selector-tag">I</span> ../<span class="hljs-selector-tag">header</span>/<br></code></pre></td></tr></table></figure><p>é¦–å…ˆå¯¹ä¸Šé¢çš„å‘½ä»¤è¿›è¡Œåˆ†è§£ä¸€ä¸‹ï¼Œ-lmyprint ç”¨äºæŒ‡å®šé“¾æ¥åº“çš„åå­—ï¼Œæˆ‘ä»¬ä¸Šé¢ç”Ÿæˆäº†ä¸€ä¸ªåä¸º libmprint.a çš„é™æ€åº“ï¼ŒæŠŠå‰ç¼€åç¼€å»æ‰ç•™ä¸‹ä¸­é—´çš„åå­—å³å¯ï¼›-L â€¦&#x2F;lib&#x2F; æŒ‡å®šé™æ€åº“çš„æœç´¢ç›®å½•ï¼Œä¸æŒ‡å®šçš„ä¼šï¼Œç¼–è¯‘å™¨åªä¼šå»é»˜è®¤çš„é“¾æ¥åº“æœç´¢è·¯å¾„å¯»æ‰¾ï¼›-I â€¦&#x2F;header&#x2F; è¿™ä¸ªå°±æ¯”è¾ƒç†Ÿæ‚‰äº†ï¼ŒæŒ‡å®šå¤´æ–‡ä»¶çš„è·¯å¾„ã€‚</p><p><img src="https://raw.githubusercontent.com/mengchao666/picture/main/blog20241125000251.png"></p><p>æˆ‘ä»¬å†å‘å¸ƒçš„æ—¶å€™ï¼Œåªéœ€è¦æŠŠ header å’Œ lib å‘å¸ƒç»™åˆ«äººå³å¯</p><p><img src="https://raw.githubusercontent.com/mengchao666/picture/main/blog458378-20231222100359610-349123771.png"></p><h1 id="ä¸‰ã€è‡ªå·±åŠ¨æ‰‹åˆ¶ä½œåŠ¨æ€é“¾æ¥åº“"><a href="#ä¸‰ã€è‡ªå·±åŠ¨æ‰‹åˆ¶ä½œåŠ¨æ€é“¾æ¥åº“" class="headerlink" title="ä¸‰ã€è‡ªå·±åŠ¨æ‰‹åˆ¶ä½œåŠ¨æ€é“¾æ¥åº“"></a>ä¸‰ã€è‡ªå·±åŠ¨æ‰‹åˆ¶ä½œåŠ¨æ€é“¾æ¥åº“</h1><h2 id="1-åŠ¨æ€åº“çš„åˆ¶ä½œ"><a href="#1-åŠ¨æ€åº“çš„åˆ¶ä½œ" class="headerlink" title="1. åŠ¨æ€åº“çš„åˆ¶ä½œ"></a>1. åŠ¨æ€åº“çš„åˆ¶ä½œ</h2><p>â‘  ç¼–è¯‘ç”Ÿæˆä¸ä½ç½®æ— å…³çš„ .o æ–‡ä»¶<br />åŠ¨æ€å…±äº«åº“æ˜¯åœ¨è¿è¡Œçš„æ—¶å€™æ‰åŠ è½½çš„ï¼Œå®ƒåŠ è½½åˆ°å†…å­˜çš„å…±äº«åº“æ®µï¼Œç”¨å®Œåå°±é‡Šæ”¾ï¼Œæ‰€ä»¥è¦ç¼–è¯‘ä¸ºä¸ä½ç½®æ— å…³çš„ã€‚è¿™é‡Œè¦ç”¨åˆ°GCC çš„ -fPIC é€‰é¡¹å‚æ•°ï¼Œè¯¥é€‰é¡¹è¡¨ç¤ºç¼–è¯‘ä¸ºä½ç½®ç‹¬ç«‹çš„ä»£ç ï¼Œå¦‚æœä¸ç”¨è¿™ä¸ªé€‰é¡¹çš„è¯ç¼–è¯‘åçš„ä»£ç æ˜¯ä½ç½®ç›¸å…³çš„ï¼Œæ‰€ä»¥åŠ¨æ€è½½å…¥çš„æ—¶å€™ä¼šé€šè¿‡ä»£ç æ‹·è´çš„æ–¹å¼æ¥æ»¡è¶³ä¸åŒè¿›ç¨‹çš„éœ€è¦ï¼Œè€Œä¸èƒ½è¾¾åˆ°çœŸæ­£ä»£ç æ®µå…±äº«çš„ç›®çš„ã€‚åœ¨é™æ€é“¾æ¥åº“ä¸­ï¼Œå¯æ‰§è¡Œæ–‡ä»¶åœ¨é“¾æ¥æ—¶å°±çŸ¥é“æ¯ä¸€è¡Œä»£ç ã€æ¯ä¸€ä¸ªå˜é‡ä¼šè¢«æ”¾åˆ°çº¿æ€§åœ°å€ç©ºé—´çš„ä»€ä¹ˆä½ç½®ï¼Œå› æ­¤è¿™äº›åœ°å€å¯ä»¥éƒ½ä½œä¸ºå¸¸æ•°å†™åˆ°ä»£ç é‡Œé¢ã€‚å¯¹äºåŠ¨æ€åº“ï¼Œåªæœ‰åŠ è½½çš„æ—¶å€™æ‰çŸ¥é“ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒåŠ¨æ€é“¾æ¥åº“è¦ç¼–è¯‘ä¸ºä¸ä½ç½®æ— å…³çš„ä»£ç ï¼Œè¿™æ ·åªæœ‰åœ¨è¿è¡Œæ—¶æ‰ç›´åˆ°ä»£ç çš„ä½ç½®ã€‚è€Œé™æ€åº“æ˜¯åœ¨ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶ä¹‹å‰ï¼Œå°±ç›´æ¥æŠŠä»£ç åŠ è½½åˆ°å†…å­˜çš„ä»£ç æ®µäº†ï¼Œä»£ç çš„ä½ç½®ç­‰ä¿¡æ¯ä¹Ÿå°±å·²ç»çŸ¥é“äº†ï¼Œæ‰€ä»¥ä¸éœ€è¦ç”Ÿæˆä¸ä½ç½®æ— å…³çš„ä»£ç ã€‚</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css">gcc -fPIC -c *<span class="hljs-selector-class">.c</span> -<span class="hljs-selector-tag">I</span> ../<span class="hljs-selector-tag">header</span>/<br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/mengchao666/picture/main/blog458378-20231222100359252-1811276820.png"></p><p>â‘¡ å°† .o æ–‡ä»¶æ‰“åŒ…<br />è¿™é‡Œè¦ç”¨åˆ° GCC çš„ -shared é€‰é¡¹ï¼Œè¯¥é€‰é¡¹æŒ‡å®šç”ŸæˆåŠ¨æ€è¿æ¥åº“ï¼ˆè®©è¿æ¥å™¨ç”ŸæˆTç±»å‹çš„å¯¼å‡ºç¬¦å·è¡¨ï¼Œæœ‰æ—¶å€™ä¹Ÿç”Ÿæˆå¼±è¿æ¥Wç±»å‹çš„å¯¼å‡ºç¬¦å·ï¼‰ï¼Œå¦‚æœä¸ç”¨è¯¥æ ‡å¿—çš„è¯å¤–éƒ¨ç¨‹åºå°†æ— æ³•è¿æ¥ã€‚<br />å¯ä»¥åœ¨åŠ¨æ€åº“æ–‡ä»¶ååé¢åŠ ç‰ˆæœ¬å· libxxx.so.ä¸»ç‰ˆæœ¬å·.å‰¯ç‰ˆæœ¬å· ï¼Œæ¯”å¦‚ libmdprint.so.1.1 è¡¨ç¤ºæˆ‘è¿™æ˜¯ 1.1 ç‰ˆæœ¬çš„åŠ¨æ€åº“ï¼Œæ–‡ä»¶åç¼€åé¢çš„æ•°å­—å°±æ˜¯ç‰ˆæœ¬å·çš„æ„æ€ã€‚</p><figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs vbnet">gcc -<span class="hljs-keyword">shared</span> *.o -o libmdrint.so<br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/mengchao666/picture/main/blog458378-20231222100358934-453919108.png"></p><h2 id="2-åŠ¨æ€åº“çš„ä½¿ç”¨"><a href="#2-åŠ¨æ€åº“çš„ä½¿ç”¨" class="headerlink" title="2. åŠ¨æ€åº“çš„ä½¿ç”¨"></a>2. åŠ¨æ€åº“çš„ä½¿ç”¨</h2><h3 id="ï¼ˆ1ï¼‰åŠ è½½åŠ¨æ€åº“"><a href="#ï¼ˆ1ï¼‰åŠ è½½åŠ¨æ€åº“" class="headerlink" title="ï¼ˆ1ï¼‰åŠ è½½åŠ¨æ€åº“"></a>ï¼ˆ1ï¼‰åŠ è½½åŠ¨æ€åº“</h3><p>ä½¿ç”¨åŠ¨æ€åº“çš„å‘½ä»¤å’Œä½¿ç”¨é™æ€åº“çš„å‘½ä»¤ä¸€æ ·</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css">gcc <span class="hljs-selector-tag">main</span><span class="hljs-selector-class">.c</span> -o exe -lmdrint -L ../lib/ -<span class="hljs-selector-tag">I</span> ../<span class="hljs-selector-tag">header</span>/<br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/mengchao666/picture/main/blog458378-20231222100358477-960135349.png"></p><h3 id="ï¼ˆ2ï¼‰â€œåŠ è½½å…±äº«åº“å‡ºé”™â€çš„è§£å†³æ–¹æ³•"><a href="#ï¼ˆ2ï¼‰â€œåŠ è½½å…±äº«åº“å‡ºé”™â€çš„è§£å†³æ–¹æ³•" class="headerlink" title="ï¼ˆ2ï¼‰â€œåŠ è½½å…±äº«åº“å‡ºé”™â€çš„è§£å†³æ–¹æ³•"></a>ï¼ˆ2ï¼‰â€œåŠ è½½å…±äº«åº“å‡ºé”™â€çš„è§£å†³æ–¹æ³•</h3><p>è¿™ä¸ªæ˜¯æ—¶å€™ï¼Œè™½ç„¶æˆ‘ä»¬å·²ç»ç”Ÿæˆäº†å¯æ‰§è¡Œæ–‡ä»¶ï¼Œä½†æ˜¯å½“æˆ‘ä»¬è¿è¡Œå¯æ‰§è¡Œæ–‡ä»¶çš„æ—¶å€™ï¼Œå¯èƒ½ä¼šå‡ºç°è¿™æ ·çš„é”™è¯¯</p><p><img src="https://raw.githubusercontent.com/mengchao666/picture/main/blog458378-20231222100358144-366040362.png"></p><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡å‘½ä»¤ ldd æ¥æŸ¥çœ‹ä¸€ä¸‹å¯æ‰§è¡Œæ–‡ä»¶çš„é“¾æ¥æƒ…å†µ</p><p><img src="https://raw.githubusercontent.com/mengchao666/picture/main/blog458378-20231222100357744-493835779.png"></p><p>åœ¨æˆ‘ä»¬è‡ªå·±å¼•å…¥çš„åº“ libmdrint.so ä¸€æ æ˜¾ç¤º â€œnot foundâ€ ï¼Œåœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬è‡ªå·±å¼•å…¥çš„åŠ¨æ€åº“æ˜¯æ— æ³•ä½¿ç”¨çš„ï¼Œéœ€è¦è¿›è¡Œä¸€äº›é…ç½®ã€‚è¿™é‡Œæä¾›ä»¥ä¸‹å‡ ç§è§£å†³æ–¹æ³•ã€‚</p><h4 id="â‘ -åœ¨ç³»ç»Ÿåº“è·¯å¾„ä¸‹å»ºç«‹è½¯é“¾æ¥"><a href="#â‘ -åœ¨ç³»ç»Ÿåº“è·¯å¾„ä¸‹å»ºç«‹è½¯é“¾æ¥" class="headerlink" title="â‘  åœ¨ç³»ç»Ÿåº“è·¯å¾„ä¸‹å»ºç«‹è½¯é“¾æ¥"></a>â‘  åœ¨ç³»ç»Ÿåº“è·¯å¾„ä¸‹å»ºç«‹è½¯é“¾æ¥</h4><p>å‰é¢æˆ‘ä»¬å·²ç»ä»‹ç»äº†ï¼ŒGCC ä¼šé»˜è®¤å»ç³»ç»Ÿåº“è·¯å¾„ä¸‹æœç´¢åº“æ–‡ä»¶ï¼Œæ‰€ä»¥åªè¦æˆ‘ä»¬æŠŠè‡ªå·±çš„åº“æ–‡ä»¶æ”¾åˆ°è¿™ä¸ªç›®å½•ä¸‹å°±å¯ä»¥äº†ï¼Œç³»ç»Ÿåº“çš„è·¯å¾„æ˜¯ &#x2F;usr&#x2F;lib æˆ– &#x2F;lib ã€‚ä½†æ˜¯æˆ‘ä»¬å®é™…æ“ä½œçš„æ—¶å€™ï¼Œå¯èƒ½æ— æ³•æŠŠæ–‡ä»¶æ‹·è´åˆ°è¿™ä¸¤ä¸ªè·¯å¾„ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ç³»ç»Ÿåº“è·¯å¾„ä¸‹å»ºç«‹ä¸€ä¸ªè½¯é“¾æ¥æ¥æŒ‡å‘æˆ‘ä»¬çš„åº“æ–‡ä»¶ï¼ˆè½¯é“¾æ¥ç›¸å…³çŸ¥è¯†è¯·å‚è€ƒæœ¬äºº Linux ä¸“æ æ–‡ç« ã€Šã€Linuxç‹è€…ä¹‹è·¯åŸºç¡€ç¯‡ï¼šåŸºæœ¬å‘½ä»¤ä¸åŸºç¡€çŸ¥è¯†ã€‘Linuxå¸¸ç”¨shellå‘½ä»¤ï¼ˆåŠç›¸å…³çŸ¥è¯†ï¼‰è¯¦è§£ä¸ç”¨æ³•æ¼”ç¤ºã€‹ï¼‰</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">sudo</span> <span class="hljs-built_in">ln</span> -s /home/qq/dm/dm_lib/lib/libmdrint.so /usr/lib/libmdrint.so<br></code></pre></td></tr></table></figure><p>è¿™é‡Œç¬¬ä¸€ä¸ªè·¯å¾„ä¹Ÿå°±æ˜¯æˆ‘ä»¬è‡ªå·±çš„åŠ¨æ€åº“æ–‡ä»¶æ‰€åœ¨ç›®å½•ï¼Œä¸€å®šè¦ç”¨ç»å¯¹è·¯å¾„ï¼ˆå¦‚æœä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼Œä¼šæ‰¾ä¸åˆ°è¯¥è·¯å¾„ï¼‰ï¼Œç¬¬äºŒä¸ªè·¯å¾„æ˜¯ç³»ç»Ÿåº“çš„è·¯å¾„ã€‚</p><h4 id="â‘¡-é…ç½®ç¯å¢ƒå˜é‡"><a href="#â‘¡-é…ç½®ç¯å¢ƒå˜é‡" class="headerlink" title="â‘¡ é…ç½®ç¯å¢ƒå˜é‡"></a>â‘¡ é…ç½®ç¯å¢ƒå˜é‡</h4><p>å®é™…ä¸Šï¼Œ ld é“¾æ¥å™¨åœ¨å¯»æ‰¾åº“è·¯å¾„çš„æ—¶å€™ï¼Œéƒ½æ˜¯é€šè¿‡ä¸€ä¸ªç¯å¢ƒå˜é‡ LD_LIBRARY_PATH æ¥å¯»æ‰¾çš„ï¼Œæˆ‘ä»¬å¯ä»¥æ‰“å°çœ‹ä¸€ä¸‹è¿™ä¸ªç¯å¢ƒå˜é‡</p><p><img src="https://raw.githubusercontent.com/mengchao666/picture/main/blog458378-20231222100357370-1446409994.png"></p><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ export å‘½ä»¤æ¥ç»™ç¯å¢ƒå˜é‡å¢åŠ ä¸€ä¸ªè·¯å¾„ï¼Œåªéœ€è¦æŠŠè‡ªå·±çš„è·¯å¾„åŠ è¿›å»å³å¯ï¼Œå‘½ä»¤å¦‚ä¸‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">export</span> LD_LIBRARY_PATH=/home/qq/dm/dm_lib/lib/:<span class="hljs-variable">$LD_LIBRARY_PATH</span><br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬çŸ¥é“åœ¨ shell ä¸‹ç›´æ¥æŠŠç»å¯¹è·¯å¾„åŠ åˆ°ç¯å¢ƒå˜é‡ä¸­ï¼Œåªæ˜¯ä¸€ç§ä¸´æ—¶çš„ç¯å¢ƒå˜é‡ï¼Œå½“å…³æœºå†æ¬¡å¼€æœºçš„æ—¶å€™ï¼Œå°±ä¼šå¤±æ•ˆï¼Œå¦‚æœæƒ³è¦æ°¸ä¹…æœ‰æ•ˆï¼Œå¯ä»¥ä¿®æ”¹é…ç½®æ–‡ä»¶ã€‚æˆ‘ä»¬å¯ä»¥æŠŠä¸Šé¢è¿™æ¡å‘½ä»¤æ”¾åˆ° .bashrc æ–‡ä»¶ä¸­ã€‚<br />åœ¨æˆ‘çš„ Linux ä¸“æ æ–‡ç« ä¸­ï¼Œå·²ç»ä¸åªä¸€æ¬¡æåˆ° .bashrc è¿™ä¸ªé…ç½®æ–‡ä»¶äº†ï¼Œå…¶å® Linux æ¯æ¬¡å¼€æœºéƒ½ä¼šæ‰§è¡Œè¿™ä¸ªé…ç½®æ–‡ä»¶ï¼Œæˆ‘ä»¬å®ç°ç¯å¢ƒå˜é‡æ°¸ä¹…æœ‰æ•ˆçš„åŸç†å°±æ˜¯ï¼ŒLinux æ¯æ¬¡å¼€æœºéƒ½ä¼šæ‰§è¡Œ .bashrc é…ç½®æ–‡ä»¶ï¼Œè€Œé…ç½®æ–‡ä»¶ä¸­åŒ…å«è®¾ç½®ç¯å¢ƒå˜é‡çš„å‘½ä»¤ï¼Œæ‰€ä»¥æ¯æ¬¡å¼€æœºéƒ½ä¼šé…ä¸€ä¸‹ç¯å¢ƒå˜é‡ï¼Œè¿™æ ·å°±è¾¾åˆ°äº†ç¯å¢ƒå˜é‡æ°¸ä¹…æœ‰æ•ˆçš„ç›®çš„ã€‚.bashrc é…ç½®æ–‡ä»¶åœ¨å®¶ç›®å½•ä¸‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim ~/.bashrc<br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/mengchao666/picture/main/blog458378-20231222100351951-1293865682.png"></p><h4 id="â‘¢-ä¿®æ”¹-ld-so-åŠ è½½å™¨çš„é…ç½®æ–‡ä»¶-ld-so-conf"><a href="#â‘¢-ä¿®æ”¹-ld-so-åŠ è½½å™¨çš„é…ç½®æ–‡ä»¶-ld-so-conf" class="headerlink" title="â‘¢ ä¿®æ”¹ ld.so åŠ è½½å™¨çš„é…ç½®æ–‡ä»¶ ld.so.conf"></a>â‘¢ ä¿®æ”¹ ld.so åŠ è½½å™¨çš„é…ç½®æ–‡ä»¶ ld.so.conf</h4><p>è¿™é‡Œå…ˆä»‹ç»å‡ ä¸ªæ¦‚å¿µï¼š</p><ul><li>ldé“¾æ¥å™¨ ï¼šgcc å¯ä»¥åœ¨ç¼–è¯‘å‘¨æœŸä¼ é€’å‚æ•°ï¼ŒæŒ‡å®šéœ€è¦é“¾æ¥çš„åº“æ–‡ä»¶ï¼Œç”Ÿå‘½å‘¨æœŸæ˜¯åœ¨ compile-timeã€‚</li><li>ld.soåŠ¨æ€é“¾æ¥å™¨&#x2F;åŠ è½½å™¨ï¼Œç¨‹åºè¿è¡Œçš„æ—¶å€™ä¼šæ ¹æ®æŒ‡å®šçš„è·¯å¾„å»åŠ è½½æŒ‡å®šçš„åº“ï¼Œç”Ÿå‘½å‘¨æœŸæ˜¯åœ¨ run-timeã€‚</li><li>ld.soåŠ è½½å™¨åŠé…ç½®æ–‡ä»¶ld.so.confï¼šæŒ‡å®šåŠ¨æ€é“¾æ¥åº“çš„æœç´¢è·¯å¾„ï¼ˆä¹Ÿå¯ä»¥é€šè¿‡é…ç½®ç¯å¢ƒå˜é‡$LD_LIBRARY_PATH æ¥æŒ‡å®šç¨‹åºè¿è¡Œæ—¶çš„åŠ¨æ€åº“.soæ–‡ä»¶çš„æœç´¢è·¯å¾„ï¼‰ã€‚ä½¿ç”¨ ldconfig å°±å¯ä»¥å°† ld.so.conf ä¸­çš„æŒ‡å®šç›®å½•çš„åº“æ–‡ä»¶åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œå¹¶è®°å½•åœ¨&#x2F;etc&#x2F;ld.so.cacheæ–‡ä»¶ä¸­ã€‚é…ç½®æ–‡ä»¶ &#x2F;etc&#x2F;ld.so.conf è®°å½•äº†ç¼–è¯‘æ—¶ä½¿ç”¨çš„åŠ¨æ€é“¾æ¥åº“çš„è·¯å¾„ï¼Œåœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œç¼–è¯‘å™¨åªä¼šä½¿ç”¨ &#x2F;lib å’Œ &#x2F;usr&#x2F;lib è¿™ä¸¤ä¸ªç›®å½•ä¸‹çš„åº“æ–‡ä»¶ï¼Œé€šè¿‡è¿™ä¸ªé…ç½®æ–‡ä»¶å¯ä»¥å¢åŠ æˆ‘ä»¬è‡ªå·±çš„åŠ¨æ€åº“æ–‡ä»¶æœç´¢è·¯å¾„ã€‚</li></ul><p>ä½¿ç”¨ vim ç¼–è¾‘å™¨æ‰“å¼€é…ç½®æ–‡ä»¶ï¼ŒæŠŠè·¯å¾„æ”¾è¿›å»</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">sudo</span> vim /etc/ld.so.conf<br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/mengchao666/picture/main/blog458378-20231222100351591-1560610303.png"></p><p>æ”¾å…¥è·¯å¾„ä¹‹åï¼Œè¿˜è¦åœ¨ shell ä¸‹æ‰§è¡Œä¸€æ¡å‘½ä»¤ï¼Œä½¿åˆšæ‰çš„é…ç½®ç”Ÿæ•ˆ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs undefined">sudo ldconfig -v<br></code></pre></td></tr></table></figure><p>ä¸ç®¡ä½¿ç”¨ä¸Šé¢ä¸‰ç§æ–¹æ³•çš„å“ªç§ï¼Œéƒ½å¯ä»¥ä½¿åŠ¨æ€åº“æ­£å¸¸åŠ è½½åˆ°å¯æ‰§è¡Œæ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬å†æ¬¡ä½¿ç”¨ ldd å‘½ä»¤æŸ¥çœ‹ exe æ–‡ä»¶ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬çš„åŠ¨æ€åº“ libmdrint.so åé¢ç”±åŸæ¥çš„ â€œnot foundâ€ å˜æˆäº†ä¸€ä¸ªè·¯å¾„ï¼Œè¿™è¯´æ˜åŠ è½½å™¨ç°åœ¨å¯ä»¥æ‰¾åˆ°åŠ¨æ€åº“çš„è·¯å¾„äº†ï¼Œå¯æ‰§è¡Œæ–‡ä»¶ exe ä¹Ÿå°±å¯ä»¥è¿è¡Œäº†ã€‚</p><p><img src="https://raw.githubusercontent.com/mengchao666/picture/main/blog458378-20231222100351053-1224186757.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;ä¸€ã€ä»€ä¹ˆæ˜¯é“¾æ¥åº“&quot;&gt;&lt;a href=&quot;#ä¸€ã€ä»€ä¹ˆæ˜¯é“¾æ¥åº“&quot; class=&quot;headerlink&quot; title=&quot;ä¸€ã€ä»€ä¹ˆæ˜¯é“¾æ¥åº“&quot;&gt;&lt;/a&gt;ä¸€ã€ä»€ä¹ˆæ˜¯é“¾æ¥åº“&lt;/h1&gt;&lt;p&gt;æœ‰æ—¶å€™æˆ‘ä»¬å¯¹å¤–æä¾›åŠŸèƒ½çš„æ—¶å€™ï¼Œå¯èƒ½ä¸å¸Œæœ›å¯¹æ–¹çœ‹åˆ°æºç ï¼Œæˆ‘ä»¬å°±å¯ä»¥åˆ¶ä½œæˆåº“æ–‡ä»¶ï¼ŒæŠŠåº“æ–‡ä»¶å’Œå¤´æ–‡</summary>
      
    
    
    
    <category term="Cè¯­è¨€" scheme="http://example.com/categories/C%E8%AF%AD%E8%A8%80/"/>
    
    
    <category term="Cè¯­è¨€" scheme="http://example.com/tags/C%E8%AF%AD%E8%A8%80/"/>
    
  </entry>
  
  <entry>
    <title>é¢„å¤„ç†ã€ç¼–è¯‘ã€æ±‡ç¼–ã€é“¾æ¥</title>
    <link href="http://example.com/posts/%E9%A2%84%E5%A4%84%E7%90%86%E3%80%81%E7%BC%96%E8%AF%91%E3%80%81%E6%B1%87%E7%BC%96%E3%80%81%E9%93%BE%E6%8E%A5.html"/>
    <id>http://example.com/posts/%E9%A2%84%E5%A4%84%E7%90%86%E3%80%81%E7%BC%96%E8%AF%91%E3%80%81%E6%B1%87%E7%BC%96%E3%80%81%E9%93%BE%E6%8E%A5.html</id>
    <published>2024-11-24T15:56:01.000Z</published>
    <updated>2024-11-24T15:56:19.559Z</updated>
    
    <content type="html"><![CDATA[<p>Cè¯­è¨€ç»å…¸çš„ â€œhello world â€ ç¨‹åºï¼Œä¼´éšç€æ¯ä¸ªç¨‹åºå‘˜ä¸€èµ·æ­¥å…¥ç¼–ç¨‹ä¸–ç•Œçš„å¤§é—¨ã€‚ä»ç¼–å†™ã€ç¼–è¯‘åˆ°è¿è¡Œï¼Œçœ‹åˆ°å±å¹•ä¸Šè¾“å‡ºçš„â€œhello world â€ï¼Œé‚£ä¹ˆä½ çŸ¥é“å®ƒéƒ½ç»å†äº†ä»€ä¹ˆå—ï¼Ÿä»Šå¤©æˆ‘ä»¬å°±æ¥èŠèŠè¿™ä¸ªè¯é¢˜ã€‚</p><p>ä¸€ã€ä»hello.cèŠèµ·<br>hello world.c</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;hello,world!\n&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨linuxä¸‹ï¼Œä½¿ç”¨ gcc ç¼–è¯‘hello.cæºæ–‡ä»¶ï¼Œä¼šåœ¨å½“å‰ç›®å½•ä¸‹é»˜è®¤ç”Ÿæˆ a.out å¯æ‰§è¡Œæ–‡ä»¶ï¼Œåœ¨ç»ˆç«¯è¾“å‡ºhelloï¼Œworldï¼ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c">$ gcc hello.c<br>$ ./a.out<br>$ hello,world!<br></code></pre></td></tr></table></figure><p>é¢„ç¼–è¯‘å™¨ã€æ±‡ç¼–å™¨asã€é“¾æ¥å™¨ldï¼Œå®é™…ä¸Šgcc å‘½ä»¤åªæ˜¯å¯¹è¿™äº›ä¸åŒç¨‹åºçš„å°è£…ï¼Œæ ¹æ®ä¸åŒçš„å‚æ•°å»è°ƒç”¨ä¸åŒçš„ç¨‹åºã€‚</p><p>ä» hello.c åˆ°å¯æ‰§è¡Œæ–‡ä»¶çš„å…¨è¿‡ç¨‹ï¼Œå¯åˆ†ä¸º4ä¸ªæ­¥éª¤ï¼š</p><p>1ã€é¢„å¤„ç†<br>gcc -E hello.c -o hello.i å¾—åˆ°é¢„å¤„ç†æ–‡ä»¶ï¼Œå…¶ä¸­ï¼Œ-E è¡¨ç¤ºåªè¿›è¡Œé¢„ç¼–è¯‘ã€‚<br>æºæ–‡ä»¶åœ¨é¢„ç¼–è¯‘é˜¶æ®µä¼šè¢«ç¼–è¯‘å™¨ç”Ÿæˆ.iæ–‡ä»¶ï¼Œä¸»è¦å¤„ç†æºä»£ç æ–‡ä»¶ä¸­ä»¥â€œ#â€å¼€å¤´çš„é¢„ç¼–è¯‘æŒ‡ä»¤ã€‚å¦‚ï¼šå®å®šä¹‰å±•å¼€ï¼Œå°†è¢«åŒ…å«çš„æ–‡ä»¶æ’å…¥åˆ°è¯¥ç¼–è¯‘æŒ‡ä»¤çš„ä½ç½®ç­‰ã€‚</p><p>2ã€ç¼–è¯‘<br>gcc -S hello.i -o hello.s å¾—åˆ°æ±‡ç¼–æ–‡ä»¶ï¼Œå…¶ä¸­ï¼Œ-S è¡¨ç¤ºç”Ÿæˆæ±‡ç¼–æ–‡ä»¶ã€‚<br>ç¼–è¯‘å°±æ˜¯æŠŠé¢„å¤„ç†å®Œçš„æ–‡ä»¶ï¼Œè¿›è¡Œè¯­æ³•åˆ†æã€è¯æ³•åˆ†æã€è¯­ä¹‰åˆ†æåŠä¼˜åŒ–åç”Ÿæˆç›¸åº”çš„æ±‡ç¼–ä»£ç æ–‡ä»¶ï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯æ•´ä¸ªç¨‹åºæ„å»ºçš„æ ¸å¿ƒè¿‡ç¨‹ï¼Œä¹Ÿæ˜¯æœ€å¤æ‚çš„éƒ¨åˆ†ã€‚</p><p>3ã€æ±‡ç¼–<br>as hello.s -o hello.o æˆ–è€… gcc -c hello.s -o hello.oï¼Œå…¶ä¸­ï¼Œ-c è¡¨ç¤ºåªç¼–è¯‘ä¸é“¾æ¥ã€‚<br>å°†æ±‡ç¼–ä»£ç æ–‡ä»¶è½¬å˜æˆæœºå™¨å¯ä»¥æ‰§è¡Œçš„æŒ‡ä»¤æ–‡ä»¶ï¼Œå³ç›®æ ‡æ–‡ä»¶ã€‚ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨ï¼šgcc -c hello.c -o hello.o ç»è¿‡é¢„å¤„ç†ã€ç¼–è¯‘ã€æ±‡ç¼–ç›´æ¥è¾“å‡ºç›®æ ‡æ–‡ä»¶ã€‚<br>ä¸ºä»€ä¹ˆæ±‡ç¼–å™¨ä¸ç›´æ¥ç”Ÿæˆå¯æ‰§è¡Œç¨‹åºï¼Œè€Œæ˜¯ä¸€ä¸ªç›®æ ‡æ–‡ä»¶å‘¢ï¼Ÿä¸ºä»€ä¹ˆè¦é“¾æ¥ï¼Ÿè¿™ä¸ªæˆ‘ä»¬åé¢ä¼šè¯¦ç»†è®¨è®ºã€‚</p><p>4ã€é“¾æ¥<br>éšç€ä»£ç é‡çš„å¢å¤šï¼Œæ‰€æœ‰ä»£ç è‹¥æ˜¯éƒ½æ”¾åœ¨åŒä¸€ä¸ªæ–‡ä»¶é‡Œï¼Œé‚£å°†æ˜¯ä¸€åœºç¾éš¾ã€‚ç°ä»£å¤§å‹è½¯ä»¶ï¼ŒåŠ¨è¾„ç”±æˆåƒä¸Šä¸‡çš„æ¨¡å—ç»„æˆï¼Œæ¯ä¸ªæ¨¡å—ç›¸äº’ä¾èµ–åˆç›¸äº’ç‹¬ç«‹ã€‚å°†è¿™äº›æ¨¡å—ç»„è£…èµ·æ¥çš„è¿‡ç¨‹å°±æ˜¯é“¾æ¥ã€‚<br>è¿™äº›æ¨¡å—å¦‚ä½•å½¢æˆä¸€ä¸ªå•ä¸€çš„ç¨‹åºå‘¢ï¼Ÿæ— éå°±æ˜¯ä¸¤ç§æ–¹å¼ï¼š1ã€æ¨¡å—é—´çš„å‡½æ•°è°ƒç”¨ï¼›2ã€æ¨¡å—é—´çš„å˜é‡è®¿é—®ã€‚å‡½æ•°è®¿é—®å¿…é¡»çŸ¥é“å‡½æ•°åœ°å€ï¼Œå˜é‡è®¿é—®å¿…é¡»çŸ¥é“å˜é‡åœ°å€ï¼Œæ‰€ä»¥ç»ˆå½’åˆ°åº•å°±æ˜¯ä¸€ç§æ–¹å¼ï¼Œä¸åŒæ¨¡å—é—´ç¬¦å·çš„å¼•ç”¨ã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;Cè¯­è¨€ç»å…¸çš„ â€œhello world â€ ç¨‹åºï¼Œä¼´éšç€æ¯ä¸ªç¨‹åºå‘˜ä¸€èµ·æ­¥å…¥ç¼–ç¨‹ä¸–ç•Œçš„å¤§é—¨ã€‚ä»ç¼–å†™ã€ç¼–è¯‘åˆ°è¿è¡Œï¼Œçœ‹åˆ°å±å¹•ä¸Šè¾“å‡ºçš„â€œhello world â€ï¼Œé‚£ä¹ˆä½ çŸ¥é“å®ƒéƒ½ç»å†äº†ä»€ä¹ˆå—ï¼Ÿä»Šå¤©æˆ‘ä»¬å°±æ¥èŠèŠè¿™ä¸ªè¯é¢˜ã€‚&lt;/p&gt;
&lt;p&gt;ä¸€ã€ä»hello.cèŠèµ·&lt;br&gt;hello wo</summary>
      
    
    
    
    <category term="Cè¯­è¨€" scheme="http://example.com/categories/C%E8%AF%AD%E8%A8%80/"/>
    
    
    <category term="Cè¯­è¨€" scheme="http://example.com/tags/C%E8%AF%AD%E8%A8%80/"/>
    
  </entry>
  
  <entry>
    <title>å†…å­˜ç”³è¯·å‡½æ•°</title>
    <link href="http://example.com/posts/%E5%86%85%E5%AD%98%E7%94%B3%E8%AF%B7%E5%87%BD%E6%95%B0.html"/>
    <id>http://example.com/posts/%E5%86%85%E5%AD%98%E7%94%B3%E8%AF%B7%E5%87%BD%E6%95%B0.html</id>
    <published>2024-11-24T15:55:07.000Z</published>
    <updated>2024-11-24T15:55:29.247Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ä¸€ã€malloc"><a href="#ä¸€ã€malloc" class="headerlink" title="ä¸€ã€malloc"></a>ä¸€ã€malloc</h2><p>å‡½æ•°åŸå‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span>* <span class="hljs-title function_">malloc</span> <span class="hljs-params">(<span class="hljs-type">size_t</span> size)</span>;<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°å‘å†…å­˜ç”³è¯·ä¸€å—è¿ç»­å¯ç”¨çš„ç©ºé—´ï¼Œå¹¶è¿”å›æŒ‡å‘è¿™å—ç©ºé—´çš„æŒ‡é’ˆï¼›</p><p>å¦‚æœå¼€è¾ŸæˆåŠŸï¼Œè¿”å›ä¸€ä¸ªæŒ‡å‘å¼€è¾Ÿçš„ç©ºé—´çš„é¦–åœ°å€çš„æŒ‡é’ˆï¼›</p><p>å¦‚æœå¼€è¾Ÿå¤±è´¥ï¼Œè¿”å›ä¸€ä¸ªNULLæŒ‡é’ˆï¼Œå› æ­¤mallocå‡½æ•°çš„è¿”å›å€¼ï¼Œä¸€å®šè¦åšæ£€æŸ¥ï¼›</p><p>è¿”å›å€¼çš„ç±»å‹æ—¶void*ï¼Œæ‰€ä»¥mallocå‡½æ•°å¹¶ä¸çŸ¥é“å¼€è¾Ÿç©ºé—´çš„ç±»å‹ï¼Œå…·ä½“åœ¨ä½¿ç”¨æ—¶ç”±ä½¿ç”¨è€…è‡ªå·±å†³å®šï¼ˆå¼ºåˆ¶è½¬æ¢ï¼‰ï¼›</p><p>å¦‚æœå‚æ•°sizeä¸º0ï¼Œmallocå‡½æ•°çš„è¡Œä¸ºæ˜¯æ ‡å‡†æœªå®šä¹‰çš„ï¼Œå–å†³äºç¼–è¯‘å™¨ï¼›</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>  <span class="hljs-type">int</span> arr[<span class="hljs-number">10</span>] = &#123; <span class="hljs-number">0</span> &#125;;<br>  <span class="hljs-type">int</span>* p = (<span class="hljs-type">int</span>*)<span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(arr));<span class="hljs-comment">//åŠ¨æ€å†…å­˜å¼€è¾Ÿï¼›</span><br>  <span class="hljs-keyword">if</span> (p == <span class="hljs-literal">NULL</span>) &#123;<br>    perror(<span class="hljs-string">&quot;malloc&quot;</span>);<span class="hljs-comment">//æ˜¯ç©ºæŒ‡é’ˆåˆ™è¾“å‡ºé”™è¯¯ä»£ç ï¼›</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<span class="hljs-comment">//ç»ˆæ­¢ç¨‹åºï¼›</span><br>  &#125;<br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;<br>    *(p + i) = i;<span class="hljs-comment">//èµ‹å€¼ï¼›</span><br>  &#125;<br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d &quot;</span>, *(p + i));<span class="hljs-comment">//è¾“å‡º</span><br>  &#125;<br> <br>  <span class="hljs-comment">//æ²¡æœ‰ä½¿ç”¨ åŠ¨æ€å†…å­˜é‡Šæ”¾å‡½æ•° free ï¼Œæ­¤æ—¶å¦‚æœç¨‹åºç»§ç»­è¿è¡Œï¼Œåˆ™è¢«mallocå‡½æ•°å¼€è¾Ÿçš„ç©ºé—´ä¸ä¼šè¢«å›æ”¶ï¼›</span><br>  <span class="hljs-comment">//ä½†åªè¦ç¨‹åºé€€å‡ºï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å›æ”¶å†…å­˜ç©ºé—´ï¼›</span><br>  <span class="hljs-comment">//æ­£å¸¸æƒ…å†µä¸‹ï¼Œç”±åŠ¨æ€å†…å­˜å¼€è¾Ÿå‡½æ•°æ‰€å¼€è¾Ÿçš„å†…å­˜ç©ºé—´ï¼Œåœ¨ä½¿ç”¨å®Œæˆåå¿…é¡»è¢«é‡Šæ”¾å¹¶é”€æ¯ï¼›</span><br>  <span class="hljs-built_in">free</span>(p);<span class="hljs-comment">//å°†pç©ºé—´ä¸­çš„å€¼é”€æ¯ï¼›</span><br>  p = <span class="hljs-literal">NULL</span>;<span class="hljs-comment">//pä¸å†æŒ‡å‘æœ‰æ•ˆç©ºé—´ï¼›</span><br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="äºŒã€calloc"><a href="#äºŒã€calloc" class="headerlink" title="äºŒã€calloc"></a>äºŒã€calloc</h2><p>å‡½æ•°åŸå‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span>* <span class="hljs-title function_">calloc</span><span class="hljs-params">(<span class="hljs-type">size_t</span> num,<span class="hljs-type">size_t</span> size)</span>;<br></code></pre></td></tr></table></figure><p>å‡½æ•°çš„åŠŸèƒ½æ˜¯ä¸ºnumä¸ªå¤§å°ä¸ºsizeçš„å…ƒç´ å¼€è¾Ÿä¸€å—ç©ºé—´ï¼Œå¹¶å°†ç©ºé—´çš„æ¯ä¸ªå­—èŠ‚åˆå§‹åŒ–ä¸º0ï¼›</p><p> ä¸å‡½æ•°mallocçš„åŒºåˆ«åœ¨äºï¼Œcallocä¼šåœ¨è¿”å›åœ°å€å‰æŠŠç”³è¯·çš„ç©ºé—´çš„æ¯ä¸ªå­—èŠ‚åˆå§‹åŒ–ä¸ºå…¨0ï¼›</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>  <span class="hljs-type">int</span>* p = (<span class="hljs-type">int</span>*)<span class="hljs-built_in">calloc</span>(<span class="hljs-number">10</span>, <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>));<span class="hljs-comment">//åŠ¨æ€å†…å­˜å¼€è¾Ÿï¼›</span><br>  <span class="hljs-keyword">if</span> (p == <span class="hljs-literal">NULL</span>) &#123;<br>    perror(<span class="hljs-string">&quot;calloc&quot;</span>);<span class="hljs-comment">//æ˜¯ç©ºæŒ‡é’ˆåˆ™è¾“å‡ºé”™è¯¯ä»£ç ï¼›</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<span class="hljs-comment">//ç»ˆæ­¢ç¨‹åºï¼›</span><br>  &#125;<br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d &quot;</span>, *(p + i));<span class="hljs-comment">//è¾“å‡ºä¸ºï¼š0 0 0 0 0 0 0 0 0 0ï¼›</span><br>  &#125;<br>  <span class="hljs-built_in">free</span>(p);<span class="hljs-comment">//å°†pç©ºé—´ä¸­çš„å€¼é”€æ¯ï¼›</span><br>  p = <span class="hljs-literal">NULL</span>;<span class="hljs-comment">//pä¸å†æŒ‡å‘æœ‰æ•ˆç©ºé—´ï¼›</span><br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="ä¸‰ã€realloc"><a href="#ä¸‰ã€realloc" class="headerlink" title="ä¸‰ã€realloc"></a>ä¸‰ã€realloc</h2><p>å‡½æ•°åŸå‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span>* <span class="hljs-title function_">realloc</span><span class="hljs-params">(<span class="hljs-type">void</span>* ptr,<span class="hljs-type">size_t</span> size)</span>;<br></code></pre></td></tr></table></figure><p>ptræ˜¯éœ€è¦è°ƒæ•´çš„å†…å­˜åœ°å€ï¼Œsizeæ˜¯è°ƒæ•´ä¹‹åçš„ç©ºé—´å¤§å°ï¼›</p><p>è¿”å›å€¼ä¸ºè°ƒæ•´åçš„å†…å­˜çš„èµ·å§‹åœ°å€ï¼›</p><p>å‡½æ•°åœ¨è°ƒæ•´åŸå†…å­˜ç©ºé—´å¤§å°çš„åŸºç¡€ä¸Šï¼Œè¿˜ä¼šå°†åŸæ¥å†…å­˜ä¸­çš„æ•°æ®ç§»åŠ¨åˆ°æ–°çš„ç©ºé—´ï¼›</p><p>&#x2F;&#x2F;å¯¹äºå†…å­˜ç©ºé—´çš„è°ƒæ•´ï¼Œå­˜åœ¨ä¸¤ç§æƒ…å†µï¼š</p><p>1.åŸæœ‰ç©ºé—´ä¹‹åçš„ç©ºé—´è¶³å¤Ÿæ»¡è¶³æ–°ç©ºé—´çš„å¼€è¾Ÿï¼›</p><p>2.åŸæœ‰ç©ºé—´ä¹‹åæ²¡æœ‰è¶³å¤Ÿå¤§çš„ç©ºé—´æ»¡è¶³æ–°ç©ºé—´çš„å¼€è¾Ÿï¼›</p><p>&#x2F;&#x2F;å‡½æ•°è°ƒæ•´å¤±è´¥çš„æƒ…å†µï¼š</p><p>1.reallocå¤±è´¥çš„æ—¶å€™ï¼Œè¿”å›NULLï¼›</p><p>2.reallocå¤±è´¥çš„æ—¶å€™ï¼ŒåŸæ¥çš„å†…å­˜ä¸æ”¹å˜ï¼Œä¸ä¼šé‡Šæ”¾ä¹Ÿä¸ä¼šç§»åŠ¨ï¼›</p><p>&#x2F;&#x2F;æ³¨æ„ä½¿ç”¨reallocå‡½æ•°æ”¹å˜æˆ–å¼€è¾Ÿç©ºé—´ï¼Œæœ€å¥½ä½¿ç”¨æ–°çš„å˜é‡æ¥æ”¶ï¼Œå†å°†æ–°å˜é‡èµ‹å€¼ç»™æ—§å˜é‡ï¼›åŸå› æ˜¯ä¸ºäº†é¿å…å¼€è¾Ÿç©ºé—´å¤±è´¥è¿”å›ç©ºæŒ‡é’ˆï¼Œå¯¼è‡´çš„æ—§ç©ºé—´å†…å­˜æ³„æ¼(æŒ‡é’ˆè¢«ç½®ç©ºï¼Œæ— æ³•æ‰¾åˆ°æ—§ç©ºé—´)ï¼›</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>  <span class="hljs-type">int</span>* p = (<span class="hljs-type">int</span>*)<span class="hljs-built_in">malloc</span>(<span class="hljs-number">40</span>);<span class="hljs-comment">//å¼€è¾Ÿ40å­—èŠ‚ç©ºé—´èµ‹äºˆpï¼›</span><br>  <span class="hljs-keyword">if</span> (p == <span class="hljs-literal">NULL</span>) &#123;<br>    perror(<span class="hljs-string">&quot;malloc&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>  &#125;<br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;<br>    *(p + i) = i + <span class="hljs-number">1</span>;<br>  &#125;<br>  <span class="hljs-type">int</span>* ptr = <span class="hljs-built_in">realloc</span>(p, <span class="hljs-number">80</span>);<span class="hljs-comment">//æ‰©å®¹ï¼›æ­¤æ—¶ï¼Œå¦‚æœåç»­å†…å­˜ç©ºé—´è¶³å¤Ÿï¼Œåˆ™ç©ºé—´é¦–åœ°å€ä¸ä¼šæ”¹å˜ï¼Œä½†å¦‚æœåç»­å†…å­˜ç©ºé—´ä¸è¶³ï¼Œåˆ™ä¼šå‘ç°ç©ºé—´é¦–åœ°å€æ”¹å˜ï¼Œå³æ–°ç©ºé—´çš„å¼€è¾Ÿï¼›</span><br>  <span class="hljs-keyword">if</span> (ptr != <span class="hljs-literal">NULL</span>)<br>  &#123;<br>    p = ptr;<span class="hljs-comment">//æ‰©å®¹æˆåŠŸåˆ™å°†æ‰©å®¹åçš„ç©ºé—´èµ‹äºˆpï¼›</span><br>    ptr = <span class="hljs-literal">NULL</span>;<span class="hljs-comment">//pträ¸å†æŒ‡å‘æœ‰æ•ˆç©ºé—´ï¼›</span><br>  &#125;<br>  <span class="hljs-keyword">else</span><br>  &#123;<br>    perror(<span class="hljs-string">&quot;realloc&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>  &#125;<br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">10</span>; i &lt; <span class="hljs-number">20</span>; i++)<span class="hljs-comment">//ä¸ºæ‰©å®¹åçš„ç©ºé—´èµ‹å€¼ï¼›</span><br>  &#123;<br>    *(p + i) = i + <span class="hljs-number">1</span>;<br>  &#125;<br>  ptr = <span class="hljs-built_in">realloc</span>(p, <span class="hljs-number">40</span>);<span class="hljs-comment">//ç¼©å®¹ï¼› </span><br>  <span class="hljs-keyword">if</span> (ptr != <span class="hljs-literal">NULL</span>)<br>  &#123;<br>    p = ptr;<span class="hljs-comment">//ç¼©å®¹æˆåŠŸåˆ™å°†æ‰©å®¹åçš„ç©ºé—´èµ‹äºˆpï¼›</span><br>    ptr = <span class="hljs-literal">NULL</span>;<span class="hljs-comment">//å°†ptrç½®ç©ºï¼›</span><br>  &#125;<br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">20</span>; i++)<span class="hljs-comment">//ä¸ºæ‰©å®¹åçš„ç©ºé—´èµ‹å€¼ï¼›</span><br>  &#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d &quot;</span>, p[i]);<br>  &#125;<br>  <span class="hljs-built_in">free</span>(p);<span class="hljs-comment">//å°†pç©ºé—´ä¸­çš„å€¼é”€æ¯ï¼›</span><br>  p = <span class="hljs-literal">NULL</span>;<span class="hljs-comment">//pä¸å†æŒ‡å‘æœ‰æ•ˆç©ºé—´ï¼›</span><br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;ä¸€ã€malloc&quot;&gt;&lt;a href=&quot;#ä¸€ã€malloc&quot; class=&quot;headerlink&quot; title=&quot;ä¸€ã€malloc&quot;&gt;&lt;/a&gt;ä¸€ã€malloc&lt;/h2&gt;&lt;p&gt;å‡½æ•°åŸå‹ï¼š&lt;/p&gt;
&lt;figure class=&quot;highlight c&quot;&gt;&lt;table&gt;&lt;</summary>
      
    
    
    
    <category term="Cè¯­è¨€" scheme="http://example.com/categories/C%E8%AF%AD%E8%A8%80/"/>
    
    
    <category term="Cè¯­è¨€" scheme="http://example.com/tags/C%E8%AF%AD%E8%A8%80/"/>
    
  </entry>
  
  <entry>
    <title>å­—ç¬¦ä¸²å‡½æ•°</title>
    <link href="http://example.com/posts/%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%87%BD%E6%95%B0.html"/>
    <id>http://example.com/posts/%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%87%BD%E6%95%B0.html</id>
    <published>2024-11-24T15:54:08.000Z</published>
    <updated>2024-11-24T15:54:33.785Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ä¸€ã€strlen"><a href="#ä¸€ã€strlen" class="headerlink" title="ä¸€ã€strlen"></a>ä¸€ã€strlen</h2><p>1ã€åŸå‹ï¼š<code>size_t strlen(char const* string);</code><br>2ã€åŠŸèƒ½ï¼šè¿”å›å­—ç¬¦ä¸² string çš„é•¿åº¦ï¼ˆä¸åŒ…å«å­—ç¬¦ä¸²ç»ˆæ­¢ç¬¦NULï¼‰<br>3ã€æ³¨æ„ï¼šsize_tæ˜¯ä¸€ä¸ªæ— ç¬¦å·æ•´æ•°ç±»å‹</p><h2 id="äºŒã€strcpy"><a href="#äºŒã€strcpy" class="headerlink" title="äºŒã€strcpy"></a>äºŒã€strcpy</h2><p>1ã€åŸå‹ï¼š<code>char *strcpy(char *dst, char const *src);</code></p><p>2ã€åŠŸèƒ½ï¼šå°†å‚æ•°srcå­—ç¬¦ä¸²å¤åˆ¶åˆ°dstå‚æ•°ä¸­ã€‚å¦‚æœå‚æ•°srcå’Œdståœ¨å†…å­˜ä¸­å‡ºç°é‡å ï¼Œå…¶ç»“æœæ˜¯æœªå®šä¹‰çš„ã€‚ç”±äºdstå‚æ•°å°†è¿›è¡Œä¿®æ”¹ï¼Œæ‰€ä»¥å®ƒå¿…é¡»æ˜¯ä¸ªå­—ç¬¦æ•°ç»„æˆ–è€…æ˜¯ä¸€ä¸ªæŒ‡å‘åŠ¨æ€åˆ†é…å†…å­˜çš„æ•°ç»„çš„æŒ‡é’ˆï¼Œä¸èƒ½ä½¿ç”¨å­—ç¬¦ä¸²å¸¸é‡ã€‚è¿”å›å‚æ•°dstçš„ä¸€ä»½æ‹·è´ã€‚</p><p>3ã€æ³¨æ„ï¼š</p><p>ç›®æ ‡å‚æ•°dstçš„ä»¥å‰å†…å®¹å°†è¢«è¦†ç›–å¹¶ä¸¢å¤±ã€‚å³ä½¿æ–°çš„å­—ç¬¦ä¸²æ¯”dståŸå…ˆçš„å†…å­˜æ›´çŸ­ï¼Œç”±äºæ–°å­—ç¬¦ä¸²æ˜¯ä»¥NULå­—ç¬¦ç»“å°¾ï¼Œæ‰€ä»¥è€å­—ç¬¦ä¸²æœ€åå‰©ä½™çš„å‡ ä¸ªå­—ç¬¦ä¹Ÿä¼šè¢«æœ‰æ•ˆçš„åˆ é™¤ã€‚å¦‚æœå­—ç¬¦ä¸²æ¯”æ•°ç»„é•¿ï¼Œå¤šä½™çš„å­—ç¬¦ä»è¢«å¤åˆ¶ï¼Œå®ƒä»¬å°†è¦†ç›–åŸå…ˆå­˜å‚¨äºæ•°ç»„åé¢çš„å†…å­˜ç©ºé—´çš„å€¼ã€‚æ‰€ä»¥å¿…é¡»ä¿è¯ç›®æ ‡å­—ç¬¦æ•°ç»„çš„ç©ºé—´è¶³ä»¥å®¹çº³éœ€è¦å¤åˆ¶çš„å­—ç¬¦ä¸²ã€‚</p><h2 id="ä¸‰ã€strncpy"><a href="#ä¸‰ã€strncpy" class="headerlink" title="ä¸‰ã€strncpy"></a>ä¸‰ã€strncpy</h2><p>1ã€åŸå‹ï¼š<code>char *strncpy(char *dst, char const *src, size_t len);</code></p><p>2ã€åŠŸèƒ½ï¼šå’Œstrcpyä¸€æ ·ï¼ŒstrncpyæŠŠæºå­—ç¬¦ä¸²çš„å­—ç¬¦å¤åˆ¶åˆ°ç›®æ ‡æ•°ç»„ã€‚ç„¶è€Œï¼Œå®ƒæ€»æ˜¯ æ­£å¥½å‘dstå†™å…¥lenä¸ªå­—ç¬¦ã€‚å¦‚æœstrlen(src)çš„å€¼å°äºlen, dstæ•°ç»„å°±ç”¨é¢å¤–çš„NULå­—èŠ‚å¡«å……åˆ°lené•¿åº¦ã€‚å¦‚æœstrlen(src)çš„å€¼å¤§äºæˆ–è€…ç­‰äºlen,é‚£ä¹ˆåªæœ‰lenä¸ªå­—ç¬¦è¢«å¤åˆ¶åˆ°dstä¸­ã€‚</p><p>3ã€æ³¨æ„ï¼šstrncpyè°ƒç”¨çš„ç»“æœå¯èƒ½ä¸æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œ<strong>å®ƒçš„ç»“æœå°†ä¸ä¼šä»¥NULå­—ç¬¦ç»“å°¾ï¼Œ</strong>  å› æ­¤å­—ç¬¦ä¸²å¿…é¡»ä»¥NULå­—ç¬¦ç»“å°¾</p><h2 id="å››ã€strcat"><a href="#å››ã€strcat" class="headerlink" title="å››ã€strcat"></a>å››ã€strcat</h2><p>1ã€åŸå‹ï¼š<code>char *strcat(char *dst, char const *src);</code></p><p>2ã€åŠŸèƒ½ï¼šå°†ä¸€ä¸ªå­—ç¬¦ä¸²æ·»åŠ (è¿æ¥)åˆ°å¦ä¸€ä¸ªå­—ç¬¦ä¸²çš„åé¢ã€‚</p><p>3ã€æ³¨æ„ï¼šsrcå’Œdstçš„æ‰€æŒ‡çš„å†…å­˜åŒºåŸŸä¸èƒ½é‡å ï¼Œå¦‚æœå‘ç”Ÿé‡å ï¼Œå…¶ç»“æœæ˜¯æœªå®šä¹‰çš„ã€‚</p><h2 id="äº”ã€strncat"><a href="#äº”ã€strncat" class="headerlink" title="äº”ã€strncat"></a>äº”ã€strncat</h2><p>1ã€åŸå‹ï¼š<code>char *strncat(char *dst, char const *src, size_t len);</code></p><p>2ã€åŠŸèƒ½ï¼šå®ƒä»srcæœ€å¤šå¤åˆ¶ lenä¸ªå­—ç¬¦åˆ°dstä¸­ã€‚ä½†æ˜¯, strncatæ€»æ˜¯åœ¨ç»“æœå­—ç¬¦ä¸²åé¢æ·»åŠ ä¸€ä¸ªNULå­—ç¬¦ã€‚</p><p>3ã€æ³¨æ„ï¼šsrcå’Œdstæ‰€æŒ‡çš„å†…å­˜åŒºåŸŸä¸èƒ½é‡å ï¼Œå¹¶ä¸”dstå¿…é¡»æœ‰è¶³å¤Ÿå¤šçš„ç©ºé—´æ¥å®¹çº³srcçš„å­—ç¬¦ä¸²ã€‚</p><h2 id="å…­ã€strcmp"><a href="#å…­ã€strcmp" class="headerlink" title="å…­ã€strcmp"></a>å…­ã€strcmp</h2><p>1ã€åŸå‹ï¼š<code>int strcmp(char const *s1, char const *s2);</code></p><p>2ã€åŠŸèƒ½ï¼šæ¯”è¾ƒä¸¤ä¸ªå­—ç¬¦ä¸²ã€‚å¦‚æœs1å°äºs2ï¼Œstrcmpå‡½æ•°è¿”å›ä¸€ä¸ªå°äºé›¶çš„å€¼ã€‚å¦‚æœs1å¤§äºs2ï¼Œå‡½æ•°è¿”å›ä¸€ä¸ªå¤§äºé›¶çš„å€¼ã€‚å¦‚æœä¸¤ä¸ªå­—ç¬¦ä¸²ç›¸ç­‰ï¼Œå‡½æ•°å°±è¿”å›é›¶ã€‚</p><p>3ã€æ³¨æ„ï¼šç”±äºstrcmpå¹¶ä¸ä¿®æ”¹å®ƒçš„ä»»ä½•ä¸€ä¸ªå‚æ•°ï¼Œæ‰€ä»¥ä¸å­˜åœ¨æº¢å‡ºå­—ç¬¦æ•°ç»„çš„å±é™©ã€‚ä½†æ˜¯ï¼Œå’Œå…¶ä»–ä¸å—é™åˆ¶çš„å­—ç¬¦ä¸²å‡½æ•°(strcpy, strcat)ä¸€æ ·ï¼Œstrcmpå‡½æ•°çš„å­—ç¬¦ä¸²å‚æ•°ä¹Ÿå¿…é¡»ä»¥ä¸€ä¸ªNULå­—ç¬¦ç»“å°¾ã€‚å¦‚æœå¹¶éå¦‚æ­¤ï¼Œstrcmpå°±å¯èƒ½å¯¹å‚æ•°åé¢çš„å­—ç¬¦è¿›è¡Œæ¯”è¾ƒï¼Œè¿™ä¸ªæ¯”è¾ƒç»“æœå°†ä¸ä¼šæœ‰ä»€ä¹ˆæ„ä¹‰ã€‚</p><h2 id="ä¸ƒã€strncmp"><a href="#ä¸ƒã€strncmp" class="headerlink" title="ä¸ƒã€strncmp"></a>ä¸ƒã€strncmp</h2><p>1ã€åŸå‹ï¼š<code>int strncmp(char const *s1, char const *s2, size_t len);</code></p><p> 2ã€åŠŸèƒ½ï¼šå’Œstrcmpä¸€æ ·ï¼Œä¹Ÿç”¨äºæ¯”è¾ƒä¸¤ä¸ªå­—ç¬¦ä¸²ï¼Œä½†å®ƒæœ€å¤šæ¯”è¾ƒ len ä¸ªå­—èŠ‚ã€‚å¦‚æœä¸¤ä¸ªå­—ç¬¦ä¸²åœ¨ç¬¬ len ä¸ªå­—ç¬¦ä¹‹å‰å­˜åœ¨ä¸ç›¸ç­‰çš„å­—ç¬¦ï¼Œè¿™ä¸ªå‡½æ•°å°±åƒstrcmpä¸€æ ·åœæ­¢æ¯”è¾ƒï¼Œè¿”å›ç»“æœã€‚å¦‚æœä¸¤ä¸ªå­—ç¬¦ä¸²çš„å‰len ä¸ªå­—ç¬¦ç›¸ç­‰ï¼Œå‡½æ•°å°±è¿”å›é›¶ã€‚</p><h2 id="å…«ã€strchrã€strrchr"><a href="#å…«ã€strchrã€strrchr" class="headerlink" title="å…«ã€strchrã€strrchr"></a>å…«ã€strchrã€strrchr</h2><p>1ã€åŸå‹ï¼š<code>char *strchr(char const *str, int ch);</code></p><p><code>char *strrchr(char const *str, int ch);</code></p><p>2ã€åŠŸèƒ½ï¼šåœ¨ä¸€ä¸ªå­—ç¬¦ä¸²ä¸­æŸ¥æ‰¾ä¸€ä¸ªç‰¹å®šå­—ç¬¦ã€‚</p><p>3ã€æ³¨æ„ï¼šç¬¬2ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªæ•´å‹å€¼ã€‚ä½†æ˜¯ï¼Œå®ƒåŒ…å«äº†ä¸€ä¸ªå­—ç¬¦å€¼ã€‚strchråœ¨å­—ç¬¦ä¸²strä¸­æŸ¥æ‰¾å­—ç¬¦chç¬¬ä¸€æ¬¡å‡ºç°çš„ä½ç½®ï¼Œæ‰¾åˆ°åå‡½æ•°è¿”å›ä¸€ä¸ªæŒ‡å‘è¯¥ä½ç½®çš„æŒ‡é’ˆã€‚å¦‚æœè¯¥å­—ç¬¦å¹¶ä¸å­˜åœ¨äºsträ¸­ï¼Œå‡½æ•°å°±è¿”å›ä¸€ä¸ªNULLæŒ‡é’ˆã€‚strrchrçš„åŠŸèƒ½å’ŒstrchråŸºæœ¬ä¸€è‡´ï¼Œåªæ˜¯å®ƒæ‰€è¿”å›çš„æ˜¯ä¸€ä¸ªæŒ‡å‘å­—ç¬¦ä¸²ä¸­è¯¥å­—ç¬¦æœ€åä¸€æ¬¡å‡ºç°çš„ä½ç½®(æœ€å³è¾¹é‚£ä¸ª)ã€‚</p><h2 id="ä¹ã€strpbrk"><a href="#ä¹ã€strpbrk" class="headerlink" title="ä¹ã€strpbrk"></a>ä¹ã€strpbrk</h2><p>1ã€åŸå‹ï¼š<code>char *strpbrk(char const *str, char const *group);</code></p><p>2ã€åŠŸèƒ½ï¼šè¿™ä¸ªå‡½æ•°è¿”å›ä¸€ä¸ªæŒ‡å‘strä¸­ç¬¬1ä¸ªåŒ¹é…groupä¸­ä»»ä½•ä¸€ä¸ªå­—ç¬¦çš„å­—ç¬¦ä½ç½®ã€‚å¦‚æœæœªæ‰¾åˆ°åŒ¹é…ï¼Œå‡½æ•°è¿”å›ä¸€ä¸ªNULLæŒ‡é’ˆã€‚</p><h2 id="åã€strstr"><a href="#åã€strstr" class="headerlink" title="åã€strstr"></a>åã€strstr</h2><p>1ã€åŸå‹ï¼š<code>char *strstr(char *s1, char *s2);</code></p><p>2ã€åŠŸèƒ½ï¼šè¿™ä¸ªå‡½æ•°åœ¨s1ä¸­æŸ¥æ‰¾æ•´ä¸ªs2ç¬¬1æ¬¡å‡ºç°çš„èµ·å§‹ä½ç½®ï¼Œå¹¶è¿”å›ä¸€ä¸ªæŒ‡å‘è¯¥ä½ç½®çš„æŒ‡é’ˆã€‚å¦‚æœs2å¹¶æ²¡æœ‰å®Œæ•´åœ°å‡ºç°åœ¨s1çš„ä»»ä½•åœ°æ–¹ï¼Œå‡½æ•°å°†è¿”å›ä¸€ä¸ªNULLæŒ‡é’ˆã€‚å¦‚æœç¬¬2ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªç©ºå­—ç¬¦ä¸²ï¼Œå‡½æ•°å°±è¿”å›s1ã€‚</p><h2 id="åä¸€ã€strtok"><a href="#åä¸€ã€strtok" class="headerlink" title="åä¸€ã€strtok"></a>åä¸€ã€strtok</h2><p>1ã€åŸå‹ï¼š<code>char *strtok(char *str, char const *sep);</code></p><p>2ã€åŠŸèƒ½ï¼šåˆ†è§£å­—ç¬¦ä¸²strä¸ºä¸€ç»„å­—ç¬¦ä¸²ï¼Œåˆ†éš”ç¬¦ä¸ºsepã€‚</p><p>3ã€æ³¨æ„ï¼šå¦‚æœstrtokå‡½æ•°çš„ç¬¬1ä¸ªå‚æ•°ä¸æ˜¯NULLï¼Œå‡½æ•°å°†æ‰¾åˆ°å­—ç¬¦ä¸²çš„ç¬¬1ä¸ªæ ‡è®°ã€‚strtokåŒæ—¶å°†ä¿å­˜å®ƒåœ¨å­—ç¬¦ä¸²ä¸­çš„ä½ç½®ã€‚å¦‚æœstrtokå‡½æ•°çš„ç¬¬1ä¸ªå‚æ•°æ˜¯NULLï¼Œå‡½æ•°å°±åœ¨åŒä¸€ä¸ªå­—ç¬¦ä¸²ä¸­ä»è¿™ä¸ªè¢«ä¿å­˜çš„ä½ç½®å¼€å§‹åƒå‰é¢ä¸€æ ·æŸ¥æ‰¾ä¸‹ä¸€ä¸ªæ ‡è®°ã€‚å¦‚æœå­—ç¬¦ä¸²å†…ä¸å­˜åœ¨æ›´å¤šçš„æ ‡è®°ï¼Œstrtokå‡½æ•°å°±è¿”å›ä¸€ä¸ªNULLæŒ‡é’ˆã€‚åœ¨å…¸å‹æƒ…å†µä¸‹ï¼Œåœ¨ç¬¬1æ¬¡è°ƒç”¨strtokæ—¶ï¼Œå‘å®ƒä¼ é€’ä¸€ä¸ªæŒ‡å‘å­—ç¬¦ä¸²çš„æŒ‡é’ˆã€‚ç„¶åï¼Œè¿™ä¸ªå‡½æ•°è¢«é‡å¤è°ƒç”¨ï¼ˆç¬¬1ä¸ªå‚æ•°ä¸ºNULLï¼‰ï¼Œç›´åˆ°å®ƒè¿”å›NULLä¸ºæ­¢ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-type">char</span> whitespace[] = <span class="hljs-string">&quot; &quot;</span>;<br>    <span class="hljs-type">char</span> *token;<br>    <span class="hljs-type">char</span> line[] = <span class="hljs-string">&quot;I love you&quot;</span>;<br>    <span class="hljs-keyword">for</span> (token = strtok(line, whitespace); token !=<span class="hljs-literal">NULL</span>;<br>         token = strtok(<span class="hljs-literal">NULL</span>, whitespace)) &#123;<br>             <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Next token is |%s|\n&quot;</span>, token);<br>        &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;ä¸€ã€strlen&quot;&gt;&lt;a href=&quot;#ä¸€ã€strlen&quot; class=&quot;headerlink&quot; title=&quot;ä¸€ã€strlen&quot;&gt;&lt;/a&gt;ä¸€ã€strlen&lt;/h2&gt;&lt;p&gt;1ã€åŸå‹ï¼š&lt;code&gt;size_t strlen(char const* string);&lt;</summary>
      
    
    
    
    <category term="Cè¯­è¨€" scheme="http://example.com/categories/C%E8%AF%AD%E8%A8%80/"/>
    
    
    <category term="Cè¯­è¨€" scheme="http://example.com/tags/C%E8%AF%AD%E8%A8%80/"/>
    
  </entry>
  
  <entry>
    <title>æŒ‡é’ˆ</title>
    <link href="http://example.com/posts/%E6%8C%87%E9%92%88.html"/>
    <id>http://example.com/posts/%E6%8C%87%E9%92%88.html</id>
    <published>2024-11-24T15:53:14.000Z</published>
    <updated>2024-11-24T15:53:36.326Z</updated>
    
    <content type="html"><![CDATA[<h2 id="1ã€Cè¯­è¨€çš„ç²¾é«“â€“æŒ‡é’ˆ"><a href="#1ã€Cè¯­è¨€çš„ç²¾é«“â€“æŒ‡é’ˆ" class="headerlink" title="1ã€Cè¯­è¨€çš„ç²¾é«“â€“æŒ‡é’ˆ"></a>1ã€Cè¯­è¨€çš„ç²¾é«“â€“æŒ‡é’ˆ</h2><p>æŒ‡é’ˆå°±æ˜¯åœ°å€ï¼Œåœ¨ä¸€å®šç¨‹åº¦ä¸Šå¯ä»¥æŠŠæ•°ç»„åå°±çœ‹æˆä¸€ä¸ªç‰¹æ®Šçš„æŒ‡é’ˆ,æŒ‡é’ˆä¹Ÿå°±æ˜¯ä¸€ä¸ªå˜é‡è€Œå·²ï¼ŒæŒ‡é’ˆå…¨åæŒ‡é’ˆå˜é‡ã€‚</p><h3 id="ï¼ˆ1ï¼‰æŒ‡é’ˆæ•°ç»„"><a href="#ï¼ˆ1ï¼‰æŒ‡é’ˆæ•°ç»„" class="headerlink" title="ï¼ˆ1ï¼‰æŒ‡é’ˆæ•°ç»„"></a>ï¼ˆ1ï¼‰æŒ‡é’ˆæ•°ç»„</h3><p>æŒ‡é’ˆæ•°ç»„ï¼Œæ˜¯ä¸ªæ•°ç»„ï¼Œé‡Œè¾¹æ”¾çš„ä¸œè¥¿éƒ½æ˜¯æŒ‡é’ˆã€‚<code>char *p[2]=&#123;&quot;china&quot;,&quot;linux&quot;&#125;;</code></p><p>ä»”ç»†æ¥è¯´ï¼Œä»è¿ç®—ç¬¦ä¼˜å…ˆçº§æ¥çœ‹ï¼Œ<code>[]çš„ä¼˜å…ˆçº§æ¯”*é«˜ï¼Œæ‰€ä»¥på…ˆå’Œ[]ç»“åˆ</code>ã€‚æ‰€ä»¥è¿™å°±æ˜¯ä¸ªæ•°ç»„ï¼Œå†ä¸æŒ‡é’ˆç»“åˆï¼Œæ‰€ä»¥å«æŒ‡é’ˆæ•°ç»„ã€‚ äºŒé‡æŒ‡é’ˆå¯ä»¥æŒ‡å‘æŒ‡é’ˆæ•°ç»„ã€‚</p><h3 id="ï¼ˆ2ï¼‰æ•°ç»„æŒ‡é’ˆ"><a href="#ï¼ˆ2ï¼‰æ•°ç»„æŒ‡é’ˆ" class="headerlink" title="ï¼ˆ2ï¼‰æ•°ç»„æŒ‡é’ˆ"></a>ï¼ˆ2ï¼‰æ•°ç»„æŒ‡é’ˆ</h3><p>æ•°ç»„æŒ‡é’ˆï¼Œæ˜¯ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘æ•°ç»„çš„æŒ‡é’ˆ.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> a[<span class="hljs-number">2</span>][<span class="hljs-number">5</span>]=&#123;<span class="hljs-number">0</span>&#125;;  <span class="hljs-type">int</span> (*p)[<span class="hljs-number">5</span>]=a;        <span class="hljs-comment">//æŒ‡å‘äºŒç»´æ•°ç»„ </span><br><span class="hljs-type">int</span> b[<span class="hljs-number">2</span>][<span class="hljs-number">3</span>][<span class="hljs-number">4</span>] = &#123;<span class="hljs-number">0</span>&#125;; <span class="hljs-comment">// å¤šç»´æ•°ç»„ int(*q)[3][4] = b;</span><br></code></pre></td></tr></table></figure><p>è¿™é‡ŒæŒ‡é’ˆæ˜¯åœ¨()ä¸­æ”¾ç€ï¼Œ())å’Œ[]ä¼˜å…ˆçº§éƒ½æ˜¯æœ€é«˜çš„ï¼Œç»“åˆæ€§æ˜¯ä»å·¦å‘å³ï¼Œæ‰€ä»¥å…ˆä¸*ç»“åˆï¼Œè¿™æ˜¯ä¸ªæŒ‡é’ˆï¼Œç„¶åä¸[]ç»“åˆï¼Œå°±æ˜¯æŒ‡é’ˆæ•°ç»„ã€‚</p><h3 id="ï¼ˆ3ï¼‰å‡½æ•°æŒ‡é’ˆ"><a href="#ï¼ˆ3ï¼‰å‡½æ•°æŒ‡é’ˆ" class="headerlink" title="ï¼ˆ3ï¼‰å‡½æ•°æŒ‡é’ˆ"></a>ï¼ˆ3ï¼‰å‡½æ•°æŒ‡é’ˆ</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> (*p)(<span class="hljs-type">int</span> a,<span class="hljs-type">char</span> b);<span class="hljs-comment">// å‡½æ•°æŒ‡é’ˆpæŒ‡å‘è¿”å›å€¼ç±»å‹ä¸ºintçš„ï¼Œä¸¤ä¸ªå‚æ•°ä¸ºintå’Œcharçš„å‡½æ•° ä½¿ç”¨æ–¹æ³•å¦‚ä¸‹ï¼Œ p(a,b); æˆ–è€… (*p)(a,b);</span><br></code></pre></td></tr></table></figure><p>void *ç±»å‹å¯ä»¥æŒ‡å‘ä»»ä½•ä¸€ä¸ªç±»å‹çš„æŒ‡é’ˆ</p><p><code>void (*signal(int sig, void (*func) (int))) (int)</code></p><p><strong>signalä»ç„¶æ˜¯ä¸€ä¸ªå‡½æ•°</strong>ï¼Œä»–è¿”å›ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼Œè¿™ä¸ªæŒ‡é’ˆæŒ‡å‘çš„å‡½æ•°æ²¡æœ‰è¿”å›å€¼ï¼Œåªæœ‰ä¸€ä¸ªintç±»å‹çš„å‚æ•°</p><h3 id="ï¼ˆ4ï¼‰äºŒç»´æ•°ç»„"><a href="#ï¼ˆ4ï¼‰äºŒç»´æ•°ç»„" class="headerlink" title="ï¼ˆ4ï¼‰äºŒç»´æ•°ç»„"></a>ï¼ˆ4ï¼‰äºŒç»´æ•°ç»„</h3><p><code>a[5][7];//ç”¨æŒ‡é’ˆè®¿é—®å°±æ˜¯*ï¼ˆ*ï¼ˆp+5ï¼‰+7ï¼‰ int (*p)[7]=a;</code></p><h3 id="ï¼ˆ5ï¼‰å­—ç¬¦æ•°ç»„ä¸æŒ‡å‘å­—ç¬¦ä¸²æŒ‡é’ˆçš„é—®é¢˜"><a href="#ï¼ˆ5ï¼‰å­—ç¬¦æ•°ç»„ä¸æŒ‡å‘å­—ç¬¦ä¸²æŒ‡é’ˆçš„é—®é¢˜" class="headerlink" title="ï¼ˆ5ï¼‰å­—ç¬¦æ•°ç»„ä¸æŒ‡å‘å­—ç¬¦ä¸²æŒ‡é’ˆçš„é—®é¢˜"></a>ï¼ˆ5ï¼‰å­—ç¬¦æ•°ç»„ä¸æŒ‡å‘å­—ç¬¦ä¸²æŒ‡é’ˆçš„é—®é¢˜</h3><p>å…¶ä¸­<code>char *p=&quot;linux&quot;</code> è¿™ç§æƒ…å†µå­—ç¬¦ä¸²Linuxåªå­˜åœ¨äºåªè¯»æ•°æ®æ®µä¸­ï¼ˆrodataï¼‰ï¼Œæ‰€ä»¥pæ‰€æŒ‡å‘çš„å†…å®¹ä¸å¯ä»¥è¢«æ›´æ”¹ï¼Œå¦‚<code>*ï¼ˆp+1ï¼‰=a;</code>è¿™æ˜¯å®ç°ä¸äº†çš„ï¼Œä½†æ˜¯å¯ä»¥æ›´æ”¹æŒ‡é’ˆp æŒ‡å‘çš„åœ°å€ï¼Œä¾‹å¦‚p&#x3D;â€mengchaoâ€,ä½†æ˜¯è¿™é‡Œçš„p&#x3D;â€mengchaoâ€è¿™æ®µè¯æ”¾åœ¨å­å‡½æ•°ä¸­æ˜¯ä¸å¯ä»¥çš„ï¼Œå­—ç¬¦ä¸²mengchaoæ˜¯å­˜åœ¨äºæ ˆä¸­ï¼Œå­å‡½æ•°ç»“æŸå°±è¢«é‡Šæ”¾äº†ï¼Œä¸èƒ½å¤Ÿè¾¾åˆ°æ”¹å˜çš„ç›®çš„ã€‚å¯ä»¥ä½¿ç”¨äºŒé‡æŒ‡é’ˆæ¥å®ç°ã€‚</p><p>char p[]&#x3D;â€linuxâ€ è¿™ä¸ªæ˜¯å­—ç¬¦æ•°ç»„ï¼Œç›¸å½“äºåˆå§‹åŒ–æ•°ç»„ï¼Œå¯ä»¥æ›´æ”¹å†…å®¹ï¼Œå¦‚p[1]&#x3D;â€™aâ€™;* è¿™é‡ŒLinuxå­˜åœ¨äºæ ˆä¸Š</p><p><strong>æ‰€ä»¥æœ‰çš„å­—ç¬¦ä¸²æ“ä½œå‡½æ•°ä¾‹å¦‚</strong>â€‹<strong>â€‹<code>char *strcat(char *dst,char const *src);</code>â€‹</strong>â€‹<strong>å‰é¢çš„å‚æ•°dst,éœ€è¦ä¿®æ”¹ï¼Œåªèƒ½ä¼ æ•°ç»„ï¼Œä¸èƒ½ç›´æ¥ä¼ ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå› ä¸ºå­—ç¬¦ä¸²ä¸å¯æ”¹å˜</strong></p><p>æ‰€ä»¥æƒ³ä¿®æ”¹å­—ç¬¦ä¸²ï¼Œè¯·å°†ä»–æ”¾åœ¨å­—ç¬¦æ•°ç»„ä¸­ã€‚ å¦å¤–å…³äºè¿™ä¸ªç¨‹åº</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">char</span> c = <span class="hljs-string">&#x27;a&#x27;</span>; <span class="hljs-type">char</span> *p = &amp;c;<br><span class="hljs-type">char</span> *q = <span class="hljs-string">&quot;china&quot;</span>; <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%p\n&quot;</span>,p);     <span class="hljs-comment">//006DFEE7 </span><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%c\n&quot;</span>,*p);    <span class="hljs-comment">//a </span><br><span class="hljs-built_in">cout</span> &lt;&lt; *p &lt;&lt; <span class="hljs-built_in">endl</span>;   <span class="hljs-comment">//a </span><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%p\n&quot;</span>,q);     <span class="hljs-comment">//004B9024 </span><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s\n&quot;</span>,q);     <span class="hljs-comment">//china </span><br><span class="hljs-built_in">cout</span> &lt;&lt; q &lt;&lt; <span class="hljs-built_in">endl</span>;    <span class="hljs-comment">//china </span><br><span class="hljs-built_in">cout</span> &lt;&lt; *q &lt;&lt; <span class="hljs-built_in">endl</span>;   <span class="hljs-comment">//c</span><br></code></pre></td></tr></table></figure><p>è¿™é‡Œæƒ³æ’ä¸€å¥å…³äºstrlenå’Œsizeofçš„åŒºåˆ«ã€‚æ¯”å¦‚æˆ‘ä»¬å®šä¹‰char buf[100]&#x3D;{â€œhelloworldâ€}; strlen(buf);å°±æ˜¯é‡Œè¾¹å­—ç¬¦ä¸²çš„é•¿åº¦ï¼Œè€Œsizeof(buf);å°±æ˜¯æ•°ç»„é•¿åº¦100.</p><p><strong>ä¸€å®šç¨‹åº¦ä¸Šå¯ä»¥è®¤ä¸ºä¸€çº§æŒ‡é’ˆä¸ä¸€ç»´æ•°ç»„åç­‰ä»·ï¼ŒäºŒçº§æŒ‡é’ˆä¸æŒ‡é’ˆæ•°ç»„åç­‰ä»·ï¼Œæ•°ç»„æŒ‡é’ˆä¸äºŒç»´æ•°ç»„åç­‰ä»·ã€‚è€ŒäºŒçº§æŒ‡é’ˆå’ŒäºŒç»´æ•°ç»„åæ²¡æœ‰ä¸€æ¯›é’±å…³ç³»ã€‚</strong></p><h3 id="ï¼ˆ6ï¼‰æ•°ç»„å"><a href="#ï¼ˆ6ï¼‰æ•°ç»„å" class="headerlink" title="ï¼ˆ6ï¼‰æ•°ç»„å"></a>ï¼ˆ6ï¼‰æ•°ç»„å</h3><p>æ•°ç»„åå¯ä»¥çœ‹æˆæ˜¯é¦–å…ƒç´ çš„é¦–åœ°å€ï¼Œä¹Ÿå¯ä»¥å½“æˆä¸€ä¸ªæ•´ä½“æ¥çœ‹ã€‚æ•°ç»„åæ˜¯å¸¸é‡ï¼Œæ‰å¯ä»¥å”¯ä¸€çš„ç¡®å®šæ•°ç»„å…ƒç´ çš„èµ·å§‹åœ°å€ã€‚è®¾æœ‰ä¸€ç»´æ•°ç»„<code>int a[5]</code>:</p><p><code>a[1] = *(a+1); //aä»£è¡¨é¦–å…ƒç´ é¦–åœ°å€,åŠ 1è·¨åº¦ä¸ºintå¤§å°ä¸º4</code></p><p>å¯¹ä¸€ç»´æ•°ç»„åå’ŒäºŒç»´æ•°ç»„åå¼•ç”¨(å–åœ°å€)å¯¹ä¸€ç»´æ•°ç»„åè¿›è¡Œå¼•ç”¨ä¼šå°†ä½¿å…¶å‡çº§ä¸ºäºŒç»´æ•°ç»„åã€‚</p><p><code>(&amp;a+1)//è¿™ä¸ªä¸œè¥¿åŠ 1ï¼ŒåŠ çš„å¤§å°æ˜¯æ•´ä¸ªæ•°ç»„çš„å¤§å°ï¼Œæ˜¯20.</code></p><p>äºŒç»´æ•°ç»„åè§£å¼•ç”¨ï¼Œé™ç»´ä¸ºä¸€ç»´æ•°ç»„åã€‚äºŒç»´æ•°ç»„åæ˜¯é¦–å…ƒç´ é¦–åœ°å€ï¼Œè®¾æœ‰<code>int a[4][3]</code>,åˆ™</p><p><code>*(a+1) //ä»£è¡¨çš„æ˜¯äºŒç»´æ•°ç»„çš„ç¬¬äºŒç»´ a[1][2] = *(*(a+1)+2)</code></p><p>æ³¨æ„ä¸‹é¢çš„é—®é¢˜</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c">*p++ï¼šç­‰åŒäºï¼š*p;  p += <span class="hljs-number">1</span>;å…ˆè¿ç®—å†++ <br>è§£æï¼šå®é™…ä¸Š*p++ç¬¦å·æ•´ä½“å¯¹å¤–è¡¨ç°çš„å€¼æ˜¯*pçš„å€¼ï¼Œè¿ç®—å®Œæˆåpå†åŠ <span class="hljs-number">1.</span> ã€æ³¨æ„ã€‘æ˜¯è¿ç®—åpå†åŠ <span class="hljs-number">1</span>ï¼Œè€Œä¸æ˜¯pæ‰€æŒ‡å‘çš„å˜é‡*på†åŠ <span class="hljs-number">1</span> <br><br>*++pï¼šç­‰åŒäº p += <span class="hljs-number">1</span>;    <br>*p;å…ˆ++å†è¿ç®— è§£æï¼šç”±äº++åœ¨pçš„å‰é¢ï¼Œ++å‰ç½®çš„å«ä¹‰æ˜¯ï¼Œå…ˆåŠ <span class="hljs-number">1</span>ï¼Œå¾—åˆ°ä¸€ä¸ªæ–°çš„pï¼ˆå®ƒçš„å€¼æ˜¯åŸæ¥pçš„å€¼åŠ <span class="hljs-number">1</span>ï¼‰ã€‚ç„¶åè¿™ä¸ªæ–°çš„på†ä¸å‰é¢çš„*ç»“åˆ. <br><br>ã€æ€»ç»“ã€‘æ— è®ºæ˜¯*p++è¿˜æ˜¯*++pï¼Œéƒ½æ˜¯æŒ‡é’ˆp += <span class="hljs-number">1</span>ï¼Œå³pçš„å€¼+<span class="hljs-number">1</span>ï¼Œè€Œä¸æ˜¯pæ‰€æŒ‡å‘çš„å˜é‡*pçš„å€¼+<span class="hljs-number">1</span>ã€‚ ++å‰ç½®ä¸++åç½®ï¼Œåªæ˜¯å†³å®šäº†åˆ°åº•æ˜¯å…ˆp += <span class="hljs-number">1</span>ï¼Œè¿˜æ˜¯å…ˆ*pã€‚++å‰ç½®è¡¨ç¤ºå…ˆp += <span class="hljs-number">1</span>ï¼Œå†*pã€‚++åç½®è¡¨ç¤ºå…ˆ*pï¼Œåœ¨p += <span class="hljs-number">1</span>ï¼› --å‰ç½®ä¸--åç½®çš„çš„åˆ†ææ–¹æ³•++å‰ç½®ä¸++åç½®çš„ä¸€æ ·ã€‚<br></code></pre></td></tr></table></figure><h2 id="2ã€è¿›ç¨‹ç©ºé—´"><a href="#2ã€è¿›ç¨‹ç©ºé—´" class="headerlink" title="2ã€è¿›ç¨‹ç©ºé—´"></a>2ã€è¿›ç¨‹ç©ºé—´</h2><p><img src="https://raw.githubusercontent.com/mengchao666/picture/main/blog5b809e6f908834233029fd990bccc4d5.png"></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c">å…¨å±€å˜é‡ï¼šä¸åˆå§‹åŒ–çš„é»˜è®¤ä¸º<span class="hljs-number">0</span>ï¼Œæ”¾åœ¨.bssæ®µï¼Œåˆå§‹åŒ–ä¸º<span class="hljs-number">0</span>çš„ä¹Ÿæ”¾åœ¨.bssæ®µ <br>åˆå§‹åŒ–ä¸ºé<span class="hljs-number">0</span>çš„å…¨å±€å˜é‡æ”¾åœ¨.dataæ®µä¸­ï¼Œç”Ÿå‘½å‘¨æœŸå…¨å±€ <br>å±€éƒ¨å˜é‡æ”¾åœ¨æ ˆä¸Šï¼Œå½“è°ƒç”¨ç»“æŸï¼Œç”Ÿå‘½å‘¨æœŸç»“æŸ<br></code></pre></td></tr></table></figure><h2 id="3ã€ç»“æ„ä½“"><a href="#3ã€ç»“æ„ä½“" class="headerlink" title="3ã€ç»“æ„ä½“"></a>3ã€ç»“æ„ä½“</h2><p>ã€Šé“å¾·ç»ã€‹ æ›°ï¼šâ€ä¸€ç”ŸäºŒï¼ŒäºŒç”Ÿä¸‰ï¼Œä¸‰ç”Ÿä¸‡ç‰©â€ã€‚ç»“æ„ä½“ç”¨å…³é”®å­— struct å®šä¹‰ï¼Œè¡¨è¾¾å‡ºå¤šä¸ªä¸åŒå˜é‡åœ¨ä¸€èµ·çš„ç±»å‹ã€‚æˆ‘ä»¬ç”±æ­¤å¯ä»¥ä½¿ç”¨structè‡ªå®šä¹‰å‡ ä¹æ‰€æœ‰æƒ³è¦çš„ç±»å‹ã€‚</p><p>ç»“æ„ä½“çš„å®šä¹‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">student</span></span><br><span class="hljs-class">&#123;</span><br>  <span class="hljs-type">char</span> name[<span class="hljs-number">30</span>];<br>  <span class="hljs-type">char</span> sex;<br>  <span class="hljs-type">int</span> age;<br>  <span class="hljs-type">float</span> high;<br>&#125;stu1;<span class="hljs-comment">//è¿™é‡Œå®šä¹‰äº†ä¸€ä¸ªå˜é‡stu1</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">student</span> <span class="hljs-title">stu2</span>;</span><span class="hljs-comment">//è¿™é‡Œå®šä¹‰äº†ä¸€ä¸ªå˜é‡stu2</span><br></code></pre></td></tr></table></figure><p>è¿™ç§å®šä¹‰å‡ºæ¥çš„ç»“æ„ä½“ç±»å‹åœ¨å®šä¹‰å˜é‡æ—¶å¿…é¡»è·Ÿç€structï¼Œå°±åƒ<code>struct student stu1;</code>ä¸€æ ·ï¼Œæˆ‘ä»¬å¼•å…¥typedefï¼Œé¿å…è¿™ç§æƒ…å†µã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">student</span></span><br><span class="hljs-class">&#123;</span><br>  <span class="hljs-type">char</span> name[<span class="hljs-number">30</span>];<br>  <span class="hljs-type">char</span> sex;<br>  <span class="hljs-type">int</span> age;<br>  <span class="hljs-type">float</span> high;<br>&#125;STUDENT;<span class="hljs-comment">//å°†struct studentç±»å‹é‡å‘½åä¸ºSTUDENT</span><br>STUDENT stu, stu2;<span class="hljs-comment">//ä½¿ç”¨STUDENTæ›¿æ¢struct studentå®šä¹‰å˜é‡</span><br></code></pre></td></tr></table></figure><h3 id="ç»“æ„ä½“å˜é‡åˆå§‹åŒ–åŠæˆå‘˜è®¿é—®"><a href="#ç»“æ„ä½“å˜é‡åˆå§‹åŒ–åŠæˆå‘˜è®¿é—®" class="headerlink" title="ç»“æ„ä½“å˜é‡åˆå§‹åŒ–åŠæˆå‘˜è®¿é—®"></a>ç»“æ„ä½“å˜é‡åˆå§‹åŒ–åŠæˆå‘˜è®¿é—®</h3><p>å®šä¹‰çš„ç»“æ„ä½“å˜é‡ç”¨ç‚¹æˆå‘˜è¿ç®—ç¬¦ï¼ˆ.ï¼‰è®¿é—®æˆå‘˜å˜é‡ï¼Œæ¯”å¦‚<code>stu.sex</code>å°±è¿™æ ·è®¿é—®æˆå‘˜å˜é‡ã€‚å¦‚æœæ˜¯ç»“æ„ä½“ç±»å‹çš„æŒ‡é’ˆå˜é‡åˆ™ä½¿ç”¨-&gt;è®¿é—®æˆå‘˜å˜é‡ã€‚<code>STUDENT stu; stu-&gt;sex = &#39;x&#39;;</code>åˆå§‹åŒ–å¤§æ¦‚æœ‰ä¸‰ç§æ–¹æ³•ã€‚</p><p>ä¸¾ä¾‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c">typede <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">block</span> &#123;</span> <br>  <span class="hljs-type">char</span> name[<span class="hljs-number">32</span>];   <br>  <span class="hljs-type">int</span> type;   <br>  <span class="hljs-type">int</span> size; <br> &#125;block;<br></code></pre></td></tr></table></figure><p>æ–¹æ³•ä¸€ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">block test = &#123;<span class="hljs-string">&quot;version&quot;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">32</span>&#125;ï¼› éœ€è¦æ³¨æ„å¯¹åº”çš„é¡ºåºï¼Œä¸èƒ½é”™ä½ã€‚<br></code></pre></td></tr></table></figure><p>æ–¹æ³•äºŒï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c">block test; <br>test.name = <span class="hljs-string">&quot;version&quot;</span>; <br>test.type = <span class="hljs-number">1</span>; <br>test.size= <span class="hljs-number">3</span>;<br></code></pre></td></tr></table></figure><p>æ–¹æ³•ä¸‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c">block  test = &#123;  <br>  .type= <span class="hljs-number">1</span>,  <br>  .size = <span class="hljs-number">12</span>,  <br>  .name= <span class="hljs-string">&quot;version&quot;</span> <br> &#125;;<br></code></pre></td></tr></table></figure><h3 id="ç»“æ„ä½“å¤§å°"><a href="#ç»“æ„ä½“å¤§å°" class="headerlink" title="ç»“æ„ä½“å¤§å°"></a>ç»“æ„ä½“å¤§å°</h3><p>è®¾è®¡å†…å­˜å¯¹é½</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Date</span> &#123;</span>     <br>  <span class="hljs-type">char</span> a;<br>  <span class="hljs-type">int</span> b;<br>  <span class="hljs-type">int64_t</span> c;  <br>  <span class="hljs-type">char</span> d;<br>&#125;; <br>Date data [<span class="hljs-number">2</span>][<span class="hljs-number">10</span>];<br></code></pre></td></tr></table></figure><p>ç»“æ„ä½“æ‰€å çš„å†…å­˜å¤§å° a.æ•´ä½“æ‰€å çš„å†…å­˜å¤§å°åº”è¯¥æ˜¯ç»“æ„ä¸­æˆå‘˜ç±»å‹æœ€å¤§çš„æ•´æ•°å€ï¼Œæ­¤å¤„æœ€å¤§çš„ç±»å‹æ˜¯int_64tï¼Œå 8ä¸ªå­—èŠ‚ã€‚å³æœ€åæ‰€å å­—èŠ‚çš„æ€»æ•°åº”è¯¥æ˜¯8çš„å€æ•°ï¼Œä¸è¶³çš„è¡¥è¶³ b.æ•°æ®å¯¹é½åŸåˆ™-å†…å­˜æŒ‰ç»“æ„ä½“æˆå‘˜çš„å…ˆåé¡ºåºæ’åˆ—ï¼Œå½“æ’åˆ°è¯¥æˆå‘˜å˜é‡æ—¶ï¼Œå…¶å‰é¢æ‰€æœ‰æˆå‘˜å·²ç»å ç”¨çš„ç©ºé—´å¤§å°å¿…é¡»æ˜¯è¯¥æˆå‘˜ç±»å‹å¤§å°çš„æ•´æ•°å€ï¼Œå¦‚æœä¸å¤Ÿï¼Œåˆ™å‰é¢çš„æˆå‘˜å ç”¨çš„ç©ºé—´è¦è¡¥é½ï¼Œä½¿ä¹‹æˆä¸ºå½“å‰æˆå‘˜ç±»å‹çš„æ•´æ•°å€ã€‚å‡è®¾æ˜¯åœ°å€æ˜¯ä»0å¼€å§‹ï¼Œç»“æ„ä½“ä¸­ç¬¬ä¸€ä¸ªæˆå‘˜ç±»å‹charå‹å ä¸€ä¸ªå­—èŠ‚ï¼Œåˆ™å†…å­˜åœ°å€0-1ï¼Œç¬¬äºŒæˆå‘˜ä»2å¼€å§‹ï¼Œintå‹æ‰€å å†…å­˜4ä¸ªå­—èŠ‚æ ¹æ®åŸåˆ™bï¼Œç¬¬ä¸€ä¸ªæˆå‘˜æ‰€å å†…å­˜è¡¥é½4çš„å€æ•°ï¼Œæ•…ç¬¬ä¸€ä¸ªæˆå‘˜æ‰€å å†…å­˜:1ï¼‹3ï¼4ï¼›ç¬¬äºŒä¸ªæˆå‘˜å 5-8.ç¬¬ä¸‰ä¸ªæˆå‘˜å 8ä¸ªå­—èŠ‚ï¼Œæ»¡è¶³åŸåˆ™bï¼Œä¸éœ€è¦è¡¥é½ï¼Œå 9-16ç¬¬å››ä¸ªæˆå‘˜å ä¸€ä¸ªå­—èŠ‚ï¼Œå 17.æ•…æ€»å†…å­˜ä¸º1ï¼‹3ï¼‹4ï¼‹8ï¼‹1ï¼17ä¸ªå­—èŠ‚ï¼Œä½†æ ¹æ®åŸåˆ™1æ€»å­—èŠ‚æ•°éœ€æ˜¯8çš„å€æ•°ï¼Œéœ€å°†17è¡¥é½åˆ°24.æ•…æ­¤ç»“æ„ä½“æ€»å­—èŠ‚æ•°ä¸º:24å­—èŠ‚</p><h2 id="4ã€ä¸€äº›å…³é”®å­—çš„è¯¦è§£"><a href="#4ã€ä¸€äº›å…³é”®å­—çš„è¯¦è§£" class="headerlink" title="4ã€ä¸€äº›å…³é”®å­—çš„è¯¦è§£"></a>4ã€ä¸€äº›å…³é”®å­—çš„è¯¦è§£</h2><h3 id="inline"><a href="#inline" class="headerlink" title="inline"></a>inline</h3><p>åœ¨c&#x2F;c++ä¸­ï¼Œä¸ºäº†è§£å†³ä¸€äº›é¢‘ç¹è°ƒç”¨çš„å°å‡½æ•°å¤§é‡æ¶ˆè€—æ ˆç©ºé—´ï¼ˆæ ˆå†…å­˜ï¼‰çš„é—®é¢˜ï¼Œç‰¹åˆ«çš„å¼•å…¥äº†inlineä¿®é¥°ç¬¦ï¼Œè¡¨ç¤ºä¸ºå†…è”å‡½æ•°ã€‚æ ˆç©ºé—´å°±æ˜¯æŒ‡æ”¾ç½®ç¨‹åºçš„å±€éƒ¨æ•°æ®ï¼ˆä¹Ÿå°±æ˜¯å‡½æ•°å†…æ•°æ®ï¼‰çš„å†…å­˜ç©ºé—´ã€‚ inlineçš„ä½¿ç”¨æ˜¯æœ‰æ‰€é™åˆ¶çš„ï¼Œinlineåªé€‚åˆæ¶µæ•°ä½“å†…ä»£ç ç®€å•çš„æ¶µæ•°ä½¿ç”¨ï¼Œä¸èƒ½åŒ…å«å¤æ‚çš„ç»“æ„æ§åˆ¶è¯­å¥ä¾‹å¦‚whileã€switchï¼Œå¹¶ä¸”ä¸èƒ½å†…è”å‡½æ•°æœ¬èº«ä¸èƒ½æ˜¯ç›´æ¥é€’å½’å‡½æ•°ï¼ˆå³ï¼Œè‡ªå·±å†…éƒ¨è¿˜è°ƒç”¨è‡ªå·±çš„å‡½æ•°ï¼‰ã€‚ inlineå‡½æ•°ä»…ä»…æ˜¯ä¸€ä¸ªå¯¹ç¼–è¯‘å™¨çš„å»ºè®®ï¼Œæ‰€ä»¥æœ€åèƒ½å¦çœŸæ­£å†…è”ï¼Œçœ‹ç¼–è¯‘å™¨çš„æ„æ€ï¼Œå®ƒå¦‚æœè®¤ä¸ºå‡½æ•°ä¸å¤æ‚ï¼Œèƒ½åœ¨è°ƒç”¨ç‚¹å±•å¼€ï¼Œå°±ä¼šçœŸæ­£å†…è”ï¼Œå¹¶ä¸æ˜¯è¯´å£°æ˜äº†å†…è”å°±ä¼šå†…è”ï¼Œå£°æ˜å†…è”åªæ˜¯ä¸€ä¸ªå»ºè®®è€Œå·²ã€‚</p><h3 id="inlineå‡½æ•°çš„å®šä¹‰æ”¾åœ¨å¤´æ–‡ä»¶ä¸­"><a href="#inlineå‡½æ•°çš„å®šä¹‰æ”¾åœ¨å¤´æ–‡ä»¶ä¸­" class="headerlink" title="inlineå‡½æ•°çš„å®šä¹‰æ”¾åœ¨å¤´æ–‡ä»¶ä¸­"></a>inlineå‡½æ•°çš„å®šä¹‰æ”¾åœ¨å¤´æ–‡ä»¶ä¸­</h3><p>å…¶æ¬¡ï¼Œå› ä¸ºå†…è”å‡½æ•°è¦åœ¨è°ƒç”¨ç‚¹å±•å¼€ï¼Œæ‰€ä»¥ç¼–è¯‘å™¨å¿…é¡»éšå¤„å¯è§å†…è”å‡½æ•°çš„å®šä¹‰ï¼Œè¦ä¸ç„¶å°±æˆäº†éå†…è”å‡½æ•°çš„è°ƒç”¨äº†ã€‚æ‰€ä»¥ï¼Œè¿™è¦æ±‚æ¯ä¸ªè°ƒç”¨äº†å†…è”å‡½æ•°çš„æ–‡ä»¶éƒ½å‡ºç°äº†è¯¥å†…è”å‡½æ•°çš„å®šä¹‰ã€‚ å› æ­¤ï¼Œå°†å†…è”å‡½æ•°çš„å®šä¹‰æ”¾åœ¨å¤´æ–‡ä»¶é‡Œå®ç°æ˜¯åˆé€‚çš„ï¼Œçœå´ä½ ä¸ºæ¯ä¸ªæ–‡ä»¶å®ç°ä¸€æ¬¡çš„éº»çƒ¦ã€‚ å£°æ˜è·Ÿå®šä¹‰è¦ä¸€è‡´ï¼šå¦‚æœåœ¨æ¯ä¸ªæ–‡ä»¶é‡Œéƒ½å®ç°ä¸€æ¬¡è¯¥å†…è”å‡½æ•°çš„è¯ï¼Œé‚£ä¹ˆï¼Œæœ€å¥½ä¿è¯æ¯ä¸ªå®šä¹‰éƒ½æ˜¯ä¸€æ ·çš„ï¼Œå¦åˆ™ï¼Œå°†ä¼šå¼•èµ·æœªå®šä¹‰çš„è¡Œä¸ºã€‚å¦‚æœä¸æ˜¯æ¯ä¸ªæ–‡ä»¶é‡Œçš„å®šä¹‰éƒ½ä¸€æ ·ï¼Œé‚£ä¹ˆï¼Œç¼–è¯‘å™¨å±•å¼€çš„æ˜¯å“ªä¸€ä¸ªï¼Œé‚£è¦çœ‹å…·ä½“çš„ç¼–è¯‘å™¨è€Œå®šã€‚æ‰€ä»¥ï¼Œæœ€å¥½å°†å†…è”å‡½æ•°å®šä¹‰æ”¾åœ¨å¤´æ–‡ä»¶ä¸­ã€‚</p><p>æ³¨ï¼šä¹‹æ‰€ä»¥å®šä¹‰æ”¾åœ¨å¤´æ–‡ä»¶ä¸­ï¼Œæ˜¯å› ä¸ºinlineæ˜¯åœ¨ç¼–è¯‘é˜¶æ®µå±•å¼€çš„ï¼Œå¹¶ä¸æ˜¯è¿æ¥æºæ–‡ä»¶ã€‚</p><h3 id="static"><a href="#static" class="headerlink" title="static"></a>static</h3><p>staticåˆ«çš„ä¸œè¥¿ä¸æƒ³è¯´ï¼Œå°±è¯´staticåœ¨ä¿®é¥°å±€éƒ¨å˜é‡çš„æ—¶å€™ï¼Œå‡½æ•°ç»“æŸæ­¤æ—¶å±€éƒ¨å˜é‡å¹¶ä¸ä¼šè¢«é‡Šæ”¾ï¼Œå¹¶ä¸”ä¿®é¥°çš„å±€éƒ¨å˜é‡çš„å€¼æ˜¯ä¸€ç›´ä¿å­˜çš„ï¼Œç±»ä¼¼äºå…¨å±€å˜é‡ï¼Œä½†æ˜¯è¿˜æ˜¯åªèƒ½åœ¨è¿™ä¸ªå‡½æ•°å†…æ‰èƒ½è®¿é—®</p><h3 id="const"><a href="#const" class="headerlink" title="const"></a>const</h3><p>conståˆå«å¸¸å˜é‡ï¼Œä¿®é¥°çš„å˜é‡ä¸€èˆ¬ä¸èƒ½è¢«æ›´æ”¹ã€‚ä½†æ˜¯åœ¨Cè¯­è¨€ä¸­è¿™æ˜¯å‡çš„ï¼Œé€šè¿‡å®šä¹‰ä¸€ä¸ªæŒ‡é’ˆï¼Œä¿®æ”¹æŒ‡é’ˆæŒ‡å‘çš„å†…å­˜ä¾æ—§å¯ä»¥æ›´æ”¹constä¿®é¥°çš„å˜é‡ã€‚åœ¨C++ä¸­æ‰æ˜¯çœŸæ­£çš„constï¼Œæ— æ³•ä¿®æ”¹ã€‚ constä¸€èˆ¬å‡ºç°åœ¨å‚æ•°åˆ—è¡¨ä¸­ï¼Œæ„å‘³ç€è¿™ä¸ªå˜é‡åœ¨å‡½æ•°ä¸­å¹¶ä¸ä¼šè¢«ä¿®æ”¹ï¼Œæ˜¯è¾“å…¥å‹å‚æ•°ã€‚</p><h3 id="volatile"><a href="#volatile" class="headerlink" title="volatile"></a>volatile</h3><p>è¿™ä¸ªvolatileï¼Œè‹±æ–‡åæ˜“å˜çš„ã€‚å› ä¸ºè®¿é—®å¯„å­˜å™¨è¦æ¯”è®¿é—®å†…å­˜å•å…ƒå¿«çš„å¤š,æ‰€ä»¥ç¼–è¯‘å™¨ä¸€èˆ¬éƒ½ä¼šä½œå‡å°‘å­˜å–å†…å­˜çš„ä¼˜åŒ–ï¼Œä½†æœ‰å¯èƒ½ä¼šè¯»è„æ•°æ®ã€‚å½“è¦æ±‚ä½¿ç”¨volatileå£°æ˜å˜é‡å€¼çš„æ—¶å€™ï¼Œç³»ç»Ÿæ€»æ˜¯é‡æ–°ä»å®ƒæ‰€åœ¨çš„å†…å­˜è¯»å–æ•°æ®ï¼Œå³ä½¿å®ƒå‰é¢çš„æŒ‡ä»¤åˆšåˆšä»è¯¥å¤„è¯»å–è¿‡æ•°æ®ã€‚ ç²¾ç¡®åœ°è¯´å°±æ˜¯ï¼Œé‡åˆ°è¿™ä¸ªå…³é”®å­—å£°æ˜çš„å˜é‡ï¼Œç¼–è¯‘å™¨å¯¹è®¿é—®è¯¥å˜é‡çš„ä»£ç å°±ä¸å†è¿›è¡Œä¼˜åŒ–ï¼Œä»è€Œå¯ä»¥æä¾›å¯¹ç‰¹æ®Šåœ°å€çš„ç¨³å®šè®¿é—®ï¼›å¦‚æœä¸ä½¿ç”¨valatileï¼Œåˆ™ç¼–è¯‘å™¨å°†å¯¹æ‰€å£°æ˜çš„è¯­å¥è¿›è¡Œä¼˜åŒ–ã€‚</p><h2 id="5ã€å¤šæ–‡ä»¶ç¼–ç¨‹"><a href="#5ã€å¤šæ–‡ä»¶ç¼–ç¨‹" class="headerlink" title="5ã€å¤šæ–‡ä»¶ç¼–ç¨‹"></a>5ã€å¤šæ–‡ä»¶ç¼–ç¨‹</h2><p>ä¸€ä¸ªç®€å•çš„ä¾‹å­ å…¨å±€å˜é‡æœ€å¥½å£°æ˜ä¸º staticï¼Œåªåœ¨å½“å‰æ–‡ä»¶ä¸­å¯è§ï¼Œä¸è¦å¯¹å¤–æš´éœ²ï¼›å¦‚æœå¿…é¡»å¯¹å¤–æš´éœ²ï¼Œå¯ä»¥ä½¿ç”¨å®å®šä¹‰ä»£æ›¿ï¼Œå…¨å±€å˜é‡æœ€å¥½åªåœ¨æœ¬æ–‡ä»¶å†…ä½¿ç”¨ï¼Œå¦‚æœå…¶ä»–æ–‡ä»¶å¿…é¡»ä½¿ç”¨ï¼Œæœ€å¥½å°è£…getæ¥å£setæ¥å£ï¼Œè¯·çœ‹ä¸‹é¢çš„ä»£ç ã€‚ main.c æºç ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;conio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;module.h&quot;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>  <span class="hljs-type">int</span> n1 = <span class="hljs-number">1</span>, n2 = <span class="hljs-number">100</span>;<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;ä»%d åŠ åˆ°%d çš„å’Œä¸º%ld [By %s]&quot;</span>, n1, n2, sum(n1, n2), OS);<br>  getch();<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>module.c æºç ï¼šå¦‚æœä½¿ç”¨äº†å¤´æ–‡ä»¶ä¸­çš„å®å®šä¹‰ï¼Œè¿™é‡Œä¹Ÿæ˜¯éœ€è¦åŒ…å«å¤´æ–‡ä»¶çš„</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;module.h&quot;</span></span><br><br><span class="hljs-type">long</span> <span class="hljs-title function_">sum</span><span class="hljs-params">(<span class="hljs-type">int</span> fromNum, <span class="hljs-type">int</span> endNum)</span><br>&#123;<br>  <span class="hljs-type">int</span> i;<br>  <span class="hljs-type">long</span> result = <span class="hljs-number">0</span>;<br>  <span class="hljs-comment">// å‚æ•°ä¸ç¬¦åˆè§„åˆ™ï¼Œè¿”å› -1</span><br>  <span class="hljs-keyword">if</span>(fromNum&lt;<span class="hljs-number">0</span> || endNum&lt;<span class="hljs-number">0</span> || endNum&lt;fromNum)&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>  &#125;<br><br>  <span class="hljs-keyword">for</span>(i=fromNum; i&lt;=endNum; i++)&#123;<br>    result += i;<br>  &#125;<br>  <span class="hljs-comment">// è¿”å›å¤§äºç­‰äº 0 çš„å€¼</span><br>  <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure><p>module.h æºç ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __MODULE_H_ </span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __MODULE_H_ </span><br><span class="hljs-comment">// ç”¨å®å®šä¹‰æ¥ä»£æ›¿å…¨å±€å˜é‡ </span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> OS <span class="hljs-string">&quot;Windows 7&quot;</span> </span><br><span class="hljs-comment">// ä¹Ÿå¯ä»¥çœç•¥ externï¼›ä¸è¿‡ä¸ºäº†ç¨‹åºå¯è¯»æ€§ï¼Œå»ºè®®å†™ä¸Š </span><br><span class="hljs-keyword">extern</span> <span class="hljs-type">long</span> <span class="hljs-title function_">sum</span><span class="hljs-params">(<span class="hljs-type">int</span>, <span class="hljs-type">int</span>)</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure><p>å¤šä¸ª.cæ–‡ä»¶çš„æ—¶å€™ï¼Œä¹Ÿå¯ä»¥åªç”¨ä¸€ä¸ª.hå¤´æ–‡ä»¶ï¼Œç„¶åéƒ½åŒ…å«ä¸€ä¸‹è¿™ä¸ª.hæ–‡ä»¶</p><h2 id="6ã€æ–‡ä»¶æ“ä½œ"><a href="#6ã€æ–‡ä»¶æ“ä½œ" class="headerlink" title="6ã€æ–‡ä»¶æ“ä½œ"></a>6ã€æ–‡ä»¶æ“ä½œ</h2><p><a href="https://www.cnblogs.com/wuqianling/p/5340719.html">https://www.cnblogs.com/wuqianling/p/5340719.html</a>è¿™ç¯‡æ–‡ç« å†™çš„å°±ä¸é”™ã€‚</p><p>ä¸»è¦æ˜¯æ–‡ä»¶æ“ä½œåˆ†ä¸ºäºŒè¿›åˆ¶æ–‡ä»¶å’Œæ–‡æœ¬æ–‡ä»¶ï¼Œfopenæ‰“å¼€çš„æ—¶å€™è®¾ç½®æ‰“å¼€æ¨¡å¼ï¼Œè¿”å›å€¼é—®FILE*ç±»å‹çš„ä¸€ä¸ªæ–‡ä»¶æŒ‡é’ˆã€‚é€šè¿‡è¿™ä¸ªæ–‡ä»¶æŒ‡é’ˆå°±å¯ä»¥è®¿é—®è¿™ä¸ªæ–‡ä»¶ã€‚</p><h2 id="7ã€ç¼–ç è§„èŒƒ"><a href="#7ã€ç¼–ç è§„èŒƒ" class="headerlink" title="7ã€ç¼–ç è§„èŒƒ"></a>7ã€ç¼–ç è§„èŒƒ</h2><ul><li>for whileç­‰å…³é”®å­—å’Œæ‹¬å·ä¹‹é—´ç•™å‡ºä¸€ä¸ªç©ºæ ¼ï¼Œçªå‡ºå…³é”®å­—ï¼Œforåå“ªæ€•åªæœ‰ä¸€è¡Œä¹Ÿå†™{}</li><li>æ³¨é‡Šçš„åŒæ–œçº¿ä¹‹åè¦æœ‰ä¸€ä¸ªç©ºæ ¼ï¼Œçªå‡ºæ³¨é‡Š</li><li>å‡½æ•°åå’Œç±»ä½¿ç”¨å¤§é©¼å³°å‘½åæ³•é¦–ä¸ªå•è¯å¤§å†™ï¼Œå˜é‡ä½¿ç”¨å°é©¼å³°å‘½åæ³•ç¬¬ä¸€ä¸ªå­—æ¯å°å†™</li><li>ç±»å’Œå‡½æ•°å†™å®Œä¹‹åè¦ç©ºä¸€è¡Œ</li><li>åˆ†å·ã€é€—å·å‰è¾¹ä¸ç©ºæ ¼ï¼Œåè¾¹ç•™ç©ºæ ¼ã€‚åŒç›®è¿ç®—ç¬¦ä¸¤è¾¹ç•™ç©ºæ ¼</li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;1ã€Cè¯­è¨€çš„ç²¾é«“â€“æŒ‡é’ˆ&quot;&gt;&lt;a href=&quot;#1ã€Cè¯­è¨€çš„ç²¾é«“â€“æŒ‡é’ˆ&quot; class=&quot;headerlink&quot; title=&quot;1ã€Cè¯­è¨€çš„ç²¾é«“â€“æŒ‡é’ˆ&quot;&gt;&lt;/a&gt;1ã€Cè¯­è¨€çš„ç²¾é«“â€“æŒ‡é’ˆ&lt;/h2&gt;&lt;p&gt;æŒ‡é’ˆå°±æ˜¯åœ°å€ï¼Œåœ¨ä¸€å®šç¨‹åº¦ä¸Šå¯ä»¥æŠŠæ•°ç»„åå°±çœ‹æˆä¸€ä¸ªç‰¹æ®Šçš„æŒ‡é’ˆ,æŒ‡é’ˆä¹Ÿå°±</summary>
      
    
    
    
    <category term="Cè¯­è¨€" scheme="http://example.com/categories/C%E8%AF%AD%E8%A8%80/"/>
    
    
    <category term="Cè¯­è¨€" scheme="http://example.com/tags/C%E8%AF%AD%E8%A8%80/"/>
    
  </entry>
  
  <entry>
    <title>procç›®å½•ä¸‹pidå„æ–‡ä»¶ç›®å½•å«ä¹‰</title>
    <link href="http://example.com/posts/proc%E7%9B%AE%E5%BD%95%E4%B8%8Bpid%E5%90%84%E6%96%87%E4%BB%B6%E7%9B%AE%E5%BD%95%E5%90%AB%E4%B9%89.html"/>
    <id>http://example.com/posts/proc%E7%9B%AE%E5%BD%95%E4%B8%8Bpid%E5%90%84%E6%96%87%E4%BB%B6%E7%9B%AE%E5%BD%95%E5%90%AB%E4%B9%89.html</id>
    <published>2024-11-24T15:41:06.000Z</published>
    <updated>2024-11-25T14:44:43.732Z</updated>
    
    <content type="html"><![CDATA[<p>Linux å†…æ ¸æä¾›äº†ä¸€ç§é€šè¿‡ proc æ–‡ä»¶ç³»ç»Ÿï¼Œåœ¨è¿è¡Œæ—¶è®¿é—®å†…æ ¸å†…éƒ¨æ•°æ®ç»“æ„ã€æ”¹å˜å†…æ ¸è®¾ç½®çš„æœºåˆ¶ã€‚proc æ–‡ä»¶ç³»ç»Ÿæ˜¯ä¸€ä¸ªä¼ªæ–‡ä»¶ç³»ç»Ÿï¼Œå®ƒåªå­˜åœ¨å†…å­˜å½“ä¸­ï¼Œè€Œä¸å ç”¨å¤–å­˜ç©ºé—´ã€‚å®ƒä»¥æ–‡ä»¶ç³»ç»Ÿçš„æ–¹å¼ä¸ºè®¿é—®ç³»ç»Ÿå†…æ ¸æ•°æ®çš„æ“ä½œæä¾›æ¥å£ã€‚</p><p>ç”¨æˆ·å’Œåº”ç”¨ç¨‹åºå¯ä»¥é€šè¿‡ proc å¾—åˆ°ç³»ç»Ÿçš„ä¿¡æ¯ï¼Œå¹¶å¯ä»¥æ”¹å˜å†…æ ¸çš„æŸäº›å‚æ•°ã€‚ç”±äºç³»ç»Ÿçš„ä¿¡æ¯ï¼Œå¦‚è¿›ç¨‹ï¼Œæ˜¯åŠ¨æ€æ”¹å˜çš„ï¼Œæ‰€ä»¥ç”¨æˆ·æˆ–åº”ç”¨ç¨‹åºè¯»å– proc æ–‡ä»¶æ—¶ï¼Œproc æ–‡ä»¶ç³»ç»Ÿæ˜¯åŠ¨æ€ä»ç³»ç»Ÿå†…æ ¸è¯»å‡ºæ‰€éœ€ä¿¡æ¯å¹¶æäº¤çš„ã€‚</p><p>ä¸‹é¢åˆ—å‡ºçš„è¿™äº›æ–‡ä»¶æˆ–å­æ–‡ä»¶å¤¹ï¼Œå¹¶ä¸æ˜¯éƒ½æ˜¯åœ¨ä½ çš„ç³»ç»Ÿä¸­å­˜åœ¨ï¼Œè¿™å–å†³äºä½ çš„å†…æ ¸é…ç½®å’Œè£…è½½çš„æ¨¡å—ã€‚å¦å¤–ï¼Œåœ¨ proc ä¸‹è¿˜æœ‰ä¸‰ä¸ªå¾ˆé‡è¦çš„ç›®å½•ï¼šnetï¼Œscsi å’Œ sysã€‚ sys ç›®å½•æ˜¯å¯å†™çš„ï¼Œå¯ä»¥é€šè¿‡å®ƒæ¥è®¿é—®æˆ–ä¿®æ”¹å†…æ ¸çš„å‚æ•°ï¼Œè€Œ net å’Œ scsi åˆ™ä¾èµ–äºå†…æ ¸é…ç½®ã€‚ä¾‹å¦‚ï¼Œå¦‚æœç³»ç»Ÿä¸æ”¯æŒ scsiï¼Œåˆ™ scsi ç›®å½•ä¸å­˜åœ¨ã€‚</p><p>é™¤äº†ä»¥ä¸Šä»‹ç»çš„è¿™äº›ï¼Œè¿˜æœ‰çš„æ˜¯ä¸€äº›ä»¥æ•°å­—å‘½åçš„ç›®å½•ï¼Œå®ƒä»¬æ˜¯è¿›ç¨‹ç›®å½•ã€‚ç³»ç»Ÿä¸­å½“å‰è¿è¡Œçš„æ¯ä¸€ä¸ªè¿›ç¨‹éƒ½æœ‰å¯¹åº”çš„ä¸€ä¸ªç›®å½•åœ¨ proc ä¸‹ï¼Œä»¥è¿›ç¨‹çš„ PID å·ä¸ºç›®å½•åï¼Œå®ƒä»¬æ˜¯è¯»å–è¿›ç¨‹ä¿¡æ¯çš„æ¥å£ã€‚è€Œ self ç›®å½•åˆ™æ˜¯è¯»å–è¿›ç¨‹æœ¬èº«çš„ä¿¡æ¯æ¥å£ï¼Œæ˜¯ä¸€ä¸ª linkã€‚</p><h3 id="proc-pid-auxv"><a href="#proc-pid-auxv" class="headerlink" title="&#x2F;proc&#x2F;[pid]&#x2F;auxv"></a>&#x2F;proc&#x2F;[pid]&#x2F;auxv</h3><p>&#x2F;proc&#x2F;[pid]&#x2F;auxv åŒ…å«ä¼ é€’ç»™è¿›ç¨‹çš„ ELF è§£é‡Šå™¨ä¿¡æ¯ï¼Œæ ¼å¼æ˜¯æ¯ä¸€é¡¹éƒ½æ˜¯ä¸€ä¸ª unsigned longé•¿åº¦çš„ ID åŠ ä¸Šä¸€ä¸ª unsigned long é•¿åº¦çš„å€¼ã€‚æœ€åä¸€é¡¹ä»¥è¿ç»­çš„ä¸¤ä¸ª 0x00 å¼€å¤´ã€‚ä¸¾ä¾‹å¦‚ä¸‹ï¼š</p><blockquote><p>$ hexdump -x &#x2F;proc&#x2F;2406&#x2F;auxv</p><p>0000000    0021    0000    0000    0000    f000    f7fa    7fff    0000<br>0000010    0010    0000    0000    0000    fbff    1f8b    0000    0000<br>0000020    0006    0000    0000    0000    1000    0000    0000    0000<br>0000030    0011    0000    0000    0000    0064    0000    0000    0000<br>0000040    0003    0000    0000    0000    0040    0040    0000    0000<br>0000050    0004    0000    0000    0000    0038    0000    0000    0000<br>0000060    0005    0000    0000    0000    0007    0000    0000    0000<br>0000070    0007    0000    0000    0000    0000    0000    0000    0000<br>0000080    0008    0000    0000    0000    0000    0000    0000    0000<br>0000090    0009    0000    0000    0000    55e0    0045    0000    0000<br>00000a0    000b    0000    0000    0000    0000    0000    0000    0000<br>00000b0    000c    0000    0000    0000    0000    0000    0000    0000<br>00000c0    000d    0000    0000    0000    0000    0000    0000    0000<br>00000d0    000e    0000    0000    0000    0000    0000    0000    0000<br>00000e0    0017    0000    0000    0000    0000    0000    0000    0000<br>00000f0    0019    0000    0000    0000    f079    f7f6    7fff    0000<br>0000100    001f    0000    0000    0000    ffea    f7f6    7fff    0000<br>0000110    000f    0000    0000    0000    f089    f7f6    7fff    0000<br>0000120    0000    0000    0000    0000    0000    0000    0000    0000<br>0000130</p></blockquote><h3 id="proc-pid-cmdline"><a href="#proc-pid-cmdline" class="headerlink" title="&#x2F;proc&#x2F;[pid]&#x2F;cmdline"></a>&#x2F;proc&#x2F;[pid]&#x2F;cmdline</h3><p>&#x2F;proc&#x2F;[pid]&#x2F;cmdline æ˜¯ä¸€ä¸ªåªè¯»æ–‡ä»¶ï¼ŒåŒ…å«è¿›ç¨‹çš„å®Œæ•´å‘½ä»¤è¡Œä¿¡æ¯ã€‚å¦‚æœè¯¥è¿›ç¨‹å·²ç»è¢«äº¤æ¢å‡ºå†…å­˜æˆ–è€…è¿™ä¸ªè¿›ç¨‹æ˜¯ zombie è¿›ç¨‹ï¼Œåˆ™è¿™ä¸ªæ–‡ä»¶æ²¡æœ‰ä»»ä½•å†…å®¹ã€‚è¯¥æ–‡ä»¶ä»¥ç©ºå­—ç¬¦ null è€Œä¸æ˜¯æ¢è¡Œç¬¦ä½œä¸ºç»“æŸæ ‡å¿—ã€‚ä¸¾ä¾‹å¦‚ä¸‹ï¼š</p><blockquote><p>$ ps aux|grep frps<br>root      2406  0.1  0.1  54880 10524 ?        Sl   Dec11  21:30 frps -c .&#x2F;frps.ini</p><p>$ cat &#x2F;proc&#x2F;2406&#x2F;cmdline<br>frps-c.&#x2F;frps.ini</p></blockquote><h3 id="proc-pid-comm"><a href="#proc-pid-comm" class="headerlink" title="&#x2F;proc&#x2F;[pid]&#x2F;comm"></a>&#x2F;proc&#x2F;[pid]&#x2F;comm</h3><p>&#x2F;proc&#x2F;[pid]&#x2F;comm åŒ…å«è¿›ç¨‹çš„å‘½ä»¤åã€‚ä¸¾ä¾‹å¦‚ä¸‹ï¼š</p><blockquote><p>$ cat &#x2F;proc&#x2F;2406&#x2F;comm<br>frps</p></blockquote><h3 id="proc-pid-cwd"><a href="#proc-pid-cwd" class="headerlink" title="&#x2F;proc&#x2F;[pid]&#x2F;cwd"></a>&#x2F;proc&#x2F;[pid]&#x2F;cwd</h3><p>&#x2F;proc&#x2F;[pid]&#x2F;cwd æ˜¯è¿›ç¨‹å½“å‰å·¥ä½œç›®å½•çš„ç¬¦å·é“¾æ¥ã€‚ä¸¾ä¾‹å¦‚ä¸‹ï¼š</p><blockquote><p>$ ls -lt &#x2F;proc&#x2F;2406&#x2F;cwd<br>lrwxrwxrwx 1 root root 0 Dec 12 20:39 &#x2F;proc&#x2F;2406&#x2F;cwd -&gt; &#x2F;home&#x2F;mike&#x2F;frp_0.13.0_linux_amd64</p></blockquote><h3 id="proc-pid-environ"><a href="#proc-pid-environ" class="headerlink" title="&#x2F;proc&#x2F;[pid]&#x2F;environ"></a>&#x2F;proc&#x2F;[pid]&#x2F;environ</h3><p>&#x2F;proc&#x2F;[pid]&#x2F;environ æ˜¾ç¤ºè¿›ç¨‹çš„ç¯å¢ƒå˜é‡ã€‚ä¸¾ä¾‹å¦‚ä¸‹ï¼š</p><blockquote><p>$ strings &#x2F;proc&#x2F;2406&#x2F;environ</p><p>SUPERVISOR_GROUP_NAME&#x3D;ssh<br>TERM&#x3D;linux<br>SUPERVISOR_SERVER_URL&#x3D;unix:&#x2F;&#x2F;&#x2F;var&#x2F;run&#x2F;supervisor.sock<br>SUPERVISOR_PROCESS_NAME&#x3D;ssh<br>RUNLEVEL&#x3D;2<br>UPSTART_EVENTS&#x3D;runlevel<br>PREVLEVEL&#x3D;N<br>PATH&#x3D;&#x2F;usr&#x2F;local&#x2F;sbin:&#x2F;usr&#x2F;local&#x2F;bin:&#x2F;sbin:&#x2F;bin:&#x2F;usr&#x2F;sbin:&#x2F;usr&#x2F;bin<br>UPSTART_INSTANCE&#x3D;<br>UPSTART_JOB&#x3D;rc<br>SUPERVISOR_ENABLED&#x3D;1<br>runlevel&#x3D;2<br>PWD&#x3D;&#x2F;<br>previous&#x3D;N</p></blockquote><h3 id="proc-pid-exe"><a href="#proc-pid-exe" class="headerlink" title="&#x2F;proc&#x2F;[pid]&#x2F;exe"></a>&#x2F;proc&#x2F;[pid]&#x2F;exe</h3><p>&#x2F;proc&#x2F;[pid]&#x2F;exe ä¸ºå®é™…è¿è¡Œç¨‹åºçš„ç¬¦å·é“¾æ¥ã€‚ä¸¾ä¾‹å¦‚ä¸‹ï¼š</p><blockquote><p>$ ls -lt &#x2F;proc&#x2F;2406&#x2F;exe<br>lrwxrwxrwx 1 root root 0 Dec 11 19:00 &#x2F;proc&#x2F;2406&#x2F;exe -&gt; &#x2F;usr&#x2F;bin&#x2F;frps</p></blockquote><h3 id="proc-pid-fd"><a href="#proc-pid-fd" class="headerlink" title="&#x2F;proc&#x2F;[pid]&#x2F;fd"></a>&#x2F;proc&#x2F;[pid]&#x2F;fd</h3><p>&#x2F;proc&#x2F;[pid]&#x2F;fd æ˜¯ä¸€ä¸ªç›®å½•ï¼ŒåŒ…å«è¿›ç¨‹æ‰“å¼€æ–‡ä»¶çš„æƒ…å†µã€‚ä¸¾ä¾‹å¦‚ä¸‹ï¼š</p><blockquote><p>$ ls -lt &#x2F;proc&#x2F;2406&#x2F;fd</p><p>lrwxâ€”â€” 1 root root 64 Dec 24 09:39 77 -&gt; socket:[44377722]<br>lrwxâ€”â€” 1 root root 64 Dec 17 15:07 47 -&gt; socket:[29482617]<br>lr-xâ€”â€” 1 root root 64 Dec 12 20:18 0 -&gt; pipe:[13282]<br>l-wxâ€”â€” 1 root root 64 Dec 12 20:18 1 -&gt; pipe:[13283]<br>lrwxâ€”â€” 1 root root 64 Dec 12 20:18 10 -&gt; socket:[12238218]<br>lrwxâ€”â€” 1 root root 64 Dec 12 20:18 4 -&gt; anon_inode:[eventpoll]<br>lrwxâ€”â€” 1 root root 64 Dec 12 20:18 40 -&gt; socket:[19378614]</p></blockquote><p>ç›®å½•ä¸­çš„æ¯ä¸€é¡¹éƒ½æ˜¯ä¸€ä¸ªç¬¦å·é“¾æ¥ï¼ŒæŒ‡å‘æ‰“å¼€çš„æ–‡ä»¶ï¼Œæ•°å­—åˆ™ä»£è¡¨æ–‡ä»¶æè¿°ç¬¦ã€‚</p><h3 id="proc-pid-latency"><a href="#proc-pid-latency" class="headerlink" title="&#x2F;proc&#x2F;[pid]&#x2F;latency"></a>&#x2F;proc&#x2F;[pid]&#x2F;latency</h3><p>&#x2F;proc&#x2F;[pid]&#x2F;latency æ˜¾ç¤ºå“ªäº›ä»£ç é€ æˆçš„å»¶æ—¶æ¯”è¾ƒå¤§ã€‚å¦‚æœè¦ä½¿ç”¨è¿™ä¸ªç‰¹æ€§éœ€è¦æ‰§è¡Œï¼š</p><blockquote><p>$ echo 1 &gt; &#x2F;proc&#x2F;sys&#x2F;kernel&#x2F;latencytop</p></blockquote><p>ä¸¾ä¾‹å¦‚ä¸‹</p><blockquote><p>$ cat &#x2F;proc&#x2F;2406&#x2F;latency</p><p>Latency Top version : v0.1<br>30667 10650491 4891 poll_schedule_timeout do_sys_poll SyS_poll system_call_fastpath 0x7f636573dc1d<br>8 105 44 futex_wait_queue_me futex_wait do_futex SyS_futex system_call_fastpath 0x7f6365a167bc</p></blockquote><p>æ¯ä¸€è¡Œå‰ä¸‰ä¸ªæ•°å­—åˆ†åˆ«æ˜¯åé¢ä»£ç æ‰§è¡Œçš„æ¬¡æ•°ã€æ€»å…±æ‰§è¡Œå»¶è¿Ÿæ—¶é—´(å•ä½æ˜¯å¾®ç§’)å’Œæœ€é•¿æ‰§è¡Œå»¶è¿Ÿæ—¶é—´(å•ä½æ˜¯å¾®ç§’)ã€‚åé¢åˆ™æ˜¯ä»£ç å®Œæ•´çš„è°ƒç”¨æ ˆã€‚</p><h3 id="proc-pid-maps"><a href="#proc-pid-maps" class="headerlink" title="&#x2F;proc&#x2F;[pid]&#x2F;maps"></a>&#x2F;proc&#x2F;[pid]&#x2F;maps</h3><p>&#x2F;proc&#x2F;[pid]&#x2F;maps æ˜¾ç¤ºè¿›ç¨‹çš„å†…å­˜åŒºåŸŸæ˜ å°„ä¿¡æ¯ã€‚ä¸¾ä¾‹å¦‚ä¸‹ï¼š</p><blockquote><p>$ cat &#x2F;proc&#x2F;2406&#x2F;maps<br>00400000-006ea000 r-xp 00000000 fd:01 1727569                            &#x2F;usr&#x2F;bin&#x2F;frps<br>006ea000-00a6c000 râ€“p 002ea000 fd:01 1727569                            &#x2F;usr&#x2F;bin&#x2F;frps<br>00a6c000-00ab1000 rw-p 0066c000 fd:01 1727569                            &#x2F;usr&#x2F;bin&#x2F;frps<br>00ab1000-00ad4000 rw-p 00000000 00:00 0<br>c000000000-c00000b000 rw-p 00000000 00:00 0<br>c41feac000-c420000000 rw-p 00000000 00:00 0<br>c420000000-c420400000 rw-p 00000000 00:00 0<br>c420400000-c420700000 rw-p 00000000 00:00 0<br>c420700000-c420800000 rw-p 00000000 00:00 0<br>c420800000-c420900000 rw-p 00000000 00:00 0<br>c420900000-c420a00000 rw-p 00000000 00:00 0<br>c420a00000-c421ea0000 rw-p 00000000 00:00 0<br>c421ea0000-c422a00000 rw-p 00000000 00:00 0<br>c422a00000-c422a60000 rw-p 00000000 00:00 0<br>7f0418c01000-7f0418ee1000 rw-p 00000000 00:00 0<br>7ffff7f4f000-7ffff7f70000 rw-p 00000000 00:00 0                          [stack:5121]<br>7ffff7fad000-7ffff7faf000 râ€“p 00000000 00:00 0                          [vvar]<br>7ffff7faf000-7ffff7fb1000 r-xp 00000000 00:00 0                          [vdso]<br>ffffffffff600000-ffffffffff601000 r-xp 00000000 00:00 0                  [vsyscall]</p></blockquote><p>å…¶ä¸­æ³¨æ„çš„ä¸€ç‚¹æ˜¯ [stack:] æ˜¯çº¿ç¨‹çš„å †æ ˆä¿¡æ¯ï¼Œå¯¹åº”äº &#x2F;proc&#x2F;[pid]&#x2F;task&#x2F;[tid]&#x2F; è·¯å¾„ã€‚</p><h3 id="proc-pid-root"><a href="#proc-pid-root" class="headerlink" title="&#x2F;proc&#x2F;[pid]&#x2F;root"></a>&#x2F;proc&#x2F;[pid]&#x2F;root</h3><p>&#x2F;proc&#x2F;[pid]&#x2F;root æ˜¯è¿›ç¨‹æ ¹ç›®å½•çš„ç¬¦å·é“¾æ¥ã€‚ä¸¾ä¾‹å¦‚ä¸‹ï¼š</p><blockquote><p>$  ls -lt &#x2F;proc&#x2F;2406&#x2F;root<br>lrwxrwxrwx 1 root root 0 Dec 12 20:39 &#x2F;proc&#x2F;2406&#x2F;root -&gt; &#x2F;</p></blockquote><h3 id="proc-pid-stack"><a href="#proc-pid-stack" class="headerlink" title="&#x2F;proc&#x2F;[pid]&#x2F;stack"></a>&#x2F;proc&#x2F;[pid]&#x2F;stack</h3><p>&#x2F;proc&#x2F;[pid]&#x2F;stack ç¤ºå½“å‰è¿›ç¨‹çš„å†…æ ¸è°ƒç”¨æ ˆä¿¡æ¯ï¼Œåªæœ‰å†…æ ¸ç¼–è¯‘æ—¶æ‰“å¼€äº† CONFIG_STACKTRACE ç¼–è¯‘é€‰é¡¹ï¼Œæ‰ä¼šç”Ÿæˆè¿™ä¸ªæ–‡ä»¶ã€‚ä¸¾ä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c">$ cat /proc/<span class="hljs-number">2406</span>/<span class="hljs-built_in">stack</span><br>[&lt;ffffffff810fa996&gt;] futex_wait_queue_me+<span class="hljs-number">0xc6</span>/<span class="hljs-number">0x130</span><br>[&lt;ffffffff810fb05d&gt;] futex_wait+<span class="hljs-number">0x17d</span>/<span class="hljs-number">0x270</span><br>[&lt;ffffffff810fd2d5&gt;] do_futex+<span class="hljs-number">0xd5</span>/<span class="hljs-number">0x520</span><br>[&lt;ffffffff810fd791&gt;] SyS_futex+<span class="hljs-number">0x71</span>/<span class="hljs-number">0x150</span><br>[&lt;ffffffff8180cc76&gt;] entry_SYSCALL_64_fastpath+<span class="hljs-number">0x16</span>/<span class="hljs-number">0x75</span><br>[&lt;ffffffffffffffff&gt;] <span class="hljs-number">0xffffffffffffffff</span><br></code></pre></td></tr></table></figure><h3 id="proc-pid-statm"><a href="#proc-pid-statm" class="headerlink" title="&#x2F;proc&#x2F;[pid]&#x2F;statm"></a>&#x2F;proc&#x2F;[pid]&#x2F;statm</h3><p>&#x2F;proc&#x2F;[pid]&#x2F;statm æ˜¾ç¤ºè¿›ç¨‹æ‰€å ç”¨å†…å­˜å¤§å°çš„ç»Ÿè®¡ä¿¡æ¯ã€‚åŒ…å«ä¸ƒä¸ªå€¼ï¼Œåº¦é‡å•ä½æ˜¯ page(pageå¤§å°å¯é€šè¿‡ getconf PAGESIZE å¾—åˆ°)ã€‚ä¸¾ä¾‹å¦‚ä¸‹ï¼š</p><blockquote><p>$  cat &#x2F;proc&#x2F;2406&#x2F;statm<br>13720 2617 493 746 0 12007 0</p></blockquote><p>å„ä¸ªå€¼å«ä¹‰ï¼š</p><blockquote><p>aï¼‰è¿›ç¨‹å ç”¨çš„æ€»çš„å†…å­˜<br>bï¼‰è¿›ç¨‹å½“å‰æ—¶åˆ»å ç”¨çš„ç‰©ç†å†…å­˜<br>cï¼‰åŒå…¶å®ƒè¿›ç¨‹å…±äº«çš„å†…å­˜<br>dï¼‰è¿›ç¨‹çš„ä»£ç æ®µ<br>eï¼‰å…±äº«åº“(ä»2.6ç‰ˆæœ¬èµ·ï¼Œè¿™ä¸ªå€¼ä¸º0)<br>fï¼‰è¿›ç¨‹çš„å †æ ˆ<br>gï¼‰dirty pages(ä»2.6ç‰ˆæœ¬èµ·ï¼Œè¿™ä¸ªå€¼ä¸º0)</p></blockquote><h3 id="proc-pid-status"><a href="#proc-pid-status" class="headerlink" title="&#x2F;proc&#x2F;[pid]&#x2F;status"></a>&#x2F;proc&#x2F;[pid]&#x2F;status</h3><p>&#x2F;proc&#x2F;[pid]&#x2F;status åŒ…å«è¿›ç¨‹çš„çŠ¶æ€ä¿¡æ¯ã€‚å…¶å¾ˆå¤šå†…å®¹ä¸ &#x2F;proc&#x2F;[pid]&#x2F;stat å’Œ &#x2F;proc&#x2F;[pid]&#x2F;statm ç›¸åŒï¼Œä½†æ˜¯å´æ˜¯ä»¥ä¸€ç§æ›´æ¸…æ™°åœ°æ–¹å¼å±•ç°å‡ºæ¥ã€‚ä¸¾ä¾‹å¦‚ä¸‹ï¼š</p><blockquote><p>$ cat &#x2F;proc&#x2F;2406&#x2F;status<br>Name:   frps<br>State:  S (sleeping)<br>Tgid:   2406<br>Ngid:   0<br>Pid:    2406<br>PPid:   2130<br>TracerPid:  0<br>Uid:    0   0   0   0<br>Gid:    0   0   0   0<br>FDSize: 128<br>Groups: 0<br>NStgid: 2406<br>NSpid:  2406<br>NSpgid: 2406<br>NSsid:  2130<br>VmPeak:    54880 kB<br>VmSize:    54880 kB<br>VmLck:         0 kB<br>VmPin:         0 kB<br>VmHWM:     34872 kB<br>VmRSS:     10468 kB<br>VmData:    47896 kB<br>VmStk:       132 kB<br>VmExe:      2984 kB<br>VmLib:         0 kB<br>VmPTE:        68 kB<br>VmPMD:        20 kB<br>VmSwap:        0 kB<br>HugetlbPages:          0 kB<br>Threads:    11<br>SigQ:   0&#x2F;31834<br>SigPnd: 0000000000000000<br>ShdPnd: 0000000000000000<br>SigBlk: 0000000000000000<br>SigIgn: 0000000000000000<br>SigCgt: fffffffe7fc1feff<br>CapInh: 0000000000000000<br>CapPrm: 0000003fffffffff<br>CapEff: 0000003fffffffff<br>CapBnd: 0000003fffffffff<br>CapAmb: 0000000000000000<br>Seccomp:    0<br>Cpus_allowed:   f<br>Cpus_allowed_list:  0-3<br>Mems_allowed:   00000000,00000001<br>Mems_allowed_list:  0<br>voluntary_ctxt_switches:    2251028<br>nonvoluntary_ctxt_switches: 18031</p></blockquote><p>å…³äºä¿¡å·ï¼ˆsignalï¼‰çš„ä¿¡æ¯ï¼šSigQ åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼ˆä¾‹å¦‚ 0&#x2F;31834ï¼‰ï¼Œå‰é¢è¡¨ç¤ºå½“å‰å¤„åœ¨é˜Ÿåˆ—ä¸­çš„ä¿¡å·ï¼ˆ0ï¼‰ï¼Œåé¢åˆ™è¡¨ç¤ºé˜Ÿåˆ—ä¸€å…±å¯ä»¥å­˜å‚¨å¤šå°‘ä¿¡å·ï¼ˆ31834ï¼‰ï¼›SigPnd è¡¨ç¤ºå½“å‰çº¿ç¨‹ pending çš„ä¿¡å·ï¼Œè€ŒShdPnd åˆ™è¡¨ç¤ºæ•´ä¸ªè¿›ç¨‹ pending çš„ä¿¡å·ï¼›SigBlkã€SigIgn å’Œ SigCgt åˆ†åˆ«è¡¨ç¤ºå¯¹ä¿¡å·çš„å¤„ç†æ˜¯é˜»å¡ï¼Œå¿½ç•¥ï¼Œè¿˜æ˜¯æ•è·ã€‚ï¼ˆå…³äºUnixä¿¡å·çš„ç›¸å…³çŸ¥è¯†ï¼Œå¯ä»¥å‚è€ƒ Unix: Dealing with signalsï¼‰ã€‚</p><h3 id="proc-pid-syscall"><a href="#proc-pid-syscall" class="headerlink" title="&#x2F;proc&#x2F;[pid]&#x2F;syscall"></a>&#x2F;proc&#x2F;[pid]&#x2F;syscall</h3><p>&#x2F;proc&#x2F;[pid]&#x2F;syscall æ˜¾ç¤ºå½“å‰è¿›ç¨‹æ­£åœ¨æ‰§è¡Œçš„ç³»ç»Ÿè°ƒç”¨ã€‚ä¸¾ä¾‹å¦‚ä¸‹ï¼š</p><blockquote><p>$ cat &#x2F;proc&#x2F;2406&#x2F;syscall<br>202 0xab3730 0x0 0x0 0x0 0x0 0x0 0x7ffff7f6ec68 0x455bb3</p></blockquote><p>ç¬¬ä¸€ä¸ªå€¼æ˜¯ç³»ç»Ÿè°ƒç”¨å·ï¼ˆ202ä»£è¡¨pollï¼‰ï¼Œåé¢è·Ÿç€ 6 ä¸ªç³»ç»Ÿè°ƒç”¨çš„å‚æ•°å€¼ï¼ˆä½äºå¯„å­˜å™¨ä¸­ï¼‰ï¼Œæœ€åä¸¤ä¸ªå€¼ä¾æ¬¡æ˜¯å †æ ˆæŒ‡é’ˆå’ŒæŒ‡ä»¤è®¡æ•°å™¨çš„å€¼ã€‚å¦‚æœå½“å‰è¿›ç¨‹è™½ç„¶é˜»å¡ï¼Œä½†é˜»å¡å‡½æ•°å¹¶ä¸æ˜¯ç³»ç»Ÿè°ƒç”¨ï¼Œåˆ™ç³»ç»Ÿè°ƒç”¨å·çš„å€¼ä¸º -1ï¼Œåé¢åªæœ‰å †æ ˆæŒ‡é’ˆå’ŒæŒ‡ä»¤è®¡æ•°å™¨çš„å€¼ã€‚å¦‚æœè¿›ç¨‹æ²¡æœ‰é˜»å¡ï¼Œåˆ™è¿™ä¸ªæ–‡ä»¶åªæœ‰ä¸€ä¸ª running  çš„å­—ç¬¦ä¸²ã€‚</p><p>å†…æ ¸ç¼–è¯‘æ—¶æ‰“å¼€äº† CONFIG_HAVE_ARCH_TRACEHOOK ç¼–è¯‘é€‰é¡¹ï¼Œæ‰ä¼šç”Ÿæˆè¿™ä¸ªæ–‡ä»¶ã€‚</p><h3 id="proc-pid-wchan"><a href="#proc-pid-wchan" class="headerlink" title="&#x2F;proc&#x2F;[pid]&#x2F;wchan"></a>&#x2F;proc&#x2F;[pid]&#x2F;wchan</h3><p>&#x2F;proc&#x2F;[pid]&#x2F;wchan æ˜¾ç¤ºå½“è¿›ç¨‹ sleep æ—¶ï¼Œkernel å½“å‰è¿è¡Œçš„å‡½æ•°ã€‚ä¸¾ä¾‹å¦‚ä¸‹ï¼š</p><blockquote><p>$ cat &#x2F;proc&#x2F;2406&#x2F;wchan<br>futex_wait_queue_meadmin</p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;Linux å†…æ ¸æä¾›äº†ä¸€ç§é€šè¿‡ proc æ–‡ä»¶ç³»ç»Ÿï¼Œåœ¨è¿è¡Œæ—¶è®¿é—®å†…æ ¸å†…éƒ¨æ•°æ®ç»“æ„ã€æ”¹å˜å†…æ ¸è®¾ç½®çš„æœºåˆ¶ã€‚proc æ–‡ä»¶ç³»ç»Ÿæ˜¯ä¸€ä¸ªä¼ªæ–‡ä»¶ç³»ç»Ÿï¼Œå®ƒåªå­˜åœ¨å†…å­˜å½“ä¸­ï¼Œè€Œä¸å ç”¨å¤–å­˜ç©ºé—´ã€‚å®ƒä»¥æ–‡ä»¶ç³»ç»Ÿçš„æ–¹å¼ä¸ºè®¿é—®ç³»ç»Ÿå†…æ ¸æ•°æ®çš„æ“ä½œæä¾›æ¥å£ã€‚&lt;/p&gt;
&lt;p&gt;ç”¨æˆ·å’Œåº”ç”¨ç¨‹åºå¯ä»¥é€šè¿‡ proc</summary>
      
    
    
    
    <category term="Linux" scheme="http://example.com/categories/Linux/"/>
    
    
    <category term="Linux" scheme="http://example.com/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>æŸ¥æ‰¾å†…æ ¸ç¬¦å·</title>
    <link href="http://example.com/posts/%E6%9F%A5%E6%89%BE%E5%86%85%E6%A0%B8%E7%AC%A6%E5%8F%B7.html"/>
    <id>http://example.com/posts/%E6%9F%A5%E6%89%BE%E5%86%85%E6%A0%B8%E7%AC%A6%E5%8F%B7.html</id>
    <published>2024-11-24T15:39:23.000Z</published>
    <updated>2024-11-25T14:44:57.381Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ä¸€ã€-proc-kallsyms"><a href="#ä¸€ã€-proc-kallsyms" class="headerlink" title="ä¸€ã€&#x2F;proc&#x2F;kallsyms"></a>ä¸€ã€&#x2F;proc&#x2F;kallsyms</h1><p>  å†…æ ¸ç¬¦å·å¯ä»¥é€šè¿‡&#x2F;proc&#x2F;kallsymsæŸ¥çœ‹ã€‚</p><p><img src="https://raw.githubusercontent.com/mengchao666/picture/main/blog20241124233848.png"></p><h3 id="1-ç¬¦å·ç±»å‹è¯´æ˜"><a href="#1-ç¬¦å·ç±»å‹è¯´æ˜" class="headerlink" title="(1)ç¬¦å·ç±»å‹è¯´æ˜"></a>(1)ç¬¦å·ç±»å‹è¯´æ˜</h3><p>  åœ¨Linuxå†…æ ¸ä¸­ï¼Œkallsymsæ˜¯ä¸€ä¸ªç¬¦å·è¡¨ï¼Œå®ƒåŒ…å«äº†å†…æ ¸ä¸­æ‰€æœ‰çš„ç¬¦å·ä¿¡æ¯ï¼ŒåŒ…æ‹¬å‡½æ•°ã€å˜é‡ã€å¸¸é‡ç­‰ç­‰ã€‚è¿™äº›ç¬¦å·ä¿¡æ¯å¯ä»¥è¢«å†…æ ¸æ¨¡å—å’Œå…¶ä»–ç¨‹åºä½¿ç”¨ï¼Œè¿™äº›ç¬¦å·ç±»å‹å¯ä»¥å¸®åŠ©å¼€å‘äººå‘˜æ›´å¥½åœ°ç†è§£å†…æ ¸ä¸­çš„ç¬¦å·ä¿¡æ¯ï¼Œä»è€Œæ›´å¥½åœ°è¿›è¡Œå†…æ ¸å¼€å‘å’Œè°ƒè¯•ã€‚</p><p>åœ¨kallsymsä¸­ï¼Œæ¯ä¸ªç¬¦å·éƒ½æœ‰ä¸€ä¸ªç±»å‹ï¼Œè¡¨ç¤ºå®ƒçš„ç”¨é€”ã€‚ä¸‹é¢æ˜¯ä¸€äº›å¸¸è§çš„ç¬¦å·ç±»å‹ï¼š</p><ul><li>Tï¼šè¡¨ç¤ºè¯¥ç¬¦å·æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå¯ä»¥è¢«å…¶ä»–ä»£ç è°ƒç”¨ã€‚</li><li>tï¼šè¡¨ç¤ºè¯¥ç¬¦å·æ˜¯ä¸€ä¸ªå±€éƒ¨å‡½æ•°ï¼Œåªèƒ½åœ¨å½“å‰æ–‡ä»¶ä¸­ä½¿ç”¨ã€‚</li><li>Dï¼šè¡¨ç¤ºè¯¥ç¬¦å·æ˜¯ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œå¯ä»¥è¢«å…¶ä»–ä»£ç è®¿é—®å’Œä¿®æ”¹ã€‚</li><li>dï¼šè¡¨ç¤ºè¯¥ç¬¦å·æ˜¯ä¸€ä¸ªå±€éƒ¨å˜é‡ï¼Œåªèƒ½åœ¨å½“å‰æ–‡ä»¶ä¸­ä½¿ç”¨ã€‚</li><li>Rï¼šè¡¨ç¤ºè¯¥ç¬¦å·æ˜¯ä¸€ä¸ªåªè¯»å˜é‡ï¼Œä¸èƒ½è¢«ä¿®æ”¹ã€‚</li><li>rï¼šè¡¨ç¤ºè¯¥ç¬¦å·æ˜¯ä¸€ä¸ªåªè¯»å±€éƒ¨å˜é‡ï¼Œåªèƒ½åœ¨å½“å‰æ–‡ä»¶ä¸­ä½¿ç”¨</li><li>Aï¼šè¡¨ç¤ºè¯¥ç¬¦å·æ˜¯ä¸€ä¸ªå¯è¯»å†™çš„å˜é‡ï¼Œå¯ä»¥è¢«å…¶ä»–ä»£ç è®¿é—®å’Œä¿®æ”¹ã€‚</li><li>aï¼šè¡¨ç¤ºè¯¥ç¬¦å·æ˜¯ä¸€ä¸ªå¯è¯»å†™çš„å±€éƒ¨å˜é‡ï¼Œåªèƒ½åœ¨å½“å‰æ–‡ä»¶ä¸­ä½¿ç”¨ã€‚</li><li>Bï¼šè¡¨ç¤ºè¯¥ç¬¦å·æ˜¯ä¸€ä¸ªæœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡ï¼Œå®ƒçš„å€¼åœ¨ç¨‹åºå¯åŠ¨æ—¶è¢«åˆå§‹åŒ–ä¸º0ã€‚</li><li>bï¼šè¡¨ç¤ºè¯¥ç¬¦å·æ˜¯ä¸€ä¸ªæœªåˆå§‹åŒ–çš„å±€éƒ¨å˜é‡ï¼Œå®ƒçš„å€¼åœ¨ç¨‹åºå¯åŠ¨æ—¶è¢«åˆå§‹åŒ–ä¸º0ã€‚</li><li>Gï¼šè¡¨ç¤ºè¯¥ç¬¦å·æ˜¯ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œä½†æ˜¯å®ƒçš„å€¼åœ¨ç¨‹åºè¿è¡Œæ—¶å¯èƒ½ä¼šè¢«ä¿®æ”¹ã€‚</li><li>Cï¼šè¡¨ç¤ºè¯¥ç¬¦å·æ˜¯ä¸€ä¸ªå¸¸é‡ï¼Œå®ƒçš„å€¼åœ¨ç¨‹åºè¿è¡Œæ—¶ä¸èƒ½è¢«ä¿®æ”¹ã€‚</li><li>Wï¼šè¡¨ç¤ºè¯¥ç¬¦å·æ˜¯ä¸€ä¸ªå¼±ç¬¦å·ï¼Œ</li><li>?: è¡¨ç¤ºè¯¥ç¬¦å·çš„ç±»å‹æœªçŸ¥ã€‚</li></ul><h3 id="2-å¼±ç¬¦å·"><a href="#2-å¼±ç¬¦å·" class="headerlink" title="(2)å¼±ç¬¦å·"></a>(2)å¼±ç¬¦å·</h3><p>å…³äºå¼±ç¬¦å·çš„ä¸€äº›è¯´æ˜ï¼š__weak æ˜¯ä¸€ä¸ªå…³é”®å­—ï¼Œç”¨äºå£°æ˜ä¸€ä¸ªå¼±ç¬¦å·ã€‚åœ¨ C è¯­è¨€ä¸­ï¼Œå¦‚æœä¸€ä¸ªç¬¦å·è¢«å®šä¹‰äº†å¤šæ¬¡ï¼Œç¼–è¯‘å™¨ä¼šæŠ¥é”™ã€‚ä½†æ˜¯ï¼Œå¦‚æœä¸€ä¸ªç¬¦å·è¢«å£°æ˜ä¸ºå¼±ç¬¦å·ï¼Œé‚£ä¹ˆç¼–è¯‘å™¨å°±ä¸ä¼šæŠ¥é”™ï¼Œè€Œæ˜¯åœ¨é“¾æ¥æ—¶é€‰æ‹©å…¶ä¸­ä¸€ä¸ªç¬¦å·ä½œä¸ºæœ€ç»ˆçš„ç¬¦å·ã€‚è¿™ä¸ªç‰¹æ€§åœ¨ç¼–å†™åº“æ—¶éå¸¸æœ‰ç”¨ï¼Œå› ä¸ºå®ƒå…è®¸ç”¨æˆ·åœ¨é“¾æ¥æ—¶è¦†ç›–åº“ä¸­çš„å‡½æ•°ã€‚</p><p>å¦‚ä¸‹ä¸ºä¸€ä¸ªä¾‹å­ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * probe_kernel_read(): safely attempt to read from a location</span><br><span class="hljs-comment"> * @dst: pointer to the buffer that shall take the data</span><br><span class="hljs-comment"> * @src: address to read from</span><br><span class="hljs-comment"> * @size: size of the data chunk</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Safely read from address @src to the buffer at @dst.  If a kernel fault</span><br><span class="hljs-comment"> * happens, handle that and return -EFAULT.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * We ensure that the copy_from_user is executed in atomic context so that</span><br><span class="hljs-comment"> * do_page_fault() doesn&#x27;t attempt to take mmap_sem.  This makes</span><br><span class="hljs-comment"> * probe_kernel_read() suitable for use within regions where the caller</span><br><span class="hljs-comment"> * already holds mmap_sem, or other locks which nest inside mmap_sem.</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-type">long</span> __weak <span class="hljs-title function_">probe_kernel_read</span><span class="hljs-params">(<span class="hljs-type">void</span> *dst, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *src, <span class="hljs-type">size_t</span> size)</span><br>    __<span class="hljs-title function_">attribute__</span><span class="hljs-params">((alias(<span class="hljs-string">&quot;__probe_kernel_read&quot;</span>)))</span>;<br><br><span class="hljs-type">long</span> __probe_kernel_read(<span class="hljs-type">void</span> *dst, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *src, <span class="hljs-type">size_t</span> size)<br>&#123;<br>        <span class="hljs-type">long</span> ret;<br>        <span class="hljs-type">mm_segment_t</span> old_fs = get_fs();<br><br>        set_fs(KERNEL_DS);<br>        pagefault_disable();<br>        ret = __copy_from_user_inatomic(dst,<br>                        (__force <span class="hljs-type">const</span> <span class="hljs-type">void</span> __user *)src, size);<br>        pagefault_enable();<br>        set_fs(old_fs);<br><br>        <span class="hljs-keyword">return</span> ret ? -EFAULT : <span class="hljs-number">0</span>;<br>&#125;<br>EXPORT_SYMBOL_GPL(probe_kernel_read);<br></code></pre></td></tr></table></figure><h3 id="3-å†…æ ¸é©±åŠ¨è·å–ç¬¦å·åœ°å€"><a href="#3-å†…æ ¸é©±åŠ¨è·å–ç¬¦å·åœ°å€" class="headerlink" title="(3)å†…æ ¸é©±åŠ¨è·å–ç¬¦å·åœ°å€"></a>(3)å†…æ ¸é©±åŠ¨è·å–ç¬¦å·åœ°å€</h3><p>ç¬¦å·å­˜åœ¨äº&#x2F;proc&#x2F;kallsyms æ–‡ä»¶ä¸­ï¼Œå¯ä»¥é€šè¿‡kallsyms_lookup_nameè·å–å…¶ç¬¦å·çš„åœ°å€ã€‚åœ¨å†…æ ¸ç‰ˆæœ¬ 2.6.33 - 5.7.0 å¯ä»¥ç”¨kallsyms_lookup_nameæ¥è·å–è¯¥å‡½æ•°çš„åœ°å€ã€‚åœ¨å†…æ ¸2.6.33 ä»¥ä¸‹å’Œ 5.7.0 ä»¥ä¸Šå¯ä»¥ç”¨ kprobe æ¥è·å–è¯¥å‡½æ•°çš„åœ°å€</p><p>kallsyms_lookup_nameæ˜¯å†…æ ¸APIï¼Œæºç å¦‚ä¸‹ï¼š</p><p>ä½¿ç”¨kallsyms_lookup_nameå‡½æ•°éœ€è¦<code>#include &lt;linux/kallsyms.h&gt;</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-comment">/* Lookup the address for this symbol. Returns 0 if not found. */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-title function_">kallsyms_lookup_name</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *name)</span><br>&#123;<br>        <span class="hljs-type">char</span> namebuf[KSYM_NAME_LEN];<br>        <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> i;<br>        <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> off;<br><br>        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, off = <span class="hljs-number">0</span>; i &lt; kallsyms_num_syms; i++) &#123;<br>                off = kallsyms_expand_symbol(off, namebuf, ARRAY_SIZE(namebuf));<br><br>                <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(namebuf, name) == <span class="hljs-number">0</span>)<br>                        <span class="hljs-keyword">return</span> kallsyms_sym_address(i);<br>        &#125;<br>        <span class="hljs-keyword">return</span> module_kallsyms_lookup_name(name);<br>&#125;<br>EXPORT_SYMBOL_GPL(kallsyms_lookup_name);<br></code></pre></td></tr></table></figure><p>ä¸Šè¿°å‡½æ•°å¯ä»¥ä½¿ç”¨ç¬¦å·åæ‰¾åˆ°åœ¨å†…æ ¸ä¸­çš„åœ°å€ï¼Œä½¿ç”¨è¯¥æ–¹æ³•å¯ä»¥ä½¿ç”¨å†…æ ¸ä¸­æœªå¯¼å‡ºçš„å†…æ ¸å‡½æ•°ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * text_poke - Update instructions on a live kernel</span><br><span class="hljs-comment"> * @addr: address to modify</span><br><span class="hljs-comment"> * @opcode: source of the copy</span><br><span class="hljs-comment"> * @len: length to copy</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Only atomic text poke/set should be allowed when not doing early patching.</span><br><span class="hljs-comment"> * It means the size must be writable atomically and the address must be aligned</span><br><span class="hljs-comment"> * in a way that permits an atomic write. It also makes sure we fit on a single</span><br><span class="hljs-comment"> * page.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">void</span> *<span class="hljs-title function_">text_poke</span><span class="hljs-params">(<span class="hljs-type">void</span> *addr, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *opcode, <span class="hljs-type">size_t</span> len)</span><br>&#123;<br>        <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> flags;<br>        <span class="hljs-type">char</span> *vaddr;<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">pages</span>[2];</span><br>        <span class="hljs-type">int</span> i;<br><br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">         * While boot memory allocator is runnig we cannot use struct</span><br><span class="hljs-comment">         * pages as they are not yet initialized.</span><br><span class="hljs-comment">         */</span><br>        BUG_ON(!after_bootmem);<br><br>        lockdep_assert_held(&amp;text_mutex);<br><br>        <span class="hljs-keyword">if</span> (!core_kernel_text((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)addr)) &#123;<br>                pages[<span class="hljs-number">0</span>] = vmalloc_to_page(addr);<br>                pages[<span class="hljs-number">1</span>] = vmalloc_to_page(addr + PAGE_SIZE);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>                pages[<span class="hljs-number">0</span>] = virt_to_page(addr);<br>                WARN_ON(!PageReserved(pages[<span class="hljs-number">0</span>]));<br>                pages[<span class="hljs-number">1</span>] = virt_to_page(addr + PAGE_SIZE);<br>        &#125;<br>        BUG_ON(!pages[<span class="hljs-number">0</span>]);<br>        local_irq_save(flags);<br>        set_fixmap(FIX_TEXT_POKE0, page_to_phys(pages[<span class="hljs-number">0</span>]));<br>        <span class="hljs-keyword">if</span> (pages[<span class="hljs-number">1</span>])<br>                set_fixmap(FIX_TEXT_POKE1, page_to_phys(pages[<span class="hljs-number">1</span>]));<br>        vaddr = (<span class="hljs-type">char</span> *)fix_to_virt(FIX_TEXT_POKE0);<br>        <span class="hljs-built_in">memcpy</span>(&amp;vaddr[(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)addr &amp; ~PAGE_MASK], opcode, len);<br>        clear_fixmap(FIX_TEXT_POKE0);<br>        <span class="hljs-keyword">if</span> (pages[<span class="hljs-number">1</span>])<br>                clear_fixmap(FIX_TEXT_POKE1);<br>        local_flush_tlb();<br>        sync_core();<br>        <span class="hljs-comment">/* Could also do a CLFLUSH here to speed up CPU recovery; but</span><br><span class="hljs-comment">           that causes hangs on some VIA CPUs. */</span><br>        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; len; i++)<br>                BUG_ON(((<span class="hljs-type">char</span> *)addr)[i] != ((<span class="hljs-type">char</span> *)opcode)[i]);<br>        local_irq_restore(flags);<br>        <span class="hljs-keyword">return</span> addr;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>text_poke</code>ä¸ºéå¯¼å‡ºå‡½æ•°ï¼Œåœ¨é©±åŠ¨ä¸­æ— æ³•ä½¿ç”¨ï¼Œå¯ä»¥ä½¿ç”¨<code>kallsyms_lookup_name</code>è·å–å‡½æ•°åœ°å€å¹¶èµ‹å€¼ç»™å‡½æ•°æŒ‡é’ˆï¼Œä¾¿å¯ä»¥ä½¿ç”¨è¯¥å‡½æ•°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">void</span> *(*text_poke_fn)(<span class="hljs-type">void</span> *addr, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *opcode, <span class="hljs-type">size_t</span> len);<br>text_poke_fn = (<span class="hljs-type">void</span> *(*)(<span class="hljs-type">void</span> *, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *, <span class="hljs-type">size_t</span>))kallsyms_lookup_nama(<span class="hljs-string">&quot;text_poke&quot;</span>);<br></code></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;ä¸€ã€-proc-kallsyms&quot;&gt;&lt;a href=&quot;#ä¸€ã€-proc-kallsyms&quot; class=&quot;headerlink&quot; title=&quot;ä¸€ã€&amp;#x2F;proc&amp;#x2F;kallsyms&quot;&gt;&lt;/a&gt;ä¸€ã€&amp;#x2F;proc&amp;#x2F;kallsyms&lt;/</summary>
      
    
    
    
    <category term="Linux" scheme="http://example.com/categories/Linux/"/>
    
    
    <category term="Linux" scheme="http://example.com/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>OOM</title>
    <link href="http://example.com/posts/OOM.html"/>
    <id>http://example.com/posts/OOM.html</id>
    <published>2024-11-24T15:37:20.000Z</published>
    <updated>2024-11-24T15:37:36.757Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨Linuxæ“ä½œç³»ç»Ÿä¸­ï¼ŒOOMï¼ˆOut of Memoryï¼‰æŒ‡çš„æ˜¯ç³»ç»Ÿå¯ç”¨å†…å­˜è€—å°½ï¼Œæ— æ³•å†ä¸ºä»»ä½•è¿›ç¨‹åˆ†é…æ‰€éœ€çš„å†…å­˜ï¼Œä»è€Œå¯¼è‡´ç³»ç»Ÿå¿…é¡»é‡‡å–æŸäº›æç«¯æªæ–½çš„æƒ…å†µã€‚å½“ç³»ç»Ÿé¢ä¸´OOMæ—¶ï¼Œå¯èƒ½ä¼šé€‰æ‹©æ€æ­»æŸäº›è¿›ç¨‹ä»¥é‡Šæ”¾å†…å­˜ï¼Œè¿™æ˜¯é€šè¿‡Linuxå†…æ ¸çš„OOM Killeræœºåˆ¶å®ç°çš„ã€‚</p><h3 id="OOMå‘ç”Ÿçš„åŸå› ï¼š"><a href="#OOMå‘ç”Ÿçš„åŸå› ï¼š" class="headerlink" title="OOMå‘ç”Ÿçš„åŸå› ï¼š"></a>OOMå‘ç”Ÿçš„åŸå› ï¼š</h3><ol><li><strong>ç‰©ç†å†…å­˜ä¸è¶³</strong>ï¼šå®é™…ç‰©ç†å†…å­˜èµ„æºè€—å°½ï¼Œæ— æ³•æ»¡è¶³æ‰€æœ‰è¿›ç¨‹çš„å†…å­˜éœ€æ±‚ï¼Œå°¤å…¶æ˜¯å½“å¤§é‡è¿›ç¨‹åŒæ—¶è¿è¡Œä¸”å†…å­˜å ç”¨è¾ƒå¤§æ—¶æ›´å®¹æ˜“å‡ºç°ã€‚</li><li><strong>äº¤æ¢ç©ºé—´ä¸è¶³</strong>ï¼šå³ä½¿æœ‰äº¤æ¢åˆ†åŒºï¼ˆSwapï¼‰ï¼Œä½†å½“ç³»ç»Ÿè¯•å›¾å°†ç‰©ç†å†…å­˜ä¸­çš„é¡µæ¢å‡ºåˆ°äº¤æ¢ç©ºé—´æ—¶ï¼Œå‘ç°äº¤æ¢ç©ºé—´ä¹Ÿå·²æ»¡ï¼Œæ— æ³•ç»§ç»­è¿›è¡Œå†…å­˜äº¤æ¢ã€‚</li><li><strong>å†…å­˜æ³„æ¼</strong>ï¼šåº”ç”¨ç¨‹åºå­˜åœ¨å†…å­˜æ³„æ¼é—®é¢˜ï¼Œéšç€æ—¶é—´æ¨ç§»ä¸æ–­æ¶ˆè€—å†…å­˜ï¼Œç›´è‡³è€—å°½æ•´ä¸ªç³»ç»Ÿèµ„æºã€‚</li><li><strong>ä¸€æ¬¡æ€§åŠ è½½å¤§é‡æ•°æ®</strong>ï¼šæŸä¸ªè¿›ç¨‹ç¬é—´è¯·æ±‚å¤§é‡å†…å­˜ï¼Œè¶…å‡ºäº†ç³»ç»Ÿæ‰€èƒ½æä¾›çš„èŒƒå›´ã€‚</li><li><strong>å†…å­˜é™åˆ¶</strong>ï¼šåœ¨å®¹å™¨ç¯å¢ƒä¸‹ï¼Œå•ä¸ªå®¹å™¨å¯èƒ½å­˜åœ¨ä¸¥æ ¼çš„å†…å­˜é™åˆ¶ï¼Œè¶…å‡ºé™åˆ¶åä¹Ÿä¼šè§¦å‘OOMã€‚</li></ol>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;åœ¨Linuxæ“ä½œç³»ç»Ÿä¸­ï¼ŒOOMï¼ˆOut of Memoryï¼‰æŒ‡çš„æ˜¯ç³»ç»Ÿå¯ç”¨å†…å­˜è€—å°½ï¼Œæ— æ³•å†ä¸ºä»»ä½•è¿›ç¨‹åˆ†é…æ‰€éœ€çš„å†…å­˜ï¼Œä»è€Œå¯¼è‡´ç³»ç»Ÿå¿…é¡»é‡‡å–æŸäº›æç«¯æªæ–½çš„æƒ…å†µã€‚å½“ç³»ç»Ÿé¢ä¸´OOMæ—¶ï¼Œå¯èƒ½ä¼šé€‰æ‹©æ€æ­»æŸäº›è¿›ç¨‹ä»¥é‡Šæ”¾å†…å­˜ï¼Œè¿™æ˜¯é€šè¿‡Linuxå†…æ ¸çš„OOM Killeræœºåˆ¶å®ç°çš„ã€‚&lt;/p&gt;</summary>
      
    
    
    
    <category term="Linux" scheme="http://example.com/categories/Linux/"/>
    
    
    <category term="Linux" scheme="http://example.com/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>ftpget</title>
    <link href="http://example.com/posts/ftpget.html"/>
    <id>http://example.com/posts/ftpget.html</id>
    <published>2024-11-24T15:31:27.000Z</published>
    <updated>2024-11-24T15:35:20.228Z</updated>
    
    <content type="html"><![CDATA[<p>ftpget -u  username -p passwd IP  source  target</p><p>ftpput -u  username -p passwd IP  target  source</p><p>ä¸¾ä¸ªä¾‹å­ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">ftpput -u zhangsan -p 000000 192.168.10.10 target.txt source.txt   <br>// å°†æœ¬åœ°çš„ source.txt æ–‡ä»¶ä¼ è¾“åˆ° 192.168.10.10 /home/zhangsan/ ç›®å½•ä¸‹ï¼Œå¹¶ä»¥target.txt ä¿å­˜<br></code></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;ftpget -u  username -p passwd IP  source  target&lt;/p&gt;
&lt;p&gt;ftpput -u  username -p passwd IP  target  source&lt;/p&gt;
&lt;p&gt;ä¸¾ä¸ªä¾‹å­ï¼š&lt;/p&gt;
&lt;figure class=&quot;</summary>
      
    
    
    
    <category term="Linuxå·¥å…·" scheme="http://example.com/categories/Linux%E5%B7%A5%E5%85%B7/"/>
    
    
    <category term="Linuxå·¥å…·" scheme="http://example.com/tags/Linux%E5%B7%A5%E5%85%B7/"/>
    
  </entry>
  
  <entry>
    <title>scp</title>
    <link href="http://example.com/posts/scp.html"/>
    <id>http://example.com/posts/scp.html</id>
    <published>2024-11-24T15:30:53.000Z</published>
    <updated>2024-11-24T15:34:55.284Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ä¸€ã€ä»æœ¬åœ°å¤åˆ¶åˆ°è¿œç¨‹ä¸»æœº"><a href="#ä¸€ã€ä»æœ¬åœ°å¤åˆ¶åˆ°è¿œç¨‹ä¸»æœº" class="headerlink" title="ä¸€ã€ä»æœ¬åœ°å¤åˆ¶åˆ°è¿œç¨‹ä¸»æœº"></a>ä¸€ã€ä»æœ¬åœ°å¤åˆ¶åˆ°è¿œç¨‹ä¸»æœº</h2><p>å‘½ä»¤æ ¼å¼å¦‚ä¸‹ï¼š</p><p>scp &#x2F;path&#x2F;to&#x2F;local&#x2F;file.txt user@remote_host:&#x2F;path&#x2F;on&#x2F;remote&#x2F;</p><p>è¿™ä¼šå°†æœ¬åœ°çš„ <code>file.txt</code> æ–‡ä»¶å¤åˆ¶åˆ°è¿œç¨‹ä¸»æœº <code>remote_host</code> çš„ <code>/path/on/remote/</code> ç›®å½•ä¸‹ã€‚</p><h3 id="äºŒã€ä»è¿œç¨‹ä¸»æœºå¤åˆ¶åˆ°æœ¬åœ°"><a href="#äºŒã€ä»è¿œç¨‹ä¸»æœºå¤åˆ¶åˆ°æœ¬åœ°" class="headerlink" title="äºŒã€ä»è¿œç¨‹ä¸»æœºå¤åˆ¶åˆ°æœ¬åœ°"></a>äºŒã€ä»è¿œç¨‹ä¸»æœºå¤åˆ¶åˆ°æœ¬åœ°</h3><p>ï¼ˆ1ï¼‰å‘½ä»¤è§£é‡Š<br>å‘½ä»¤æ ¼å¼å¦‚ä¸‹ï¼šscp user@remote_host:&#x2F;path&#x2F;on&#x2F;remote&#x2F;file.txt &#x2F;path&#x2F;to&#x2F;local&#x2F;</p><p>è¿™ä¼šå°†è¿œç¨‹ä¸»æœº <code>remote_host</code> çš„ <code>/path/on/remote/file.txt</code> æ–‡ä»¶å¤åˆ¶åˆ°æœ¬åœ°çš„ <code>/path/to/local/</code> ç›®å½•ä¸‹ã€‚</p><p>ï¼ˆ2ï¼‰å®é™…æ“ä½œ<br>å®æ“å‘½ä»¤å¦‚ä¸‹ï¼š<br>scp <a href="mailto:&#114;&#x6f;&#111;&#116;&#x40;&#49;&#57;&#x32;&#x2e;&#x31;&#x36;&#x38;&#46;&#49;&#x2e;&#49;&#48;&#x39;">&#114;&#x6f;&#111;&#116;&#x40;&#49;&#57;&#x32;&#x2e;&#x31;&#x36;&#x38;&#46;&#49;&#x2e;&#49;&#48;&#x39;</a>:&#x2F;home&#x2F;DataBaseMysql.zip .&#x2F;</p><p>è¿™ä¼šå°†è¿œç¨‹ä¸»æœº <code>192.168.1.109</code> çš„&#x2F;home&#x2F;DataBaseMysql.zip æ–‡ä»¶å¤åˆ¶åˆ°æœ¬åœ°çš„å½“å‰ç›®å½•ä¸‹</p><h3 id="ä¸‰ã€é€’å½’å¤åˆ¶ç›®å½•"><a href="#ä¸‰ã€é€’å½’å¤åˆ¶ç›®å½•" class="headerlink" title="ä¸‰ã€é€’å½’å¤åˆ¶ç›®å½•"></a>ä¸‰ã€é€’å½’å¤åˆ¶ç›®å½•</h3><p>å®æ“å‘½ä»¤å¦‚ä¸‹ï¼šscp -r user@remote_host:&#x2F;path&#x2F;on&#x2F;remote&#x2F;directory &#x2F;path&#x2F;to&#x2F;local&#x2F;</p><p>è¿™ä¼šå°†è¿œç¨‹ä¸»æœº <code>remote_host</code> çš„ <code>/path/on/remote/directory</code> ç›®å½•åŠå…¶æ‰€æœ‰å†…å®¹å¤åˆ¶åˆ°æœ¬åœ°çš„ <code>/path/to/local/</code> ç›®å½•ä¸‹ã€‚</p><h3 id="å››ã€æŒ‡å®š-SSH-ç«¯å£"><a href="#å››ã€æŒ‡å®š-SSH-ç«¯å£" class="headerlink" title="å››ã€æŒ‡å®š SSH ç«¯å£"></a>å››ã€æŒ‡å®š SSH ç«¯å£</h3><p>å¦‚æœè¿œç¨‹ä¸»æœºçš„ SSH ç«¯å£ä¸æ˜¯é»˜è®¤çš„ 22ï¼Œå¯ä»¥ä½¿ç”¨ <code>-P</code> é€‰é¡¹æŒ‡å®šç«¯å£ï¼š</p><p>scp -P 2222 user@remote_host:&#x2F;path&#x2F;on&#x2F;remote&#x2F;file.txt &#x2F;path&#x2F;to&#x2F;local&#x2F;</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;ä¸€ã€ä»æœ¬åœ°å¤åˆ¶åˆ°è¿œç¨‹ä¸»æœº&quot;&gt;&lt;a href=&quot;#ä¸€ã€ä»æœ¬åœ°å¤åˆ¶åˆ°è¿œç¨‹ä¸»æœº&quot; class=&quot;headerlink&quot; title=&quot;ä¸€ã€ä»æœ¬åœ°å¤åˆ¶åˆ°è¿œç¨‹ä¸»æœº&quot;&gt;&lt;/a&gt;ä¸€ã€ä»æœ¬åœ°å¤åˆ¶åˆ°è¿œç¨‹ä¸»æœº&lt;/h2&gt;&lt;p&gt;å‘½ä»¤æ ¼å¼å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;p&gt;scp &amp;#x2F;path&amp;</summary>
      
    
    
    
    <category term="Linuxå·¥å…·" scheme="http://example.com/categories/Linux%E5%B7%A5%E5%85%B7/"/>
    
    
    <category term="Linuxå·¥å…·" scheme="http://example.com/tags/Linux%E5%B7%A5%E5%85%B7/"/>
    
  </entry>
  
</feed>
